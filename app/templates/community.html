{% extends "base.html" %}

{% block title %}Agorix çµæ„Ÿé›†å¸‚{% endblock %}

{% block extra_css %}
<style>
/* ç¤¾åŒºä¸“ç”¨æ ·å¼ */
.community-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 12px 32px;
    background: #fafafa;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 14px;
    line-height: 1.5;
}

/* å¯¼èˆªæ æ ·å¼ */
.community-nav {
    background: white;
    border-radius: 8px;
    padding: 16px 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
    max-width: 1000px;
    margin: 0 auto 20px auto;
}

.nav-tabs {
    display: flex;
    gap: 12px;
}

.nav-tabs .tab {
    background: none;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    color: #666;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    font-size: 14px;
}

.nav-tabs .tab.active {
    background: rgba(0, 123, 255, 0.1);
    color: #007bff;
    border: 1px solid rgba(0, 123, 255, 0.2);
}

.nav-tabs .tab:hover:not(.active) {
    background: rgba(0, 0, 0, 0.04);
    color: #333;
    transform: translateY(-1px);
}

.create-post-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 123, 255, 0.25);
    font-size: 14px;
}

.create-post-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 18px rgba(0, 123, 255, 0.35);
}

/* å†…å®¹åŒºåŸŸå¸ƒå±€ */
.community-content {
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: 16px;
    align-items: start;
    max-width: 1000px;
    margin: 0 auto;
}

.feed-container {
    background: white;
    border-radius: 8px;
    padding: 0;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

/* å³ä¾§æ¨¡å—æ ·å¼ */
.right-modules {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.creation-module,
.trending-module {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.module-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.module-header h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.module-content {
    padding: 16px 20px;
}

/* åˆ›ä½œæ¨¡å—æ ·å¼ */
.create-post-btn.primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 123, 255, 0.25);
    font-size: 14px;
    width: 100%;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.create-post-btn.primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.35);
}

.creation-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.creation-stats .stat-item {
    text-align: center;
    padding: 8px;
    border-radius: 4px;
    background: #f8f9fa;
}

.creation-stats .stat-number {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #007bff;
}

.creation-stats .stat-label {
    display: block;
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.creation-tips h6 {
    font-size: 12px;
    margin: 0 0 8px 0;
    color: #666;
    font-weight: 600;
}

.creation-tips ul {
    margin: 0;
    padding-left: 16px;
    font-size: 11px;
    color: #666;
}

.creation-tips li {
    margin-bottom: 4px;
}

/* çƒ­ç‚¹æ¨¡å—æ ·å¼ */
.challenge-section,
.hot-tags-section,
.daily-stats-section {
    margin-bottom: 20px;
}

.challenge-section:last-child,
.hot-tags-section:last-child,
.daily-stats-section:last-child {
    margin-bottom: 0;
}

.challenge-section h6,
.hot-tags-section h6,
.daily-stats-section h6 {
    font-size: 12px;
    margin: 0 0 10px 0;
    color: #666;
    font-weight: 600;
}

.challenge-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.challenge-item:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.challenge-info {
    flex: 1;
}

.challenge-title {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
}

.challenge-desc {
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
}

.challenge-meta {
    font-size: 10px;
    color: #999;
}

.challenge-meta span {
    margin-right: 8px;
}

.challenge-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.challenge-btn:hover {
    background: #0056b3;
}

.hot-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.hot-tag {
    background: #f8f9fa;
    color: #666;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.hot-tag:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.hot-tag small {
    opacity: 0.7;
    margin-left: 4px;
}

.daily-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

.stat-label {
    color: #666;
}

.stat-value {
    font-weight: 600;
    color: #007bff;
}

/* å¸–å­å¡ç‰‡æ ·å¼ - ç´§å‡‘ç‰ˆ */
.post-card {
    background: white;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 12px 16px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.post-card:hover {
    background: #fafafa;
    transform: translateX(4px);
}

.post-card:hover::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.post-card:last-child {
    border-bottom: none;
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.post-user {
    display: flex;
    align-items: center;
    flex: 1;
}

.user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    margin-right: 8px;
    font-size: 12px;
    flex-shrink: 0;
}

.user-info {
    flex: 1;
    min-width: 0;
}

.username {
    font-weight: 600;
    color: #333;
    font-size: 13px;
    margin: 0;
}

.post-time {
    color: #666;
    font-size: 11px;
    margin: 0;
}

.post-content {
    margin: 6px 0;
    line-height: 1.4;
}

.post-content p {
    font-size: 14px;
    color: #333;
    margin: 0 0 4px 0;
    line-height: 1.4;
}

.ai-content {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 6px 10px;
    margin: 4px 0;
    border-left: 3px solid #007bff;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-content.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid rgba(0, 123, 255, 0.1);
}

.ai-content.clickable:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
    border-color: rgba(0, 123, 255, 0.2);
}

.ai-content i {
    color: #007bff;
    font-size: 14px;
}

.ai-content span {
    color: #495057;
}

.view-hint {
    margin-left: auto;
    font-size: 11px;
    color: #007bff !important;
    font-weight: 500;
    opacity: 0.8;
}

.ai-content.clickable:hover .view-hint {
    opacity: 1;
    color: #0056b3 !important;
}

.ai-prompt {
    background: #e3f2fd;
    border-radius: 4px;
    padding: 6px 8px;
    margin: 4px 0;
    font-size: 12px;
    color: #1976d2;
    border-left: 3px solid #2196f3;
}

.ai-prompt-label {
    font-weight: 600;
    margin-bottom: 2px;
}

/* å³ä¾§æ¨¡å—æ ·å¼ */
.right-modules {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.creation-module,
.trending-module {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.module-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.module-header h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.module-content {
    padding: 16px 20px;
}

/* åˆ›ä½œæ¨¡å—æ ·å¼ */
.create-post-btn.primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 123, 255, 0.25);
    font-size: 14px;
    width: 100%;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.create-post-btn.primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.35);
}

.creation-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.creation-stats .stat-item {
    text-align: center;
    padding: 8px;
    border-radius: 4px;
    background: #f8f9fa;
}

.creation-stats .stat-number {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #007bff;
}

.creation-stats .stat-label {
    display: block;
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.creation-tips h6 {
    font-size: 12px;
    margin: 0 0 8px 0;
    color: #666;
    font-weight: 600;
}

.creation-tips ul {
    margin: 0;
    padding-left: 16px;
    font-size: 11px;
    color: #666;
}

.creation-tips li {
    margin-bottom: 4px;
}

/* çƒ­ç‚¹æ¨¡å—æ ·å¼ */
.challenge-section,
.hot-tags-section,
.daily-stats-section {
    margin-bottom: 20px;
}

.challenge-section:last-child,
.hot-tags-section:last-child,
.daily-stats-section:last-child {
    margin-bottom: 0;
}

.challenge-section h6,
.hot-tags-section h6,
.daily-stats-section h6 {
    font-size: 12px;
    margin: 0 0 10px 0;
    color: #666;
    font-weight: 600;
}

.challenge-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.challenge-item:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.challenge-info {
    flex: 1;
}

.challenge-title {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
}

.challenge-desc {
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
}

.challenge-meta {
    font-size: 10px;
    color: #999;
}

.challenge-meta span {
    margin-right: 8px;
}

.challenge-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.challenge-btn:hover {
    background: #0056b3;
}

.hot-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.hot-tag {
    background: #f8f9fa;
    color: #666;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.hot-tag:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.hot-tag small {
    opacity: 0.7;
    margin-left: 4px;
}

.daily-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

.stat-label {
    color: #666;
}

.stat-value {
    font-weight: 600;
    color: #007bff;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .community-container {
        padding: 8px 16px;
        max-width: 100%;
    }
    
    .community-nav {
        max-width: 100%;
        padding: 12px 16px;
    }
    
    .community-content {
        grid-template-columns: 1fr;
        gap: 12px;
        max-width: 100%;
    }
    
    .right-modules {
        order: -1;
    }
    
    .nav-tabs {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .nav-tabs .tab {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .creation-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    
    .challenge-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .challenge-btn {
        align-self: flex-end;
    }
}

.post-tags {
    margin: 4px 0;
}

.post-tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 10px;
    margin-right: 4px;
    margin-bottom: 2px;
    font-weight: 500;
}

.post-actions {
    display: flex;
    gap: 16px;
    padding-top: 6px;
    border-top: 1px solid #f0f0f0;
    margin-top: 6px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    transition: color 0.2s ease;
    font-size: 12px;
    padding: 2px 4px;
    border-radius: 3px;
}

.action-btn:hover {
    color: #333;
    background: rgba(0,0,0,0.04);
}

.action-btn.active {
    color: #e74c3c;
}

.action-btn .count {
    font-size: 11px;
}

/* åŠ è½½çŠ¶æ€ */
.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #666;
}

.skeleton-card {
    background: white;
    border-bottom: 1px solid #f0f0f0;
    padding: 24px;
    animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-line {
    background: #e9ecef;
    height: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
}

.skeleton-line.short {
    width: 60%;
}

.skeleton-line.medium {
    width: 80%;
}

.skeleton-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    margin-right: 12px;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .community-container {
        padding: 8px 16px;
        max-width: 100%;
    }
    
    .community-nav {
        max-width: 100%;
        padding: 12px 16px;
    }
    
    .community-content {
        grid-template-columns: 1fr;
        gap: 12px;
        max-width: 100%;
    }
    
    .right-modules {
        order: -1;
    }
    
    .nav-tabs {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .nav-tabs .tab {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .creation-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    
    .challenge-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .challenge-btn {
        align-self: flex-end;
    }
}

/* åˆ›å»ºå¸–å­æ¨¡æ€æ¡† */
.create-post-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.create-post-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 0;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.08);
}

.create-post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0;
    padding: 20px 28px 16px 28px;
    border-bottom: 1px solid #e9ecef;
    background: #fafafa;
    border-radius: 8px 8px 0 0;
}

.create-post-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.close-modal {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #666;
    padding: 4px;
}

.form-group {
    margin-bottom: 14px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
    font-size: 13px;
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fafafa;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    background: white;
    transform: translateY(-1px);
}

.char-counter {
    text-align: right;
    font-size: 11px;
    color: #666;
    margin-top: 3px;
}

.char-counter.warning {
    color: #f39c12;
}

.char-counter.error {
    color: #e74c3c;
}

.create-post-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin: 16px 0 0 0;
    padding: 14px 28px 20px 28px;
    border-top: 1px solid #e9ecef;
    background: #fafafa;
    border-radius: 0 0 8px 8px;
}

.btn-secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid rgba(0,0,0,0.12);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.btn-secondary:hover {
    background: #e9ecef;
    color: #495057;
    transform: translateY(-1px);
}

.btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
}

.btn-primary:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

/* åˆ†äº«ç±»å‹é€‰æ‹©tabs */
.share-type-tabs {
    display: flex;
    background: white;
    border-bottom: 1px solid #e9ecef;
    padding: 0 28px;
}

.share-type-tab {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 2px solid transparent;
    color: #666;
    font-weight: 500;
    font-size: 13px;
}

.share-type-tab:hover {
    background: rgba(0,0,0,0.04);
    color: #333;
}

.share-type-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
    background: white;
}

.share-content {
    transition: all 0.3s ease;
}

/* å¿«æ·æ“ä½œæŒ‰é’®æ ·å¼ */
.quick-action-btn {
    transition: all 0.3s ease !important;
    border-radius: 6px !important;
}

.quick-action-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .community-container {
        padding: 12px 16px;
    }
    
    .community-content {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .community-nav {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }
    
    .nav-tabs {
        justify-content: center;
    }
    
    .create-post-content {
        width: 95%;
        margin: 0 auto;
    }
}

/* å³ä¾§ä¿¡æ¯æ ç»„ä»¶æ ·å¼ */

/* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
.user-profile {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.profile-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 18px;
    margin-right: 12px;
}

.profile-info h4 {
    margin: 0 0 2px 0;
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.profile-desc {
    margin: 0;
    font-size: 12px;
    color: #666;
}

.user-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    padding: 12px 0;
    border-top: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.stat-number {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.stat-label {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

/* åˆ›ä½œç«èµ› */
.contest-item {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
}

.contest-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.contest-badge {
    display: inline-block;
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
    margin-bottom: 6px;
}

.contest-badge.upcoming {
    background: #6c757d;
}

.contest-item h4 {
    margin: 0 0 6px 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.contest-desc {
    margin: 0 0 8px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.4;
}

.contest-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.contest-meta span {
    font-size: 11px;
    color: #666;
}

.contest-meta i {
    margin-right: 4px;
    color: #007bff;
}

/* çƒ­é—¨è¯é¢˜ */
.trending-topics {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.topic-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.topic-item:hover {
    background: #e9ecef;
    transform: translateX(2px);
}

.topic-tag {
    font-size: 13px;
    font-weight: 500;
    color: #007bff;
}

.topic-count {
    font-size: 11px;
    color: #666;
}

/* ç¤¾åŒºç»Ÿè®¡ */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

.stats-item {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stats-number {
    display: block;
    font-size: 15px;
    font-weight: 600;
    color: #007bff;
}

.stats-label {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.daily-stats {
    display: flex;
    justify-content: space-between;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.daily-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.daily-label {
    font-size: 11px;
    color: #666;
}

.daily-number {
    font-size: 14px;
    font-weight: 600;
    color: #28a745;
    margin-top: 2px;
}

/* å¿«æ·æ“ä½œæŒ‰é’® */
.quick-action-btn:hover {
    transform: translateY(-1px);
}

/* å¯¹è¯è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
.conversation-detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.conversation-detail-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 900px;
    height: 85vh;
    max-height: 700px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.conversation-detail-header {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.conversation-header-info h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.conversation-meta {
    display: flex;
    gap: 12px;
    margin-top: 2px;
}

.conversation-meta span {
    font-size: 12px;
    color: #6b7280;
}

.close-modal {
    background: none;
    border: none;
    font-size: 20px;
    color: #9ca3af;
    cursor: pointer;
    padding: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.close-modal:hover {
    background: #f3f4f6;
    color: #374151;
}

.conversation-detail-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
}

.conversation-description {
    margin-bottom: 12px;
    padding: 8px 12px;
    background: #f0f9ff;
    border-radius: 6px;
    border-left: 3px solid #3b82f6;
}

.conversation-description h4 {
    font-size: 13px;
    font-weight: 600;
    color: #1e40af;
    margin: 0 0 4px 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.conversation-description p {
    margin: 0;
    color: #1e40af;
    line-height: 1.4;
    font-size: 13px;
}

.conversation-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.conversation-content h4 {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.conversation-messages {
    flex: 1;
    background: #fafafa;
    border-radius: 6px;
    padding: 8px;
    overflow-y: auto;
    min-height: 200px;
}

/* æ¶ˆæ¯æ ·å¼ - ç±»ä¼¼chaté¡µé¢ */
.conversation-messages .message {
    display: flex;
    margin-bottom: 8px;
    align-items: flex-start;
    gap: 8px;
}

.conversation-messages .message:last-child {
    margin-bottom: 0;
}

.conversation-messages .message-avatar {
    flex-shrink: 0;
}

.conversation-messages .user-avatar,
.conversation-messages .ai-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
}

.conversation-messages .user-avatar {
    background: #3b82f6;
    color: white;
}

.conversation-messages .ai-avatar {
    background: #10b981;
    color: white;
}

.conversation-messages .message-content {
    flex: 1;
    min-width: 0;
}

.conversation-messages .message-text {
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    margin-bottom: 2px;
    border: 1px solid #e5e7eb;
    line-height: 1.4;
    font-size: 13px;
}

.conversation-messages .user-message .message-text {
    background: #eff6ff;
    border-color: #bfdbfe;
}

.conversation-messages .assistant-message .message-text {
    background: #f0fdf4;
    border-color: #bbf7d0;
}

.conversation-messages .message-time {
    font-size: 10px;
    color: #9ca3af;
    margin-left: 10px;
}

/* ä»£ç å—æ ·å¼ä¼˜åŒ– */
.conversation-messages pre {
    margin: 4px 0;
    background: #1f2937;
    border-radius: 4px;
    font-size: 11px;
}

.conversation-messages code {
    background: #f3f4f6;
    padding: 1px 4px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 11px;
}

.conversation-messages pre code {
    background: transparent;
    padding: 8px;
    display: block;
    color: #e5e7eb;
}

/* V0.3.0 å¯¹è¯é…ç½®æ ·å¼ */
.conversation-config {
    padding: 12px;
    background: #f0f9ff;
    border-radius: 6px;
    border-left: 3px solid #0ea5e9;
    margin-bottom: 12px;
}

.conversation-config h4 {
    font-size: 13px;
    font-weight: 600;
    color: #0369a1;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.conversation-config .config-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 8px;
}

.conversation-config .config-item {
    background: white;
    border: 1px solid #e0f2fe;
    border-radius: 4px;
    padding: 6px 8px;
}

.conversation-config .config-label {
    font-size: 10px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    margin-bottom: 2px;
}

.conversation-config .config-value {
    font-size: 12px;
    color: #1e293b;
    font-weight: 500;
}

.conversation-config .config-system-prompt {
    grid-column: 1 / -1;
}

.conversation-config .config-system-prompt .config-value {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
    color: #475569;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 80px;
    overflow-y: auto;
    background: #f8fafc;
    padding: 6px;
    border-radius: 3px;
    margin-top: 4px;
}

/* V0.3.1 ä¼˜åŒ–çš„é…ç½®ç½‘æ ¼å¸ƒå±€ */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
}

.config-grid .config-item {
    background: white;
    border: 1px solid #e0f2fe;
    border-radius: 6px;
    padding: 10px;
}

.config-grid .config-label {
    font-size: 11px;
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.config-grid .config-label i {
    font-size: 12px;
    color: #0ea5e9;
}

.config-grid .config-value {
    font-size: 13px;
    color: #1e293b;
    font-weight: 500;
}

.config-grid .config-system-prompt {
    grid-column: 1 / -1;
    border-color: #fed7aa;
    background: #fef3e2;
}

.config-grid .config-system-prompt .config-label {
    color: #ea580c;
}

.config-grid .config-system-prompt .config-label i {
    color: #f97316;
}

.config-grid .system-prompt-text {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
    color: #9a3412;
    background: white;
    border: 1px solid #fed7aa;
    border-radius: 4px;
    padding: 8px;
    margin-top: 4px;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 120px;
    overflow-y: auto;
}

.conversation-prompt {
    padding: 8px 12px;
    background: #fef3c7;
    border-radius: 6px;
    border-left: 3px solid #f59e0b;
    margin-bottom: 12px;
}

.conversation-prompt h4 {
    font-size: 13px;
    font-weight: 600;
    color: #92400e;
    margin: 0 0 4px 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.prompt-content {
    color: #92400e;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 11px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
}

.conversation-detail-footer {
    padding: 12px 16px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    flex-shrink: 0;
}

.conversation-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.conversation-actions .btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}

.conversation-actions .btn-primary {
    background: #3b82f6;
    color: white;
}

.conversation-actions .btn-primary:hover {
    background: #2563eb;
}

.conversation-actions .btn-outline-secondary {
    background: white;
    color: #6b7280;
    border: 1px solid #d1d5db;
}

.conversation-actions .btn-outline-secondary:hover {
    background: #f9fafb;
    color: #374151;
}

.conversation-actions .btn-outline-info {
    background: white;
    color: #0891b2;
    border: 1px solid #67e8f9;
}

.conversation-actions .btn-outline-info:hover {
    background: #ecfeff;
    color: #0e7490;
}

/* å³ä¾§æ¨¡å—æ ·å¼ */
.right-modules {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.creation-module,
.trending-module {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.module-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.module-header h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.module-content {
    padding: 16px 20px;
}

/* åˆ›ä½œæ¨¡å—æ ·å¼ */
.create-post-btn.primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 123, 255, 0.25);
    font-size: 14px;
    width: 100%;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.create-post-btn.primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.35);
}

.creation-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.creation-stats .stat-item {
    text-align: center;
    padding: 8px;
    border-radius: 4px;
    background: #f8f9fa;
}

.creation-stats .stat-number {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #007bff;
}

.creation-stats .stat-label {
    display: block;
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

.creation-tips h6 {
    font-size: 12px;
    margin: 0 0 8px 0;
    color: #666;
    font-weight: 600;
}

.creation-tips ul {
    margin: 0;
    padding-left: 16px;
    font-size: 11px;
    color: #666;
}

.creation-tips li {
    margin-bottom: 4px;
}

/* çƒ­ç‚¹æ¨¡å—æ ·å¼ */
.challenge-section,
.hot-tags-section,
.daily-stats-section {
    margin-bottom: 20px;
}

.challenge-section:last-child,
.hot-tags-section:last-child,
.daily-stats-section:last-child {
    margin-bottom: 0;
}

.challenge-section h6,
.hot-tags-section h6,
.daily-stats-section h6 {
    font-size: 12px;
    margin: 0 0 10px 0;
    color: #666;
    font-weight: 600;
}

.challenge-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.challenge-item:hover {
    border-color: #007bff;
    background: #f8f9ff;
}

.challenge-info {
    flex: 1;
}

.challenge-title {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
}

.challenge-desc {
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
}

.challenge-meta {
    font-size: 10px;
    color: #999;
}

.challenge-meta span {
    margin-right: 8px;
}

.challenge-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.challenge-btn:hover {
    background: #0056b3;
}

.hot-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.hot-tag {
    background: #f8f9fa;
    color: #666;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.hot-tag:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.hot-tag small {
    opacity: 0.7;
    margin-left: 4px;
}

.daily-stats {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

.stat-label {
    color: #666;
}

.stat-value {
    font-weight: 600;
    color: #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="community-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="community-nav">
        <div class="nav-tabs">
            <button class="tab active" data-feed="recommended">æ¨è</button>
            <button class="tab" data-feed="following">å…³æ³¨</button>
            <button class="tab" data-feed="trending">çƒ­é—¨</button>
            <button class="tab" data-feed="featured">ç²¾é€‰</button>
        </div>
    </nav>
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="community-content">
        <!-- å·¦ä¾§æ—¶é—´æµ -->
        <div class="feed-container">
            <div id="posts-container">
                <!-- å¸–å­å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="loading-indicator" id="loading-indicator">
                <i class="bi bi-arrow-clockwise spin"></i> åŠ è½½ä¸­...
            </div>
        </div>
        
        <!-- å³ä¾§åˆ›ä½œå’Œçƒ­ç‚¹æ¨¡å— -->
        <div class="right-modules">
            <!-- åˆ›ä½œæ¨¡å— -->
            <div class="creation-module">
                <div class="module-header">
                    <h6><i class="bi bi-plus-circle text-primary me-2"></i>åˆ›ä½œä¸­å¿ƒ</h6>
                </div>
                <div class="module-content">
                    {% if current_user.is_authenticated and current_user.can_use_features() %}
                        <button class="create-post-btn primary" onclick="openCreatePostModal()">
                            <i class="bi bi-edit"></i> åˆ†äº«åˆ›ä½œ
                        </button>
                    {% elif current_user.is_authenticated and current_user.is_disabled() %}
                        <div class="disabled-user-notice">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>è´¦å·å·²è¢«ç¦ç”¨</strong><br>
                                æ‚¨å¯ä»¥æŸ¥çœ‹è¿‡å¾€å†…å®¹ï¼Œä½†æ— æ³•å‘å¸ƒæ–°å†…å®¹
                            </div>
                        </div>
                    {% else %}
                        <button class="create-post-btn primary" onclick="location.href='{{ url_for('auth.login') }}'">
                            <i class="bi bi-person"></i> ç™»å½•ååˆ†äº«
                        </button>
                    {% endif %}
                    
                    <div class="creation-stats">
                        <div class="stat-item">
                            <div class="stat-number">{{ current_user.get_posts_count() if current_user.is_authenticated else 0 }}</div>
                            <div class="stat-label">æˆ‘çš„åˆ†äº«</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">12</div>
                            <div class="stat-label">è·å¾—ç‚¹èµ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">5</div>
                            <div class="stat-label">æ”¶è·è¯„è®º</div>
                        </div>
                    </div>
                    
                    <div class="creation-tips">
                        <h6>åˆ›ä½œæŠ€å·§</h6>
                        <ul>
                            <li>åˆ†äº«å…·ä½“çš„AIåº”ç”¨åœºæ™¯</li>
                            <li>æä¾›å¯å¤ç°çš„æç¤ºè¯</li>
                            <li>æ·»åŠ ç›¸å…³æ ‡ç­¾å¢åŠ æ›å…‰</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- çƒ­ç‚¹æ¨¡å— -->
            <div class="trending-module">
                <div class="module-header">
                    <h6><i class="bi bi-fire text-danger me-2"></i>çƒ­ç‚¹åŠ¨æ€</h6>
                </div>
                <div class="module-content">
                    <!-- æŒ‘æˆ˜æ¯”èµ› -->
                    <div class="challenge-section">
                        <h6>ğŸ† ç«™æ–¹æŒ‘æˆ˜</h6>
                        <div class="challenge-item">
                            <div class="challenge-info">
                                <div class="challenge-title">AIä»£ç ä¼˜åŒ–æŒ‘æˆ˜</div>
                                <div class="challenge-desc">ç”¨AIé‡æ„ä¸€æ®µä»£ç ï¼Œæ¯”æ¯”è°æ›´ä¼˜é›…</div>
                                <div class="challenge-meta">
                                    <span class="participants">126äººå‚ä¸</span>
                                    <span class="deadline">3å¤©åæˆªæ­¢</span>
                                </div>
                            </div>
                            <button class="challenge-btn">å‚ä¸</button>
                        </div>
                        
                        <div class="challenge-item">
                            <div class="challenge-info">
                                <div class="challenge-title">åˆ›æ„æ–‡æ¡ˆå¤§èµ›</div>
                                <div class="challenge-desc">AIåˆ›ä½œæœ€æœ‰è¶£çš„äº§å“æ–‡æ¡ˆ</div>
                                <div class="challenge-meta">
                                    <span class="participants">89äººå‚ä¸</span>
                                    <span class="deadline">1å‘¨åæˆªæ­¢</span>
                                </div>
                            </div>
                            <button class="challenge-btn">å‚ä¸</button>
                        </div>
                    </div>
                    
                    <!-- çƒ­é—¨æ ‡ç­¾ -->
                    <div class="hot-tags-section">
                        <h6>ğŸ”¥ çƒ­é—¨æ ‡ç­¾</h6>
                        <div class="hot-tags">
                            <span class="hot-tag" onclick="searchByTag('GPTåº”ç”¨')">#GPTåº”ç”¨ <small>2.1k</small></span>
                            <span class="hot-tag" onclick="searchByTag('ä»£ç ç”Ÿæˆ')">#ä»£ç ç”Ÿæˆ <small>1.8k</small></span>
                            <span class="hot-tag" onclick="searchByTag('æ–‡æ¡ˆåˆ›ä½œ')">#æ–‡æ¡ˆåˆ›ä½œ <small>1.3k</small></span>
                            <span class="hot-tag" onclick="searchByTag('å­¦ä¹ ç¬”è®°')">#å­¦ä¹ ç¬”è®° <small>956</small></span>
                            <span class="hot-tag" onclick="searchByTag('æ•ˆç‡å·¥å…·')">#æ•ˆç‡å·¥å…· <small>743</small></span>
                            <span class="hot-tag" onclick="searchByTag('åˆ›æ„è®¾è®¡')">#åˆ›æ„è®¾è®¡ <small>621</small></span>
                        </div>
                    </div>
                    
                    <!-- ä»Šæ—¥æ•°æ® -->
                    <div class="daily-stats-section">
                        <h6>ğŸ“Š ä»Šæ—¥æ•°æ®</h6>
                        <div class="daily-stats">
                            <div class="stat-row">
                                <span class="stat-label">æ–°å¢åˆ†äº«</span>
                                <span class="stat-value">+47</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">æ´»è·ƒç”¨æˆ·</span>
                                <span class="stat-value">238</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">çƒ­é—¨è¯é¢˜</span>
                                <span class="stat-value">#AIç¼–ç¨‹</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºå¸–å­æ¨¡æ€æ¡† -->
<div class="create-post-modal" id="createPostModal">
    <div class="create-post-content">
        <div class="create-post-header">
            <h3>åˆ†äº«ä½ çš„AIåˆ›ä½œ</h3>
            <button class="close-modal" onclick="closeCreatePostModal()">&times;</button>
        </div>
        
        <!-- åˆ†äº«ç±»å‹é€‰æ‹© -->
        <div class="share-type-tabs">
            <button type="button" class="share-type-tab active" data-type="text" onclick="switchShareType('text')">
                <i class="bi bi-chat-text"></i> æ–‡å­—åˆ†äº«
            </button>
            <button type="button" class="share-type-tab" data-type="conversation" onclick="switchShareType('conversation')">
                <i class="bi bi-chat-dots"></i> å¯¹è¯åˆ†äº«
            </button>
        </div>
        
        <form id="createPostForm" style="padding: 20px 28px 0 28px;">
            <!-- æ–‡å­—åˆ†äº«æ¨¡å¼ -->
            <div class="share-content" id="textShareContent">
                <div class="form-group">
                    <label for="postContent">åˆ†äº«å†…å®¹ *</label>
                    <textarea class="form-control" id="postContent" rows="3" 
                             placeholder="åˆ†äº«ä½ çš„AIåˆ›ä½œå¿ƒå¾—..." maxlength="140"></textarea>
                    <div class="char-counter" id="charCounter">0/140</div>
                </div>
                
                <div class="form-group">
                    <label for="aiPrompt">AIæç¤ºè¯ (å¯é€‰)</label>
                    <textarea class="form-control" id="aiPrompt" rows="2" 
                             placeholder="åˆ†äº«ä½ ä½¿ç”¨çš„æç¤ºè¯..."></textarea>
                </div>
            </div>
            
            <!-- å¯¹è¯åˆ†äº«æ¨¡å¼ -->
            <div class="share-content" id="conversationShareContent" style="display: none;">
                <div class="form-group">
                    <label for="shareDescription">å¯¹è¯æè¿° *</label>
                    <textarea class="form-control" id="shareDescription" rows="3" 
                             placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™ä¸ªå¯¹è¯çš„å†…å®¹å’Œäº®ç‚¹..." maxlength="140"></textarea>
                    <div class="char-counter" id="descriptionCharCounter">0/140</div>
                </div>
                
                <div class="form-group">
                    <label for="conversationSelect">é€‰æ‹©è¦åˆ†äº«çš„å¯¹è¯ *</label>
                    <select class="form-control" id="conversationSelect">
                        <option value="">è¯·é€‰æ‹©ä¸€ä¸ªå¯¹è¯...</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="loadConversations()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°å¯¹è¯åˆ—è¡¨
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="postTags">æ ‡ç­¾ (å¯é€‰)</label>
                <input type="text" class="form-control" id="postTags" 
                       placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šAIåˆ›ä½œ,æç¤ºè¯">
            </div>
            
            <div class="create-post-actions">
                <button type="button" class="btn-secondary" onclick="closeCreatePostModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn-primary" id="submitPostBtn">å‘å¸ƒ</button>
            </div>
        </form>
    </div>
</div>

<!-- å¯¹è¯è¯¦æƒ…æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="conversation-detail-modal" id="conversationDetailModal">
    <div class="conversation-detail-content">
        <div class="conversation-detail-header">
            <div class="conversation-header-info">
                <h3>å¯¹è¯è¯¦æƒ…</h3>
                <div class="conversation-meta">
                    <span class="conversation-user">åˆ†äº«è€…ï¼š<span id="conversationSharer"></span></span>
                    <span class="conversation-time" id="conversationTime"></span>
                </div>
            </div>
            <button class="close-modal" onclick="closeConversationModal()">&times;</button>
        </div>
        
        <div class="conversation-detail-body">
            <!-- å¯¹è¯æè¿° -->
            <div class="conversation-description">
                <h4><i class="bi bi-chat-quote"></i> åˆ†äº«æè¿°</h4>
                <p id="conversationDescription"></p>
            </div>
            
            <!-- V0.3.0 å¯¹è¯é…ç½®å‚æ•° -->
            <div class="conversation-config" id="conversationConfigSection" style="display: none;">
                <h4><i class="bi bi-gear"></i> å¯¹è¯é…ç½®</h4>
                <div class="config-content" id="conversationConfig">
                    <!-- é…ç½®å‚æ•°å°†é€šè¿‡JavaScriptåŠ è½½ -->
                </div>
            </div>
            
            <!-- å¯¹è¯å†…å®¹ -->
            <div class="conversation-content">
                <h4><i class="bi bi-chat-dots"></i> å¯¹è¯å†…å®¹</h4>
                <div class="conversation-messages" id="conversationMessages">
                    <!-- å¯¹è¯æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ è½½ -->
                </div>
            </div>
            
            <!-- AIæç¤ºè¯ï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <div class="conversation-prompt" id="conversationPromptSection" style="display: none;">
                <h4><i class="bi bi-robot"></i> AIæç¤ºè¯</h4>
                <div class="prompt-content" id="conversationPrompt"></div>
            </div>
        </div>
        
        <div class="conversation-detail-footer">
            <div class="conversation-actions">
                <button class="btn btn-primary" onclick="copyToMyChat()">
                    <i class="bi bi-chat-left-dots"></i> å¤åˆ¶åˆ°æˆ‘çš„å¯¹è¯
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ marked.js å’Œ highlight.js ç”¨äºæ¶ˆæ¯æ¸²æŸ“ - V0.3.1 æ€§èƒ½ä¼˜åŒ– -->
<script>
// æ€§èƒ½ç›‘æ§ï¼šè®°å½•èµ„æºåŠ è½½å¼€å§‹æ—¶é—´
const resourceLoadStart = performance.now();
console.log(`ğŸ” [DEBUG] å¼€å§‹åŠ è½½å¤–éƒ¨èµ„æº - ${new Date().toLocaleTimeString()}`);

// èµ„æºåŠ è½½çŠ¶æ€ç®¡ç†
window.communityResources = {
    marked: false,
    hljs: false,
    mathjax: false,
    allLoaded: false
};

// æ£€æŸ¥æ‰€æœ‰èµ„æºæ˜¯å¦åŠ è½½å®Œæˆ
function checkResourcesLoaded() {
    const resources = window.communityResources;
    if (resources.marked && resources.hljs) {
        resources.allLoaded = true;
        const totalTime = performance.now() - resourceLoadStart;
        console.log(`âœ… [DEBUG] æ ¸å¿ƒèµ„æºåŠ è½½å®Œæˆ: ${totalTime.toFixed(3)}ms`);
        
        // è§¦å‘é¡µé¢åˆå§‹åŒ–ï¼ˆä¸ç­‰å¾…MathJaxï¼‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPageAfterResources);
        } else {
            initPageAfterResources();
        }
    }
}

// èµ„æºåŠ è½½å®Œæˆåçš„é¡µé¢åˆå§‹åŒ–
function initPageAfterResources() {
    console.log(`ğŸ¯ [DEBUG] é¡µé¢åˆå§‹åŒ–æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹åˆå§‹åŒ–`);
}

// ç®€åŒ–çš„marked.jsåŠ è½½ - å¸¦å¤‡ç”¨CDN
function loadMarked() {
    return new Promise((resolve) => {
        const timeout = setTimeout(() => {
            console.warn(`âš ï¸ [DEBUG] marked.jsåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ`);
            window.marked = {
                parse: (text) => text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>')
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            };
            window.communityResources.marked = true;
            checkResourcesLoaded();
            resolve();
        }, 5000);

        // å°è¯•åŠ è½½marked.js
        function tryLoadMarked(urls, index = 0) {
            if (index >= urls.length) {
                clearTimeout(timeout);
                timeout();
                return;
            }

            const script = document.createElement('script');
            script.src = urls[index];
            script.onload = () => {
                clearTimeout(timeout);
                window.communityResources.marked = true;
                console.log(`âœ… [DEBUG] marked.jsåŠ è½½å®Œæˆ`);
                checkResourcesLoaded();
                resolve();
            };
            script.onerror = () => {
                console.warn(`âš ï¸ [DEBUG] CDN ${index + 1} å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª`);
                tryLoadMarked(urls, index + 1);
            };
            document.head.appendChild(script);
        }

        const cdns = [
            'https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js',
            'https://unpkg.com/marked@5.1.1/marked.min.js'
        ];
        
        tryLoadMarked(cdns);
    });
}

// ç®€åŒ–çš„highlight.jsåŠ è½½ - å¸¦å¤‡ç”¨CDN  
function loadHighlightJS() {
    return new Promise((resolve) => {
        const timeout = setTimeout(() => {
            console.warn(`âš ï¸ [DEBUG] highlight.jsåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ`);
            window.hljs = {
                highlightElement: (element) => {
                    if (element && element.tagName === 'CODE') {
                        element.style.fontFamily = 'Monaco, Menlo, monospace';
                        element.style.fontSize = '0.9em';
                        element.style.backgroundColor = '#f6f8fa';
                        element.style.padding = '0.2em 0.4em';
                        element.style.borderRadius = '3px';
                    }
                },
                highlightAll: () => {
                    document.querySelectorAll('pre code').forEach(block => {
                        window.hljs.highlightElement(block);
                    });
                }
            };
            window.communityResources.hljs = true;
            checkResourcesLoaded();
            resolve();
        }, 5000);

        // åŠ è½½CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css';
        document.head.appendChild(link);

        // å°è¯•åŠ è½½highlight.js
        function tryLoadHljs(urls, index = 0) {
            if (index >= urls.length) {
                clearTimeout(timeout);
                timeout();
                return;
            }

            const script = document.createElement('script');
            script.src = urls[index];
            script.onload = () => {
                clearTimeout(timeout);
                window.communityResources.hljs = true;
                console.log(`âœ… [DEBUG] highlight.jsåŠ è½½å®Œæˆ`);
                checkResourcesLoaded();
                resolve();
            };
            script.onerror = () => {
                console.warn(`âš ï¸ [DEBUG] highlight.js CDN ${index + 1} å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª`);
                tryLoadHljs(urls, index + 1);
            };
            document.head.appendChild(script);
        }

        const cdns = [
            'https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/es/highlight.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js',
            'https://unpkg.com/highlight.js@11.8.0/lib/index.js'
        ];
        
        tryLoadHljs(cdns);
    });
}

// å»¶è¿ŸåŠ è½½MathJaxï¼ˆä¸é˜»å¡é¡µé¢åˆå§‹åŒ–ï¼‰
function loadMathJax() {
    setTimeout(() => {
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                ignoreHtmlClass: 'no-mathjax',
                processHtmlClass: 'mathjax'
            }
        };

        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es/tex-mml-chtml.js';
        script.onload = () => {
            window.communityResources.mathjax = true;
            console.log(`âœ… [DEBUG] MathJaxåŠ è½½å®Œæˆ`);
        };
        script.onerror = () => {
            console.warn(`âš ï¸ [DEBUG] MathJaxåŠ è½½å¤±è´¥ï¼Œæ•°å­¦å…¬å¼æ¸²æŸ“åŠŸèƒ½ä¸å¯ç”¨`);
        };
        document.head.appendChild(script);
    }, 100);
}

// å¹¶è¡ŒåŠ è½½èµ„æº
Promise.all([loadMarked(), loadHighlightJS()]).then(() => {
    console.log(`ğŸ‰ [DEBUG] æ‰€æœ‰æ ¸å¿ƒèµ„æºåŠ è½½å®Œæˆ`);
});

// å»¶è¿ŸåŠ è½½MathJax
loadMathJax();
</script>

<!-- å·¥å…·å‡½æ•° -->
<script>
// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const pageInitStart = performance.now();
    console.log(`ğŸ” [DEBUG] è®ºå›é¡µé¢åˆå§‹åŒ–å¼€å§‹ - ${new Date().toLocaleTimeString()}`);
    
    // åˆå§‹åŒ–é¡µé¢
    const initStart = performance.now();
    initializeCommunityPage().then(() => {
        const initTime = performance.now() - initStart;
        console.log(`âœ… [DEBUG] è®ºå›é¡µé¢æ•°æ®åˆå§‹åŒ–å®Œæˆ: ${initTime.toFixed(3)}ms`);
    });
    
    // è®¾ç½®tabåˆ‡æ¢
    const tabStart = performance.now();
    setupTabSwitching();
    const tabTime = performance.now() - tabStart;
    console.log(`âœ… [DEBUG] Tabåˆ‡æ¢è®¾ç½®å®Œæˆ: ${tabTime.toFixed(3)}ms`);
    
    // è®¾ç½®åˆ›å»ºå¸–å­è¡¨å•
    const formStart = performance.now();
    setupCreatePostForm();
    const formTime = performance.now() - formStart;
    console.log(`âœ… [DEBUG] åˆ›å»ºå¸–å­è¡¨å•è®¾ç½®å®Œæˆ: ${formTime.toFixed(3)}ms`);
    
    const totalTime = performance.now() - pageInitStart;
    console.log(`ğŸ‰ [DEBUG] è®ºå›é¡µé¢åŸºç¡€åˆå§‹åŒ–å®Œæˆ: ${totalTime.toFixed(3)}ms`);
});

// åˆå§‹åŒ–ç¤¾åŒºé¡µé¢
async function initializeCommunityPage() {
    try {
        // åŠ è½½é»˜è®¤æ¨èæ—¶é—´æµ
        await loadFeed('recommended');
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        hideLoadingIndicator();
        
        console.log('ç¤¾åŒºé¡µé¢æ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
        console.error('ç¤¾åŒºé¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showError('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
        hideLoadingIndicator();
    }
}

// åŠ è½½æ—¶é—´æµæ•°æ®
async function loadFeed(feedType = 'recommended', page = 1, append = false) {
    const loadStart = performance.now();
    console.log(`ğŸ” [DEBUG] å¼€å§‹åŠ è½½æ—¶é—´æµ - ${feedType}, page ${page} - ${new Date().toLocaleTimeString()}`);
    
    try {
        if (!append) {
            showLoadingIndicator();
        }
        
        const fetchStart = performance.now();
        const response = await fetch(`/api/community/feed?type=${feedType}&page=${page}&limit=20`);
        const fetchEnd = performance.now();
        console.log(`âœ… [DEBUG] æ—¶é—´æµç½‘ç»œè¯·æ±‚å®Œæˆ: ${(fetchEnd - fetchStart).toFixed(3)}ms`);
        
        const parseStart = performance.now();
        const data = await response.json();
        const parseEnd = performance.now();
        console.log(`âœ… [DEBUG] æ—¶é—´æµæ•°æ®è§£æå®Œæˆ: ${(parseEnd - parseStart).toFixed(3)}ms`);
        
        if (data.success) {
            const renderStart = performance.now();
            renderPosts(data.posts, append);
            const renderEnd = performance.now();
            
            // æ›´æ–°å½“å‰feedç±»å‹
            window.currentFeedType = feedType;
            window.currentPage = page;
            
            const totalTime = renderEnd - loadStart;
            console.log(`âœ… [DEBUG] æ—¶é—´æµåŠ è½½å®Œæˆ:`);
            console.log(`   - ç½‘ç»œè¯·æ±‚: ${(fetchEnd - fetchStart).toFixed(3)}ms`);
            console.log(`   - æ•°æ®è§£æ: ${(parseEnd - parseStart).toFixed(3)}ms`);
            console.log(`   - é¡µé¢æ¸²æŸ“: ${(renderEnd - renderStart).toFixed(3)}ms`);
            console.log(`   - æ€»è€—æ—¶: ${totalTime.toFixed(3)}ms`);
            console.log(`   - å¸–å­æ•°é‡: ${data.posts.length}`);
        } else {
            const errorTime = performance.now() - loadStart;
            console.error(`âŒ [DEBUG] åŠ è½½æ—¶é—´æµå¤±è´¥: ${data.message} (è€—æ—¶: ${errorTime.toFixed(3)}ms)`);
            showError(data.message || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        const errorTime = performance.now() - loadStart;
        console.error(`âŒ [DEBUG] åŠ è½½æ—¶é—´æµå¼‚å¸¸: ${error.message} (è€—æ—¶: ${errorTime.toFixed(3)}ms)`);
        showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    } finally {
        if (!append) {
            hideLoadingIndicator();
        }
    }
}

// æ¸²æŸ“å¸–å­åˆ—è¡¨
function renderPosts(posts, append = false) {
    const renderStart = performance.now();
    console.log(`ğŸ” [DEBUG] å¼€å§‹æ¸²æŸ“å¸–å­åˆ—è¡¨ - æ•°é‡: ${posts.length}, è¿½åŠ æ¨¡å¼: ${append}`);
    
    const container = document.getElementById('posts-container');
    
    if (!append) {
        const clearStart = performance.now();
        container.innerHTML = '';
        const clearTime = performance.now() - clearStart;
        console.log(`âœ… [DEBUG] å®¹å™¨æ¸…ç©ºå®Œæˆ: ${clearTime.toFixed(3)}ms`);
    }
    
    if (posts.length === 0 && !append) {
        const emptyStart = performance.now();
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-chat-text" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3 text-muted">è¿˜æ²¡æœ‰å†…å®¹</h5>
                <p class="text-muted">æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«AIåˆ›ä½œçš„äººå§ï¼</p>
                <button class="btn btn-primary" onclick="openCreatePostModal()">
                    <i class="bi bi-plus"></i> å¼€å§‹åˆ†äº«
                </button>
            </div>
        `;
        const emptyTime = performance.now() - emptyStart;
        console.log(`âœ… [DEBUG] ç©ºçŠ¶æ€æ¸²æŸ“å®Œæˆ: ${emptyTime.toFixed(3)}ms`);
        return;
    }
    
    const elementsStart = performance.now();
    posts.forEach((post, index) => {
        const elementStart = performance.now();
        const postElement = createPostElement(post);
        const elementEnd = performance.now();
        
        container.appendChild(postElement);
        
        if (index < 3) { // åªè®°å½•å‰3ä¸ªå¸–å­çš„è¯¦ç»†æ—¶é—´
            console.log(`âœ… [DEBUG] å¸–å­ ${index + 1} åˆ›å»ºå®Œæˆ: ${(elementEnd - elementStart).toFixed(3)}ms`);
        }
    });
    const elementsTime = performance.now() - elementsStart;
    
    const totalTime = performance.now() - renderStart;
    console.log(`âœ… [DEBUG] å¸–å­åˆ—è¡¨æ¸²æŸ“å®Œæˆ:`);
    console.log(`   - å…ƒç´ åˆ›å»º: ${elementsTime.toFixed(3)}ms`);
    console.log(`   - æ€»è€—æ—¶: ${totalTime.toFixed(3)}ms`);
    console.log(`   - å¹³å‡æ¯å¸–å­: ${(elementsTime / posts.length).toFixed(3)}ms`);
}

// åˆ›å»ºå¸–å­å…ƒç´ 
function createPostElement(post) {
    const postDiv = document.createElement('div');
    postDiv.className = 'post-card';
    postDiv.setAttribute('data-post-id', post.id);
    
    // æ„å»ºç”¨æˆ·ä¿¡æ¯ - å¢åŠ å®‰å…¨æ£€æŸ¥
    const user = post.user || { username: 'æœªçŸ¥ç”¨æˆ·', nickname: null };
    const username = user.nickname || user.username || 'æœªçŸ¥ç”¨æˆ·';
    const avatar = getAvatarText(username);
    const timeStr = formatTime(post.created_at);
    
    // æ„å»ºæ ‡ç­¾ - ç›´æ¥æ”¾åœ¨å†…å®¹åé¢
    const tagsHtml = post.tags && post.tags.length > 0 
        ? ' ' + post.tags.map(tag => `<span class="post-tag">#${tag}</span>`).join(' ')
        : '';
    
    // æ„å»ºAIå†…å®¹æ˜¾ç¤º - ç®€åŒ–ä¸ºä¸€è¡Œ
    let aiContentHtml = '';
    if (post.ai_content_type === 'conversation') {
        aiContentHtml = `
            <div class="ai-content conversation-preview" onclick="viewConversation('${post.id}')">
                <i class="bi bi-chat-dots"></i>
                <span>AIå¯¹è¯åˆ†äº«</span>
                <span class="view-hint">ç‚¹å‡»æŸ¥çœ‹</span>
            </div>
        `;
    }
    
    postDiv.innerHTML = `
        <div class="post-header">
            <div class="post-user">
                <div class="user-avatar">${avatar}</div>
                <div class="user-info">
                    <div class="username">${escapeHtml(username)}</div>
                    <div class="post-time">${timeStr}</div>
                </div>
            </div>
        </div>
        
        <div class="post-content">
            <p>${escapeHtml(post.content)}${tagsHtml}</p>
        </div>
        
        ${aiContentHtml}
        
        <div class="post-actions">
            <button class="action-btn ${post.user_liked ? 'active' : ''}" onclick="toggleLike('${post.id}')">
                <i class="bi bi-heart${post.user_liked ? '-fill' : ''}"></i>
                <span class="count">${post.like_count || 0}</span>
            </button>
            <button class="action-btn" onclick="showComments('${post.id}')">
                <i class="bi bi-chat"></i>
                <span class="count">${post.comment_count || 0}</span>
            </button>
            <button class="action-btn" onclick="sharePost('${post.id}')">
                <i class="bi bi-share"></i>
                <span class="count">${post.share_count || 0}</span>
            </button>
            <button class="action-btn ${post.user_bookmarked ? 'active' : ''}" onclick="toggleBookmark('${post.id}')">
                <i class="bi bi-bookmark${post.user_bookmarked ? '-fill' : ''}"></i>
            </button>
        </div>
    `;
    
    return postDiv;
}

// è®¾ç½®tabåˆ‡æ¢
function setupTabSwitching() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', async function() {
            // ç§»é™¤æ‰€æœ‰activeç±»
            tabs.forEach(t => t.classList.remove('active'));
            // æ·»åŠ activeç±»åˆ°å½“å‰tab
            this.classList.add('active');
            
            // è·å–feedç±»å‹å¹¶åŠ è½½
            const feedType = this.dataset.feed;
            await loadFeed(feedType);
        });
    });
}

// ç‚¹èµåŠŸèƒ½
async function toggleLike(postId) {
    try {
        const response = await fetch(`/api/community/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°UI
            const button = document.querySelector(`[data-post-id="${postId}"] .action-btn:first-child`);
            const icon = button.querySelector('i');
            const count = button.querySelector('.count');
            
            if (data.action === 'liked') {
                button.classList.add('active');
                icon.className = 'bi bi-heart-fill';
            } else {
                button.classList.remove('active');
                icon.className = 'bi bi-heart';
            }
            
            count.textContent = data.like_count;
            
            showToast(data.action === 'liked' ? 'å·²ç‚¹èµ' : 'å·²å–æ¶ˆç‚¹èµ', 'success');
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('ç‚¹èµå¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
    }
}

// æ”¶è—åŠŸèƒ½
async function toggleBookmark(postId) {
    try {
        const response = await fetch(`/api/community/posts/${postId}/bookmark`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°UI
            const button = document.querySelector(`[data-post-id="${postId}"] .action-btn:last-child`);
            const icon = button.querySelector('i');
            
            if (data.action === 'bookmarked') {
                button.classList.add('active');
                icon.className = 'bi bi-bookmark-fill';
                showToast('å·²æ”¶è—', 'success');
            } else {
                button.classList.remove('active');
                icon.className = 'bi bi-bookmark';
                showToast('å·²å–æ¶ˆæ”¶è—', 'success');
            }
        } else {
            showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('æ”¶è—å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥', 'error');
    }
}

// æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
function showLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'flex';
    }
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const container = document.getElementById('posts-container');
    container.innerHTML = `
        <div class="error-state">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
            <h5 class="mt-3 text-danger">åŠ è½½å¤±è´¥</h5>
            <p class="text-muted">${escapeHtml(message)}</p>
            <button class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> é‡æ–°åŠ è½½
            </button>
        </div>
    `;
}

// åˆ›å»ºå¸–å­ç›¸å…³å‡½æ•°
function openCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'flex';
}

function closeCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'none';
    // é‡ç½®è¡¨å•
    document.getElementById('createPostForm').reset();
    // åˆ‡æ¢å›æ–‡å­—åˆ†äº«
    switchShareType('text');
}

function switchShareType(type) {
    // æ›´æ–°tabçŠ¶æ€
    document.querySelectorAll('.share-type-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.type === type) {
            tab.classList.add('active');
        }
    });
    
    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
    document.getElementById('textShareContent').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('conversationShareContent').style.display = type === 'conversation' ? 'block' : 'none';
    
    // å¦‚æœæ˜¯å¯¹è¯åˆ†äº«ï¼ŒåŠ è½½å¯¹è¯åˆ—è¡¨
    if (type === 'conversation') {
        loadConversations();
    }
}

// åŠ è½½å¯¹è¯åˆ—è¡¨
async function loadConversations() {
    try {
        const response = await fetch('/api/conversations?per_page=50');
        const data = await response.json();
        
        const select = document.getElementById('conversationSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªå¯¹è¯...</option>';
        
        if (data.success && data.conversations && data.conversations.length > 0) {
            data.conversations.forEach(conversation => {
                const option = document.createElement('option');
                option.value = conversation.id;
                option.textContent = conversation.title || `å¯¹è¯ ${conversation.id}`;
                select.appendChild(option);
            });
            showToast('å¯¹è¯åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success');
        } else {
            select.innerHTML = '<option value="">æš‚æ— å¯¹è¯è®°å½•</option>';
            showToast('æš‚æ— å¯¹è¯è®°å½•', 'info');
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
        const select = document.getElementById('conversationSelect');
        select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
        showToast('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// å ä½å‡½æ•°ï¼Œå¾…å®ç°
function showComments(postId) {
    showToast('è¯„è®ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function sharePost(postId) {
    showToast('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showUserBookmarks() {
    showToast('æˆ‘çš„æ”¶è—åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showUserPosts() {
    showToast('æˆ‘çš„åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function searchByTag(tag) {
    showToast(`æœç´¢æ ‡ç­¾"${tag}"åŠŸèƒ½å¼€å‘ä¸­...`, 'info');
}

function formatTime(timeStr) {
    try {
        // ç¡®ä¿æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼æ­£ç¡®
        if (!timeStr) return 'æœªçŸ¥æ—¶é—´';
        
        // å¤„ç†ISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²
        const date = new Date(timeStr);
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(date.getTime())) {
            console.warn('æ— æ•ˆçš„æ—¶é—´æ ¼å¼:', timeStr);
            return 'æ—¶é—´æ ¼å¼é”™è¯¯';
        }
        
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (hours < 24) return `${hours}å°æ—¶å‰`;
        if (days < 7) return `${days}å¤©å‰`;
        
        // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        console.error('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', error, 'timeStr:', timeStr);
        return 'æ—¶é—´é”™è¯¯';
    }
}

function getAvatarText(username) {
    return username ? username.charAt(0).toUpperCase() : 'U';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    // ç®€å•çš„toastæç¤ºï¼Œå¯ä»¥åç»­æ”¹ä¸ºæ›´å¥½çš„UIç»„ä»¶
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// è®¾ç½®åˆ›å»ºå¸–å­è¡¨å•
function setupCreatePostForm() {
    const form = document.getElementById('createPostForm');
    const postContent = document.getElementById('postContent');
    const shareDescription = document.getElementById('shareDescription');
    const charCounter = document.getElementById('charCounter');
    const descriptionCharCounter = document.getElementById('descriptionCharCounter');
    
    // å­—ç¬¦è®¡æ•°å™¨
    if (postContent && charCounter) {
        postContent.addEventListener('input', function() {
            const length = this.value.length;
            charCounter.textContent = `${length}/140`;
            if (length > 120) {
                charCounter.style.color = '#dc3545';
            } else {
                charCounter.style.color = '#6c757d';
            }
        });
    }
    
    if (shareDescription && descriptionCharCounter) {
        shareDescription.addEventListener('input', function() {
            const length = this.value.length;
            descriptionCharCounter.textContent = `${length}/140`;
            if (length > 120) {
                descriptionCharCounter.style.color = '#dc3545';
            } else {
                descriptionCharCounter.style.color = '#6c757d';
            }
        });
    }
    
    // è¡¨å•æäº¤
    if (form) {
        form.addEventListener('submit', handleCreatePost);
    }
}

// å¤„ç†åˆ›å»ºå¸–å­
async function handleCreatePost(e) {
    e.preventDefault();
    
    const activeTab = document.querySelector('.share-type-tab.active');
    const shareType = activeTab ? activeTab.dataset.type : 'text';
    
    const submitBtn = document.getElementById('submitPostBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'å‘å¸ƒä¸­...';
    
    try {
        let postData = {};
        
        if (shareType === 'text') {
            const content = document.getElementById('postContent').value.trim();
            const aiPrompt = document.getElementById('aiPrompt').value.trim();
            
            if (!content) {
                showToast('è¯·è¾“å…¥åˆ†äº«å†…å®¹', 'error');
                return;
            }
            
            postData = {
                content: content,
                ai_prompt: aiPrompt || null,
                tags: parseTagsInput()
            };
        } else if (shareType === 'conversation') {
            const description = document.getElementById('shareDescription').value.trim();
            const conversationId = document.getElementById('conversationSelect').value;
            
            if (!description) {
                showToast('è¯·è¾“å…¥å¯¹è¯æè¿°', 'error');
                return;
            }
            
            if (!conversationId) {
                showToast('è¯·é€‰æ‹©è¦åˆ†äº«çš„å¯¹è¯', 'error');
                return;
            }
            
            postData = {
                content: description,
                ai_content_type: 'conversation',
                ai_content_data: { conversation_id: conversationId },
                tags: parseTagsInput()
            };
        }
        
        const response = await fetch('/api/community/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('å‘å¸ƒæˆåŠŸï¼', 'success');
            closeCreatePostModal();
            // åˆ·æ–°æ—¶é—´æµ
            await loadFeed(window.currentFeedType || 'recommended');
        } else {
            showToast(data.message || 'å‘å¸ƒå¤±è´¥', 'error');
        }
        
    } catch (error) {
        console.error('å‘å¸ƒå¸–å­å¤±è´¥:', error);
        showToast('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'å‘å¸ƒ';
    }
}

// è§£ææ ‡ç­¾è¾“å…¥
function parseTagsInput() {
    const tagsInput = document.getElementById('postTags');
    if (!tagsInput || !tagsInput.value.trim()) return [];
    
    return tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
}

// ä»chaté¡µé¢å¤åˆ¶çš„æ¶ˆæ¯æ¸²æŸ“å‡½æ•°
function renderMarkdown(content) {
    try {
        // é¢„å¤„ç†æ•°å­¦å…¬å¼ï¼šå¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„å…¬å¼
        content = preprocessMathFormulas(content);
        
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });
        
        return marked.parse(content);
    } catch (error) {
        console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
        return formatMessageContent(content); // é™çº§åˆ°ç®€å•æ ¼å¼åŒ–
    }
}

// é¢„å¤„ç†æ•°å­¦å…¬å¼
function preprocessMathFormulas(content) {
    // 1. å¤„ç†æ¯ä¸ªç‹¬ç«‹çš„LaTeXå—çº§å…¬å¼ \[ ... \]
    let processedContent = content;
    let matches = [];
    let regex = /\\\[\s*\n?\s*([\s\S]*?)\s*\n?\s*\\\]/g;
    let match;
    
    // æ”¶é›†æ‰€æœ‰åŒ¹é…
    while ((match = regex.exec(content)) !== null) {
        matches.push({
            fullMatch: match[0],
            formula: match[1].trim(),
            index: match.index
        });
    }
    
    // ä»åå¾€å‰æ›¿æ¢ï¼Œé¿å…ç´¢å¼•åç§»
    for (let i = matches.length - 1; i >= 0; i--) {
        const m = matches[i];
        const replacement = '\n$$' + m.formula + '$$\n';
        processedContent = processedContent.substring(0, m.index) + replacement + processedContent.substring(m.index + m.fullMatch.length);
    }
    
    // 2. å¤„ç†LaTeXè¡Œå†…å…¬å¼ \( ... \)
    processedContent = processedContent.replace(/\\\(\s*(.*?)\s*\\\)/g, function(match, formula) {
        formula = formula.trim();
        return '$' + formula + '$';
    });
    
    // 3. å¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„æ•°å­¦å…¬å¼ [æ•°å­¦å†…å®¹]
    processedContent = processedContent.replace(/\[\s*([^[\]]*(?:\\[^[\]]*)*[^[\]]*)\s*\]/g, function(match, formula) {
        formula = formula.trim();
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦ç¬¦å·
        const mathIndicators = ['\\frac', '\\partial', '\\hat', '\\text', '\\quad', 
                              '\\alpha', '\\beta', '\\gamma', '\\delta', '\\theta', '\\lambda', 
                              '^{', '_{', '\\sum', '\\int', '\\cdot', '\\times'];
        
        const isMathFormula = mathIndicators.some(indicator => formula.includes(indicator));
        
        if (isMathFormula) {
            return '\n$$' + formula + '$$\n';
        }
        
        return match;
    });
    
    // 4. æ¸…ç†é‡å¤çš„æ ‡è®°
    processedContent = processedContent.replace(/\$\$\s*\$\$/g, '$$');
    processedContent = processedContent.replace(/\$\s*\$/g, '$');
    
    return processedContent;
}

// æ¸²æŸ“æ•°å­¦å…¬å¼
function renderMath(element) {
    if (window.MathJax && window.MathJax.typesetPromise) {
        // æ¸…é™¤ä¹‹å‰çš„MathJaxå¤„ç†
        window.MathJax.typesetClear([element]);
        
        // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
        window.MathJax.typesetPromise([element]).then(function() {
            console.log('MathJaxæ¸²æŸ“å®Œæˆ');
        }).catch(function (err) {
            console.log('MathJaxæ¸²æŸ“é”™è¯¯:', err.message);
        });
    }
}

// æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒä»£ç é«˜äº®å’Œæ•°å­¦å…¬å¼ï¼‰
function formatMessageContent(content) {
    // ç®€å•çš„ä»£ç å—å¤„ç†
    content = content.replace(/```([a-z]*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
    
    // è¡Œå†…ä»£ç 
    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ç²—ä½“å’Œæ–œä½“
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // æ¢è¡Œå¤„ç†
    content = content.replace(/\n/g, '<br>');
    
    return content;
}

// å…¨å±€å˜é‡å­˜å‚¨å½“å‰å¯¹è¯æ•°æ®
let currentConversationData = null;

// æŸ¥çœ‹å¯¹è¯è¯¦æƒ… - ä½¿ç”¨æ–°çš„æ¨¡æ€æ¡†
async function viewConversation(postId) {
    try {
        const response = await fetch(`/api/community/posts/${postId}/conversation`);
        const data = await response.json();
        
        if (!data.success) {
            showToast(data.message || 'åŠ è½½å¯¹è¯å¤±è´¥', 'error');
            return;
        }
        
        // å­˜å‚¨å½“å‰å¯¹è¯æ•°æ®ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        currentConversationData = data;
        
        // å¡«å……æ¨¡æ€æ¡†å†…å®¹
        document.getElementById('conversationSharer').textContent = data.post.user.nickname || data.post.user.username;
        document.getElementById('conversationTime').textContent = formatTime(data.post.created_at);
        document.getElementById('conversationDescription').textContent = data.post.content;
        
        // V0.3.1 æ˜¾ç¤ºå¯¹è¯é…ç½®å‚æ•°ï¼ˆä¼˜åŒ–æ˜¾ç¤ºï¼‰
        const configSection = document.getElementById('conversationConfigSection');
        const configContent = document.getElementById('conversationConfig');
        if (data.conversation.conversation_config) {
            const config = data.conversation.conversation_config;
            
            // æ„å»ºåŸºç¡€é…ç½®ä¿¡æ¯
            const configItems = [
                {
                    icon: 'bi-cpu',
                    label: 'æ¨¡å‹',
                    value: escapeHtml(config.model_display_name || config.model_name)
                },
                {
                    icon: 'bi-thermometer',
                    label: 'æ¸©åº¦',
                    value: escapeHtml(config.temperature_display_name || config.temperature)
                },
                {
                    icon: 'bi-textarea-resize',
                    label: 'è¾“å‡ºé•¿åº¦',
                    value: config.max_tokens.toLocaleString() + ' Token'
                }
            ];
            
            let configHtml = '<div class="config-grid">';
            configItems.forEach(item => {
                configHtml += `
                    <div class="config-item">
                        <div class="config-label">
                            <i class="bi ${item.icon}"></i> ${item.label}
                        </div>
                        <div class="config-value">${item.value}</div>
                    </div>
                `;
            });
            configHtml += '</div>';
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (config.system_prompt && config.system_prompt.trim()) {
                const displayPrompt = config.system_prompt.length > 200 
                    ? config.system_prompt.substring(0, 200) + '...' 
                    : config.system_prompt;
                    
                configHtml += `
                    <div class="config-item config-system-prompt">
                        <div class="config-label">
                            <i class="bi bi-gear"></i> ç³»ç»Ÿæç¤ºè¯
                        </div>
                        <div class="config-value system-prompt-text">
                            ${escapeHtml(displayPrompt)}
                        </div>
                    </div>
                `;
            }
            
            configContent.innerHTML = configHtml;
            configSection.style.display = 'block';
        } else {
            configSection.style.display = 'none';
        }
        
        // æ˜¾ç¤ºAIæç¤ºè¯ï¼ˆå¦‚æœæœ‰ï¼‰
        const promptSection = document.getElementById('conversationPromptSection');
        const promptContent = document.getElementById('conversationPrompt');
        if (data.post.ai_prompt) {
            promptContent.textContent = data.post.ai_prompt;
            promptSection.style.display = 'block';
        } else {
            promptSection.style.display = 'none';
        }
        
        // æ¸²æŸ“å¯¹è¯æ¶ˆæ¯
        const messagesContainer = document.getElementById('conversationMessages');
        messagesContainer.innerHTML = '';
        
        data.conversation.messages.forEach((message, index) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role === 'user' ? 'user-message' : 'assistant-message'}`;
            
            // æ¸²æŸ“æ¶ˆæ¯å†…å®¹
            let renderedContent;
            if (message.role === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨ç®€å•æ ¼å¼åŒ–
                renderedContent = formatMessageContent(message.content);
            } else {
                // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
                renderedContent = renderMarkdown(message.content);
            }
            
            const avatar = message.role === 'user' ? 
                getAvatarText(data.post.user.username) : 'AI';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <div class="${message.role === 'user' ? 'user' : 'ai'}-avatar">${avatar}</div>
                </div>
                <div class="message-content">
                    <div class="message-text mathjax">${renderedContent}</div>
                    <div class="message-time">${formatTime(message.created_at)}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        });
        
        // å¯¹ä»£ç å—æ·»åŠ é«˜äº®ï¼Œä½†ä¸æ·»åŠ å¤åˆ¶æŒ‰é’®
        messagesContainer.querySelectorAll('pre code').forEach((block) => {
            if (window.hljs) {
                hljs.highlightElement(block);
            }
        });
        
        // æ¸²æŸ“æ•°å­¦å…¬å¼
        renderMath(messagesContainer);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('conversationDetailModal').style.display = 'flex';
        
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯è¯¦æƒ…å¤±è´¥:', error);
        showToast('åŠ è½½å¯¹è¯è¯¦æƒ…å¤±è´¥', 'error');
    }
}

// å…³é—­å¯¹è¯æ¨¡æ€æ¡†
function closeConversationModal() {
    document.getElementById('conversationDetailModal').style.display = 'none';
    currentConversationData = null;
}

// å¤åˆ¶åˆ°æˆ‘çš„å¯¹è¯ - æ–°åŠŸèƒ½
async function copyToMyChat() {
    if (!currentConversationData) return;
    
    try {
        const data = currentConversationData;
        
        // æ„å»ºè¦å¤åˆ¶çš„å¯¹è¯æ•°æ®
        const conversationData = {
            title: `åŸºäº"${data.conversation.title || 'åˆ†äº«å¯¹è¯'}"çš„æ–°å¯¹è¯`,
            messages: data.conversation.messages.map(msg => ({
                role: msg.role,
                content: msg.content
            }))
        };
        
        // å°†å¯¹è¯æ•°æ®å­˜å‚¨åˆ°sessionStorageï¼Œä¾›chaté¡µé¢è¯»å–
        sessionStorage.setItem('importedConversation', JSON.stringify(conversationData));
        
        // å…³é—­æ¨¡æ€æ¡†
        closeConversationModal();
        
        // è·³è½¬åˆ°chaté¡µé¢
        window.location.href = '/chat?import=true';
        
    } catch (error) {
        console.error('å¯¼å…¥å¯¹è¯å¤±è´¥:', error);
        showToast('å¯¼å…¥å¯¹è¯å¤±è´¥', 'error');
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.addEventListener('click', function(event) {
    const modal = document.getElementById('conversationDetailModal');
    if (event.target === modal) {
        closeConversationModal();
    }
});

// ESCé”®å…³é—­æ¨¡æ€æ¡†
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeConversationModal();
    }
});
</script>
{% endblock %} 