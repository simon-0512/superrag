{% extends "base.html" %}

{% block title %}SuperRAG ç¤¾åŒº{% endblock %}

{% block extra_css %}
<style>
/* ç¤¾åŒºä¸“ç”¨æ ·å¼ */
.community-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

/* å¯¼èˆªæ æ ·å¼ */
.community-nav {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-tabs {
    display: flex;
    gap: 20px;
}

.nav-tabs .tab {
    background: none;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    color: #666;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nav-tabs .tab.active {
    background: #007bff;
    color: white;
}

.nav-tabs .tab:hover:not(.active) {
    background: #f0f0f0;
    color: #333;
}

.create-post-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
}

.create-post-btn:hover {
    background: #0056b3;
}

/* å†…å®¹åŒºåŸŸå¸ƒå±€ */
.community-content {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
}

.feed-container {
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    overflow: hidden;
}

.sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.sidebar-card h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

/* å¸–å­å¡ç‰‡æ ·å¼ */
.post-card {
    background: white;
    border-bottom: 1px solid #f0f0f0;
    padding: 24px;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.post-card:hover {
    background: #f8f9fa;
}

.post-card:last-child {
    border-bottom: none;
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    margin-right: 12px;
}

.user-info {
    flex: 1;
}

.username {
    font-weight: 600;
    color: #333;
    margin-right: 8px;
}

.timestamp {
    color: #666;
    font-size: 14px;
}

.post-content {
    margin: 16px 0;
    line-height: 1.6;
}

.user-description {
    font-size: 16px;
    color: #333;
    margin-bottom: 12px;
}

.ai-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
    border-left: 4px solid #007bff;
}

.ai-prompt {
    background: #e3f2fd;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 8px 0;
    font-size: 14px;
    color: #1976d2;
    border-left: 3px solid #2196f3;
}

.ai-prompt-label {
    font-weight: 600;
    margin-bottom: 4px;
}

.post-tags {
    margin: 12px 0;
}

.tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-right: 6px;
    margin-bottom: 4px;
}

.post-actions {
    display: flex;
    gap: 24px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    transition: color 0.2s ease;
    font-size: 14px;
}

.action-btn:hover {
    color: #007bff;
}

.action-btn.active {
    color: #007bff;
}

.action-btn.liked {
    color: #e74c3c;
}

.action-btn.bookmarked {
    color: #f39c12;
}

/* åŠ è½½çŠ¶æ€ */
.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #666;
}

.skeleton-card {
    background: white;
    border-bottom: 1px solid #f0f0f0;
    padding: 24px;
    animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-line {
    background: #e9ecef;
    height: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
}

.skeleton-line.short {
    width: 60%;
}

.skeleton-line.medium {
    width: 80%;
}

.skeleton-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    margin-right: 12px;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* åˆ›å»ºå¸–å­æ¨¡æ€æ¡† */
.create-post-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.create-post-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 24px;
}

.create-post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e9ecef;
}

.create-post-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.char-counter {
    text-align: right;
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.char-counter.warning {
    color: #f39c12;
}

.char-counter.error {
    color: #e74c3c;
}

.create-post-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #e9ecef;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-primary {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-primary:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .community-content {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        order: -1;
    }
    
    .nav-tabs {
        gap: 10px;
    }
    
    .nav-tabs .tab {
        padding: 6px 12px;
        font-size: 14px;
    }
    
    .community-nav {
        flex-direction: column;
        gap: 16px;
    }
    
    .post-actions {
        gap: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="community-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="community-nav">
        <div class="nav-tabs">
            <button class="tab active" data-feed="recommended">æ¨è</button>
            <button class="tab" data-feed="following">å…³æ³¨</button>
            <button class="tab" data-feed="trending">çƒ­é—¨</button>
            <button class="tab" data-feed="featured">ç²¾é€‰</button>
        </div>
        <button class="create-post-btn" onclick="openCreatePostModal()">
            <i class="bi bi-plus"></i> åˆ†äº«åˆ›ä½œ
        </button>
    </nav>
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="community-content">
        <!-- å·¦ä¾§æ—¶é—´æµ -->
        <div class="feed-container">
            <div id="posts-container">
                <!-- å¸–å­å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="loading-indicator" id="loading-indicator">
                <i class="bi bi-arrow-clockwise spin"></i> åŠ è½½ä¸­...
            </div>
        </div>
        
        <!-- å³ä¾§ä¿¡æ¯æ  -->
        <div class="sidebar">
            <!-- çƒ­é—¨è¯é¢˜ -->
            <div class="sidebar-card">
                <h3><i class="bi bi-hash"></i> çƒ­é—¨è¯é¢˜</h3>
                <div id="trending-tags">
                    <!-- çƒ­é—¨æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ è½½ -->
                </div>
            </div>
            
            <!-- ç¤¾åŒºç»Ÿè®¡ -->
            <div class="sidebar-card">
                <h3><i class="bi bi-bar-chart"></i> ç¤¾åŒºç»Ÿè®¡</h3>
                <div id="community-stats">
                    <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptåŠ è½½ -->
                </div>
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            <div class="sidebar-card">
                <h3><i class="bi bi-lightning"></i> å¿«æ·æ“ä½œ</h3>
                <div class="quick-actions">
                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="location.href='/chat'">
                        <i class="bi bi-chat-dots me-1"></i> æ–°å»ºå¯¹è¯
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="showMyBookmarks()">
                        <i class="bi bi-bookmark me-1"></i> æˆ‘çš„æ”¶è—
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100" onclick="showMyPosts()">
                        <i class="bi bi-file-text me-1"></i> æˆ‘çš„åˆ†äº«
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºå¸–å­æ¨¡æ€æ¡† -->
<div class="create-post-modal" id="createPostModal">
    <div class="create-post-content">
        <div class="create-post-header">
            <h3>åˆ†äº«ä½ çš„AIåˆ›ä½œ</h3>
            <button class="close-modal" onclick="closeCreatePostModal()">&times;</button>
        </div>
        
        <form id="createPostForm">
            <div class="form-group">
                <label for="postContent">åˆ†äº«å†…å®¹ *</label>
                <textarea class="form-control" id="postContent" rows="3" 
                         placeholder="åˆ†äº«ä½ çš„AIåˆ›ä½œå¿ƒå¾—..." maxlength="140"></textarea>
                <div class="char-counter" id="charCounter">0/140</div>
            </div>
            
            <div class="form-group">
                <label for="aiPrompt">AIæç¤ºè¯ (å¯é€‰)</label>
                <textarea class="form-control" id="aiPrompt" rows="2" 
                         placeholder="åˆ†äº«ä½ ä½¿ç”¨çš„æç¤ºè¯..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="postTags">æ ‡ç­¾ (å¯é€‰)</label>
                <input type="text" class="form-control" id="postTags" 
                       placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šAIåˆ›ä½œ,æç¤ºè¯">
            </div>
            
            <div class="create-post-actions">
                <button type="button" class="btn-secondary" onclick="closeCreatePostModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn-primary" id="submitPostBtn">å‘å¸ƒ</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ç¤¾åŒºåŠŸèƒ½JavaScript
let currentFeed = 'recommended';
let currentPage = 1;
let isLoading = false;
let hasMore = true;

// åˆå§‹åŒ–ç¤¾åŒºé¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    initializeCommunity();
});

function initializeCommunity() {
    loadFeed();
    loadTrendingTags();
    loadCommunityStats();
    setupInfiniteScroll();
    setupCreatePostForm();
}

// åŠ è½½æ—¶é—´æµ
async function loadFeed(reset = false) {
    if (isLoading || (!hasMore && !reset)) return;
    
    isLoading = true;
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'block';
    
    try {
        if (reset) {
            currentPage = 1;
            hasMore = true;
        }
        
        const response = await fetch(`/api/community/feed?type=${currentFeed}&page=${currentPage}&limit=20`);
        const data = await response.json();
        
        if (data.success) {
            const postsContainer = document.getElementById('posts-container');
            
            if (reset) {
                postsContainer.innerHTML = '';
            }
            
            if (data.posts.length === 0) {
                if (reset) {
                    postsContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-chat-square-text" style="font-size: 3rem; color: #ccc;"></i><p class="text-muted mt-2">è¿˜æ²¡æœ‰å†…å®¹ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«è€…å§ï¼</p></div>';
                }
                hasMore = false;
            } else {
                data.posts.forEach(post => {
                    postsContainer.appendChild(createPostCard(post));
                });
                currentPage++;
                hasMore = data.posts.length === 20;
            }
        } else {
            console.error('åŠ è½½æ—¶é—´æµå¤±è´¥:', data.message);
            showToast('åŠ è½½æ—¶é—´æµå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åŠ è½½æ—¶é—´æµå¼‚å¸¸:', error);
        showToast('åŠ è½½æ—¶é—´æµå¼‚å¸¸', 'error');
    } finally {
        isLoading = false;
        loadingIndicator.style.display = hasMore ? 'none' : 'block';
        if (!hasMore) {
            loadingIndicator.innerHTML = '<i class="bi bi-check-circle"></i> å·²åŠ è½½å…¨éƒ¨å†…å®¹';
        }
    }
}

// åˆ›å»ºå¸–å­å¡ç‰‡
function createPostCard(post) {
    const card = document.createElement('div');
    card.className = 'post-card';
    card.dataset.postId = post.id;
    
    // æ ¼å¼åŒ–æ—¶é—´
    const timeStr = formatTime(post.created_at);
    
    // æ¸²æŸ“æ ‡ç­¾
    const tagsHtml = post.tags.map(tag => `<span class="tag">#${tag}</span>`).join('');
    
    // æ¸²æŸ“AIå†…å®¹
    let aiContentHtml = '';
    if (post.ai_prompt) {
        aiContentHtml += `<div class="ai-prompt"><div class="ai-prompt-label">ğŸ¤– AIæç¤ºè¯ï¼š</div>${escapeHtml(post.ai_prompt)}</div>`;
    }
    
    if (post.ai_content_data) {
        aiContentHtml += '<div class="ai-content"><i class="bi bi-robot"></i> AIåˆ›ä½œå†…å®¹ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</div>';
    }
    
    card.innerHTML = `
        <div class="post-header">
            <div class="user-avatar">${getAvatarText(post.user.username)}</div>
            <div class="user-info">
                <span class="username">${escapeHtml(post.user.nickname || post.user.username)}</span>
                <span class="timestamp">${timeStr}</span>
            </div>
        </div>
        
        <div class="post-content">
            <p class="user-description">${escapeHtml(post.content)}</p>
            ${aiContentHtml}
            <div class="post-tags">${tagsHtml}</div>
        </div>
        
        <div class="post-actions">
            <button class="action-btn like-btn ${post.user_interactions?.like ? 'active liked' : ''}" 
                    onclick="toggleLike(${post.id}, this)" data-count="${post.like_count}">
                <i class="bi bi-heart${post.user_interactions?.like ? '-fill' : ''}"></i> 
                <span>${post.like_count}</span>
            </button>
            <button class="action-btn comment-btn" onclick="showComments(${post.id})" data-count="${post.comment_count}">
                <i class="bi bi-chat"></i> <span>${post.comment_count}</span>
            </button>
            <button class="action-btn share-btn" onclick="sharePost(${post.id})" data-count="${post.share_count}">
                <i class="bi bi-share"></i> <span>${post.share_count}</span>
            </button>
            <button class="action-btn bookmark-btn ${post.user_interactions?.bookmark ? 'active bookmarked' : ''}" 
                    onclick="toggleBookmark(${post.id}, this)">
                <i class="bi bi-bookmark${post.user_interactions?.bookmark ? '-fill' : ''}"></i>
            </button>
        </div>
    `;
    
    return card;
}

// åˆ‡æ¢feedç±»å‹
function switchFeed(feedType) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.feed === feedType) {
            tab.classList.add('active');
        }
    });
    
    currentFeed = feedType;
    loadFeed(true);
}

// è®¾ç½®tabäº‹ä»¶ç›‘å¬
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        switchFeed(tab.dataset.feed);
    });
});

// ç‚¹èµ/å–æ¶ˆç‚¹èµ
async function toggleLike(postId, button) {
    try {
        const response = await fetch(`/api/community/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const icon = button.querySelector('i');
            const countSpan = button.querySelector('span');
            
            if (data.action === 'liked') {
                button.classList.add('active', 'liked');
                icon.className = 'bi bi-heart-fill';
            } else {
                button.classList.remove('active', 'liked');
                icon.className = 'bi bi-heart';
            }
            
            countSpan.textContent = data.like_count;
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
        showToast('ç‚¹èµæ“ä½œå¤±è´¥', 'error');
    }
}

// æ”¶è—/å–æ¶ˆæ”¶è—
async function toggleBookmark(postId, button) {
    try {
        const response = await fetch(`/api/community/posts/${postId}/bookmark`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const icon = button.querySelector('i');
            
            if (data.action === 'bookmarked') {
                button.classList.add('active', 'bookmarked');
                icon.className = 'bi bi-bookmark-fill';
                showToast('å·²æ”¶è—', 'success');
            } else {
                button.classList.remove('active', 'bookmarked');
                icon.className = 'bi bi-bookmark';
                showToast('å·²å–æ¶ˆæ”¶è—', 'success');
            }
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
        showToast('æ”¶è—æ“ä½œå¤±è´¥', 'error');
    }
}

// åŠ è½½çƒ­é—¨æ ‡ç­¾
async function loadTrendingTags() {
    try {
        const response = await fetch('/api/community/trending/tags?limit=8');
        const data = await response.json();
        
        const container = document.getElementById('trending-tags');
        
        if (data.success && data.tags.length > 0) {
            container.innerHTML = data.tags.map(tag => 
                `<span class="tag" style="cursor: pointer; margin: 2px;" onclick="searchByTag('${tag.name}')">#${tag.name} (${tag.count})</span>`
            ).join('');
        } else {
            container.innerHTML = '<p class="text-muted small">æš‚æ— çƒ­é—¨è¯é¢˜</p>';
        }
    } catch (error) {
        console.error('åŠ è½½çƒ­é—¨æ ‡ç­¾å¤±è´¥:', error);
    }
}

// åŠ è½½ç¤¾åŒºç»Ÿè®¡
async function loadCommunityStats() {
    try {
        const response = await fetch('/api/community/stats');
        const data = await response.json();
        
        const container = document.getElementById('community-stats');
        
        if (data.success) {
            const stats = data.stats;
            container.innerHTML = `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted small">ä»Šæ—¥å¸–å­</span>
                    <span class="fw-bold">${stats.today_posts}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted small">æ€»å¸–å­æ•°</span>
                    <span class="fw-bold">${stats.total_posts}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted small">æ€»ç”¨æˆ·æ•°</span>
                    <span class="fw-bold">${stats.total_users}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted small">ä»Šæ—¥æ´»è·ƒ</span>
                    <span class="fw-bold">${stats.today_active_users}</span>
                </div>
            `;
        } else {
            container.innerHTML = '<p class="text-muted small">ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥</p>';
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// æ— é™æ»šåŠ¨
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
            loadFeed();
        }
    });
}

// åˆ›å»ºå¸–å­æ¨¡æ€æ¡†
function openCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'block';
    document.getElementById('postContent').focus();
}

function closeCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'none';
    document.getElementById('createPostForm').reset();
    updateCharCounter();
}

// è®¾ç½®åˆ›å»ºå¸–å­è¡¨å•
function setupCreatePostForm() {
    const contentTextarea = document.getElementById('postContent');
    const charCounter = document.getElementById('charCounter');
    const form = document.getElementById('createPostForm');
    
    // å­—ç¬¦è®¡æ•°
    contentTextarea.addEventListener('input', updateCharCounter);
    
    function updateCharCounter() {
        const length = contentTextarea.value.length;
        charCounter.textContent = `${length}/140`;
        
        charCounter.className = 'char-counter';
        if (length > 120) {
            charCounter.classList.add('warning');
        }
        if (length > 140) {
            charCounter.classList.add('error');
        }
    }
    
    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = contentTextarea.value.trim();
        if (!content) {
            showToast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        if (content.length > 140) {
            showToast('å†…å®¹ä¸èƒ½è¶…è¿‡140å­—', 'error');
            return;
        }
        
        const submitBtn = document.getElementById('submitPostBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'å‘å¸ƒä¸­...';
        
        try {
            const postData = {
                content: content,
                ai_prompt: document.getElementById('aiPrompt').value.trim() || null,
                tags: document.getElementById('postTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };
            
            const response = await fetch('/api/community/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('å‘å¸ƒæˆåŠŸï¼', 'success');
                closeCreatePostModal();
                loadFeed(true); // é‡æ–°åŠ è½½æ—¶é—´æµ
                loadCommunityStats(); // æ›´æ–°ç»Ÿè®¡æ•°æ®
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            console.error('å‘å¸ƒå¤±è´¥:', error);
            showToast('å‘å¸ƒå¤±è´¥', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'å‘å¸ƒ';
        }
    });
}

// å·¥å…·å‡½æ•°
function formatTime(timeStr) {
    const date = new Date(timeStr);
    const now = new Date();
    const diff = now - date;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'åˆšåˆš';
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    
    return date.toLocaleDateString();
}

function getAvatarText(username) {
    return username ? username.charAt(0).toUpperCase() : 'U';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    // ç®€å•çš„toastæç¤ºï¼Œå¯ä»¥åç»­æ”¹ä¸ºæ›´å¥½çš„UIç»„ä»¶
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// å ä½å‡½æ•°ï¼Œå¾…å®ç°
function showComments(postId) {
    showToast('è¯„è®ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function sharePost(postId) {
    showToast('è½¬å‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function searchByTag(tag) {
    showToast(`æœç´¢æ ‡ç­¾ #${tag} åŠŸèƒ½å¼€å‘ä¸­...`, 'info');
}

function showMyBookmarks() {
    showToast('æˆ‘çš„æ”¶è—åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showMyPosts() {
    showToast('æˆ‘çš„åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}
</script>
{% endblock %} 