{% extends "base.html" %}

{% block title %}åˆ›å»ºæ€ç»´å¯¼å›¾{% endblock %}

{% block content %}
<div class="mindmap-container">
    <!-- æ€ç»´å¯¼å›¾ä¾§è¾¹æ è§¦å‘å™¨ -->
    <div class="sidebar-trigger-mindmap" id="sidebarTriggerMindmap" title="æ˜¾ç¤ºæ€ç»´å¯¼å›¾åˆ—è¡¨">
        <i class="fas fa-project-diagram"></i>
    </div>
    
    <!-- å·¦ä¾§è¾¹æ  - æ€ç»´å¯¼å›¾åˆ—è¡¨ -->
    <div class="mindmap-sidebar" id="mindmapSidebar">
        <div class="sidebar-header">
            <h6 class="mb-0">æˆ‘çš„æ€ç»´å¯¼å›¾</h6>
            <button class="btn btn-sm btn-outline-secondary" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-search">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="form-control search-input" placeholder="æœç´¢æ€ç»´å¯¼å›¾..." id="mindmapSearch">
            </div>
        </div>
        
        <div class="sidebar-content">
            <div class="mindmap-list" id="mindmapList">
                <!-- æ€ç»´å¯¼å›¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                <div class="loading-mindmaps text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <small class="text-muted d-block mt-2">åŠ è½½ä¸­...</small>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="btn btn-primary btn-sm w-100" onclick="window.location.href='/mindmap'">
                <i class="fas fa-plus me-2"></i>è¿”å›é¦–é¡µ
            </button>
        </div>
    </div>
    
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <input type="text" id="mindmap-title" class="title-input" 
                   placeholder="æ€ç»´å¯¼å›¾æ ‡é¢˜" value="æ–°å»ºæ€ç»´å¯¼å›¾">
        </div>
        <div class="toolbar-right">
            <button class="btn btn-outline-secondary btn-sm" onclick="showHelp()">
                <i class="fas fa-question-circle"></i> å¸®åŠ©
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="undoAction()" title="æ’¤é”€ (Ctrl+Z)">
                <i class="fas fa-undo"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="redoAction()" title="é‡åš (Ctrl+Y)">
                <i class="fas fa-redo"></i>
            </button>
            <button class="btn btn-primary btn-sm" onclick="addRootNode()">
                <i class="fas fa-plus"></i> æ·»åŠ æ ¹èŠ‚ç‚¹
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="saveMindmap()">
                <i class="fas fa-save"></i> ä¿å­˜
            </button>
            <div class="dropdown d-inline-block">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-download"></i> å¯¼å‡º
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportMindmap('json')">
                        <i class="fas fa-file-code me-2"></i>å¯¼å‡ºJSON
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportMindmap('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>å¯¼å‡ºPDF
                    </a></li>
                </ul>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="importMindmap()">
                <i class="fas fa-upload"></i> å¯¼å…¥
            </button>
        </div>
    </div>
    
    <!-- ä¸»ç”»å¸ƒåŒºåŸŸ -->
    <div class="canvas-wrapper">
        <div id="mindmap-canvas">
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="canvas-hint" id="canvas-hint">
                <div class="hint-content">
                    <i class="fas fa-lightbulb"></i>
                    <h4>å¿«æ·æ“ä½œæŒ‡å—</h4>
                    <div class="shortcuts">
                        <div class="shortcut-item">
                            <kbd>åŒå‡»</kbd> æˆ– <kbd>Enter</kbd> - ç¼–è¾‘èŠ‚ç‚¹æ–‡å­—
                        </div>
                        <div class="shortcut-item">
                            <kbd>Tab</kbd> æˆ–ç‚¹å‡» <i class="fas fa-plus"></i> - æ·»åŠ å­èŠ‚ç‚¹
                        </div>
                        <div class="shortcut-item">
                            <kbd>I</kbd> æˆ–ç‚¹å‡» <i class="fas fa-sticky-note"></i> - æ·»åŠ è¯´æ˜
                        </div>
                        <div class="shortcut-item">
                            <kbd>Delete</kbd> - åˆ é™¤é€‰ä¸­èŠ‚ç‚¹
                        </div>
                        <div class="shortcut-item">
                            <kbd>Ctrl+Z</kbd> / <kbd>Ctrl+Y</kbd> - æ’¤é”€/é‡åš
                        </div>
                        <div class="shortcut-item">
                            æ‹–æ‹½èŠ‚ç‚¹ - è‡ªç”±ç§»åŠ¨ä½ç½®
                        </div>
                        <div class="shortcut-item">
                            ç‚¹å‡» <i class="fas fa-link"></i> - è¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ç”¨äºå¯¼å…¥ -->
<input type="file" id="import-file" accept=".json" style="display: none;">

<!-- èŠ‚ç‚¹æ ·å¼ç¼–è¾‘é¢æ¿ -->
<div class="style-panel" id="style-panel">
    <div class="panel-header">
        <span>èŠ‚ç‚¹æ ·å¼</span>
        <button class="close-btn" onclick="closeStylePanel()">Ã—</button>
    </div>
    <div class="panel-content">
        <div class="style-section">
            <label>é…è‰²æ¨¡æ¿</label>
            <div class="template-themes">
                <div class="template-option" data-template="github" title="GitHub Dark">
                    <div class="template-preview">
                        <div class="template-node" style="background: #24292e; color: white;"></div>
                        <div class="template-node" style="background: #0969da; color: white;"></div>
                        <div class="template-node" style="background: #1f883d; color: white;"></div>
                        <div class="template-node" style="background: #cf222e; color: white;"></div>
                    </div>
                    <span>GitHub</span>
                </div>
                <div class="template-option" data-template="vscode" title="VS Code">
                    <div class="template-preview">
                        <div class="template-node" style="background: #1e1e1e; color: white;"></div>
                        <div class="template-node" style="background: #0e639c; color: white;"></div>
                        <div class="template-node" style="background: #16825d; color: white;"></div>
                        <div class="template-node" style="background: #d16969; color: white;"></div>
                    </div>
                    <span>VS Code</span>
                </div>
                <div class="template-option" data-template="dracula" title="Dracula">
                    <div class="template-preview">
                        <div class="template-node" style="background: #282a36; color: white;"></div>
                        <div class="template-node" style="background: #8be9fd; color: #282a36;"></div>
                        <div class="template-node" style="background: #50fa7b; color: #282a36;"></div>
                        <div class="template-node" style="background: #ff79c6; color: #282a36;"></div>
                    </div>
                    <span>Dracula</span>
                </div>
                <div class="template-option" data-template="material" title="Material">
                    <div class="template-preview">
                        <div class="template-node" style="background: #263238; color: white;"></div>
                        <div class="template-node" style="background: #29b6f6; color: white;"></div>
                        <div class="template-node" style="background: #66bb6a; color: white;"></div>
                        <div class="template-node" style="background: #ef5350; color: white;"></div>
                    </div>
                    <span>Material</span>
                </div>
                <div class="template-option" data-template="minimal" title="ç®€çº¦">
                    <div class="template-preview">
                        <div class="template-node" style="background: #f8f9fa; color: #495057; border: 1px solid #dee2e6;"></div>
                        <div class="template-node" style="background: #e9ecef; color: #495057; border: 1px solid #ced4da;"></div>
                        <div class="template-node" style="background: #dee2e6; color: #495057; border: 1px solid #ced4da;"></div>
                        <div class="template-node" style="background: #ced4da; color: #495057; border: 1px solid #adb5bd;"></div>
                    </div>
                    <span>ç®€çº¦</span>
                </div>
            </div>
        </div>
        <div class="style-section">
            <label>å•ç‹¬é¢œè‰²</label>
            <div class="color-themes">
                <div class="theme-option" data-theme="github" style="background: #24292e; color: white;" title="GitHubä¸»é¢˜"></div>
                <div class="theme-option" data-theme="vscode" style="background: #007acc; color: white;" title="VS Codeä¸»é¢˜"></div>
                <div class="theme-option" data-theme="atom" style="background: #3C4043; color: white;" title="Atomä¸»é¢˜"></div>
                <div class="theme-option" data-theme="sublime" style="background: #393B40; color: white;" title="Sublimeä¸»é¢˜"></div>
                <div class="theme-option" data-theme="intellij" style="background: #2B2B2B; color: white;" title="IntelliJä¸»é¢˜"></div>
                <div class="theme-option" data-theme="jetbrains" style="background: #1E1E1E; color: white;" title="JetBrainsä¸»é¢˜"></div>
                <div class="theme-option" data-theme="dracula" style="background: #44475A; color: white;" title="Draculaä¸»é¢˜"></div>
                <div class="theme-option" data-theme="material" style="background: #263238; color: white;" title="Materialä¸»é¢˜"></div>
                <div class="theme-option" data-theme="minimal" style="background: #f8f9fa; color: #495057; border: 1px solid #dee2e6;" title="ç®€çº¦ä¸»é¢˜"></div>
                <div class="theme-option" data-theme="primary" style="background: #0d6efd; color: white;" title="ä¸»è‰²è°ƒ"></div>
                <div class="theme-option" data-theme="success" style="background: #198754; color: white;" title="æˆåŠŸè‰²"></div>
                <div class="theme-option" data-theme="warning" style="background: #fd7e14; color: white;" title="è­¦å‘Šè‰²"></div>
            </div>
        </div>
        <div class="style-section">
            <label>èŠ‚ç‚¹å½¢çŠ¶</label>
            <div class="shape-options">
                <button class="shape-btn" data-shape="rounded" title="åœ†è§’çŸ©å½¢">
                    <div class="shape-preview rounded-preview"></div>
                </button>
                <button class="shape-btn" data-shape="rect" title="çŸ©å½¢">
                    <div class="shape-preview rect-preview"></div>
                </button>
                <button class="shape-btn" data-shape="circle" title="åœ†å½¢">
                    <div class="shape-preview circle-preview"></div>
                </button>
                <button class="shape-btn" data-shape="diamond" title="è±å½¢">
                    <div class="shape-preview diamond-preview"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è¿æ¥çº¿æ¨¡å¼æç¤º -->
<div class="connection-hint" id="connection-hint">
    <i class="fas fa-link"></i>
    è¿æ¥æ¨¡å¼ï¼šç‚¹å‡»ä¸¤ä¸ªèŠ‚ç‚¹åˆ›å»ºè¿æ¥
    <button onclick="exitConnectionMode()">é€€å‡º</button>
</div>

<!-- Toast æç¤º -->
<div class="toast" id="toast">
    <div class="toast-content">
        <i class="fas fa-check-circle"></i>
        <span class="toast-message"></span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* å…¨å±€å¸ƒå±€ */
.mindmap-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    position: relative;
}

/* æ€ç»´å¯¼å›¾ä¾§è¾¹æ è§¦å‘å™¨ */
.sidebar-trigger-mindmap {
    position: fixed;
    top: 80px;
    left: 20px;
    width: 40px;
    height: 40px;
    background: #ffffff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.sidebar-trigger-mindmap:hover {
    background: #f8f9fa;
    border-color: #0969da;
    color: #0969da;
}

.sidebar-trigger-mindmap.hidden {
    display: none;
}

/* æ€ç»´å¯¼å›¾ä¾§è¾¹æ  */
.mindmap-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 300px;
    height: 100vh;
    background: #ffffff;
    border-right: 1px solid #e5e5e5;
    display: flex;
    flex-direction: column;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
}

.mindmap-sidebar.show {
    transform: translateX(0);
}

.mindmap-sidebar .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.mindmap-sidebar .sidebar-search {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e5e5;
}

.mindmap-sidebar .search-input-wrapper {
    position: relative;
}

.mindmap-sidebar .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 14px;
}

.mindmap-sidebar .search-input {
    padding-left: 36px;
    font-size: 14px;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
}

.mindmap-sidebar .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
}

.mindmap-sidebar .sidebar-footer {
    padding: 16px;
    border-top: 1px solid #e5e5e5;
    background: #f8f9fa;
}

/* æ€ç»´å¯¼å›¾åˆ—è¡¨é¡¹ */
.mindmap-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.mindmap-item:hover {
    background: #f8f9fa;
}

.mindmap-item:last-child {
    border-bottom: none;
}

.mindmap-item-title {
    font-weight: 500;
    color: #24292f;
    margin-bottom: 4px;
    font-size: 14px;
}

.mindmap-item-meta {
    font-size: 12px;
    color: #656d76;
    margin-bottom: 8px;
}

.mindmap-item-actions {
    display: flex;
    gap: 4px;
}

.mindmap-item-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    border: 1px solid;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
}

.mindmap-item-actions .btn-outline-primary {
    border-color: #0969da;
    color: #0969da;
}

.mindmap-item-actions .btn-outline-primary:hover {
    background: #0969da;
    color: white;
}

.mindmap-item-actions .btn-outline-info {
    border-color: #0dcaf0;
    color: #0dcaf0;
}

.mindmap-item-actions .btn-outline-info:hover {
    background: #0dcaf0;
    color: white;
}

.mindmap-item-actions .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
}

.mindmap-item-actions .btn-outline-danger:hover {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

/* ä¸»ç”»å¸ƒåŒºåŸŸè°ƒæ•´ */
.mindmap-container.sidebar-open .canvas-wrapper {
    margin-left: 300px;
    transition: margin-left 0.3s ease;
}

.mindmap-container.sidebar-open .sidebar-trigger-mindmap {
    display: none;
}

/* å·¥å…·æ  */
.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1000;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.title-input {
    border: 1px solid #d1d9e0;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: 500;
    width: 300px;
    background: white;
}

.title-input:focus {
    outline: none;
    border-color: #0969da;
    box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2);
}

/* ç”»å¸ƒå®¹å™¨ */
.canvas-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
}

#mindmap-canvas {
    width: 100%;
    height: 100%;
    background: #fdfdfd;
    background-image: 
        radial-gradient(circle, #e8e8e8 1px, transparent 1px);
    background-size: 30px 30px;
    position: relative;
    cursor: grab;
    overflow: hidden;
}

#mindmap-canvas:active {
    cursor: grabbing;
}

/* æç¤ºä¿¡æ¯ */
.canvas-hint {
    position: absolute;
    top: 20px;
    left: 20px;
    text-align: left;
    color: #6c757d;
    font-size: 14px;
    pointer-events: none;
    z-index: 1;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    max-width: 300px;
}

.hint-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.hint-content i {
    font-size: 32px;
    color: #ffc107;
    margin-bottom: 8px;
}

.hint-content h4 {
    margin: 0;
    color: #495057;
    font-weight: 600;
}

.shortcuts {
    display: flex;
    flex-direction: column;
    gap: 8px;
    text-align: left;
}

.shortcut-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #6c757d;
}

.shortcut-item kbd {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 11px;
    font-family: inherit;
    color: #495057;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.shortcut-item i {
    font-size: 12px;
    color: #28a745;
}

/* èŠ‚ç‚¹æ ·å¼ */
.mindmap-node {
    position: absolute;
    background: #24292e;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    min-width: 80px;
    text-align: center;
    user-select: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 10;
    word-wrap: break-word;
    max-width: 200px;
    line-height: 1.4;
}

.mindmap-node:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.mindmap-node.selected {
    box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.5);
}

.mindmap-node.connection-source {
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.5);
    transform: scale(1.05);
}

.mindmap-node.connection-target {
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
    cursor: crosshair;
}

.mindmap-node.connection-target:hover {
    box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.8);
    transform: scale(1.1);
}

.mindmap-node.editing {
    background: white;
    color: #24292f;
    border: 2px solid #0969da;
}

.mindmap-node.note-node {
    background: #fff9c4;
    color: #856404;
    border: 1px solid #ffd60a;
    font-style: italic;
    border-radius: 4px;
    font-size: 12px;
    padding: 8px 12px;
    position: relative;
    max-width: 150px;
}

.mindmap-node.note-node::before {
    content: "ğŸ’¡";
    position: absolute;
    top: -8px;
    left: -8px;
    background: #ffd60a;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-style: normal;
}

.mindmap-node.root-node {
    background: #24292e;
    font-size: 16px;
    font-weight: 600;
    padding: 16px 28px;
    border-radius: 10px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

/* èŠ‚ç‚¹æŒ‰é’® */
.node-buttons {
    position: absolute;
    top: -12px;
    right: -12px;
    display: none;
    flex-direction: row;
    gap: 4px;
}

.node-btn {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.add-btn {
    background: #28a745;
    color: white;
}

.note-btn {
    background: #ffc107;
    color: white;
}

.style-btn {
    background: #6f42c1;
    color: white;
}

.connect-btn {
    background: #17a2b8;
    color: white;
}

.node-btn:hover {
    transform: scale(1.1);
}

.mindmap-node:hover .node-buttons {
    display: flex;
}

/* è¿æ¥çº¿ */
.connection-line {
    position: absolute;
    background: #6c757d;
    height: 2px;
    transform-origin: 0 50%;
    pointer-events: none;
    z-index: 5;
    transition: all 0.2s ease;
}

.connection-line.highlight {
    background: #0969da;
    height: 3px;
    box-shadow: 0 0 6px rgba(9, 105, 218, 0.5);
}

.connection-line.note-connection {
    background: #ffd60a;
    height: 1px;
    opacity: 0.8;
    border-style: dashed;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.btn-primary {
    background: #0969da;
    color: white;
}

.btn-primary:hover {
    background: #0860ca;
}

.btn-outline-secondary {
    background: white;
    color: #6c757d;
    border: 1px solid #d1d9e0;
}

.btn-outline-secondary:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

/* æ ·å¼é¢æ¿ */
.style-panel {
    position: fixed;
    top: 20%;
    right: 20px;
    width: 280px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    transform: translateY(-20px);
    opacity: 0;
    transition: all 0.3s ease;
}

.style-panel.show {
    display: block;
    transform: translateY(0);
    opacity: 1;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.close-btn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #6c757d;
}

.close-btn:hover {
    color: #dc3545;
}

.panel-content {
    padding: 16px;
}

.style-section {
    margin-bottom: 20px;
}

.style-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 12px;
    color: #6c757d;
    text-transform: uppercase;
}

/* é…è‰²æ¨¡æ¿ */
.template-themes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
}

.template-option {
    cursor: pointer;
    padding: 8px;
    border: 2px solid transparent;
    border-radius: 6px;
    text-align: center;
    transition: all 0.2s ease;
    background: #f8f9fa;
}

.template-option:hover {
    border-color: #0969da;
    background: #f1f8ff;
}

.template-option.active {
    border-color: #0969da;
    background: #e6f3ff;
}

.template-preview {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2px;
    margin-bottom: 4px;
    height: 20px;
}

.template-node {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    display: inline-block;
}

.template-option span {
    font-size: 10px;
    font-weight: 500;
    color: #666;
}

.color-themes {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 8px;
}

.theme-option {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.theme-option:hover {
    border-color: #0969da;
    transform: scale(1.1);
}

.theme-option.active {
    border-color: #0969da;
    box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.2);
}

.shape-options {
    display: flex;
    gap: 8px;
}

.shape-btn {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.shape-btn:hover {
    border-color: #0969da;
    background: #e3f2fd;
}

.shape-btn.active {
    border-color: #0969da;
    background: #e3f2fd;
}

.shape-preview {
    width: 20px;
    height: 12px;
    background: #6c757d;
}

.rounded-preview {
    border-radius: 6px;
}

.rect-preview {
    border-radius: 0;
}

.circle-preview {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.diamond-preview {
    width: 12px;
    height: 12px;
    transform: rotate(45deg);
}

/* è¿æ¥æ¨¡å¼æç¤º */
.connection-hint {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #0969da;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 1001;
    display: none;
}

.connection-hint button {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: 12px;
    cursor: pointer;
}

.connection-hint button:hover {
    background: rgba(255,255,255,0.3);
}

/* Toast æç¤º */
.toast {
    position: fixed;
    top: 80px; /* é¿å…è¢«å·¥å…·æ é®æŒ¡ */
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 9999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    transform: translateX(100%);
    transition: transform 0.3s ease;
    font-size: 14px;
    font-weight: 500;
}

.toast.show {
    transform: translateX(0);
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .toolbar {
        flex-direction: column;
        gap: 8px;
        padding: 8px;
    }
    
    .title-input {
        width: 100%;
        max-width: 250px;
    }
    
    .toolbar-right {
        width: 100%;
        justify-content: center;
    }
    
    .style-panel {
        width: 90%;
        right: 5%;
        top: 10%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let currentMindmapId = null;
let selectedNode = null;
let isConnectionMode = false;
let connectionStart = null;
let nodeCounter = 0;
let connections = [];
let nodes = [];

// æ’¤é”€/é‡åšåŠŸèƒ½
let undoStack = [];
let redoStack = [];
const MAX_UNDO_STACK = 50;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeMindmap();
    bindEventListeners();
    initializeSidebar();
});

// åˆå§‹åŒ–ä¾§è¾¹æ 
function initializeSidebar() {
    const trigger = document.getElementById('sidebarTriggerMindmap');
    const sidebar = document.getElementById('mindmapSidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    const container = document.querySelector('.mindmap-container');
    
    // ç»‘å®šäº‹ä»¶
    trigger.addEventListener('click', showSidebar);
    closeSidebar.addEventListener('click', hideSidebar);
    
    // åŠ è½½æ€ç»´å¯¼å›¾åˆ—è¡¨
    loadMindmapList();
    
    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('mindmapSearch');
    searchInput.addEventListener('input', filterMindmaps);
}

// æ˜¾ç¤ºä¾§è¾¹æ 
function showSidebar() {
    const sidebar = document.getElementById('mindmapSidebar');
    const trigger = document.getElementById('sidebarTriggerMindmap');
    const container = document.querySelector('.mindmap-container');
    
    sidebar.classList.add('show');
    trigger.classList.add('hidden');
    container.classList.add('sidebar-open');
}

// éšè—ä¾§è¾¹æ 
function hideSidebar() {
    const sidebar = document.getElementById('mindmapSidebar');
    const trigger = document.getElementById('sidebarTriggerMindmap');
    const container = document.querySelector('.mindmap-container');
    
    sidebar.classList.remove('show');
    trigger.classList.remove('hidden');
    container.classList.remove('sidebar-open');
}

// åŠ è½½æ€ç»´å¯¼å›¾åˆ—è¡¨
function loadMindmapList() {
    fetch('/mindmap/api/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderMindmapList(data.data.mindmaps || []);
            } else {
                console.error('åŠ è½½æ€ç»´å¯¼å›¾åˆ—è¡¨å¤±è´¥:', data.error);
                renderMindmapList([]);
            }
        })
        .catch(error => {
            console.error('åŠ è½½æ€ç»´å¯¼å›¾åˆ—è¡¨é”™è¯¯:', error);
            renderMindmapList([]);
        });
}

// æ¸²æŸ“æ€ç»´å¯¼å›¾åˆ—è¡¨ - æ›´æ–°æŒ‰é’®æ ·å¼
function renderMindmapList(mindmaps) {
    const listContainer = document.getElementById('mindmapList');
    
    if (!mindmaps || mindmaps.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-project-diagram fa-2x text-muted mb-2"></i>
                <p class="text-muted small">è¿˜æ²¡æœ‰æ€ç»´å¯¼å›¾</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    mindmaps.forEach(mindmap => {
        html += `
            <div class="mindmap-item" data-id="${mindmap.id}" data-title="${mindmap.title}">
                <div class="mindmap-item-title">${mindmap.title}</div>
                <div class="mindmap-item-meta">
                    æ›´æ–°äº ${new Date(mindmap.updated_at).toLocaleDateString()}
                </div>
                <div class="mindmap-item-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editMindmap('${mindmap.id}')" title="ç¼–è¾‘">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="shareMindmap('${mindmap.id}')" title="åˆ†äº«">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMindmap('${mindmap.id}')" title="åˆ é™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    listContainer.innerHTML = html;
}

// è¿‡æ»¤æ€ç»´å¯¼å›¾
function filterMindmaps() {
    const searchTerm = document.getElementById('mindmapSearch').value.toLowerCase();
    const items = document.querySelectorAll('.mindmap-item');
    
    items.forEach(item => {
        const title = item.dataset.title.toLowerCase();
        if (title.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// ç¼–è¾‘æ€ç»´å¯¼å›¾
function editMindmap(id) {
    window.location.href = `/mindmap/${id}`;
}

// åˆ†äº«æ€ç»´å¯¼å›¾åˆ°ç¤¾åŒº
function shareMindmap(id) {
    if (confirm('ç¡®å®šè¦åˆ†äº«è¿™ä¸ªæ€ç»´å¯¼å›¾åˆ°ç¤¾åŒºå—ï¼Ÿ')) {
        fetch(`/mindmap/api/share/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('æ€ç»´å¯¼å›¾å·²åˆ†äº«åˆ°ç¤¾åŒº');
            } else {
                alert('åˆ†äº«å¤±è´¥ï¼š' + data.error);
            }
        })
        .catch(error => {
            console.error('åˆ†äº«é”™è¯¯:', error);
            alert('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
}

// åˆ é™¤æ€ç»´å¯¼å›¾
function deleteMindmap(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ€ç»´å¯¼å›¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        fetch(`/mindmap/api/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('æ€ç»´å¯¼å›¾å·²åˆ é™¤');
                loadMindmapList(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
            }
        })
        .catch(error => {
            console.error('åˆ é™¤é”™è¯¯:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
}

// åˆå§‹åŒ–æ€ç»´å¯¼å›¾
function initializeMindmap() {
    const canvas = document.getElementById('mindmap-canvas');
    
    // åˆ›å»ºæ ¹èŠ‚ç‚¹
    createRootNode();
    
    // éšè—æç¤º
    setTimeout(() => {
        const hint = document.getElementById('canvas-hint');
        if (hint) {
            hint.style.opacity = '0';
            hint.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                hint.style.display = 'none';
            }, 500);
        }
    }, 5000);
}

// åˆ›å»ºæ ¹èŠ‚ç‚¹
function createRootNode() {
    const canvas = document.getElementById('mindmap-canvas');
    const rootNode = createNode('ä¸­å¿ƒä¸»é¢˜', 'root-node');
    
    // ç­‰å¾…DOMæ¸²æŸ“åå†è®¾ç½®ä½ç½®
    setTimeout(() => {
        const canvasRect = canvas.getBoundingClientRect();
        const nodeRect = rootNode.getBoundingClientRect();
        
        rootNode.style.left = (canvasRect.width / 2 - nodeRect.width / 2) + 'px';
        rootNode.style.top = (canvasRect.height / 2 - nodeRect.height / 2) + 'px';
        
        // ä¿å­˜åˆå§‹çŠ¶æ€
        saveState();
    }, 50);
    
    canvas.appendChild(rootNode);
    selectNode(rootNode);
}

// åˆ›å»ºèŠ‚ç‚¹
function createNode(text, className = '') {
    const node = document.createElement('div');
    node.className = `mindmap-node ${className}`;
    node.textContent = text;
    node.id = `node-${nodeCounter++}`;
    
    // æ·»åŠ èŠ‚ç‚¹æŒ‰é’®
    const buttonGroup = createNodeButtons(node);
    node.appendChild(buttonGroup);
    
    // ç»‘å®šäº‹ä»¶
    node.addEventListener('click', () => selectNode(node));
    node.addEventListener('dblclick', () => editNode(node));
    
    // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
    enableNodeDragging(node);
    
    // è®°å½•èŠ‚ç‚¹
    nodes.push(node);
    
    return node;
}

// åˆ›å»ºèŠ‚ç‚¹æŒ‰é’®ç»„
function createNodeButtons(node) {
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'node-buttons';
    
    // æ·»åŠ å­èŠ‚ç‚¹æŒ‰é’®
    const addBtn = document.createElement('button');
    addBtn.className = 'node-btn add-btn';
    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
    addBtn.title = 'æ·»åŠ å­èŠ‚ç‚¹ (Tab)';
    addBtn.onclick = (e) => {
        e.stopPropagation();
        addChildNode(node);
    };
    
    // æ·»åŠ è¯´æ˜æŒ‰é’®
    const noteBtn = document.createElement('button');
    noteBtn.className = 'node-btn note-btn';
    noteBtn.innerHTML = '<i class="fas fa-sticky-note"></i>';
    noteBtn.title = 'æ·»åŠ è¯´æ˜ (I)';
    noteBtn.onclick = (e) => {
        e.stopPropagation();
        addNoteNode(node);
    };
    
    // æ ·å¼æŒ‰é’®
    const styleBtn = document.createElement('button');
    styleBtn.className = 'node-btn style-btn';
    styleBtn.innerHTML = '<i class="fas fa-palette"></i>';
    styleBtn.title = 'ç¼–è¾‘æ ·å¼';
    styleBtn.onclick = (e) => {
        e.stopPropagation();
        showStylePanel(node);
    };
    
    // æ·»åŠ è¿æ¥æŒ‰é’®
    const connectBtn = document.createElement('button');
    connectBtn.className = 'node-btn connect-btn';
    connectBtn.innerHTML = '<i class="fas fa-link"></i>';
    connectBtn.title = 'è¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹';
    connectBtn.onclick = (e) => {
        e.stopPropagation();
        startConnection(node);
    };
    
    buttonGroup.appendChild(addBtn);
    buttonGroup.appendChild(noteBtn);
    buttonGroup.appendChild(connectBtn);
    buttonGroup.appendChild(styleBtn);
    
    return buttonGroup;
}

// æ·»åŠ å­èŠ‚ç‚¹
function addChildNode(parentNode) {
    const canvas = document.getElementById('mindmap-canvas');
    const childNode = createNode('æ–°èŠ‚ç‚¹');
    
    // è®¡ç®—å­èŠ‚ç‚¹ä½ç½® - å¢åŠ è·ç¦»å¹¶æ”¹è¿›åˆ†å¸ƒç®—æ³•
    const parentRect = parentNode.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    
    const childCount = getChildCount(parentNode);
    const baseDistance = 180; // å¢åŠ åŸºç¡€è·ç¦»
    const distance = baseDistance + (childCount * 20); // åŠ¨æ€è°ƒæ•´è·ç¦»
    
    // æ”¹è¿›è§’åº¦åˆ†å¸ƒç®—æ³•ï¼Œé¿å…é‡å 
    let angle;
    if (childCount === 0) {
        angle = 0; // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹åœ¨å³ä¾§
    } else if (childCount === 1) {
        angle = Math.PI; // ç¬¬äºŒä¸ªå­èŠ‚ç‚¹åœ¨å·¦ä¾§
    } else {
        // å…¶ä»–å­èŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒåœ¨åœ†å‘¨ä¸Š
        const totalAngle = Math.PI * 2;
        const angleStep = totalAngle / Math.max(6, childCount + 2); // è‡³å°‘6ä¸ªä½ç½®
        angle = angleStep * (childCount - 1);
    }
    
    // è®¡ç®—ä½ç½®ï¼Œè€ƒè™‘èŠ‚ç‚¹å¤§å°é¿å…é‡å 
    const nodeWidth = 120; // é¢„ä¼°èŠ‚ç‚¹å®½åº¦
    const nodeHeight = 40; // é¢„ä¼°èŠ‚ç‚¹é«˜åº¦
    const actualDistance = Math.max(distance, nodeWidth + nodeHeight);
    
    const x = (parentRect.left - canvasRect.left) + Math.cos(angle) * actualDistance;
    const y = (parentRect.top - canvasRect.top) + Math.sin(angle) * actualDistance;
    
    // ç¡®ä¿èŠ‚ç‚¹ä¸ä¼šè¶…å‡ºç”»å¸ƒè¾¹ç•Œ
    const minX = 20;
    const minY = 20;
    const maxX = canvas.offsetWidth - nodeWidth - 20;
    const maxY = canvas.offsetHeight - nodeHeight - 20;
    
    const finalX = Math.max(minX, Math.min(maxX, x));
    const finalY = Math.max(minY, Math.min(maxY, y));
    
    childNode.style.left = finalX + 'px';
    childNode.style.top = finalY + 'px';
    
    canvas.appendChild(childNode);
    
    // åˆ›å»ºè¿æ¥çº¿
    createConnection(parentNode, childNode);
    
    // é€‰ä¸­æ–°èŠ‚ç‚¹å¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼
    selectNode(childNode);
    setTimeout(() => {
        editNode(childNode);
        // ä¿å­˜çŠ¶æ€
        saveState();
    }, 100);
}

// æ·»åŠ è¯´æ˜èŠ‚ç‚¹
function addNoteNode(parentNode) {
    const canvas = document.getElementById('mindmap-canvas');
    const noteNode = createNode('è¯´æ˜å†…å®¹', 'note-node');
    
    // ç§»é™¤è¯´æ˜èŠ‚ç‚¹çš„æŒ‰é’®ï¼ˆè¯´æ˜èŠ‚ç‚¹ä¸èƒ½å†æ‰©å±•ï¼‰
    const buttons = noteNode.querySelector('.node-buttons');
    if (buttons) {
        buttons.remove();
    }
    
    // è®¡ç®—è¯´æ˜èŠ‚ç‚¹ä½ç½® - ä½¿ç”¨æ›´å¥½çš„é—´è·
    const parentRect = parentNode.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    
    // è¯´æ˜èŠ‚ç‚¹æ”¾ç½®åœ¨çˆ¶èŠ‚ç‚¹çš„å³ä¸‹è§’ï¼Œé¿å…ä¸å­èŠ‚ç‚¹é‡å 
    const offsetX = 100;
    const offsetY = 60;
    
    const x = (parentRect.left - canvasRect.left) + offsetX;
    const y = (parentRect.top - canvasRect.top) + offsetY;
    
    // ç¡®ä¿ä¸è¶…å‡ºç”»å¸ƒè¾¹ç•Œ
    const minX = 20;
    const minY = 20;
    const maxX = canvas.offsetWidth - 200 - 20;
    const maxY = canvas.offsetHeight - 50 - 20;
    
    const finalX = Math.max(minX, Math.min(maxX, x));
    const finalY = Math.max(minY, Math.min(maxY, y));
    
    noteNode.style.left = finalX + 'px';
    noteNode.style.top = finalY + 'px';
    
    canvas.appendChild(noteNode);
    
    // åˆ›å»ºè¿æ¥çº¿
    createConnection(parentNode, noteNode);
    
    // é€‰ä¸­æ–°èŠ‚ç‚¹å¹¶è¿›å…¥ç¼–è¾‘æ¨¡å¼
    selectNode(noteNode);
    setTimeout(() => {
        editNode(noteNode);
        // ä¿å­˜çŠ¶æ€
        saveState();
    }, 100);
}

// è·å–å­èŠ‚ç‚¹æ•°é‡
function getChildCount(parentNode) {
    return connections.filter(conn => conn.from === parentNode).length;
}

// åˆ›å»ºè¿æ¥çº¿
function createConnection(fromNode, toNode) {
    const canvas = document.getElementById('mindmap-canvas');
    const line = document.createElement('div');
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è¯´æ˜èŠ‚ç‚¹è¿æ¥
    const isNoteConnection = toNode.classList.contains('note-node');
    
    if (isNoteConnection) {
        line.className = 'connection-line note-connection';
    } else {
        line.className = 'connection-line';
    }
    
    // è®°å½•è¿æ¥å…³ç³»
    connections.push({ from: fromNode, to: toNode, line: line });
    
    // æ›´æ–°è¿æ¥çº¿ä½ç½®
    updateConnectionLine(fromNode, toNode, line);
    
    canvas.appendChild(line);
}

// æ›´æ–°è¿æ¥çº¿ä½ç½®
function updateConnectionLine(fromNode, toNode, line) {
    const canvas = document.getElementById('mindmap-canvas');
    
    // ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹çš„ä½ç½®å’Œå¤§å°ï¼Œä¸ä¾èµ–getBoundingClientRect
    const fromLeft = parseInt(fromNode.style.left) || 0;
    const fromTop = parseInt(fromNode.style.top) || 0;
    const fromWidth = fromNode.offsetWidth;
    const fromHeight = fromNode.offsetHeight;
    
    const toLeft = parseInt(toNode.style.left) || 0;
    const toTop = parseInt(toNode.style.top) || 0;
    const toWidth = toNode.offsetWidth;
    const toHeight = toNode.offsetHeight;
    
    const fromX = fromLeft + fromWidth / 2;
    const fromY = fromTop + fromHeight / 2;
    const toX = toLeft + toWidth / 2;
    const toY = toTop + toHeight / 2;
    
    const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
    const angle = Math.atan2(toY - fromY, toX - fromX) * 180 / Math.PI;
    
    line.style.left = fromX + 'px';
    line.style.top = fromY + 'px';
    line.style.width = length + 'px';
    line.style.transform = `rotate(${angle}deg)`;
    line.style.transformOrigin = '0 50%';
}

// é€‰æ‹©èŠ‚ç‚¹
function selectNode(node) {
    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
    document.querySelectorAll('.mindmap-node').forEach(n => {
        n.classList.remove('selected');
    });
    
    if (node) {
        node.classList.add('selected');
        selectedNode = node;
        
        // è¿æ¥æ¨¡å¼å¤„ç†
        if (isConnectionMode) {
            if (node.classList.contains('connection-target')) {
                finishConnection(node);
            }
        }
    } else {
        selectedNode = null;
        // å¦‚æœç‚¹å‡»ç©ºç™½å¤„ï¼Œå–æ¶ˆè¿æ¥æ¨¡å¼
        if (isConnectionMode) {
            document.querySelectorAll('.mindmap-node').forEach(n => {
                n.classList.remove('connection-source', 'connection-target');
            });
            connectionStart = null;
            isConnectionMode = false;
        }
    }
}

// ç¼–è¾‘èŠ‚ç‚¹
function editNode(node) {
    if (node.classList.contains('editing')) return;
    
    node.classList.add('editing');
    const originalText = node.textContent;
    
    // åˆ›å»ºè¾“å…¥æ¡†
    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.className = 'node-input';
    input.style.cssText = `
        position: absolute;
        background: white;
        border: 2px solid #0969da;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        min-width: 100px;
    `;
    
    // å®šä½è¾“å…¥æ¡†
    const nodeRect = node.getBoundingClientRect();
    input.style.left = nodeRect.left + 'px';
    input.style.top = nodeRect.top + 'px';
    input.style.width = Math.max(nodeRect.width, 100) + 'px';
    
    document.body.appendChild(input);
    input.focus();
    input.select();
    
    // å¤„ç†è¾“å…¥å®Œæˆ
    const finishEditing = () => {
        const newText = input.value.trim() || originalText;
        node.textContent = newText;
        node.classList.remove('editing');
        
        // é‡æ–°æ·»åŠ æŒ‰é’®ï¼ˆé™¤äº†è¯´æ˜èŠ‚ç‚¹ï¼‰
        if (!node.classList.contains('note-node')) {
            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æŒ‰é’®
            const existingButtons = node.querySelector('.node-buttons');
            if (existingButtons) {
                existingButtons.remove();
            }
            
            const buttonGroup = createNodeButtons(node);
            node.appendChild(buttonGroup);
        }
        
        // è°ƒæ•´èŠ‚ç‚¹å¤§å°
        adjustNodeSize(node);
        
        // æ›´æ–°è¿æ¥çº¿
        updateNodeConnections(node);
        
        document.body.removeChild(input);
    };
    
    input.addEventListener('blur', finishEditing);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            finishEditing();
        } else if (e.key === 'Escape') {
            node.classList.remove('editing');
            if (!node.classList.contains('note-node')) {
                // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æŒ‰é’®
                const existingButtons = node.querySelector('.node-buttons');
                if (existingButtons) {
                    existingButtons.remove();
                }
                
                const buttonGroup = createNodeButtons(node);
                node.appendChild(buttonGroup);
            }
            document.body.removeChild(input);
        }
    });
}

// å¼€å§‹è¿æ¥æ¨¡å¼
function startConnection(node) {
    // æ¸…é™¤ä¹‹å‰çš„è¿æ¥çŠ¶æ€
    document.querySelectorAll('.mindmap-node').forEach(n => {
        n.classList.remove('connection-source', 'connection-target');
    });
    
    // è®¾ç½®è¿æ¥æºèŠ‚ç‚¹
    node.classList.add('connection-source');
    connectionStart = node;
    
    // æ˜¾ç¤ºè¿æ¥æç¤º
    showToast('è¯·ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹åˆ›å»ºè¿æ¥', 'info');
    
    // ä¸ºå…¶ä»–èŠ‚ç‚¹æ·»åŠ è¿æ¥ç›®æ ‡æ ·å¼
    document.querySelectorAll('.mindmap-node').forEach(n => {
        if (n !== node) {
            n.classList.add('connection-target');
        }
    });
    
    // è®¾ç½®è¿æ¥æ¨¡å¼
    isConnectionMode = true;
}

// å®Œæˆè¿æ¥
function finishConnection(targetNode) {
    if (connectionStart && targetNode !== connectionStart) {
        createConnection(connectionStart, targetNode);
        showToast('è¿æ¥å·²åˆ›å»º');
    }
    
    // æ¸…é™¤è¿æ¥çŠ¶æ€
    document.querySelectorAll('.mindmap-node').forEach(n => {
        n.classList.remove('connection-source', 'connection-target');
    });
    
    connectionStart = null;
    isConnectionMode = false;
}

// è°ƒæ•´èŠ‚ç‚¹å¤§å°
function adjustNodeSize(node) {
    const text = node.textContent;
    const minWidth = 80;
    const maxWidth = 200;
    
    // åˆ›å»ºä¸´æ—¶å…ƒç´ æµ‹é‡æ–‡æœ¬å®½åº¦
    const temp = document.createElement('div');
    temp.style.cssText = `
        position: absolute;
        visibility: hidden;
        white-space: nowrap;
        font-size: 14px;
        font-weight: 500;
        padding: 12px 20px;
        border-radius: 8px;
        font-family: inherit;
    `;
    temp.textContent = text;
    document.body.appendChild(temp);
    
    const textWidth = temp.offsetWidth;
    document.body.removeChild(temp);
    
    // è®¾ç½®èŠ‚ç‚¹å®½åº¦
    const newWidth = Math.min(Math.max(textWidth, minWidth), maxWidth);
    node.style.width = newWidth + 'px';
    
    // å¦‚æœè¶…è¿‡æœ€å¤§å®½åº¦ï¼Œå¯ç”¨æ¢è¡Œ
    if (textWidth > maxWidth) {
        node.style.whiteSpace = 'normal';
        node.style.wordBreak = 'break-word';
        node.style.width = maxWidth + 'px';
    } else {
        node.style.whiteSpace = 'nowrap';
    }
}

// æ›´æ–°èŠ‚ç‚¹çš„æ‰€æœ‰è¿æ¥çº¿
function updateNodeConnections(node) {
    connections.forEach(conn => {
        if (conn.from === node || conn.to === node) {
            updateConnectionLine(conn.from, conn.to, conn.line);
        }
    });
}

// æ˜¾ç¤ºæ ·å¼é¢æ¿
function showStylePanel(node) {
    const panel = document.getElementById('style-panel');
    panel.classList.add('show');
    
    // è®°å½•å½“å‰ç¼–è¾‘çš„èŠ‚ç‚¹
    panel.dataset.nodeId = node.id;
    
    // ç»‘å®šæ ·å¼é€‰æ‹©äº‹ä»¶
    bindStyleEvents();
}

// å…³é—­æ ·å¼é¢æ¿
function closeStylePanel() {
    document.getElementById('style-panel').classList.remove('show');
}

// ç»‘å®šæ ·å¼äº‹ä»¶
function bindStyleEvents() {
    const panel = document.getElementById('style-panel');
    
    // é…è‰²æ¨¡æ¿
    panel.querySelectorAll('.template-option').forEach(option => {
        option.onclick = () => {
            const template = option.dataset.template;
            applyTemplate(template);
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            panel.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
        };
    });
    
    // é¢œè‰²ä¸»é¢˜
    panel.querySelectorAll('.theme-option').forEach(option => {
        option.onclick = () => {
            const theme = option.dataset.theme;
            const nodeId = panel.dataset.nodeId;
            const node = document.getElementById(nodeId);
            
            applyTheme(node, theme);
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            panel.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
        };
    });
    
    // å½¢çŠ¶é€‰æ‹©
    panel.querySelectorAll('.shape-btn').forEach(btn => {
        btn.onclick = () => {
            const shape = btn.dataset.shape;
            const nodeId = panel.dataset.nodeId;
            const node = document.getElementById(nodeId);
            
            applyShape(node, shape);
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            panel.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
    });
}

// åº”ç”¨é…è‰²æ¨¡æ¿
function applyTemplate(template) {
    const templateSchemes = {
        github: ['#24292e', '#0969da', '#1f883d', '#cf222e', '#8250df', '#bc4c00'],
        vscode: ['#1e1e1e', '#0e639c', '#16825d', '#d16969', '#c586c0', '#dcdcaa'],
        dracula: ['#282a36', '#8be9fd', '#50fa7b', '#ff79c6', '#bd93f9', '#ffb86c'],
        material: ['#263238', '#29b6f6', '#66bb6a', '#ef5350', '#ab47bc', '#ff7043'],
        minimal: ['#f8f9fa', '#e9ecef', '#dee2e6', '#ced4da', '#adb5bd', '#6c757d']
    };
    
    const scheme = templateSchemes[template];
    if (!scheme) return;
    
    const nodes = document.querySelectorAll('.mindmap-node');
    let colorIndex = 0;
    let nodesByLevel = new Map();
    
    // æŒ‰å±‚çº§åˆ†ç»„èŠ‚ç‚¹
    nodes.forEach(node => {
        const level = getNodeLevel(node);
        if (!nodesByLevel.has(level)) {
            nodesByLevel.set(level, []);
        }
        nodesByLevel.get(level).push(node);
    });
    
    // æŒ‰å±‚çº§åº”ç”¨é¢œè‰²
    nodesByLevel.forEach((levelNodes, level) => {
        const color = scheme[level % scheme.length];
        const textColor = isLightColor(color) ? '#000' : '#fff';
        
        levelNodes.forEach(node => {
            node.style.background = color;
            node.style.color = textColor;
            if (template === 'minimal') {
                node.style.border = '1px solid #ced4da';
            }
        });
    });
    
    showToast('é…è‰²æ¨¡æ¿å·²åº”ç”¨');
}

// è·å–èŠ‚ç‚¹å±‚çº§
function getNodeLevel(node) {
    if (node.classList.contains('center-node')) return 0;
    
    // é€šè¿‡è¿æ¥å…³ç³»è®¡ç®—å±‚çº§
    let level = 1; // é»˜è®¤ä¸ºç¬¬ä¸€çº§
    
    // æŸ¥æ‰¾æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„è¿æ¥
    for (let conn of connections) {
        if (conn.to === node) {
            if (conn.from.classList.contains('center-node')) {
                return 1; // ç›´æ¥è¿æ¥åˆ°ä¸­å¿ƒèŠ‚ç‚¹çš„ä¸ºç¬¬ä¸€çº§
            } else {
                return getNodeLevel(conn.from) + 1; // é€’å½’è®¡ç®—çˆ¶èŠ‚ç‚¹å±‚çº§ + 1
            }
        }
    }
    
    return level;
}

// åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºæµ…è‰²
function isLightColor(color) {
    const hex = color.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 155;
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(node, theme) {
    const themes = {
        github: { background: '#24292e', color: 'white' },
        vscode: { background: '#007acc', color: 'white' },
        atom: { background: '#3C4043', color: 'white' },
        sublime: { background: '#393B40', color: 'white' },
        intellij: { background: '#2B2B2B', color: 'white' },
        jetbrains: { background: '#1E1E1E', color: 'white' },
        dracula: { background: '#44475A', color: 'white' },
        material: { background: '#263238', color: 'white' },
        minimal: { background: '#f8f9fa', color: '#495057' },
        primary: { background: '#0d6efd', color: 'white' },
        success: { background: '#198754', color: 'white' },
        warning: { background: '#fd7e14', color: 'white' }
    };
    
    if (themes[theme]) {
        node.style.background = themes[theme].background;
        node.style.color = themes[theme].color;
    }
}

// åº”ç”¨å½¢çŠ¶
function applyShape(node, shape) {
    const shapes = {
        rounded: '8px',
        rect: '4px', 
        circle: '50%',
        diamond: '4px'
    };
    
    // æ¸…é™¤æ‰€æœ‰å½¢çŠ¶ç›¸å…³çš„æ ·å¼å’Œç±»
    node.classList.remove('shape-rounded', 'shape-rect', 'shape-circle', 'shape-diamond');
    node.style.clipPath = '';
    node.style.transform = '';
    node.style.width = 'auto';
    node.style.height = 'auto';
    node.style.display = 'block';
    
    // æ¢å¤åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆå¦‚æœè¢«è±å½¢å½¢çŠ¶ä¿®æ”¹è¿‡ï¼‰
    if (node.querySelector('span') && node.dataset.originalText) {
        node.textContent = node.dataset.originalText;
        delete node.dataset.originalText;
    }
    
    // æ·»åŠ å½¢çŠ¶ç±»å’Œè®¾ç½®æ ·å¼
    node.classList.add(`shape-${shape}`);
    node.style.borderRadius = shapes[shape] || '8px';
    
    if (shape === 'circle') {
        const size = Math.max(node.offsetWidth, node.offsetHeight, 80);
        node.style.width = size + 'px';
        node.style.height = size + 'px';
        node.style.display = 'flex';
        node.style.alignItems = 'center';
        node.style.justifyContent = 'center';
    } else if (shape === 'diamond') {
        // ä¿å­˜åŸå§‹æ–‡æœ¬
        if (!node.dataset.originalText) {
            node.dataset.originalText = node.textContent;
        }
        
        node.style.display = 'flex';
        node.style.alignItems = 'center';
        node.style.justifyContent = 'center';
        node.style.width = '80px';
        node.style.height = '80px';
        node.style.borderRadius = '0';
        node.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';
        
        // ç¡®ä¿æ–‡å­—å±…ä¸­æ˜¾ç¤º
        const textContent = node.dataset.originalText || node.textContent;
        node.innerHTML = '';
        const textSpan = document.createElement('span');
        textSpan.style.fontSize = '12px';
        textSpan.style.textAlign = 'center';
        textSpan.style.lineHeight = '1';
        textSpan.style.maxWidth = '50px';
        textSpan.style.wordBreak = 'break-all';
        textSpan.textContent = textContent;
        node.appendChild(textSpan);
        
        // é‡æ–°æ·»åŠ æŒ‰é’®ï¼ˆå¦‚æœä¸æ˜¯noteèŠ‚ç‚¹ï¼‰
        if (!node.classList.contains('note-node')) {
            const existingButtons = node.querySelector('.node-buttons');
            if (!existingButtons) {
                const buttonGroup = createNodeButtons(node);
                node.appendChild(buttonGroup);
            }
        }
    }
}

// ä¿å­˜çŠ¶æ€åˆ°æ’¤é”€æ ˆ
function saveState() {
    const state = extractCanvasData();
    undoStack.push(JSON.stringify(state));
    
    // é™åˆ¶æ’¤é”€æ ˆå¤§å°
    if (undoStack.length > MAX_UNDO_STACK) {
        undoStack.shift();
    }
    
    // æ¸…ç©ºé‡åšæ ˆ
    redoStack = [];
}

// æ’¤é”€æ“ä½œ
function undoAction() {
    if (undoStack.length <= 1) {
        showToast('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'warning');
        return;
    }
    
    // å½“å‰çŠ¶æ€æ¨å…¥é‡åšæ ˆ
    const currentState = extractCanvasData();
    redoStack.push(JSON.stringify(currentState));
    
    // ä»æ’¤é”€æ ˆè·å–å‰ä¸€ä¸ªçŠ¶æ€
    undoStack.pop(); // ç§»é™¤å½“å‰çŠ¶æ€
    const prevState = undoStack[undoStack.length - 1];
    
    restoreState(JSON.parse(prevState));
    showToast('æ’¤é”€æˆåŠŸ', 'info');
}

// é‡åšæ“ä½œ
function redoAction() {
    if (redoStack.length === 0) {
        showToast('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ', 'warning');
        return;
    }
    
    // å½“å‰çŠ¶æ€æ¨å…¥æ’¤é”€æ ˆ
    const currentState = extractCanvasData();
    undoStack.push(JSON.stringify(currentState));
    
    // ä»é‡åšæ ˆè·å–çŠ¶æ€
    const nextState = redoStack.pop();
    
    restoreState(JSON.parse(nextState));
    showToast('é‡åšæˆåŠŸ', 'info');
}

// æ¢å¤çŠ¶æ€
function restoreState(state) {
    // æ¸…ç©ºå½“å‰ç”»å¸ƒ
    const canvas = document.getElementById('mindmap-canvas');
    canvas.querySelectorAll('.mindmap-node, .connection-line').forEach(el => el.remove());
    
    // é‡ç½®å˜é‡
    nodes = [];
    connections = [];
    nodeCounter = 0;
    selectedNode = null;
    
    // æ¢å¤èŠ‚ç‚¹
    state.nodes.forEach(nodeData => {
        const node = createNodeFromData(nodeData);
        canvas.appendChild(node);
    });
    
    // æ¢å¤è¿æ¥
    state.connections.forEach(connData => {
        const fromNode = document.getElementById(connData.from);
        const toNode = document.getElementById(connData.to);
        if (fromNode && toNode) {
            createConnection(fromNode, toNode);
        }
    });
}

// ä»æ•°æ®åˆ›å»ºèŠ‚ç‚¹
function createNodeFromData(nodeData) {
    const node = document.createElement('div');
    node.className = nodeData.className;
    node.id = nodeData.id;
    node.style.left = nodeData.x + 'px';
    node.style.top = nodeData.y + 'px';
    
    // åº”ç”¨æ ·å¼
    if (nodeData.style) {
        Object.assign(node.style, nodeData.style);
    }
    
    // å¤„ç†è±å½¢èŠ‚ç‚¹çš„ç‰¹æ®Šæƒ…å†µ
    if (nodeData.style && nodeData.style.clipPath && nodeData.style.clipPath.includes('polygon')) {
        // è¿™æ˜¯è±å½¢èŠ‚ç‚¹
        if (nodeData.originalText) {
            node.dataset.originalText = nodeData.originalText;
        }
        
        const textSpan = document.createElement('span');
        textSpan.style.fontSize = '12px';
        textSpan.style.textAlign = 'center';
        textSpan.style.lineHeight = '1';
        textSpan.style.maxWidth = '50px';
        textSpan.style.wordBreak = 'break-all';
        textSpan.textContent = nodeData.text;
        node.appendChild(textSpan);
    } else {
        // æ™®é€šèŠ‚ç‚¹
        node.textContent = nodeData.text;
    }
    
    // æ·»åŠ æŒ‰é’®å’Œäº‹ä»¶
    if (!node.classList.contains('note-node')) {
        const buttonGroup = createNodeButtons(node);
        node.appendChild(buttonGroup);
    }
    
    node.addEventListener('click', () => selectNode(node));
    node.addEventListener('dblclick', () => editNode(node));
    enableNodeDragging(node);
    
    nodes.push(node);
    
    // æ›´æ–°è®¡æ•°å™¨
    const nodeId = parseInt(nodeData.id.replace('node-', ''));
    if (nodeId >= nodeCounter) {
        nodeCounter = nodeId + 1;
    }
    
    return node;
}

// æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
function bindKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // Ctrl+Z æ’¤é”€
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undoAction();
            return;
        }
        
        // Ctrl+Y é‡åš
        if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            redoAction();
            return;
        }
        
        switch(e.key) {
            case 'Tab':
                e.preventDefault();
                if (selectedNode) {
                    addChildNode(selectedNode);
                }
                break;
            case 'i':
            case 'I':
                e.preventDefault();
                if (selectedNode) {
                    addNoteNode(selectedNode);
                }
                break;
            case 'Delete':
            case 'Backspace':
                e.preventDefault();
                deleteSelected();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedNode) {
                    editNode(selectedNode);
                }
                break;
        }
    });
}

// ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
function bindEventListeners() {
    bindKeyboardShortcuts();
    
    // ç”»å¸ƒç‚¹å‡»å’Œæ‹–æ‹½
    const canvas = document.getElementById('mindmap-canvas');
    
    canvas.addEventListener('click', (e) => {
        if (e.target.id === 'mindmap-canvas') {
            selectNode(null);
        }
    });
    
    // ç”»å¸ƒæ‹–æ‹½åŠŸèƒ½
    enableCanvasDragging(canvas);
}

// å¯ç”¨ç”»å¸ƒæ‹–æ‹½åŠŸèƒ½
function enableCanvasDragging(canvas) {
    let isDragging = false;
    let startX, startY;
    let canvasOffsetX = 0, canvasOffsetY = 0;
    
    canvas.addEventListener('mousedown', function(e) {
        // åªæœ‰ç‚¹å‡»ç©ºç™½åŒºåŸŸæ‰å¼€å§‹æ‹–æ‹½
        if (e.target === canvas) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            canvas.style.cursor = 'grabbing';
            e.preventDefault();
        }
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        canvasOffsetX += deltaX;
        canvasOffsetY += deltaY;
        
        // ç§»åŠ¨æ‰€æœ‰èŠ‚ç‚¹å’Œè¿æ¥çº¿
        document.querySelectorAll('.mindmap-node').forEach(node => {
            const currentLeft = parseInt(node.style.left) || 0;
            const currentTop = parseInt(node.style.top) || 0;
            node.style.left = (currentLeft + deltaX) + 'px';
            node.style.top = (currentTop + deltaY) + 'px';
        });
        
        // æ›´æ–°æ‰€æœ‰è¿æ¥çº¿
        connections.forEach(conn => {
            updateConnectionLine(conn.from, conn.to, conn.line);
        });
        
        startX = e.clientX;
        startY = e.clientY;
    });
    
    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            canvas.style.cursor = 'grab';
        }
    });
}

// åˆ é™¤é€‰ä¸­èŠ‚ç‚¹
function deleteSelected() {
    if (!selectedNode) return;
    
    // ä¸èƒ½åˆ é™¤æ ¹èŠ‚ç‚¹
    if (selectedNode.classList.contains('root-node')) {
        showToast('ä¸èƒ½åˆ é™¤æ ¹èŠ‚ç‚¹', 'error');
        return;
    }
    
    // åˆ é™¤ç›¸å…³è¿æ¥
    connections = connections.filter(conn => {
        if (conn.from === selectedNode || conn.to === selectedNode) {
            conn.line.remove();
            return false;
        }
        return true;
    });
    
    // åˆ é™¤èŠ‚ç‚¹
    selectedNode.remove();
    nodes = nodes.filter(node => node !== selectedNode);
    selectedNode = null;
    
    // ä¿å­˜çŠ¶æ€
    saveState();
    
    showToast('èŠ‚ç‚¹å·²åˆ é™¤');
}

// æ·»åŠ æ ¹èŠ‚ç‚¹
function addRootNode() {
    const canvas = document.getElementById('mindmap-canvas');
    const rootNode = createNode('æ–°æ ¹èŠ‚ç‚¹', 'root-node');
    
    // éšæœºä½ç½®
    const x = Math.random() * (canvas.offsetWidth - 200) + 100;
    const y = Math.random() * (canvas.offsetHeight - 100) + 50;
    
    rootNode.style.left = x + 'px';
    rootNode.style.top = y + 'px';
    
    canvas.appendChild(rootNode);
    selectNode(rootNode);
    setTimeout(() => {
        editNode(rootNode);
        // ä¿å­˜çŠ¶æ€
        saveState();
    }, 100);
}

// ä¿å­˜æ€ç»´å¯¼å›¾
function saveMindmap() {
    const title = document.getElementById('mindmap-title').value;
    const canvasData = extractCanvasData();
    
    const data = {
        title: title,
        description: '',
        canvas_data: canvasData,
        is_public: false,
        tags: []
    };
    
    // å¦‚æœå·²æœ‰IDï¼Œæ›´æ–°ç°æœ‰æ€ç»´å¯¼å›¾ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„
    const url = currentMindmapId ? `/mindmap/api/update/${currentMindmapId}` : '/mindmap/api/create';
    const method = currentMindmapId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!currentMindmapId) {
                currentMindmapId = data.data.id;
                // æ›´æ–°URLè€Œä¸åˆ·æ–°é¡µé¢
                history.replaceState(null, null, `/mindmap/${currentMindmapId}`);
            }
            showToast('æ€ç»´å¯¼å›¾å·²ä¿å­˜');
            // é‡æ–°åŠ è½½ä¾§è¾¹æ åˆ—è¡¨
            loadMindmapList();
        } else {
            showToast('ä¿å­˜å¤±è´¥ï¼š' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

// æå–ç”»å¸ƒæ•°æ®
function extractCanvasData() {
    const nodeElements = document.querySelectorAll('.mindmap-node');
    const nodeData = Array.from(nodeElements).map((node, index) => {
        // è·å–çœŸå®çš„æ–‡æœ¬å†…å®¹
        let text = node.textContent;
        if (node.dataset.originalText) {
            text = node.dataset.originalText; // è±å½¢èŠ‚ç‚¹ä½¿ç”¨åŸå§‹æ–‡æœ¬
        }
        
        return {
            id: node.id || `node-${index}`,
            text: text,
            x: parseFloat(node.style.left) || 0,
            y: parseFloat(node.style.top) || 0,
            className: node.className,
            style: {
                background: node.style.background || node.style.backgroundColor,
                color: node.style.color,
                borderRadius: node.style.borderRadius,
                clipPath: node.style.clipPath,
                width: node.style.width,
                height: node.style.height,
                fontSize: node.style.fontSize
            },
            originalText: node.dataset.originalText || null // ä¿å­˜åŸå§‹æ–‡æœ¬
        };
    });
    
    const connectionData = connections.map(conn => ({
        from: conn.from.id,
        to: conn.to.id
    }));
    
    return {
        nodes: nodeData,
        connections: connectionData,
        version: '1.0'
    };
}

// å¯¼å‡ºæ€ç»´å¯¼å›¾
function exportMindmap(format = 'json') {
    const title = document.getElementById('mindmap-title').value || 'æ€ç»´å¯¼å›¾';
    
    if (format === 'json') {
        const canvasData = extractCanvasData();
        const exportData = {
            title: title,
            canvasData: canvasData,
            exportTime: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = title + '.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showToast('JSONæ–‡ä»¶å·²å¯¼å‡º');
    } else if (format === 'pdf') {
        exportToPDF(title);
    }
}

// å¯¼å‡ºä¸ºPDF
function exportToPDF(title) {
    // ä½¿ç”¨html2canvas + jsPDFæ¥ç”ŸæˆPDF
    if (typeof html2canvas === 'undefined') {
        // å¦‚æœhtml2canvasæ²¡æœ‰åŠ è½½ï¼ŒåŠ¨æ€åŠ è½½
        loadPDFLibraries().then(() => {
            generatePDF(title);
        });
    } else {
        generatePDF(title);
    }
}

// åŠ è½½PDFæ‰€éœ€çš„åº“
function loadPDFLibraries() {
    return new Promise((resolve) => {
        if (typeof html2canvas !== 'undefined' && typeof jsPDF !== 'undefined') {
            resolve();
            return;
        }
        
        // åŠ è½½html2canvas
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(html2canvasScript);
        
        // åŠ è½½jsPDF
        const jsPDFScript = document.createElement('script');
        jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(jsPDFScript);
        
        // ç­‰å¾…ä¸¤ä¸ªåº“éƒ½åŠ è½½å®Œæˆ
        let loadedCount = 0;
        const checkLoaded = () => {
            loadedCount++;
            if (loadedCount === 2) {
                resolve();
            }
        };
        
        html2canvasScript.onload = checkLoaded;
        jsPDFScript.onload = checkLoaded;
    });
}

// ç”ŸæˆPDF
function generatePDF(title) {
    const canvas = document.getElementById('mindmap-canvas');
    
    // ä¸´æ—¶éšè—æç¤ºä¿¡æ¯
    const hint = document.getElementById('canvas-hint');
    if (hint) hint.style.display = 'none';
    
    // è®¾ç½®canvasèƒŒæ™¯ä¸ºç™½è‰²
    canvas.style.backgroundColor = 'white';
    
    html2canvas(canvas, {
        backgroundColor: 'white',
        scale: 2,
        useCORS: true,
        allowTaint: true
    }).then(canvasImg => {
        const imgData = canvasImg.toDataURL('image/png');
        
        // æ­£ç¡®å¼•ç”¨ jsPDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgWidth = 297; // A4 landscape width
        const imgHeight = (canvasImg.height * imgWidth) / canvasImg.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(title + '.pdf');
        
        // æ¢å¤æç¤ºä¿¡æ¯
        if (hint) hint.style.display = 'block';
        
        showToast('PDFæ–‡ä»¶å·²å¯¼å‡º');
    }).catch(error => {
        console.error('PDFå¯¼å‡ºé”™è¯¯:', error);
        showToast('PDFå¯¼å‡ºå¤±è´¥', 'error');
        
        // æ¢å¤æç¤ºä¿¡æ¯
        if (hint) hint.style.display = 'block';
    });
}

// å¯¼å…¥æ€ç»´å¯¼å›¾
function importMindmap() {
    const fileInput = document.getElementById('import-file');
    fileInput.click();
}

// å¤„ç†æ–‡ä»¶å¯¼å…¥
document.getElementById('import-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.type !== 'application/json') {
        alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            
            // éªŒè¯æ–‡ä»¶æ ¼å¼
            if (!importData.canvasData || !importData.canvasData.nodes) {
                alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            
            // æ¸…ç©ºå½“å‰ç”»å¸ƒ
            const canvas = document.getElementById('mindmap-canvas');
            canvas.innerHTML = '';
            
            // é‡ç½®è¿æ¥æ•°ç»„
            connections = [];
            
            // å¯¼å…¥æ ‡é¢˜
            if (importData.title) {
                document.getElementById('mindmap-title').value = importData.title;
            }
            
            // å¯¼å…¥èŠ‚ç‚¹æ•°æ®
            renderImportedData(importData.canvasData);
            
            showToast('æ€ç»´å¯¼å›¾å·²å¯¼å…¥');
            
        } catch (error) {
            console.error('å¯¼å…¥é”™è¯¯:', error);
            alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
        }
    };
    
    reader.readAsText(file);
    
    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
    e.target.value = '';
});

// æ¸²æŸ“å¯¼å…¥çš„æ•°æ®
function renderImportedData(canvasData) {
    const canvas = document.getElementById('mindmap-canvas');
    const nodeMap = new Map(); // å­˜å‚¨èŠ‚ç‚¹æ˜ å°„ï¼Œç”¨äºé‡å»ºè¿æ¥
    
    // åˆ›å»ºèŠ‚ç‚¹
    canvasData.nodes.forEach((nodeData, index) => {
        const node = createNode(nodeData.text);
        
        // è®¾ç½®ä½ç½®
        node.style.left = nodeData.x + 'px';
        node.style.top = nodeData.y + 'px';
        
        // è®¾ç½®æ ·å¼
        if (nodeData.style) {
            if (nodeData.style.backgroundColor) {
                node.style.backgroundColor = nodeData.style.backgroundColor;
            }
            if (nodeData.style.color) {
                node.style.color = nodeData.style.color;
            }
            if (nodeData.style.fontSize) {
                node.style.fontSize = nodeData.style.fontSize;
            }
        }
        
        // è®¾ç½®ç±»å‹
        if (nodeData.type === 'center') {
            node.classList.add('center-node');
        } else if (nodeData.type === 'ai') {
            node.classList.add('ai-generated');
        } else if (nodeData.type === 'note') {
            node.classList.add('note-node');
        }
        
        canvas.appendChild(node);
        nodeMap.set(nodeData.id || index, node);
    });
    
    // é‡å»ºè¿æ¥
    if (canvasData.connections) {
        canvasData.connections.forEach(connData => {
            const fromNode = nodeMap.get(connData.from);
            const toNode = nodeMap.get(connData.to);
            if (fromNode && toNode) {
                createConnection(fromNode, toNode);
            }
        });
    }
}

// æ˜¾ç¤ºå¸®åŠ©
function showHelp() {
    const hint = document.getElementById('canvas-hint');
    if (hint) {
        hint.style.display = 'block';
        hint.style.opacity = '1';
        hint.style.transition = 'opacity 0.3s ease';
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            hint.style.opacity = '0';
            setTimeout(() => {
                hint.style.display = 'none';
            }, 300);
        }, 3000);
    }
}

// å¯ç”¨èŠ‚ç‚¹æ‹–æ‹½
function enableNodeDragging(node) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    node.addEventListener('mousedown', function(e) {
        // åªåœ¨èŠ‚ç‚¹æœ¬èº«ä¸Šå¼€å§‹æ‹–æ‹½ï¼Œä¸åœ¨æŒ‰é’®ä¸Š
        if (e.target.classList.contains('node-btn') || e.target.closest('.node-buttons')) {
            return;
        }
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(node.style.left) || 0;
        startTop = parseInt(node.style.top) || 0;
        
        node.style.cursor = 'grabbing';
        e.preventDefault();
        e.stopPropagation();
        
        const onMouseMove = (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            node.style.left = (startLeft + deltaX) + 'px';
            node.style.top = (startTop + deltaY) + 'px';
            
            // æ›´æ–°è¿æ¥çº¿
            updateNodeConnections(node);
        };
        
        const onMouseUp = () => {
            isDragging = false;
            node.style.cursor = 'pointer';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
}

// æ˜¾ç¤ºæç¤º
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const messageSpan = toast.querySelector('.toast-message');
    
    messageSpan.textContent = message;
    
    // è®¾ç½®ä¸åŒç±»å‹çš„æ ·å¼
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    toast.style.background = colors[type] || colors.success;
    
    // å¦‚æœæ˜¯warningç±»å‹ï¼Œæ–‡å­—é¢œè‰²æ”¹ä¸ºæ·±è‰²
    if (type === 'warning') {
        toast.style.color = '#212529';
    } else {
        toast.style.color = 'white';
    }
    
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
</script>
{% endblock %}