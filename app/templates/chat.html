{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - SuperRAG{% endblock %}

{% block extra_css %}
<!-- Markdownè§£æåº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<!-- ä»£ç é«˜äº®åº“ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/one-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
<!-- MathJaxæ•°å­¦å…¬å¼æ¸²æŸ“åº“ -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: {'[+]': ['ams', 'newcommand', 'autoload', 'configmacros', 'action']},
        maxMacros: 1000,
        maxBuffer: 5 * 1024
    },
    options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
    },
    startup: {
        ready: function () {
            console.log('MathJaxå·²å‡†å¤‡å°±ç»ª');
            MathJax.startup.defaultReady();
        }
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
/* èŠå¤©é¡µé¢éšè—é¡µè„šï¼Œä¸ºå¯¹è¯åŒºåŸŸé‡Šæ”¾æ›´å¤šç©ºé—´ */
footer {
    display: none !important;
}

/* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸé«˜åº¦ */
.main-content {
    min-height: calc(100vh - 60px) !important; /* å‡å»å¯¼èˆªæ é«˜åº¦ */
    padding-bottom: 0 !important;
}

/* èŠå¤©é¡µé¢å†…å®¹å®¹å™¨ */
.chat-page-content {
    padding: 0 !important;
    margin: 0 !important;
    height: calc(100vh - 60px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
    overflow: hidden;
}

/* ä¼˜åŒ–èŠå¤©å®¹å™¨é«˜åº¦ */
.chat-container {
    height: 100% !important;
    max-height: none !important;
    border-radius: 0 !important; /* ç§»é™¤åœ†è§’ï¼Œå……åˆ†åˆ©ç”¨ç©ºé—´ */
    box-shadow: none !important;
}

/* è°ƒè¯•é¢æ¿æ ·å¼ */
.debug-panel {
    position: fixed;
    top: 60px;
    right: 0;
    width: 500px;
    height: calc(100vh - 60px);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border-left: 1px solid #e5e5e5;
    box-shadow: -2px 0 20px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.debug-header {
    padding: 16px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: between;
    align-items: center;
    background: #f8f9fa;
}

.debug-controls {
    display: flex;
    gap: 8px;
}

.debug-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.debug-tabs {
    display: flex;
    border-bottom: 1px solid #e5e5e5;
    background: #f8f9fa;
}

.debug-tab {
    flex: 1;
    padding: 12px 8px;
    border: none;
    background: none;
    font-size: 12px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.debug-tab:hover {
    background: #e9ecef;
    color: #333;
}

.debug-tab.active {
    background: #fff;
    color: #0066cc;
    border-bottom: 2px solid #0066cc;
}

.debug-tab-content {
    flex: 1;
    overflow: hidden;
}

.debug-tab-pane {
    height: 100%;
    overflow: auto;
    padding: 16px;
    display: none;
}

.debug-tab-pane.active {
    display: block;
}

.debug-log {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    line-height: 1.4;
}

.debug-info {
    font-size: 12px;
    line-height: 1.5;
}

.debug-entry {
    margin-bottom: 12px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #dee2e6;
}

.debug-entry.info {
    border-left-color: #0066cc;
}

.debug-entry.success {
    border-left-color: #28a745;
}

.debug-entry.warning {
    border-left-color: #ffc107;
}

.debug-entry.error {
    border-left-color: #dc3545;
}

.debug-entry-header {
    font-weight: bold;
    margin-bottom: 4px;
    display: flex;
    justify-content: between;
    align-items: center;
}

.debug-entry-content {
    color: #666;
}

.debug-json {
    background: #f1f3f4;
    padding: 8px;
    border-radius: 4px;
    overflow-x: auto;
    margin-top: 8px;
    white-space: pre-wrap;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
}

/* æ•°æ®åº“æ“ä½œæ ·å¼ */
.db-operations-section {
    margin-top: 15px;
}

.db-operations-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px;
}

.db-operation {
    padding: 6px 8px;
    margin: 2px 0;
    border-radius: 3px;
    font-size: 12px;
    line-height: 1.4;
}

.db-operation.success {
    background: rgba(40, 167, 69, 0.1);
    border-left: 3px solid #28a745;
}

.db-operation.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

.db-operation.error {
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

.db-operation.info {
    background: rgba(0, 123, 255, 0.1);
    border-left: 3px solid #007bff;
}

/* è°ƒè¯•æ¨¡å¼ä¸‹è°ƒæ•´èŠå¤©åŒºåŸŸ */
.chat-main.debug-mode {
    margin-right: 500px;
}



/* ğŸ”¥ æ–°å¢ï¼šç­‰å¾…åŠ¨ç”»æ ·å¼ */
.waiting-animation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.9rem;
    padding: 0.5rem 0;
}

.waiting-text {
    color: #64748b;
}

.waiting-dots {
    display: flex;
    gap: 0.1rem;
}

.waiting-dots span {
    opacity: 0.4;
    animation: waitingDots 1.5s infinite ease-in-out;
}

.waiting-dots span:nth-child(1) {
    animation-delay: 0s;
}

.waiting-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.waiting-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes waitingDots {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(1);
    }
    40% {
        opacity: 1;
        transform: scale(1.2);
    }
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 1200px) {
    .debug-panel {
        width: 400px;
    }
    .chat-main.debug-mode {
        margin-right: 400px;
    }
}

@media (max-width: 992px) {
    .debug-panel {
        width: 100%;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
    }
    .chat-main.debug-mode {
        margin-right: 0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="chat-page-content">
    <div class="chat-container" id="chatContainer">
        <!-- èŠå¤©ä¾§è¾¹æ å±•å¼€è§¦å‘å™¨ -->
        <div class="sidebar-trigger-chat" id="sidebarTriggerChat" title="æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨">
            <i class="bi bi-chat-dots"></i>
        </div>
        
        <!-- å·¦ä¾§è¾¹æ  - å¯¹è¯å†å² -->
        <div class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-header">
                <button class="btn btn-primary w-100" id="newChatBtn">
                    <i class="bi bi-plus"></i> æ–°å»ºå¯¹è¯
                </button>
            </div>
            
            <div class="sidebar-search">
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control search-input" placeholder="æœç´¢å¯¹è¯..." id="conversationSearch">
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="conversation-list" id="conversationList">
                    <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    <div class="loading-conversations text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <small class="text-muted d-block mt-2">åŠ è½½å¯¹è¯ä¸­...</small>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="btn btn-outline-secondary btn-sm w-100" id="toggleSidebar">
                    <i class="bi bi-chevron-left"></i> æ”¶èµ·
                </button>
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-3" id="showSidebar">
                            <i class="bi bi-list"></i>
                        </button>
                        <div>
                            <h5 class="mb-0" id="currentChatTitle">æ™ºèƒ½é—®ç­”</h5>
                            <small class="text-muted">
                                <i class="bi bi-robot"></i> ç”± DeepSeek-V3 é©±åŠ¨
                            </small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info btn-sm" id="debugBtn" title="è°ƒè¯•æ¨¡å¼">
                            <i class="bi bi-bug me-1"></i>è°ƒè¯•
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="settingsBtn">
                            <i class="bi bi-gear me-1"></i>è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- è°ƒè¯•é¢æ¿ -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-header">
                    <h6 class="mb-0">
                        <i class="bi bi-bug"></i> è°ƒè¯•ä¿¡æ¯
                    </h6>
                    <div class="debug-controls">
                        <button class="btn btn-outline-secondary btn-sm" id="clearDebugBtn">
                            <i class="bi bi-trash me-1"></i>æ¸…ç©º
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="closeDebugBtn">
                            <i class="bi bi-x me-1"></i>å…³é—­
                        </button>
                    </div>
                </div>
                <div class="debug-content">
                    <div class="debug-tabs">
                        <button class="debug-tab active" data-tab="processing">å¤„ç†è¿‡ç¨‹</button>
                        <button class="debug-tab" data-tab="context">ä¸Šä¸‹æ–‡</button>
                        <button class="debug-tab" data-tab="langchain">LangChain</button>
                        <button class="debug-tab" data-tab="database">æ•°æ®åº“</button>
                        <button class="debug-tab" data-tab="system">ç³»ç»Ÿ</button>
                    </div>
                    <div class="debug-tab-content">
                        <div class="debug-tab-pane active" id="debug-processing">
                            <div class="debug-log" id="debugLog">
                                <div class="text-muted text-center py-3">æš‚æ— è°ƒè¯•ä¿¡æ¯</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-context">
                            <div class="debug-info" id="debugContext">
                                <div class="text-muted text-center py-3">é€‰æ‹©ä¸€æ¡æ¶ˆæ¯æŸ¥çœ‹ä¸Šä¸‹æ–‡ä¿¡æ¯</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-langchain">
                            <div class="debug-info" id="debugLangchain">
                                <div class="text-muted text-center py-3">LangChainå¤„ç†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-database">
                            <div class="debug-info" id="debugDatabase">
                                <div class="text-muted text-center py-3">æ•°æ®åº“ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-system">
                            <div class="debug-info" id="debugSystem">
                                <div class="text-muted text-center py-3">ç³»ç»ŸçŠ¶æ€ä¿¡æ¯</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message" id="welcomeMessage">
                        <i class="bi bi-chat-dots welcome-icon"></i>
                        <h4>å¼€å§‹æ–°çš„å¯¹è¯</h4>
                        <p>å‘æˆ‘æé—®ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä¼šåŸºäºæ‚¨çš„çŸ¥è¯†åº“ä¸ºæ‚¨æä¾›å‡†ç¡®çš„ç­”æ¡ˆã€‚</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="chat-input-container">
                <!-- çŸ¥è¯†åº“é€‰æ‹© -->
                <div class="chat-controls">
                    <div class="knowledge-base-selector">
                        <small class="text-muted">çŸ¥è¯†åº“ï¼š</small>
                        <select class="form-select form-select-sm" id="knowledgeBaseSelect">
                            <option value="">é€‰æ‹©çŸ¥è¯†åº“...</option>
                        </select>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·å¸®æˆ‘æ€»ç»“ä¸€ä¸‹')">
                            <i class="bi bi-lightning me-1"></i>æ€»ç»“
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·è¯¦ç»†è§£é‡Š')">
                            <i class="bi bi-question-circle me-1"></i>è§£é‡Š
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·ä¸¾ä¸ªä¾‹å­')">
                            <i class="bi bi-lightbulb me-1"></i>ä¸¾ä¾‹
                        </button>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ¡† -->
                <form id="chatForm" class="chat-input-form">
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                                 rows="1"></textarea>
                        <button type="submit" class="send-btn" id="sendBtn" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let isLoading = false;
let conversations = [];

// è°ƒè¯•åŠŸèƒ½ç›¸å…³å˜é‡
let debugMode = false;
let debugData = {};
let currentDebugTab = 'processing';

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–Markdownè§£æå™¨
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
    }
    
    // åˆå§‹åŒ–å„ç§äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners();
    
    // åŠ è½½å¯¹è¯åˆ—è¡¨
    loadConversations();
    
    // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
    loadKnowledgeBases();
    
    // æ£€æŸ¥LangChainçŠ¶æ€
    checkLangChainStatus();
});

// æ£€æŸ¥LangChainçŠ¶æ€
async function checkLangChainStatus() {
    try {
        const response = await fetch('/api/langchain/config');
        const data = await response.json();
        
        if (data.success && data.config.enabled) {
            // LangChainæ ‡è¯†å·²ç§»é™¤ï¼Œåªä¿ç•™è°ƒè¯•ä¿¡æ¯
            addDebugEntry('system', 'LangChainå·²å¯ç”¨', 'success');
        }
    } catch (error) {
        console.error('æ£€æŸ¥LangChainçŠ¶æ€å¤±è´¥:', error);
    }
}

// åˆå§‹åŒ–è°ƒè¯•åŠŸèƒ½
function initializeDebugFeatures() {
    // è°ƒè¯•æŒ‰é’®äº‹ä»¶
    document.getElementById('debugBtn').addEventListener('click', toggleDebugMode);
    document.getElementById('closeDebugBtn').addEventListener('click', closeDebugPanel);
    document.getElementById('clearDebugBtn').addEventListener('click', clearDebugLog);
    
    // è°ƒè¯•æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.debug-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            switchDebugTab(this.dataset.tab);
        });
    });
}

// åˆ‡æ¢è°ƒè¯•æ¨¡å¼
function toggleDebugMode() {
    debugMode = !debugMode;
    const debugPanel = document.getElementById('debugPanel');
    const chatMain = document.querySelector('.chat-main');
    const debugBtn = document.getElementById('debugBtn');
    
    if (debugMode) {
        debugPanel.style.display = 'flex';
        chatMain.classList.add('debug-mode');
        debugBtn.classList.add('active');
        addDebugEntry('system', 'è°ƒè¯•æ¨¡å¼å·²å¼€å¯', 'info');
        loadSystemInfo();
    } else {
        debugPanel.style.display = 'none';
        chatMain.classList.remove('debug-mode');
        debugBtn.classList.remove('active');
    }
}

// å…³é—­è°ƒè¯•é¢æ¿
function closeDebugPanel() {
    debugMode = false;
    document.getElementById('debugPanel').style.display = 'none';
    document.querySelector('.chat-main').classList.remove('debug-mode');
    document.getElementById('debugBtn').classList.remove('active');
}

// æ¸…ç©ºè°ƒè¯•æ—¥å¿—
function clearDebugLog() {
    document.getElementById('debugLog').innerHTML = '<div class="text-muted text-center py-3">è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º</div>';
    document.getElementById('debugContext').innerHTML = '<div class="text-muted text-center py-3">é€‰æ‹©ä¸€æ¡æ¶ˆæ¯æŸ¥çœ‹ä¸Šä¸‹æ–‡ä¿¡æ¯</div>';
    document.getElementById('debugLangchain').innerHTML = '<div class="text-muted text-center py-3">LangChainå¤„ç†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    document.getElementById('debugDatabase').innerHTML = '<div class="text-muted text-center py-3">æ•°æ®åº“ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    debugData = {};
}

// åˆ‡æ¢è°ƒè¯•æ ‡ç­¾
function switchDebugTab(tabName) {
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.debug-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
    document.querySelectorAll('.debug-tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(`debug-${tabName}`).classList.add('active');
    
    currentDebugTab = tabName;
    
    // å¦‚æœåˆ‡æ¢åˆ°ç³»ç»Ÿæ ‡ç­¾ï¼ŒåŠ è½½ç³»ç»Ÿä¿¡æ¯
    if (tabName === 'system') {
        loadSystemInfo();
    }
    
    // å¦‚æœåˆ‡æ¢åˆ°æ•°æ®åº“æ ‡ç­¾ï¼ŒåŠ è½½æ•°æ®åº“ä¿¡æ¯
    if (tabName === 'database') {
        loadDatabaseInfo();
    }
}

// æ·»åŠ è°ƒè¯•æ—¥å¿—æ¡ç›®
function addDebugEntry(type, message, level = 'info', data = null) {
    if (!debugMode) return;
    
    const debugLog = document.getElementById('debugLog');
    const timestamp = new Date().toLocaleTimeString();
    
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ¡ç›®ï¼Œæ¸…ç©ºé»˜è®¤æ¶ˆæ¯
    if (debugLog.innerHTML.includes('æš‚æ— è°ƒè¯•ä¿¡æ¯')) {
        debugLog.innerHTML = '';
    }
    
    const entry = document.createElement('div');
    entry.className = `debug-entry ${level}`;
    
    let content = `
        <div class="debug-entry-header">
            <span>[${timestamp}] ${type.toUpperCase()}</span>
        </div>
        <div class="debug-entry-content">${message}</div>
    `;
    
    if (data) {
        content += `<div class="debug-json">${JSON.stringify(data, null, 2)}</div>`;
    }
    
    entry.innerHTML = content;
    debugLog.appendChild(entry);
    debugLog.scrollTop = debugLog.scrollHeight;
}

// æ›´æ–°ä¸Šä¸‹æ–‡è°ƒè¯•ä¿¡æ¯
function updateContextDebug(contextInfo) {
    if (!debugMode) return;
    
    const debugContext = document.getElementById('debugContext');
    debugContext.innerHTML = `
        <div class="debug-entry info">
            <div class="debug-entry-header">å¯¹è¯ä¸Šä¸‹æ–‡ä¿¡æ¯</div>
            <div class="debug-entry-content">
                <p><strong>æ¶ˆæ¯æ•°é‡:</strong> ${contextInfo.message_count || 0}</p>
                <p><strong>ä¸Šä¸‹æ–‡é•¿åº¦:</strong> ${contextInfo.context_length || 0} å­—ç¬¦</p>
                <p><strong>ä½¿ç”¨æ‘˜è¦:</strong> ${contextInfo.has_summary ? 'æ˜¯' : 'å¦'}</p>
                <p><strong>çŸ¥è¯†åº“:</strong> ${contextInfo.knowledge_base || 'æ— '}</p>
            </div>
        </div>
    `;
    
    if (contextInfo.history) {
        debugContext.innerHTML += `
            <div class="debug-entry">
                <div class="debug-entry-header">å¯¹è¯å†å²</div>
                <div class="debug-json">${JSON.stringify(contextInfo.history, null, 2)}</div>
            </div>
        `;
    }
}

// æ›´æ–°LangChainè°ƒè¯•ä¿¡æ¯
function updateLangChainDebug(langchainInfo) {
    if (!debugMode) return;
    
    const debugLangchain = document.getElementById('debugLangchain');
    debugLangchain.innerHTML = '';
    
    if (langchainInfo.enabled) {
        debugLangchain.innerHTML += `
            <div class="debug-entry success">
                <div class="debug-entry-header">LangChainçŠ¶æ€</div>
                <div class="debug-entry-content">
                    <p><strong>çŠ¶æ€:</strong> å·²å¯ç”¨</p>
                    <p><strong>å†…å­˜ç±»å‹:</strong> ${langchainInfo.memory_type || 'æœªçŸ¥'}</p>
                    <p><strong>å¤„ç†æ—¶é—´:</strong> ${langchainInfo.processing_time || 'æœªçŸ¥'}ms</p>
                </div>
            </div>
        `;
        
        if (langchainInfo.context_info) {
            debugLangchain.innerHTML += `
                <div class="debug-entry info">
                    <div class="debug-entry-header">ä¸Šä¸‹æ–‡ç®¡ç†</div>
                    <div class="debug-json">${JSON.stringify(langchainInfo.context_info, null, 2)}</div>
                </div>
            `;
        }
        
        if (langchainInfo.processing_steps) {
            debugLangchain.innerHTML += `
                <div class="debug-entry">
                    <div class="debug-entry-header">å¤„ç†æ­¥éª¤</div>
                    <div class="debug-entry-content">
                        ${langchainInfo.processing_steps.map(step => `<p>â€¢ ${step}</p>`).join('')}
                    </div>
                </div>
            `;
        }
    } else {
        debugLangchain.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">LangChainçŠ¶æ€</div>
                <div class="debug-entry-content">LangChainæœªå¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿä¸Šä¸‹æ–‡ç®¡ç†</div>
            </div>
        `;
    }
}

// æ›´æ–°æ•°æ®åº“è°ƒè¯•ä¿¡æ¯
function updateDatabaseDebug(dbOperations) {
    if (!debugMode) return;
    
    // åœ¨å¤„ç†è¿‡ç¨‹æ ‡ç­¾é¡µæ˜¾ç¤ºæ•°æ®åº“æ“ä½œ
    const debugProcess = document.getElementById('debug-process');
    if (!debugProcess) return;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºæ•°æ®åº“æ“ä½œéƒ¨åˆ†
    let dbSection = debugProcess.querySelector('.db-operations-section');
    if (!dbSection) {
        dbSection = document.createElement('div');
        dbSection.className = 'db-operations-section';
        dbSection.innerHTML = `
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ“Š æ•°æ®åº“æ“ä½œ</div>
                <div class="db-operations-list"></div>
            </div>
        `;
        debugProcess.appendChild(dbSection);
    }
    
    const operationsList = dbSection.querySelector('.db-operations-list');
    
    // æ¸²æŸ“æ•°æ®åº“æ“ä½œ
    dbOperations.forEach(op => {
        const opDiv = document.createElement('div');
        opDiv.className = `db-operation ${getOperationLevel(op.operation)}`;
        
        const timestamp = new Date(op.timestamp * 1000).toLocaleTimeString();
        let content = `<strong>[${timestamp}]</strong> ${getOperationDescription(op)}`;
        
        if (op.duration) {
            content += ` <span class="text-muted">(${op.duration.toFixed(3)}s)</span>`;
        }
        
        if (op.error) {
            content += `<br><span class="text-danger">é”™è¯¯: ${op.error}</span>`;
        }
        
        opDiv.innerHTML = content;
        operationsList.appendChild(opDiv);
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    operationsList.scrollTop = operationsList.scrollHeight;
}

// è·å–æ“ä½œçº§åˆ«æ ·å¼
function getOperationLevel(operation) {
    const successOps = ['user_message_saved', 'save_ai_message_success', 'ai_message_queued_for_save'];
    const warningOps = ['message_already_exists', 'retry_scheduled'];
    const errorOps = ['save_ai_message_error', 'conversation_not_found', 'save_failed_final'];
    
    if (successOps.includes(operation)) return 'success';
    if (warningOps.includes(operation)) return 'warning';
    if (errorOps.includes(operation)) return 'error';
    return 'info';
}

// è·å–æ“ä½œæè¿°
function getOperationDescription(op) {
    const descriptions = {
        'user_message_saved': 'âœ… ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜',
        'ai_message_queued_for_save': 'â³ AIæ¶ˆæ¯å·²åŠ å…¥ä¿å­˜é˜Ÿåˆ—',
        'save_ai_message_start': 'ğŸ”„ å¼€å§‹ä¿å­˜AIæ¶ˆæ¯',
        'save_ai_message_success': 'âœ… AIæ¶ˆæ¯ä¿å­˜æˆåŠŸ',
        'save_ai_message_error': 'âŒ AIæ¶ˆæ¯ä¿å­˜å¤±è´¥',
        'conversation_not_found': 'âš ï¸ å¯¹è¯ä¸å­˜åœ¨',
        'message_already_exists': 'âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜',
        'retry_scheduled': 'ğŸ”„ å®‰æ’é‡è¯•ä¿å­˜',
        'save_failed_final': 'ğŸ’€ ä¿å­˜å½»åº•å¤±è´¥',
        'rollback_error': 'âš ï¸ å›æ»šå¤±è´¥',
        'stream_error': 'âŒ æµå¼å¤„ç†é”™è¯¯'
    };
    
    let desc = descriptions[op.operation] || `ğŸ“ ${op.operation}`;
    
    if (op.ai_msg_id) {
        desc += ` (ID: ${op.ai_msg_id.substring(0, 8)}...)`;
    }
    
    if (op.retry_count > 0) {
        desc += ` [é‡è¯• ${op.retry_count}]`;
    }
    
    if (op.queue_size !== undefined) {
        desc += ` [é˜Ÿåˆ—: ${op.queue_size}]`;
    }
    
    return desc;
}

// åŠ è½½ç³»ç»Ÿä¿¡æ¯
async function loadSystemInfo() {
    if (!debugMode || currentDebugTab !== 'system') return;
    
    const debugSystem = document.getElementById('debugSystem');
    debugSystem.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> åŠ è½½ä¸­...</div>';
    
    try {
        // è·å–LangChainé…ç½®
        const langchainResponse = await fetch('/api/langchain/config');
        const langchainData = await langchainResponse.json();
        
        // è·å–å¯¹è¯ç»Ÿè®¡
        const conversationsResponse = await fetch('/api/conversations');
        const conversationsData = await conversationsResponse.json();
        
        // ğŸ”¥ è·å–æ¶ˆæ¯ä¿å­˜é˜Ÿåˆ—çŠ¶æ€
        const messageSaveResponse = await fetch('/api/message_save_status');
        const messageSaveData = await messageSaveResponse.json();
        
        debugSystem.innerHTML = `
            <div class="debug-entry info">
                <div class="debug-entry-header">ç³»ç»ŸçŠ¶æ€</div>
                <div class="debug-entry-content">
                    <p><strong>å½“å‰æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>å¯¹è¯æ•°é‡:</strong> ${conversationsData.conversations?.length || 0}</p>
                    <p><strong>å½“å‰å¯¹è¯ID:</strong> ${currentConversationId || 'æ— '}</p>
                    <p><strong>è°ƒè¯•æ¨¡å¼:</strong> å·²å¼€å¯</p>
                </div>
            </div>
            
            <div class="debug-entry ${messageSaveData.success ? 'success' : 'warning'}">
                <div class="debug-entry-header">ğŸ’¾ æ¶ˆæ¯ä¿å­˜é˜Ÿåˆ—</div>
                <div class="debug-entry-content">
                    <p><strong>é˜Ÿåˆ—å¤§å°:</strong> ${messageSaveData.status?.queue_size || 0}</p>
                    <p><strong>å·¥ä½œçº¿ç¨‹:</strong> ${messageSaveData.status?.thread_status || 'æœªçŸ¥'}</p>
                    <p><strong>é˜Ÿåˆ—çŠ¶æ€:</strong> ${messageSaveData.status?.queue_empty ? 'ç©ºé—²' : 'å·¥ä½œä¸­'}</p>
                    ${messageSaveData.status?.thread_id ? `<p><strong>çº¿ç¨‹ID:</strong> ${messageSaveData.status.thread_id}</p>` : ''}
                </div>
            </div>
            
            <div class="debug-entry ${langchainData.success ? 'success' : 'warning'}">
                <div class="debug-entry-header">ğŸ”— LangChainé…ç½®</div>
                <div class="debug-json">${JSON.stringify(langchainData.config || {}, null, 2)}</div>
            </div>
        `;
    } catch (error) {
        debugSystem.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">åŠ è½½å¤±è´¥</div>
                <div class="debug-entry-content">æ— æ³•åŠ è½½ç³»ç»Ÿä¿¡æ¯: ${error.message}</div>
            </div>
        `;
    }
}

// åŠ è½½æ•°æ®åº“ä¿¡æ¯å¯è§†åŒ–
async function loadDatabaseInfo() {
    if (!debugMode || currentDebugTab !== 'database') return;
    
    const debugDatabase = document.getElementById('debugDatabase');
    
    // åˆ›å»ºæœç´¢ç•Œé¢
    debugDatabase.innerHTML = `
        <div class="database-search-panel">
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ” æ•°æ®åº“æœç´¢</div>
                <div class="debug-entry-content">
                    <div class="search-controls" style="margin-bottom: 12px;">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="dbSearchInput" placeholder="è¾“å…¥å¯¹è¯IDæˆ–å…³é”®è¯æœç´¢..." />
                            <select class="form-select" id="dbSearchType" style="max-width: 150px;">
                                <option value="keyword">å…³é”®è¯æœç´¢</option>
                                <option value="conversation_id">å¯¹è¯ID</option>
                                <option value="all">å…¨éƒ¨</option>
                            </select>
                            <button class="btn btn-primary" type="button" id="dbSearchBtn">æœç´¢</button>
                        </div>
                    </div>
                    <div class="search-quick-actions">
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchCurrentConv()">å½“å‰å¯¹è¯</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchType('ç”¨æˆ·')">ç”¨æˆ·æ¶ˆæ¯</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchType('assistant')">AIå›å¤</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearDatabaseSearch()">æ¸…ç©º</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="databaseSearchResults"></div>
        <div id="databaseCurrentInfo"></div>
    `;
    
    // ç»‘å®šæœç´¢äº‹ä»¶
    document.getElementById('dbSearchBtn').addEventListener('click', performDatabaseSearch);
    document.getElementById('dbSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performDatabaseSearch();
        }
    });
    
    // è‡ªåŠ¨åŠ è½½å½“å‰å¯¹è¯ä¿¡æ¯
    await loadCurrentDatabaseInfo();
}

// æ‰§è¡Œæ•°æ®åº“æœç´¢
async function performDatabaseSearch() {
    const searchInput = document.getElementById('dbSearchInput');
    const searchType = document.getElementById('dbSearchType');
    const resultsDiv = document.getElementById('databaseSearchResults');
    
    const query = searchInput.value.trim();
    if (!query) {
        resultsDiv.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">âš ï¸ æœç´¢æç¤º</div>
                <div class="debug-entry-content">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>
            </div>
        `;
        return;
    }
    
    resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> æœç´¢ä¸­...</div>';
    
    try {
        const response = await fetch(`/api/database_search?q=${encodeURIComponent(query)}&type=${searchType.value}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'æœç´¢å¤±è´¥');
        }
        
        renderSearchResults(data.results, query);
        
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">âŒ æœç´¢å¤±è´¥</div>
                <div class="debug-entry-content">${error.message}</div>
            </div>
        `;
    }
}

// æ¸²æŸ“æœç´¢ç»“æœ
function renderSearchResults(results, query) {
    const resultsDiv = document.getElementById('databaseSearchResults');
    
    if (results.conversations.length === 0 && results.messages.length === 0) {
        resultsDiv.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">ğŸ” æœç´¢ç»“æœ</div>
                <div class="debug-entry-content">æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ</div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="debug-entry success">
            <div class="debug-entry-header">ğŸ” æœç´¢ç»“æœ</div>
            <div class="debug-entry-content">
                <p><strong>æœç´¢å…³é”®è¯:</strong> "${query}"</p>
                <p><strong>æ‰¾åˆ°å¯¹è¯:</strong> ${results.search_stats.conversations_found} ä¸ª</p>
                <p><strong>æ‰¾åˆ°æ¶ˆæ¯ç»„:</strong> ${results.search_stats.message_groups_found} ä¸ª</p>
                <p><strong>åŒ¹é…æ¶ˆæ¯æ•°:</strong> ${results.search_stats.total_message_matches} æ¡</p>
                <p><strong>æœç´¢æ—¶é—´:</strong> ${results.search_stats.search_time}</p>
            </div>
        </div>
    `;
    
    // æ¸²æŸ“å¯¹è¯ç»“æœ
    if (results.conversations.length > 0) {
        html += `
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ’¬ åŒ¹é…çš„å¯¹è¯ (${results.conversations.length})</div>
                <div class="debug-entry-content">
                    <div style="max-height: 300px; overflow-y: auto;">
        `;
        
        results.conversations.forEach(conv => {
            html += `
                <div class="conversation-result" style="margin-bottom: 12px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer;" onclick="loadSpecificConversation('${conv.id}')">
                    <div style="font-weight: bold; color: #007bff;">${highlightText(conv.title, query)}</div>
                    <div style="font-size: 11px; color: #666;">
                        ID: <code>${conv.id}</code>
                        ${conv.match_type ? `| ${conv.match_type}` : ''}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        æ¶ˆæ¯æ•°: ${conv.message_count} | åˆ›å»º: ${conv.created_at_formatted}
                        ${conv.matching_messages_count !== undefined ? `| åŒ¹é…æ¶ˆæ¯: ${conv.matching_messages_count}` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“æ¶ˆæ¯ç»“æœ
    if (results.messages.length > 0) {
        html += `
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ“ åŒ¹é…çš„æ¶ˆæ¯</div>
                <div class="debug-entry-content">
                    <div style="max-height: 400px; overflow-y: auto;">
        `;
        
        results.messages.forEach(group => {
            html += `
                <div class="message-group-result" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 10px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">
                        ğŸ“ ${group.conversation_title}
                        <span style="font-size: 11px; color: #666;">(${group.messages.length} æ¡åŒ¹é…)</span>
                    </div>
            `;
            
            group.messages.forEach(msg => {
                const roleColor = msg.role === 'user' ? '#007bff' : '#28a745';
                const roleIcon = msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                
                html += `
                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                            ${roleIcon} <span style="color: ${roleColor};">${msg.role.toUpperCase()}</span> 
                            | ${msg.created_at_formatted} 
                            | ${msg.content_length} å­—ç¬¦
                            | Token: ${msg.token_count || 0}
                        </div>
                        <div style="font-size: 12px; line-height: 1.4;">
                            ${highlightText(msg.content_preview, query)}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
}

// é«˜äº®æœç´¢å…³é”®è¯
function highlightText(text, query) {
    if (!query || !text) return text;
    
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark style="background-color: yellow; padding: 1px 2px;">$1</mark>');
}

// å¿«é€Ÿæœç´¢åŠŸèƒ½
function quickSearchCurrentConv() {
    if (currentConversationId) {
        document.getElementById('dbSearchInput').value = currentConversationId;
        document.getElementById('dbSearchType').value = 'conversation_id';
        performDatabaseSearch();
    }
}

function quickSearchType(type) {
    document.getElementById('dbSearchInput').value = type;
    document.getElementById('dbSearchType').value = 'keyword';
    performDatabaseSearch();
}

function clearDatabaseSearch() {
    document.getElementById('dbSearchInput').value = '';
    document.getElementById('databaseSearchResults').innerHTML = '';
}

// åŠ è½½æŒ‡å®šå¯¹è¯çš„è¯¦ç»†ä¿¡æ¯
async function loadSpecificConversation(conversationId) {
    const currentInfoDiv = document.getElementById('databaseCurrentInfo');
    currentInfoDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> åŠ è½½å¯¹è¯è¯¦æƒ…ä¸­...</div>';
    
    try {
        const response = await fetch(`/api/conversation_database_info/${conversationId}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'è·å–å¯¹è¯ä¿¡æ¯å¤±è´¥');
        }
        
        renderConversationDetails(data);
        
    } catch (error) {
        currentInfoDiv.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">âŒ åŠ è½½å¤±è´¥</div>
                <div class="debug-entry-content">${error.message}</div>
            </div>
        `;
    }
}

// åŠ è½½å½“å‰å¯¹è¯ä¿¡æ¯
async function loadCurrentDatabaseInfo() {
    if (!currentConversationId) {
        document.getElementById('databaseCurrentInfo').innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">âš ï¸ æ— å¯¹è¯é€‰ä¸­</div>
                <div class="debug-entry-content">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯æ¥æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½</div>
            </div>
        `;
        return;
    }
    
    await loadSpecificConversation(currentConversationId);
}

// æ¸²æŸ“å¯¹è¯è¯¦ç»†ä¿¡æ¯
function renderConversationDetails(data) {
    const currentInfoDiv = document.getElementById('databaseCurrentInfo');
    const { conversation, messages, statistics, table_info, user_info, query_stats } = data;
        
    currentInfoDiv.innerHTML = `
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ’¬ æ¶ˆæ¯åˆ—è¡¨ (${messages.length})</div>
                <div class="debug-entry-content">
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px;">
                        ${messages.map(msg => `
                            <div style="margin-bottom: 10px; padding: 8px; border-radius: 4px; background: ${msg.role === 'user' ? 'rgba(0,123,255,0.1)' : 'rgba(40,167,69,0.1)'};">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    <strong>#${msg.sequence}</strong> | 
                                    <span style="color: ${msg.role === 'user' ? '#007bff' : '#28a745'};">${msg.role.toUpperCase()}</span> | 
                                    ${msg.created_at_formatted}
                                    ${msg.time_diff_formatted ? ` | â±ï¸ ${msg.time_diff_formatted}` : ''}
                                </div>
                                <div style="font-size: 12px;">
                                    <strong>ID:</strong> <code style="font-size: 10px;">${msg.id}</code><br>
                                    <strong>é•¿åº¦:</strong> ${msg.content_length} å­—ç¬¦ | <strong>Token:</strong> ${msg.token_count || 0}<br>
                                    <strong>å†…å®¹:</strong> ${msg.content_preview}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <!-- å¯¹è¯ç»Ÿè®¡ -->
            <div class="debug-entry success">
                <div class="debug-entry-header">ğŸ“Š å¯¹è¯ç»Ÿè®¡</div>
                <div class="debug-entry-content">
                    <p><strong>å¯¹è¯ID:</strong> <code>${conversation.id}</code></p>
                    <p><strong>æ ‡é¢˜:</strong> ${conversation.title}</p>
                    <p><strong>æ€»æ¶ˆæ¯æ•°:</strong> ${statistics.total_messages} (ç”¨æˆ·: ${statistics.user_messages}, AI: ${statistics.ai_messages})</p>
                    <p><strong>æ€»å­—ç¬¦æ•°:</strong> ${statistics.total_characters.toLocaleString()}</p>
                    <p><strong>æ€»Tokenæ•°:</strong> ${statistics.total_tokens.toLocaleString()}</p>
                    <p><strong>å¹³å‡æ¶ˆæ¯é•¿åº¦:</strong> ${statistics.avg_message_length} å­—ç¬¦</p>
                    ${statistics.conversation_duration_formatted ? `<p><strong>å¯¹è¯æŒç»­æ—¶é—´:</strong> ${statistics.conversation_duration_formatted}</p>` : ''}
                    <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${conversation.created_at_formatted}</p>
                </div>
            </div>
            
            <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</div>
                <div class="debug-entry-content">
                    <p><strong>ç”¨æˆ·å:</strong> ${user_info.username}</p>
                    <p><strong>é‚®ç®±:</strong> ${user_info.email}</p>
                    <p><strong>æ³¨å†Œæ—¶é—´:</strong> ${user_info.created_at_formatted}</p>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç»Ÿè®¡ -->
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ“ˆ ç”¨æˆ·ç»Ÿè®¡</div>
                <div class="debug-entry-content">
                    <p><strong>ç”¨æˆ·å¯¹è¯æ•°:</strong> ${query_stats.user_total_conversations}</p>
                    <p><strong>ç”¨æˆ·æ¶ˆæ¯æ•°:</strong> ${query_stats.user_total_messages}</p>
                    <p><strong>æ•°æ®åº“æ€»å¯¹è¯:</strong> ${query_stats.database_total_conversations}</p>
                    <p><strong>æ•°æ®åº“æ€»æ¶ˆæ¯:</strong> ${query_stats.database_total_messages}</p>
                </div>
            </div>
        `;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–Markdownè§£æå™¨
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
    }
    
    loadKnowledgeBases();
    setupEventListeners();
    loadConversationsAndInitialize();
    
    // ğŸ”¥ ä¿®å¤ï¼šåˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateSendButtonState();
    
    // åˆå§‹åŒ–è°ƒè¯•åŠŸèƒ½
    initializeDebugFeatures();
    
    // åœ¨èŠå¤©é¡µé¢ç¦ç”¨å…¨å±€ä¾§è¾¹æ åŠŸèƒ½
    disableGlobalSidebar();
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const chatForm = document.getElementById('chatForm');
    const newChatBtn = document.getElementById('newChatBtn');
    const sendBtn = document.getElementById('sendBtn');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const showSidebar = document.getElementById('showSidebar');
    const conversationSearch = document.getElementById('conversationSearch');
    const sidebarOverlay = document.getElementById('sidebarOverlay'); // ä½¿ç”¨base.htmlä¸­çš„é®ç½©å±‚
    const sidebarTriggerChat = document.getElementById('sidebarTriggerChat');
    
    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        
        // ğŸ”¥ ä¿®å¤ï¼šå®æ—¶æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€ï¼ˆç«‹å³æ£€æŸ¥ï¼Œæ— å»¶è¿Ÿï¼‰
        setTimeout(() => updateSendButtonState(), 0);
    });
    
    // ğŸ”¥ æ–°å¢ï¼šå¢å¼ºè¾“å…¥æ¡†äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
    messageInput.addEventListener('focus', function() {
        console.log('[è¾“å…¥æ¡†èšç„¦] æ£€æŸ¥å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€');
        setTimeout(() => updateSendButtonState(), 0);
    });
    
    messageInput.addEventListener('keyup', function() {
        // é˜²æŠ–å¤„ç†ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„æ›´æ–°
        clearTimeout(window.updateButtonTimeout);
        window.updateButtonTimeout = setTimeout(() => updateSendButtonState(), 50);
    });
    
    // é”®ç›˜å¿«æ·é”®
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading && this.value.trim()) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // è¡¨å•æäº¤
    chatForm.addEventListener('submit', handleSendMessage);
    
    // æ–°å¯¹è¯æŒ‰é’®
    newChatBtn.addEventListener('click', startNewConversation);
    
    // ä¾§è¾¹æ æ§åˆ¶
    toggleSidebar.addEventListener('click', hideSidebar);
    showSidebar.addEventListener('click', showSidebarPanel);
    if (sidebarTriggerChat) {
        sidebarTriggerChat.addEventListener('click', showSidebarPanel);
    }
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', hideSidebar); // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
    }
    
    // å¯¹è¯æœç´¢
    conversationSearch.addEventListener('input', filterConversations);
}

// ç¦ç”¨å…¨å±€ä¾§è¾¹æ åŠŸèƒ½
function disableGlobalSidebar() {
    // éšè—å…¨å±€ä¾§è¾¹æ 
    const globalSidebar = document.getElementById('sidebar');
    if (globalSidebar) {
        globalSidebar.style.display = 'none';
    }
    
    // ç§»é™¤å…¨å±€ä¾§è¾¹æ è§¦å‘å™¨çš„äº‹ä»¶ç›‘å¬
    const globalTrigger = document.getElementById('sidebarTrigger');
    if (globalTrigger) {
        globalTrigger.style.display = 'none';
        // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        globalTrigger.replaceWith(globalTrigger.cloneNode(true));
    }
    
    // ç§»é™¤å…¨å±€ä¾§è¾¹æ çš„é¼ æ ‡äº‹ä»¶
    const globalSidebarOverlay = document.getElementById('sidebarOverlay');
    if (globalSidebarOverlay) {
        // åªåœ¨èŠå¤©é¡µé¢ä½¿ç”¨é®ç½©å±‚ï¼Œä¸è®©å…¨å±€ä¾§è¾¹æ ä½¿ç”¨
        globalSidebarOverlay.removeAttribute('onclick');
    }
    
    // éšè—é¡¶éƒ¨å¯¼èˆªæ çš„ä¾§è¾¹æ æŒ‰é’®
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.style.display = 'none';
    }
    
    console.log('å…¨å±€ä¾§è¾¹æ åŠŸèƒ½å·²åœ¨èŠå¤©é¡µé¢ç¦ç”¨');
}

// åŠ è½½å¯¹è¯åˆ—è¡¨å¹¶åˆå§‹åŒ–é¡µé¢
async function loadConversationsAndInitialize() {
    try {
        const response = await fetch('/api/conversations');
        const data = await response.json();
        
        if (data.success) {
            conversations = data.conversations;
            renderConversationList(conversations);
            
            // å¦‚æœæœ‰å¯¹è¯å†å²ï¼Œè‡ªåŠ¨åŠ è½½æœ€è¿‘çš„å¯¹è¯
            if (conversations.length > 0) {
                const latestConversation = conversations[0]; // å·²æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
                await switchConversation(latestConversation.id);
            } else {
                // æ²¡æœ‰å†å²å¯¹è¯ï¼Œæ˜¾ç¤ºæ–°å¯¹è¯é¡µé¢
                startNewConversation();
            }
        } else {
            console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', data.message);
            startNewConversation();
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¼‚å¸¸:', error);
        startNewConversation();
    }
}

// åŠ è½½å¯¹è¯åˆ—è¡¨ï¼ˆä¸åˆå§‹åŒ–é¡µé¢ï¼‰
async function loadConversations() {
    try {
        // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
        const response = await fetch(`/api/conversations?t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            conversations = data.conversations;
            renderConversationList(conversations);
        } else {
            console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¼‚å¸¸:', error);
    }
}

// æ¸²æŸ“å¯¹è¯åˆ—è¡¨
function renderConversationList(conversationList) {
    const conversationListEl = document.getElementById('conversationList');
    
    if (conversationList.length === 0) {
        conversationListEl.innerHTML = `
            <div class="empty-conversations text-center py-4">
                <i class="bi bi-chat-text text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">è¿˜æ²¡æœ‰å¯¹è¯å†å²</p>
                <small class="text-muted">ç‚¹å‡»ä¸Šæ–¹"æ–°å»ºå¯¹è¯"å¼€å§‹</small>
            </div>
        `;
        return;
    }
    
    const conversationItems = conversationList.map(conv => {
        const isActive = conv.id === currentConversationId;
        
        // å®‰å…¨çš„æ—¥æœŸå¤„ç†
        let lastUpdate = 'æœªçŸ¥æ—¶é—´';
        try {
            if (conv.last_message_time) {
                const date = new Date(conv.last_message_time);
                if (!isNaN(date.getTime())) {
                    const now = new Date();
                    const diffMs = now - date;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffHours / 24);
                    
                    if (diffDays > 0) {
                        lastUpdate = `${diffDays}å¤©å‰`;
                    } else if (diffHours > 0) {
                        lastUpdate = `${diffHours}å°æ—¶å‰`;
                    } else {
                        const diffMinutes = Math.floor(diffMs / (1000 * 60));
                        lastUpdate = diffMinutes > 0 ? `${diffMinutes}åˆ†é’Ÿå‰` : 'åˆšåˆš';
                    }
                }
            } else if (conv.updated_at) {
                const date = new Date(conv.updated_at);
                if (!isNaN(date.getTime())) {
                    lastUpdate = date.toLocaleDateString();
                }
            }
        } catch (error) {
            console.warn('æ—¥æœŸè§£æå¤±è´¥:', conv.updated_at, error);
        }
        
        // æ¶ˆæ¯é¢„è§ˆ
        const messagePreview = conv.last_message_preview || 'æš‚æ— æ¶ˆæ¯';
        
        return `
            <div class="conversation-item ${isActive ? 'active' : ''}" 
                 data-conversation-id="${conv.id}"
                 onclick="switchConversation('${conv.id}')">
                <div class="conversation-content">
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-preview">
                        <small class="text-muted">${messagePreview}</small>
                    </div>
                    <div class="conversation-meta">
                        <small class="text-muted">
                            <i class="bi bi-chat-dots"></i> ${conv.message_count} æ¡æ¶ˆæ¯
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${lastUpdate}
                        </small>
                    </div>
                </div>
                <div class="conversation-actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConversation('${conv.id}', event)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    conversationListEl.innerHTML = conversationItems;
}

// åˆ‡æ¢å¯¹è¯
async function switchConversation(conversationId) {
    if (conversationId === currentConversationId) {
        console.log('åˆ‡æ¢åˆ°ç›¸åŒå¯¹è¯ï¼Œè·³è¿‡');
        return;
    }
    
    console.log(`[UI] åˆ‡æ¢å¯¹è¯: ${conversationId}`);
    currentConversationId = conversationId;
    
    // æ›´æ–°UIçŠ¶æ€
    updateActiveConversation(conversationId);
    
    // åŠ è½½å¯¹è¯å†å²
    await loadConversationHistory(conversationId);
    
    // å¦‚æœè°ƒè¯•æ¨¡å¼å¼€å¯ä¸”å½“å‰åœ¨æ•°æ®åº“æ ‡ç­¾ï¼Œåˆ·æ–°æ•°æ®åº“ä¿¡æ¯
    if (debugMode && currentDebugTab === 'database') {
        await loadDatabaseInfo();
    }
}

// æ›´æ–°æ´»è·ƒå¯¹è¯çŠ¶æ€
function updateActiveConversation(conversationId) {
    // æ›´æ–°å¯¹è¯åˆ—è¡¨ä¸­çš„æ´»è·ƒçŠ¶æ€
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.conversationId === conversationId) {
            item.classList.add('active');
        }
    });
    
    // æ›´æ–°æ ‡é¢˜
    const conversation = conversations.find(c => c.id === conversationId);
    if (conversation) {
        document.getElementById('currentChatTitle').textContent = conversation.title;
    }
}

// åŠ è½½å¯¹è¯å†å²
async function loadConversationHistory(conversationId) {
    try {
        // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
        const response = await fetch(`/api/conversations/${conversationId}/messages?t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            console.log(`[æ•°æ®åº“] åŠ è½½å¯¹è¯å†å²: ${data.messages ? data.messages.length : 0} æ¡æ¶ˆæ¯`);
            
            // æ¸…ç©ºå½“å‰èŠå¤©åŒºåŸŸ
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            console.log('èŠå¤©åŒºåŸŸå·²æ¸…ç©º');
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if (data.messages && data.messages.length > 0) {
                // console.log('å¼€å§‹æ¸²æŸ“å†å²æ¶ˆæ¯...');
                
                // æµ‹è¯•addMessageå‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof addMessage !== 'function') {
                    console.error('addMessage å‡½æ•°ä¸å­˜åœ¨!');
                    return;
                }
                
                data.messages.forEach((msg, index) => {
                    // console.log(`æ¸²æŸ“å†å²æ¶ˆæ¯ ${index + 1}:`, {
                    //     role: msg.role,
                    //     content: msg.content.substring(0, 100) + '...',
                    //     contentLength: msg.content.length
                    // });
                    
                    try {
                        addMessage(msg.role, msg.content);
                        // console.log(`æ¶ˆæ¯ ${index + 1} æ¸²æŸ“å®Œæˆ`);
                    } catch (error) {
                        console.error(`æ¸²æŸ“æ¶ˆæ¯ ${index + 1} å¤±è´¥:`, error);
                    }
                });
                console.log(`[UI] å·²æ¸²æŸ“ ${data.messages.length} æ¡å†å²æ¶ˆæ¯`);
                
                // æ£€æŸ¥æ¸²æŸ“åçš„DOM
                const messagesAfter = chatMessages.children.length;
                // console.log('æ¸²æŸ“åèŠå¤©åŒºåŸŸçš„å­å…ƒç´ æ•°é‡:', messagesAfter);
            } else {
                console.log('è¯¥å¯¹è¯æš‚æ— å†å²æ¶ˆæ¯');
            }
            
            // éšè—æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                scrollToBottom();
            }, 100);
        } else {
            console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯å†å²å¼‚å¸¸:', error);
    }
}

// å¼€å§‹æ–°å¯¹è¯
function startNewConversation() {
    currentConversationId = null;
    
    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="welcome-message" id="welcomeMessage">
            <i class="bi bi-chat-dots welcome-icon"></i>
            <h4>å¼€å§‹æ–°çš„å¯¹è¯</h4>
            <p>å‘æˆ‘æé—®ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä¼šåŸºäºæ‚¨çš„çŸ¥è¯†åº“ä¸ºæ‚¨æä¾›å‡†ç¡®çš„ç­”æ¡ˆã€‚</p>
        </div>
    `;
    
    // æ›´æ–°æ ‡é¢˜
    document.getElementById('currentChatTitle').textContent = 'æ™ºèƒ½é—®ç­”';
    
    // æ¸…é™¤æ´»è·ƒçŠ¶æ€
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById('messageInput').focus();
}

// åˆ é™¤å¯¹è¯
async function deleteConversation(conversationId, event) {
    event.stopPropagation();
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/conversations/${conversationId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œå¼€å§‹æ–°å¯¹è¯
            if (conversationId === currentConversationId) {
                startNewConversation();
            }
            
            // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
            await loadConversations();
        } else {
            alert('åˆ é™¤å¯¹è¯å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¯¹è¯å¼‚å¸¸:', error);
        alert('åˆ é™¤å¯¹è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// è¿‡æ»¤å¯¹è¯
function filterConversations() {
    const searchTerm = document.getElementById('conversationSearch').value.toLowerCase();
    const filteredConversations = conversations.filter(conv => 
        conv.title.toLowerCase().includes(searchTerm)
    );
    renderConversationList(filteredConversations);
}

// æ˜¾ç¤º/éšè—ä¾§è¾¹æ 
function showSidebarPanel() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const chatContainer = document.getElementById('chatContainer');
    
    sidebar.classList.remove('hidden');
    sidebar.classList.add('show');
    chatContainer.classList.remove('sidebar-hidden');
    
    // ç§»åŠ¨ç«¯æ˜¾ç¤ºé®ç½©å±‚
    if (window.innerWidth <= 768 && overlay) {
        overlay.classList.add('show');
    }
}

function hideSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const chatContainer = document.getElementById('chatContainer');
    
    sidebar.classList.remove('show');
    sidebar.classList.add('hidden');
    chatContainer.classList.add('sidebar-hidden');
    
    if (overlay) {
        overlay.classList.remove('show');
    }
}

// å¤„ç†å‘é€æ¶ˆæ¯
async function handleSendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const message = messageInput.value.trim();
    
    if (!message || isLoading) return;
    
    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    addDebugEntry('user', `å‘é€æ¶ˆæ¯: ${message.substring(0, 100)}${message.length > 100 ? '...' : ''}`, 'info');
    
    try {
        // ä¿å­˜å‘é€å‰çš„çŠ¶æ€
        const previousState = {
            message: message,
            conversationId: currentConversationId
        };
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        isLoading = true;
        window.lastSendTime = Date.now(); // è®°å½•å‘é€æ—¶é—´ï¼Œç”¨äºè¶…æ—¶æ£€æµ‹
        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
        updateSendButtonState();
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        addDebugEntry('system', 'ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ åˆ°ç•Œé¢', 'info');
        
        // è®¾ç½®æ¢å¤è¶…æ—¶
        const recoveryTimeout = setTimeout(() => {
            if (isLoading) {
                console.warn('[é”™è¯¯æ¢å¤] æ£€æµ‹åˆ°è¯·æ±‚å¯èƒ½è¶…æ—¶ï¼Œå°è¯•æ¢å¤çŠ¶æ€');
                addDebugEntry('error', 'è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œå°è¯•æ¢å¤çŠ¶æ€', 'error');
                recoverFromError(previousState);
            }
        }, 30000); // 30ç§’è¶…æ—¶
        
        try {
            // ä½¿ç”¨æµå¼å“åº”
            const url = new URL('/api/chat', window.location.origin);
            url.searchParams.set('stream', 'true');
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: currentConversationId,
                    knowledge_base_id: document.getElementById('knowledgeBaseSelect').value || null
                })
            });
            
            // æ¸…é™¤æ¢å¤è¶…æ—¶
            clearTimeout(recoveryTimeout);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
                    // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
        const assistantMessageDiv = createMessageContainer('assistant');
        const messageContent = assistantMessageDiv.querySelector('.message-content');
        let aiResponse = '';
        
        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºç­‰å¾…åŠ¨ç”»
        messageContent.innerHTML = `
            <div class="waiting-animation">
                <span class="waiting-text">æ­£åœ¨æ€è€ƒ</span>
                <span class="waiting-dots">
                    <span>.</span><span>.</span><span>.</span>
                </span>
            </div>
        `;
        
        // ğŸ”¥ æ–°å¢ï¼šéšè—æ¸²æŸ“æŒ‰é’®ç›´åˆ°è¾“å‡ºå®Œæˆ
        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
            
            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            switch (data.type) {
                                case 'start':
                                    addDebugEntry('stream', 'å¼€å§‹æ¥æ”¶AIå“åº”', 'info');
                                    currentConversationId = data.conversation_id;
                                    
                                    // ä¿å­˜è°ƒè¯•ä¿¡æ¯
                                    if (data.debug_info) {
                                        addDebugEntry('debug', 'æ”¶åˆ°è°ƒè¯•ä¿¡æ¯', 'info', data.debug_info);
                                    }
                                    
                                    // æ›´æ–°å¯¹è¯æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰
                                    if (!conversations.find(c => c.id === currentConversationId)) {
                                        const title = message.length > 30 ? message.substring(0, 30) + '...' : message;
                                        document.getElementById('currentChatTitle').textContent = title;
                                        
                                        // ç«‹å³æ·»åŠ æ–°å¯¹è¯åˆ°åˆ—è¡¨é¡¶éƒ¨
                                        const newConversation = {
                                            id: currentConversationId,
                                            title: title,
                                            created_at: new Date().toISOString(),
                                            message_count: 1
                                        };
                                        conversations.unshift(newConversation);
                                        renderConversationList(conversations);
                                        
                                        // è®¾ç½®ä¸ºæ´»è·ƒçŠ¶æ€
                                        setTimeout(() => {
                                            const newItem = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
                                            if (newItem) {
                                                document.querySelectorAll('.conversation-item').forEach(item => {
                                                    item.classList.remove('active');
                                                });
                                                newItem.classList.add('active');
                                            }
                                        }, 100);
                                    }
                                    break;
                                case 'processing':
                                    // ğŸ”¥ ä¿®å¤BUG2ï¼šå¤„ç†å¤„ç†çŠ¶æ€æ¶ˆæ¯ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
                                    console.log('[æ¨¡å‹] å¤„ç†çŠ¶æ€:', data.status);
                                    addDebugEntry('stream', `å¤„ç†çŠ¶æ€: ${data.status}`, 'info');
                                    break;
                                case 'content':
                                    aiResponse += data.content;
                                    
                                    // ğŸ”¥ æ–°å¢ï¼šç¬¬ä¸€æ¬¡æ”¶åˆ°å†…å®¹æ—¶æ¸…é™¤ç­‰å¾…åŠ¨ç”»
                                    if (aiResponse === data.content && messageContent.querySelector('.waiting-animation')) {
                                        messageContent.innerHTML = '';
                                    }
                                    
                                    // æ›´æ–°åŸæ–‡å†…å®¹
                                    const messageRaw = assistantMessageDiv.querySelector('.message-raw');
                                    if (messageRaw) {
                                        messageRaw.textContent = aiResponse;
                                    }
                                    // æ¸²æŸ“Markdown
                                    messageContent.innerHTML = renderMarkdown(aiResponse);
                                    // ä»£ç é«˜äº®å’Œå¤åˆ¶æŒ‰é’®
                                    messageContent.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightElement(block);
                                        addCopyButtonToCodeBlock(block.parentElement);
                                    });
                                    // æ¸²æŸ“æ•°å­¦å…¬å¼
                                    renderMath(messageContent);
                                    scrollToBottom();
                                    break;
                                case 'done':
                                    console.log('[æ¨¡å‹] æµå¼å“åº”å®Œæˆ');
                                    addDebugEntry('stream', 'æµå¼å“åº”å®Œæˆ', 'success');
                                    try {
                                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                                        if (data.debug_info) {
                                            addDebugEntry('debug', 'æ”¶åˆ°å®Œæ•´è°ƒè¯•ä¿¡æ¯', 'success', data.debug_info);
                                            
                                            // ğŸ”¥ æ˜¾ç¤ºæ•°æ®åº“æ“ä½œä¿¡æ¯
                                            if (data.debug_info.db_operations && data.debug_info.db_operations.length > 0) {
                                                updateDatabaseDebug(data.debug_info.db_operations);
                                            }
                                            
                                            // æ›´æ–°å„è°ƒè¯•é¢æ¿çš„ä¿¡æ¯
                                            if (data.debug_info.context_info) {
                                                updateContextDebug(data.debug_info.context_info);
                                            }
                                            
                                            if (data.debug_info.langchain_enabled) {
                                                updateLangChainDebug({
                                                    enabled: true,
                                                    memory_type: data.debug_info.langchain_result?.context_info?.memory_type,
                                                    processing_time: data.debug_info.timing?.total_time,
                                                    context_info: data.debug_info.context_info,
                                                    processing_steps: data.debug_info.processing_steps
                                                });
                                            } else {
                                                updateLangChainDebug({
                                                    enabled: false
                                                });
                                            }
                                            
                                            // æ˜¾ç¤ºæ¶ˆæ¯ä¿å­˜çŠ¶æ€
                                            if (data.debug_info.final_stats) {
                                                const stats = data.debug_info.final_stats;
                                                addDebugEntry('database', 
                                                    `æ¶ˆæ¯ä¿å­˜çŠ¶æ€: ${stats.save_queued ? 'å·²åŠ å…¥é˜Ÿåˆ—' : 'æœªä¿å­˜'}, é˜Ÿåˆ—å¤§å°: ${stats.queue_size || 0}`, 
                                                    stats.save_queued ? 'success' : 'warning'
                                                );
                                            }
                                        }
                                        
                                        // æµå¼å“åº”å·²å®Œæˆï¼ŒAIæ¶ˆæ¯å·²åœ¨æœåŠ¡å™¨ç«¯ä¿å­˜
                                        console.log(`[æ•°æ®åº“] AIæ¶ˆæ¯å·²ä¿å­˜: ${data.message_id}`);
                                        
                                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°
                                        await loadConversations();
                                        console.log('[UI] å¯¹è¯åˆ—è¡¨å·²åˆ·æ–°');
                                        
                                        // é‡ç½®æ‰€æœ‰çŠ¶æ€
                                        isLoading = false;
                                        window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
                                        
                                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°  
                                        updateSendButtonState();
                                        
                                        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºæ¸²æŸ“æŒ‰é’®
                                        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
                                        if (toggleBtn) {
                                            toggleBtn.style.display = 'inline-block';
                                        }
                                        
                                        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                                        const messageInput = document.getElementById('messageInput');
                                        if (messageInput) {
                                            messageInput.focus();
                                        }
                                        
                                        addDebugEntry('system', 'æ¶ˆæ¯å¤„ç†å®Œæˆï¼ŒçŠ¶æ€å·²é‡ç½®', 'success');
                                        
                                    } catch (error) {
                                        console.error('doneäº‹ä»¶å¤„ç†å¼‚å¸¸:', error);
                                        addDebugEntry('error', `doneäº‹ä»¶å¤„ç†å¼‚å¸¸: ${error.message}`, 'error');
                                    }
                                    break;
                                case 'error':
                                    console.error('AIå“åº”é”™è¯¯:', data.error);
                                    try {
                                        const errorMessage = `æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ï¼š${data.error}`;
                                        messageContent.innerHTML = renderMarkdown(errorMessage);
                                        assistantMessageDiv.querySelector('.message-bubble').classList.add('error');
                                        // æ›´æ–°åŸæ–‡å†…å®¹
                                        const errorMessageRaw = assistantMessageDiv.querySelector('.message-raw');
                                        if (errorMessageRaw) {
                                            errorMessageRaw.textContent = errorMessage;
                                        }
                                        // æ¸²æŸ“æ•°å­¦å…¬å¼
                                        renderMath(messageContent);
                                    } catch (error) {
                                        console.error('erroräº‹ä»¶å¤„ç†å¼‚å¸¸:', error);
                                    } finally {
                                        // é‡ç½®åŠ è½½çŠ¶æ€
                                        isLoading = false;
                                        window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
                                        
                                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
                                        updateSendButtonState();
                                        
                                        // ğŸ”¥ æ–°å¢ï¼šé”™è¯¯æ—¶ä¹Ÿè¦æ˜¾ç¤ºæ¸²æŸ“æŒ‰é’®
                                        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
                                        if (toggleBtn) {
                                            toggleBtn.style.display = 'inline-block';
                                        }
                                        
                                        console.log('erroräº‹ä»¶å¤„ç†å®Œæˆï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤ï¼ŒisLoading=', isLoading);
                                    }
                                    break;
                            }
                        } catch (e) {
                            console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            }
            
        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            recoverFromError(previousState);
            addMessage('assistant', 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
        }
    } catch (error) {
        console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
        addMessage('assistant', 'æŠ±æ­‰ï¼Œå¤„ç†æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
    }
}

// æ·»åŠ é”™è¯¯æ¢å¤å‡½æ•°
function recoverFromError(previousState) {
    console.log('[é”™è¯¯æ¢å¤] å¼€å§‹æ¢å¤çŠ¶æ€');
    
    // é‡ç½®åŠ è½½çŠ¶æ€
    isLoading = false;
    window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
    
    // æ¢å¤UIå…ƒç´ 
    const messageInput = document.getElementById('messageInput');
    
    // ğŸ”¥ ä¿®å¤ï¼šæ¢å¤è¾“å…¥æ¡†å†…å®¹å¹¶èšç„¦
    if (messageInput) {
        messageInput.value = previousState.message;
        messageInput.focus();
    }
    
    // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
    updateSendButtonState();
    
    // æ¢å¤å¯¹è¯ID
    if (previousState.conversationId) {
        currentConversationId = previousState.conversationId;
    }
    
    console.log('[é”™è¯¯æ¢å¤] çŠ¶æ€å·²æ¢å¤');
}

// åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼å“åº”ï¼‰
function createMessageContainer(role, isError = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const bubbleClass = isError ? 'message-bubble error' : 'message-bubble';
    
    // æ ¹æ®è§’è‰²å†³å®šå¤´åƒå’Œæ¶ˆæ¯çš„é¡ºåº
    if (role === 'user') {
        // ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ä¾§ï¼ HTMLç»“æ„è¦æ˜ç¡®ï¼šæ°”æ³¡ + å¤´åƒ
        messageDiv.innerHTML = `
            <div class="${bubbleClass}">
                <div class="message-content"></div>
            </div>
            <div class="message-avatar">
                <i class="bi bi-person-fill"></i>
            </div>
        `;
    } else {
        // AIæ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œæ¶ˆæ¯æ°”æ³¡åœ¨å³ï¼ŒåŒ…å«åˆ‡æ¢æŒ‰é’®
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi bi-robot"></i>
            </div>
            <div class="${bubbleClass}">
                <div class="message-header">
                    <button class="btn btn-outline-secondary btn-sm message-toggle-btn" 
                            onclick="toggleMessageFormat('${messageId}')" 
                            title="åˆ‡æ¢åŸæ–‡/æ¸²æŸ“è§†å›¾">
                        <i class="bi bi-eye"></i> æ¸²æŸ“
                    </button>
                </div>
                <div class="message-content" id="${messageId}"></div>
                <div class="message-raw" id="${messageId}_raw" style="display: none;"></div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function addMessage(role, content, isError = false) {
    // console.log(`æ·»åŠ æ¶ˆæ¯: role=${role}, contentLength=${content.length}, isError=${isError}`);
    
    // ğŸ”¥ ä¿®å¤BUG1ï¼šæ·»åŠ æ¶ˆæ¯æ—¶ç«‹å³éšè—æ¬¢è¿æ¶ˆæ¯
    const welcomeMessage = document.getElementById('welcomeMessage');
    if (welcomeMessage && welcomeMessage.style.display !== 'none') {
        welcomeMessage.style.display = 'none';
    }
    
    const messageDiv = createMessageContainer(role, isError);
    const messageContent = messageDiv.querySelector('.message-content');
    
    if (!messageContent) {
        console.error('æ— æ³•æ‰¾åˆ° .message-content å…ƒç´ !', messageDiv);
        return;
    }
    
    if (role === 'user') {
        // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨ç®€å•æ ¼å¼åŒ–
        messageContent.innerHTML = formatMessage(content);
        // console.log('ç”¨æˆ·æ¶ˆæ¯å·²æ¸²æŸ“');
    } else {
        // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
        const messageRaw = messageDiv.querySelector('.message-raw');
        if (messageRaw) {
            messageRaw.textContent = content; // ä¿å­˜åŸæ–‡
        } else {
            console.warn('æœªæ‰¾åˆ° .message-raw å…ƒç´ ï¼ŒAIæ¶ˆæ¯å¯èƒ½æ˜¾ç¤ºä¸å®Œæ•´');
        }
        
        const renderedContent = renderMarkdown(content);
        messageContent.innerHTML = renderedContent;
        // console.log('AIæ¶ˆæ¯å·²æ¸²æŸ“ï¼Œå†…å®¹é•¿åº¦:', renderedContent.length);
        
        // ä»£ç é«˜äº®å’Œå¤åˆ¶æŒ‰é’®
        messageContent.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
            addCopyButtonToCodeBlock(block.parentElement);
        });
        
        // æ¸²æŸ“æ•°å­¦å…¬å¼
        renderMath(messageContent);
    }
    
    scrollToBottom();
}

// æ¸²æŸ“Markdownå†…å®¹
function renderMarkdown(content) {
    try {
        // é¢„å¤„ç†æ•°å­¦å…¬å¼ï¼šå¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„å…¬å¼
        content = preprocessMathFormulas(content);
        
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });
        
        return marked.parse(content);
    } catch (error) {
        console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
        return formatMessage(content); // é™çº§åˆ°ç®€å•æ ¼å¼åŒ–
    }
}

// é¢„å¤„ç†æ•°å­¦å…¬å¼
function preprocessMathFormulas(content) {
    // console.log('å¼€å§‹é¢„å¤„ç†æ•°å­¦å…¬å¼ï¼ŒåŸå§‹å†…å®¹:', content.substring(0, 100) + '...');
    
    // 1. å¤„ç†æ¯ä¸ªç‹¬ç«‹çš„LaTeXå—çº§å…¬å¼ \[ ... \]
    let processedContent = content;
    let matches = [];
    let regex = /\\\[\s*\n?\s*([\s\S]*?)\s*\n?\s*\\\]/g;
    let match;
    
    // æ”¶é›†æ‰€æœ‰åŒ¹é…
    while ((match = regex.exec(content)) !== null) {
        matches.push({
            fullMatch: match[0],
            formula: match[1].trim(),
            index: match.index
        });
    }
    
    // console.log('æ‰¾åˆ°', matches.length, 'ä¸ªLaTeXå—çº§å…¬å¼');
    
    // ä»åå¾€å‰æ›¿æ¢ï¼Œé¿å…ç´¢å¼•åç§»
    for (let i = matches.length - 1; i >= 0; i--) {
        const m = matches[i];
        // console.log('å¤„ç†å…¬å¼', i + 1, ':', m.formula);
        const replacement = '\n$$' + m.formula + '$$\n';
        processedContent = processedContent.substring(0, m.index) + replacement + processedContent.substring(m.index + m.fullMatch.length);
    }
    
    // 2. å¤„ç†LaTeXè¡Œå†…å…¬å¼ \( ... \)
    processedContent = processedContent.replace(/\\\(\s*(.*?)\s*\\\)/g, function(match, formula) {
        formula = formula.trim();
                    // console.log('å‘ç°LaTeXè¡Œå†…å…¬å¼:', formula);
        return '$' + formula + '$';
    });
    
    // 3. å¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„æ•°å­¦å…¬å¼ [æ•°å­¦å†…å®¹]
    processedContent = processedContent.replace(/\[\s*([^[\]]*(?:\\[^[\]]*)*[^[\]]*)\s*\]/g, function(match, formula) {
        formula = formula.trim();
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦ç¬¦å·
        const mathIndicators = ['\\frac', '\\partial', '\\hat', '\\text', '\\quad', 
                              '\\alpha', '\\beta', '\\gamma', '\\delta', '\\theta', '\\lambda', 
                              '^{', '_{', '\\sum', '\\int', '\\cdot', '\\times'];
        
        const isMathFormula = mathIndicators.some(indicator => formula.includes(indicator));
        
        if (isMathFormula) {
            // console.log('å‘ç°æ–¹æ‹¬å·æ•°å­¦å…¬å¼:', formula);
            return '\n$$' + formula + '$$\n';
        }
        
        return match;
    });
    
    // 4. æ¸…ç†é‡å¤çš„æ ‡è®°
    processedContent = processedContent.replace(/\$\$\s*\$\$/g, '$$');
    processedContent = processedContent.replace(/\$\s*\$/g, '$');
    
    // console.log('æ•°å­¦å…¬å¼é¢„å¤„ç†å®Œæˆï¼Œå¤„ç†åå†…å®¹:', processedContent.substring(0, 100) + '...');
    return processedContent;
}

// æ¸²æŸ“æ•°å­¦å…¬å¼
function renderMath(element) {
    if (window.MathJax && window.MathJax.typesetPromise) {
        // æ¸…é™¤ä¹‹å‰çš„MathJaxå¤„ç†
        window.MathJax.typesetClear([element]);
        
        // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
        window.MathJax.typesetPromise([element]).then(function() {
            // console.log('MathJaxæ¸²æŸ“å®Œæˆ');
        }).catch(function (err) {
            // console.log('MathJaxæ¸²æŸ“é”™è¯¯:', err.message);
        });
    }
}

// ç®€å•æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºç”¨æˆ·æ¶ˆæ¯ï¼‰
function formatMessage(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/\n/g, '<br>');
}

// åˆ‡æ¢æ¶ˆæ¯æ˜¾ç¤ºæ ¼å¼ï¼ˆæ¸²æŸ“/åŸæ–‡ï¼‰
function toggleMessageFormat(messageId) {
    const contentDiv = document.getElementById(messageId);
    const rawDiv = document.getElementById(messageId + '_raw');
    const toggleBtn = document.querySelector(`[onclick="toggleMessageFormat('${messageId}')"]`);
    
    if (contentDiv.style.display === 'none') {
        // åˆ‡æ¢åˆ°æ¸²æŸ“è§†å›¾
        contentDiv.style.display = 'block';
        rawDiv.style.display = 'none';
        toggleBtn.innerHTML = '<i class="bi bi-eye"></i> æ¸²æŸ“';
        toggleBtn.title = 'åˆ‡æ¢åˆ°åŸæ–‡è§†å›¾';
    } else {
        // åˆ‡æ¢åˆ°åŸæ–‡è§†å›¾
        contentDiv.style.display = 'none';
        rawDiv.style.display = 'block';
        toggleBtn.innerHTML = '<i class="bi bi-code"></i> åŸæ–‡';
        toggleBtn.title = 'åˆ‡æ¢åˆ°æ¸²æŸ“è§†å›¾';
    }
}

// æ‰“å­—æŒ‡ç¤ºå™¨åŠŸèƒ½å·²ç§»é™¤

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// æ’å…¥å¿«æ·æ–‡æœ¬
function insertQuickText(text) {
    const messageInput = document.getElementById('messageInput');
    messageInput.value = text;
    messageInput.focus();
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    document.getElementById('sendBtn').disabled = false;
}

// ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
async function saveMessage(conversationId, messageId, content, role = 'assistant') {
    try {
        const response = await fetch('/api/save_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                message_id: messageId,
                content: content,
                role: role
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('ä¿å­˜æ¶ˆæ¯å¼‚å¸¸:', error);
    }
}

// åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
async function loadKnowledgeBases() {
    try {
        const response = await fetch('/api/knowledge_bases');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('knowledgeBaseSelect');
            data.knowledge_bases.forEach(kb => {
                const option = document.createElement('option');
                option.value = kb.id;
                option.textContent = kb.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
    }
}

// ğŸ”¥ ä¿®å¤ï¼šç»Ÿä¸€çš„å‘é€æŒ‰é’®çŠ¶æ€ç®¡ç†å‡½æ•°
function updateSendButtonState() {
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    
    if (!sendBtn || !messageInput) return;
    
    const hasContent = messageInput.value.trim().length > 0;
    
    if (isLoading) {
        // åŠ è½½çŠ¶æ€ï¼šç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½å›¾æ ‡
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
    } else {
        // éåŠ è½½çŠ¶æ€ï¼šæ ¹æ®å†…å®¹å†³å®šæŒ‰é’®çŠ¶æ€
        sendBtn.disabled = !hasContent;
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
    }
    
    console.log(`[æŒ‰é’®çŠ¶æ€] isLoading=${isLoading}, hasContent=${hasContent}, disabled=${sendBtn.disabled}`);
}

// ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶é‡ç½®åŠ è½½çŠ¶æ€çš„å‡½æ•°
function forceResetLoadingState() {
    console.log('[å¼ºåˆ¶é‡ç½®] æ£€æµ‹åˆ°å¯èƒ½çš„çŠ¶æ€å¼‚å¸¸ï¼Œå¼ºåˆ¶é‡ç½®åŠ è½½çŠ¶æ€');
    isLoading = false;
    updateSendButtonState();
    
    // ç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.disabled = false;
        messageInput.focus();
    }
    
    console.log('[å¼ºåˆ¶é‡ç½®] åŠ è½½çŠ¶æ€å·²å¼ºåˆ¶é‡ç½®ä¸ºfalse');
}

// ğŸ”¥ ä¿®å¤ï¼šæ™ºèƒ½çŠ¶æ€æ£€æŸ¥å‡½æ•°
function checkAndResetState() {
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨çŠ¶æ€å¼‚å¸¸
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    
    if (sendBtn && messageInput) {
        const hasContent = messageInput.value.trim().length > 0;
        
        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ£€æµ‹å¼‚å¸¸çŠ¶æ€å¹¶å¼ºåˆ¶é‡ç½®
        if (!isLoading && hasContent && sendBtn.disabled) {
            console.warn('[çŠ¶æ€æ£€æŸ¥] æ£€æµ‹åˆ°å¼‚å¸¸ï¼šisLoading=falseä½†æŒ‰é’®è¢«ç¦ç”¨ï¼Œå¼ºåˆ¶é‡ç½®');
            forceResetLoadingState();
            return;
        }
        
        // å¦‚æœè¶…è¿‡10ç§’è¿˜åœ¨åŠ è½½çŠ¶æ€ï¼Œå¼ºåˆ¶é‡ç½®
        if (isLoading && window.lastSendTime && (Date.now() - window.lastSendTime > 10000)) {
            console.warn('[çŠ¶æ€æ£€æŸ¥] æ£€æµ‹åˆ°è¶…æ—¶ï¼šåŠ è½½çŠ¶æ€è¶…è¿‡10ç§’ï¼Œå¼ºåˆ¶é‡ç½®');
            forceResetLoadingState();
            return;
        }
    }
    
    updateSendButtonState();
}

// å®šæœŸæ£€æŸ¥çŠ¶æ€ï¼ˆå‡å°‘é¢‘ç‡ï¼‰
setInterval(checkAndResetState, 1000); // æ”¹ä¸º1ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæ›´åŠæ—¶å‘ç°é—®é¢˜
</script>

<style>
/* èŠå¤©å¸ƒå±€æ ·å¼ */
.chat-layout {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(37, 99, 235, 0.1);
}

.chat-header {
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
    border-bottom: 1px solid rgba(37, 99, 235, 0.1);
    background: #ffffff;
}

.chat-messages-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
    background: #fafafa;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(37, 99, 235, 0.2);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(37, 99, 235, 0.3);
}

/* æ¬¢è¿æ¶ˆæ¯æ ·å¼ */
.welcome-message {
    text-align: center;
    padding: 3rem 1rem;
    color: #64748b;
}

.welcome-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 1rem;
    display: block;
}

.welcome-message h4 {
    margin-bottom: 0.5rem;
    color: #334155;
}

/* è¿™äº›æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ï¼Œæ— éœ€é‡å¤ */

/* message-avatar æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* message-bubbleæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* AIæ¶ˆæ¯æ°”æ³¡æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

.message-bubble.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.message-content {
    font-size: 14px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»15pxæ”¹ä¸º14px */
}

.message-content pre {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.6rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.75remæ”¹ä¸º0.6rem */
    border-radius: 0.4rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.5remæ”¹ä¸º0.4rem */
    margin: 0.4rem 0; /* ğŸ”¥ ç¼©å°ï¼šä»0.5remæ”¹ä¸º0.4rem */
    overflow-x: auto;
    font-size: 13px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»14pxæ”¹ä¸º13px */
}

.message-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.15rem 0.3rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.2rem 0.4remæ”¹ä¸º0.15rem 0.3rem */
    border-radius: 0.2rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.25remæ”¹ä¸º0.2rem */
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 13px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»14pxæ”¹ä¸º13px */
}

.message-content strong {
    font-weight: 600;
}

.message-content em {
    font-style: italic;
}

/* è¾“å…¥åŒºåŸŸæ ·å¼ */
.chat-input-container {
    background: #ffffff;
    border-top: 1px solid rgba(37, 99, 235, 0.1);
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
}

.chat-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.knowledge-base-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.knowledge-base-selector select {
    width: auto;
    min-width: 150px;
}

.quick-actions {
    display: flex;
    gap: 0.5rem;
}

.chat-input-form {
    margin: 0;
}

/* input-wrapperæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* input-wrapper:focus-withinæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* chat-inputæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

.chat-input::placeholder {
    color: #94a3b8;
}

/* send-btnæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* send-btn hoverå’Œdisabledæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* æ‰“å­—æŒ‡ç¤ºå™¨æ ·å¼ */
.typing-indicator {
    display: none;
    padding: 0 1.5rem 1rem;
}

.typing-dots {
    display: inline-flex;
    margin-left: 0.5rem;
}

.typing-dots span {
    height: 4px;
    width: 4px;
    border-radius: 50%;
    background-color: var(--accent);
    margin: 0 1px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0.8); 
        opacity: 0.5; 
    }
    40% { 
        transform: scale(1); 
        opacity: 1; 
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .chat-layout {
        height: calc(100vh - 80px);
    }
    
    .chat-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .quick-actions {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .message-bubble {
        max-width: 85%;
    }
}
</style>

<script>
// ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
function addCopyButtonToCodeBlock(preElement) {
    // å¦‚æœå·²ç»æœ‰å¤åˆ¶æŒ‰é’®ï¼Œä¸é‡å¤æ·»åŠ 
    if (preElement.querySelector('.code-copy-btn')) {
        return;
    }
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = 'å¤åˆ¶';
    copyBtn.title = 'å¤åˆ¶ä»£ç ';
    
    copyBtn.addEventListener('click', async function() {
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return;
        
        const text = codeElement.textContent;
        
        try {
            await navigator.clipboard.writeText(text);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'å·²å¤åˆ¶';
            copyBtn.classList.add('copied');
            
            // 2ç§’åæ¢å¤åŸçŠ¶
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
            
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            
            // é™çº§åˆ°æ—§ç‰ˆæœ¬å¤åˆ¶æ–¹æ³•
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'å·²å¤åˆ¶';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
        }
    });
    
    preElement.appendChild(copyBtn);
}
</script>

{% endblock %} 