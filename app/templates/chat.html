{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - Agorix{% endblock %}

{% block extra_css %}
<!-- Markdownè§£æåº“ -->
<script>
console.log(`ğŸ” [DEBUG] å¼€å§‹åŠ è½½å¤–éƒ¨èµ„æº - ${new Date().toLocaleTimeString()}`);
const resourceLoadStart = performance.now();
</script>
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js" onload="console.log(`âœ… [DEBUG] marked.jsåŠ è½½å®Œæˆ: ${(performance.now() - resourceLoadStart).toFixed(3)}ms`)" onerror="console.error('âŒ [DEBUG] marked.jsåŠ è½½å¤±è´¥')"></script>
<!-- ä»£ç é«˜äº®åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" onload="console.log(`âœ… [DEBUG] highlight.js CSSåŠ è½½å®Œæˆ`)" onerror="console.error('âŒ [DEBUG] highlight.js CSSåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN')">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" onload="console.log(`âœ… [DEBUG] highlight.jsåŠ è½½å®Œæˆ`)" onerror="console.error('âŒ [DEBUG] highlight.jsåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN')"></script>
<!-- MathJaxæ•°å­¦å…¬å¼æ¸²æŸ“åº“ -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: {'[+]': ['ams', 'newcommand', 'autoload', 'configmacros', 'action']},
        maxMacros: 1000,
        maxBuffer: 5 * 1024
    },
    options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
    },
    startup: {
        ready: function () {
            console.log('MathJaxå·²å‡†å¤‡å°±ç»ª');
            MathJax.startup.defaultReady();
        }
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
/* èŠå¤©é¡µé¢éšè—é¡µè„šï¼Œä¸ºå¯¹è¯åŒºåŸŸé‡Šæ”¾æ›´å¤šç©ºé—´ */
footer {
    display: none !important;
}

/* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸé«˜åº¦ */
.main-content {
    min-height: calc(100vh - 60px) !important; /* å‡å»å¯¼èˆªæ é«˜åº¦ */
    padding-bottom: 0 !important;
}

/* èŠå¤©é¡µé¢å†…å®¹å®¹å™¨ */
.chat-page-content {
    padding: 0 !important;
    margin: 0 !important;
    height: calc(100vh - 60px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
    overflow: hidden;
}

/* ä¼˜åŒ–èŠå¤©å®¹å™¨é«˜åº¦ */
.chat-container {
    height: 100% !important;
    max-height: none !important;
    border-radius: 0 !important; /* ç§»é™¤åœ†è§’ï¼Œå……åˆ†åˆ©ç”¨ç©ºé—´ */
    box-shadow: none !important;
}

/* è°ƒè¯•é¢æ¿æ ·å¼ */
.debug-panel {
    position: fixed;
    top: 60px;
    right: 0;
    width: 500px;
    height: calc(100vh - 60px);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border-left: 1px solid #e5e5e5;
    box-shadow: -2px 0 20px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.debug-header {
    padding: 16px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: between;
    align-items: center;
    background: #f8f9fa;
}

.debug-controls {
    display: flex;
    gap: 8px;
}

.debug-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.debug-tabs {
    display: flex;
    border-bottom: 1px solid #e5e5e5;
    background: #f8f9fa;
}

.debug-tab {
    flex: 1;
    padding: 12px 8px;
    border: none;
    background: none;
    font-size: 12px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.debug-tab:hover {
    background: #e9ecef;
    color: #333;
}

.debug-tab.active {
    background: #fff;
    color: #0066cc;
    border-bottom: 2px solid #0066cc;
}

.debug-tab-content {
    flex: 1;
    overflow: hidden;
}

.debug-tab-pane {
    height: 100%;
    overflow: auto;
    padding: 16px;
    display: none;
}

.debug-tab-pane.active {
    display: block;
}

.debug-log {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    line-height: 1.4;
}

.debug-info {
    font-size: 12px;
    line-height: 1.5;
}

.debug-entry {
    margin-bottom: 12px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #dee2e6;
}

.debug-entry.info {
    border-left-color: #0066cc;
}

.debug-entry.success {
    border-left-color: #28a745;
}

.debug-entry.warning {
    border-left-color: #ffc107;
}

.debug-entry.error {
    border-left-color: #dc3545;
}

.debug-entry-header {
    font-weight: bold;
    margin-bottom: 4px;
    display: flex;
    justify-content: between;
    align-items: center;
}

.debug-entry-content {
    color: #666;
}

.debug-json {
    background: #f1f3f4;
    padding: 8px;
    border-radius: 4px;
    overflow-x: auto;
    margin-top: 8px;
    white-space: pre-wrap;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 11px;
}

/* æ•°æ®åº“æ“ä½œæ ·å¼ */
.db-operations-section {
    margin-top: 15px;
}

.db-operations-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px;
}

.db-operation {
    padding: 6px 8px;
    margin: 2px 0;
    border-radius: 3px;
    font-size: 12px;
    line-height: 1.4;
}

.db-operation.success {
    background: rgba(40, 167, 69, 0.1);
    border-left: 3px solid #28a745;
}

.db-operation.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

.db-operation.error {
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

.db-operation.info {
    background: rgba(0, 123, 255, 0.1);
    border-left: 3px solid #007bff;
}

/* è°ƒè¯•æ¨¡å¼ä¸‹è°ƒæ•´èŠå¤©åŒºåŸŸ */
.chat-main.debug-mode {
    margin-right: 500px;
}



/* ğŸ”¥ æ–°å¢ï¼šç­‰å¾…åŠ¨ç”»æ ·å¼ */
.waiting-animation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.9rem;
    padding: 0.5rem 0;
}

.waiting-text {
    color: #64748b;
}

.waiting-dots {
    display: flex;
    gap: 0.1rem;
}

.waiting-dots span {
    opacity: 0.4;
    animation: waitingDots 1.5s infinite ease-in-out;
}

.waiting-dots span:nth-child(1) {
    animation-delay: 0s;
}

.waiting-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.waiting-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes waitingDots {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(1);
    }
    40% {
        opacity: 1;
        transform: scale(1.2);
    }
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 1200px) {
    .debug-panel {
        width: 400px;
    }
    .chat-main.debug-mode {
        margin-right: 400px;
    }
}

@media (max-width: 992px) {
    .debug-panel {
        width: 100%;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
    }
    .chat-main.debug-mode {
        margin-right: 0;
    }
}

/* V0.3.0 ç´§å‡‘å‹é…ç½®æ¨¡æ€æ¡†æ ·å¼ */
#configModal .modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

#configModal .modal-header {
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px 12px 0 0;
}

#configModal .modal-body {
    background: #fafbfc;
}

#configModal .form-label.small {
    font-weight: 600;
    color: #495057;
}

#configModal .form-select-sm,
#configModal .form-control-sm {
    font-size: 13px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

#configModal .form-select-sm:focus,
#configModal .form-control-sm:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#configModal .form-check-input {
    margin-top: 0.2em;
}

#configModal .form-check-label.small {
    font-size: 12px;
    color: #6c757d;
}

#configModal #configPreview {
    background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
    border: 1px solid #bbdefb;
    border-radius: 8px;
    font-size: 12px;
}

#configModal .collapse {
    transition: all 0.3s ease;
}

#configModal .btn-link {
    color: #6c757d;
    font-size: 12px;
}

#configModal .btn-link:hover {
    color: #007bff;
}

#configModal .modal-footer {
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* è¾“å‡ºé•¿åº¦å•é€‰æŒ‰é’®æ ·å¼ */
#maxTokensRadioGroup .form-check {
    margin-right: 1rem;
}

#maxTokensRadioGroup .form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

#maxTokensRadioGroup .form-check-label {
    font-weight: 500;
    color: #495057;
}

/* æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºæ ·å¼ */
.thinking-process {
    background: #f8f9fa;
    border-left: 3px solid #6c757d;
    padding: 12px;
    margin: 10px 0;
    border-radius: 0 6px 6px 0;
    font-size: 0.9em;
    color: #6c757d;
}

.thinking-process .thinking-header {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    cursor: pointer;
}

.thinking-process .thinking-content {
    line-height: 1.5;
}

.thinking-process.collapsed .thinking-content {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="chat-page-content">
    <div class="chat-container" id="chatContainer">
        <!-- èŠå¤©ä¾§è¾¹æ å±•å¼€è§¦å‘å™¨ -->
        <div class="sidebar-trigger-chat" id="sidebarTriggerChat" title="æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨">
            <i class="bi bi-chat-dots"></i>
        </div>
        
        <!-- å·¦ä¾§è¾¹æ  - å¯¹è¯å†å² -->
        <div class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-header">
                <button class="btn btn-primary w-100" id="newChatBtn">
                    <i class="bi bi-plus"></i> æ–°å»ºå¯¹è¯
                </button>
            </div>
            
            <div class="sidebar-search">
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control search-input" placeholder="æœç´¢å¯¹è¯..." id="conversationSearch">
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="conversation-list" id="conversationList">
                    <!-- å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    <div class="loading-conversations text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <small class="text-muted d-block mt-2">åŠ è½½å¯¹è¯ä¸­...</small>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="btn btn-outline-secondary btn-sm w-100" id="toggleSidebar">
                    <i class="bi bi-chevron-left"></i> æ”¶èµ·
                </button>
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="chat-header">
                <div class="d-flex align-items-center position-relative">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-3" id="showSidebar">
                            <i class="bi bi-list"></i>
                        </button>
                        <div>
                            <h5 class="mb-0 editable-title" id="currentChatTitle" onclick="startEditTitle()" title="ç‚¹å‡»ç¼–è¾‘æ ‡é¢˜">
                                æ™ºèƒ½é—®ç­”
                                <i class="bi bi-pencil-square edit-icon"></i>
                            </h5>
                            <input type="text" class="form-control form-control-sm title-editor" id="titleEditor" style="display: none;" maxlength="50">
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center ms-auto">
                        {% if current_user.role.value in ['admin', 'tester'] %}
                        <button class="btn btn-outline-info btn-sm" id="debugBtn" title="è°ƒè¯•æ¨¡å¼">
                            <i class="bi bi-bug me-1"></i>è°ƒè¯•
                        </button>
                        {% endif %}
                        <button class="btn btn-outline-secondary btn-sm" id="settingsBtn">
                            <i class="bi bi-gear me-1"></i>è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†äº«å¯¹è¯æ¨¡æ€æ¡† -->
            <div class="share-conversation-modal" id="shareConversationModal">
                <div class="share-conversation-content">
                    <div class="share-conversation-header">
                        <h3><i class="bi bi-share"></i> åˆ†äº«å¯¹è¯åˆ°è®ºå›</h3>
                        <button class="close-modal" onclick="closeShareConversationModal()">&times;</button>
                    </div>
                    
                    <form id="shareConversationForm" style="padding: 20px 28px;">
                        <div class="form-group">
                            <label for="shareConversationTitle">å¯¹è¯æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="shareConversationTitle" readonly>
                            <small class="text-muted">å½“å‰å¯¹è¯æ ‡é¢˜ï¼ˆæ— æ³•ä¿®æ”¹ï¼‰</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="shareConversationDescription">åˆ†äº«æè¿° *</label>
                            <textarea class="form-control" id="shareConversationDescription" rows="3" 
                                     placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™ä¸ªå¯¹è¯çš„å†…å®¹å’Œäº®ç‚¹..." maxlength="140"></textarea>
                            <div class="char-counter" id="shareDescriptionCharCounter">0/140</div>
                            <small class="text-muted">å‘å¤§å®¶ä»‹ç»è¿™ä¸ªå¯¹è¯çš„ç²¾å½©ä¹‹å¤„</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="shareConversationTags">æ ‡ç­¾</label>
                            <input type="text" class="form-control" id="shareConversationTags" 
                                   placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šç¼–ç¨‹,åˆ›æ„å†™ä½œ,é—®é¢˜è§£ç­”">
                            <small class="text-muted">æ·»åŠ ç›¸å…³æ ‡ç­¾å¸®åŠ©å…¶ä»–ç”¨æˆ·å‘ç°ä½ çš„åˆ†äº«ï¼ˆå¯é€‰ï¼‰</small>
                        </div>
                        
                        <div class="form-group">
                            <label>å¯¹è¯ç»Ÿè®¡</label>
                            <div class="conversation-stats">
                                <span class="stat-item">
                                    <i class="bi bi-chat-dots"></i>
                                    <span id="shareConversationMessageCount">-</span> æ¡æ¶ˆæ¯
                                </span>
                                <span class="stat-item">
                                    <i class="bi bi-robot"></i>
                                    <span id="shareConversationModel">-</span>
                                </span>
                                <span class="stat-item">
                                    <i class="bi bi-clock"></i>
                                    <span id="shareConversationTime">-</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="share-conversation-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeShareConversationModal()">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary" id="submitShareBtn">
                                <i class="bi bi-share"></i> åˆ†äº«åˆ°è®ºå›
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è°ƒè¯•é¢æ¿ -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-header">
                    <h6 class="mb-0">
                        <i class="bi bi-bug"></i> è°ƒè¯•ä¿¡æ¯
                    </h6>
                    <div class="debug-controls">
                        <button class="btn btn-outline-secondary btn-sm" id="clearDebugBtn">
                            <i class="bi bi-trash me-1"></i>æ¸…ç©º
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="closeDebugBtn">
                            <i class="bi bi-x me-1"></i>å…³é—­
                        </button>
                    </div>
                </div>
                <div class="debug-content">
                    <div class="debug-tabs">
                        <button class="debug-tab active" data-tab="model">æ¨¡å‹å‚æ•°</button>
                        <button class="debug-tab" data-tab="context">ä¸Šä¸‹æ–‡</button>
                        <button class="debug-tab" data-tab="langchain">LangChain</button>
                        <button class="debug-tab" data-tab="database">æ•°æ®åº“</button>
                        <button class="debug-tab" data-tab="system">ç³»ç»Ÿ</button>
                    </div>
                    <div class="debug-tab-content">
                        <div class="debug-tab-pane active" id="debug-model">
                            <div class="debug-info" id="debugModel">
                                <div class="text-muted text-center py-3">æ¨¡å‹å‚æ•°ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-context">
                            <div class="debug-info" id="debugContext">
                                <div class="text-muted text-center py-3">APIäº¤äº’ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-langchain">
                            <div class="debug-info" id="debugLangchain">
                                <div class="text-muted text-center py-3">LangChainå¤„ç†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-database">
                            <div class="debug-info" id="debugDatabase">
                                <div class="text-muted text-center py-3">æ•°æ®åº“ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        <div class="debug-tab-pane" id="debug-system">
                            <div class="debug-info" id="debugSystem">
                                <div class="text-muted text-center py-3">ç³»ç»ŸçŠ¶æ€ä¿¡æ¯</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message" id="welcomeMessage">
                        <i class="bi bi-chat-dots welcome-icon"></i>
                        <h4>å¼€å§‹æ–°çš„å¯¹è¯</h4>
                        <p>å‘æˆ‘æé—®ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä¼šåŸºäºæ‚¨çš„çŸ¥è¯†åº“ä¸ºæ‚¨æä¾›å‡†ç¡®çš„ç­”æ¡ˆã€‚</p>
                    </div>
                </div>
            </div>

            <!-- V0.3.0 ç´§å‡‘å‹å¯¹è¯é…ç½®æ¨¡æ€æ¡† -->
            <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" style="max-width: 480px;">
                    <div class="modal-content">
                        <div class="modal-header py-2 px-3">
                            <h6 class="modal-title" id="configModalLabel">
                                <i class="bi bi-gear me-1"></i><span id="configModalTitle">å¯¹è¯å‚æ•°é…ç½®</span>
                            </h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body px-3 py-2">
                            <form id="configForm">
                                <!-- ç´§å‡‘å‹å¸ƒå±€ï¼šæ¨¡å‹é€‰æ‹©å’Œæ¸©åº¦ -->
                                <div class="row g-2 mb-3">
                                    <div class="col-7">
                                        <label class="form-label small mb-1">
                                            <i class="bi bi-cpu"></i> æ¨¡å‹
                                        </label>
                                        <select class="form-select form-select-sm" id="modelSelect" name="model_name">
                                            <option value="deepseek-chat">DeepSeek-V3 (å¿«é€Ÿ)</option>
                                            <option value="deepseek-reasoner">DeepSeek-R1 (æ·±åº¦æ€è€ƒ)</option>
                                        </select>
                                    </div>
                                    <div class="col-5">
                                        <label class="form-label small mb-1">
                                            <i class="bi bi-thermometer-half"></i> æ¸©åº¦
                                        </label>
                                        <select class="form-select form-select-sm" id="temperatureSelect" name="temperature">
                                            <option value="0.0">0 - ä»£ç </option>
                                            <option value="1.0" selected>1.0 - é€šç”¨</option>
                                            <option value="1.5">1.5 - åˆ›æ„</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- è¾“å‡ºé•¿åº¦ -->
                                <div class="mb-3">
                                    <label class="form-label small mb-1">
                                        <i class="bi bi-textarea-resize"></i> è¾“å‡ºé•¿åº¦
                                    </label>
                                    <div class="d-flex gap-2" id="maxTokensRadioGroup">
                                        <!-- åŠ¨æ€å¡«å……å•é€‰æŒ‰é’® -->
                                    </div>
                                </div>

                                <!-- å¿«é€Ÿæ¨¡å¼é€‰é¡¹ -->
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="enableThinking" />
                                        <label class="form-check-label small" for="enableThinking">
                                            æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ (ä»…R1)
                                        </label>
                                    </div>
                                </div>

                                <!-- åˆå§‹æç¤ºè¯ï¼ˆå¯æŠ˜å ï¼‰ -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <label class="form-label small mb-0 me-2">
                                            <i class="bi bi-chat-square-text"></i> åˆå§‹æç¤ºè¯
                                        </label>
                                        <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none" 
                                                data-bs-toggle="collapse" data-bs-target="#promptCollapse" 
                                                aria-expanded="false" aria-controls="promptCollapse">
                                            <i class="bi bi-chevron-down" id="promptToggleIcon"></i>
                                        </button>
                                    </div>
                                    <div class="collapse" id="promptCollapse">
                                        <textarea class="form-control form-control-sm" id="systemPrompt" name="system_prompt" 
                                                 rows="3" maxlength="2000" 
                                                 placeholder="è®¾ç½®AIè§’è‰²ï¼Œå¦‚ï¼šä½ æ˜¯ä¸“ä¸šæŠ€æœ¯é¡¾é—®..."></textarea>
                                        <div class="form-text small">
                                            <span id="promptCharCount">0</span>/2000 å­—ç¬¦
                                        </div>
                                    </div>
                                </div>

                                <!-- é…ç½®é¢„è§ˆ -->
                                <div class="alert alert-light py-2 px-2 mb-0" id="configPreview">
                                    <!-- åŠ¨æ€ç”Ÿæˆé…ç½®é¢„è§ˆ -->
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer py-2 px-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                å–æ¶ˆ
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" id="saveConfigBtn">
                                <span id="saveConfigBtnText">å¼€å§‹å¯¹è¯</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="chat-input-container">
                <!-- å¿«æ·æ“ä½œ - V0.3.0 ç§»é™¤çŸ¥è¯†åº“é€‰æ‹© -->
                <div class="chat-controls">
                    <div class="quick-actions">
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·å¸®æˆ‘æ€»ç»“ä¸€ä¸‹')">
                            <i class="bi bi-lightning me-1"></i>æ€»ç»“
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·è¯¦ç»†è§£é‡Š')">
                            <i class="bi bi-question-circle me-1"></i>è§£é‡Š
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="insertQuickText('è¯·ä¸¾ä¸ªä¾‹å­')">
                            <i class="bi bi-lightbulb me-1"></i>ä¸¾ä¾‹
                        </button>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ¡† - V0.3.0 è°ƒé«˜è¾“å…¥æ¡† -->
                <form id="chatForm" class="chat-input-form">
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                                 rows="3" style="min-height: 80px;"></textarea>
                        <button type="submit" class="send-btn" id="sendBtn" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;
let isLoading = false;
let conversations = [];

// è°ƒè¯•åŠŸèƒ½ç›¸å…³å˜é‡
let debugMode = false;
let debugData = {};
let currentDebugTab = 'model';

// ç¬¬ä¸€ä¸ªDOMContentLoadedå·²ç§»é™¤ - é¿å…é‡å¤åˆå§‹åŒ–

// æ£€æŸ¥LangChainçŠ¶æ€
async function checkLangChainStatus() {
    try {
        const response = await fetch('/api/langchain/config');
        const data = await response.json();
        
        if (data.success && data.config.enabled) {
            // LangChainæ ‡è¯†å·²ç§»é™¤ï¼Œåªä¿ç•™è°ƒè¯•ä¿¡æ¯
            addDebugEntry('system', 'LangChainå·²å¯ç”¨', 'success');
        }
    } catch (error) {
        console.error('æ£€æŸ¥LangChainçŠ¶æ€å¤±è´¥:', error);
    }
}

// åˆå§‹åŒ–è°ƒè¯•åŠŸèƒ½
function initializeDebugFeatures() {
    // è°ƒè¯•æŒ‰é’®äº‹ä»¶
    // è°ƒè¯•æŒ‰é’®å¯èƒ½ä¸å­˜åœ¨ï¼ˆéç®¡ç†å‘˜/æµ‹è¯•å‘˜ï¼‰
const debugBtn = document.getElementById('debugBtn');
if (debugBtn) {
    debugBtn.addEventListener('click', toggleDebugMode);
}
document.getElementById('closeDebugBtn').addEventListener('click', closeDebugPanel);
document.getElementById('clearDebugBtn').addEventListener('click', clearDebugLog);
    
    // è°ƒè¯•æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.debug-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            switchDebugTab(this.dataset.tab);
        });
    });
}

// V0.3.0 å¯¹è¯é…ç½®åŠŸèƒ½ - V0.3.1 ä¿®å¤é»˜è®¤é…ç½®
let currentConfig = {
    model_name: 'deepseek-chat',
    temperature: 1.0,
    max_tokens: 4000,
    system_prompt: ''
};

let configModalMode = 'edit'; // 'create' æˆ– 'edit'

// V0.3.1 æ·»åŠ ï¼šç¡®ä¿é»˜è®¤é…ç½®æ­£ç¡®åˆå§‹åŒ–
function ensureDefaultConfig() {
    if (!currentConfig || typeof currentConfig.temperature === 'undefined') {
        console.log('[é…ç½®] ä¿®å¤é»˜è®¤é…ç½®');
        currentConfig = {
            model_name: 'deepseek-chat',
            temperature: 1.0,
            max_tokens: 4000,
            system_prompt: ''
        };
    }
    console.log('[é…ç½®] å½“å‰é…ç½®çŠ¶æ€:', currentConfig);
}

// V0.3.1 æ·»åŠ ï¼šæµ‹è¯•é…ç½®åŠŸèƒ½
function testConfig() {
    console.log('[æµ‹è¯•] å¼€å§‹æµ‹è¯•é…ç½®åŠŸèƒ½');
    
    const temperatureSelect = document.getElementById('temperatureSelect');
    const modelSelect = document.getElementById('modelSelect');
    const systemPrompt = document.getElementById('systemPrompt');
    
    console.log('[æµ‹è¯•] æ¸©åº¦é€‰æ‹©å™¨å€¼:', temperatureSelect ? temperatureSelect.value : 'æœªæ‰¾åˆ°');
    console.log('[æµ‹è¯•] æ¨¡å‹é€‰æ‹©å™¨å€¼:', modelSelect ? modelSelect.value : 'æœªæ‰¾åˆ°');
    console.log('[æµ‹è¯•] ç³»ç»Ÿæç¤ºè¯å…ƒç´ :', systemPrompt ? 'å­˜åœ¨' : 'æœªæ‰¾åˆ°');
    console.log('[æµ‹è¯•] è¾“å‡ºé•¿åº¦å€¼:', getMaxTokensValue ? getMaxTokensValue() : 'å‡½æ•°æœªæ‰¾åˆ°');
    
    // æµ‹è¯•æ¸©åº¦é€‰æ‹©å™¨çš„æ‰€æœ‰é€‰é¡¹
    if (temperatureSelect) {
        console.log('[æµ‹è¯•] æ¸©åº¦é€‰æ‹©å™¨é€‰é¡¹è¯¦æƒ…:');
        for (let i = 0; i < temperatureSelect.options.length; i++) {
            const option = temperatureSelect.options[i];
            console.log(`  é€‰é¡¹${i}: value="${option.value}", text="${option.text}", selected=${option.selected}`);
        }
        
        // æµ‹è¯•è®¾ç½®æ¸©åº¦å€¼
        console.log('[æµ‹è¯•] å°è¯•è®¾ç½®æ¸©åº¦ä¸º1.0');
        temperatureSelect.value = '1.0';
        console.log('[æµ‹è¯•] è®¾ç½®åï¼Œæ¸©åº¦å€¼:', temperatureSelect.value);
        console.log('[æµ‹è¯•] è®¾ç½®åï¼Œé€‰ä¸­çš„ç´¢å¼•:', temperatureSelect.selectedIndex);
    }
    
    // æµ‹è¯•å½“å‰é…ç½®
    console.log('[æµ‹è¯•] å½“å‰é…ç½®å¯¹è±¡:', currentConfig);
    console.log('[æµ‹è¯•] å½“å‰å¯¹è¯ID:', currentConversationId);
    console.log('[æµ‹è¯•] é…ç½®æ¨¡å¼:', configModalMode);
    
    console.log('[æµ‹è¯•] é…ç½®åŠŸèƒ½æµ‹è¯•å®Œæˆ');
}

// V0.3.1 æ·»åŠ ï¼šä¿®å¤æ¸©åº¦é€‰æ‹©å™¨çš„å‡½æ•°
window.fixTemperatureSelect = function() {
    console.log('[ä¿®å¤] å¼€å§‹ä¿®å¤æ¸©åº¦é€‰æ‹©å™¨');
    
    const temperatureSelect = document.getElementById('temperatureSelect');
    if (!temperatureSelect) {
        console.error('[ä¿®å¤] æ¸©åº¦é€‰æ‹©å™¨ä¸å­˜åœ¨');
        return;
    }
    
    // å¼ºåˆ¶è®¾ç½®ä¸º1.0å¹¶è§¦å‘äº‹ä»¶
    temperatureSelect.value = '1.0';
    temperatureSelect.dispatchEvent(new Event('change'));
    
    console.log('[ä¿®å¤] ä¿®å¤åæ¸©åº¦å€¼:', temperatureSelect.value);
    console.log('[ä¿®å¤] ä¿®å¤åé€‰ä¸­ç´¢å¼•:', temperatureSelect.selectedIndex);
    
    // å¦‚æœè¿˜æ˜¯ä¸å¯¹ï¼Œé€šè¿‡selectedIndexè®¾ç½®
    if (temperatureSelect.value !== '1.0') {
        for (let i = 0; i < temperatureSelect.options.length; i++) {
            if (temperatureSelect.options[i].value === '1.0') {
                temperatureSelect.selectedIndex = i;
                temperatureSelect.dispatchEvent(new Event('change'));
                console.log('[ä¿®å¤] é€šè¿‡selectedIndexä¿®å¤æˆåŠŸ:', temperatureSelect.value);
                break;
            }
        }
    }
};

// V0.3.1 æ·»åŠ ï¼šæµ‹è¯•è°ƒè¯•åŠŸèƒ½çš„å‡½æ•°
window.testDebugFeatures = function() {
    console.log('[æµ‹è¯•] å¼€å§‹æµ‹è¯•è°ƒè¯•åŠŸèƒ½');
    
    // æµ‹è¯•DOMå…ƒç´ å­˜åœ¨æ€§
    const debugElements = [
        'debugPanel', 'debugModel', 'debugContext', 
        'debugLangchain', 'debugDatabase', 'debugSystem'
    ];
    
    debugElements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`[æµ‹è¯•] ${id}:`, element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
    });
    
    // æµ‹è¯•è°ƒè¯•æ¨¡å¼åˆ‡æ¢
    console.log('[æµ‹è¯•] å½“å‰è°ƒè¯•æ¨¡å¼:', debugMode);
    
    // V0.3.1 ä¿®å¤ï¼šä¸è‡ªåŠ¨å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œåªæç¤ºç”¨æˆ·å¦‚ä½•æ‰‹åŠ¨å¼€å¯
    if (!debugMode) {
        console.log('[æµ‹è¯•] è°ƒè¯•æ¨¡å¼æœªå¼€å¯ã€‚å¦‚éœ€æµ‹è¯•è°ƒè¯•åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»è°ƒè¯•æŒ‰é’®æˆ–è°ƒç”¨ toggleDebugMode()');
        console.log('[æµ‹è¯•] è·³è¿‡éœ€è¦è°ƒè¯•æ¨¡å¼çš„æµ‹è¯•é¡¹ç›®');
        return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œéœ€è¦è°ƒè¯•æ¨¡å¼çš„æµ‹è¯•
    }
    
    // æµ‹è¯•æ·»åŠ è°ƒè¯•æ¡ç›®
    try {
        addDebugEntry('test', 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è°ƒè¯•æ¡ç›®', 'info');
        console.log('[æµ‹è¯•] âœ… addDebugEntryå‡½æ•°æ­£å¸¸å·¥ä½œ');
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ addDebugEntryå‡½æ•°å‡ºé”™:', error);
    }
    
    // æµ‹è¯•æ¸…ç©ºè°ƒè¯•æ—¥å¿—
    try {
        clearDebugLog();
        console.log('[æµ‹è¯•] âœ… clearDebugLogå‡½æ•°æ­£å¸¸å·¥ä½œ');
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ clearDebugLogå‡½æ•°å‡ºé”™:', error);
    }
    
    console.log('[æµ‹è¯•] è°ƒè¯•åŠŸèƒ½æµ‹è¯•å®Œæˆ');
};

// V0.3.1 æ·»åŠ ï¼šæµ‹è¯•é…ç½®æ¨¡æ€æ¡†å®‰å…¨æ€§çš„å‡½æ•°
window.testConfigModalSafety = function() {
    console.log('[æµ‹è¯•] å¼€å§‹æµ‹è¯•é…ç½®æ¨¡æ€æ¡†å®‰å…¨æ€§');
    
    // æµ‹è¯•åœ¨æ¨¡æ€æ¡†å…³é—­åè°ƒç”¨å„ç§å‡½æ•°
    console.log('[æµ‹è¯•] æµ‹è¯•æ¨¡æ€æ¡†å…³é—­åçš„å‡½æ•°å®‰å…¨æ€§');
    
    try {
        updateConfigPreview();
        console.log('[æµ‹è¯•] âœ… updateConfigPreview: å®‰å…¨å¤„ç†äº†ç©ºå…ƒç´ ');
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ updateConfigPreview: å‡ºç°é”™è¯¯:', error);
    }
    
    try {
        updateCharCount();
        console.log('[æµ‹è¯•] âœ… updateCharCount: å®‰å…¨å¤„ç†äº†ç©ºå…ƒç´ ');
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ updateCharCount: å‡ºç°é”™è¯¯:', error);
    }
    
    try {
        const maxTokens = getMaxTokensValue();
        console.log('[æµ‹è¯•] âœ… getMaxTokensValue: è¿”å›å€¼', maxTokens);
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ getMaxTokensValue: å‡ºç°é”™è¯¯:', error);
    }
    
    try {
        onModelChange();
        console.log('[æµ‹è¯•] âœ… onModelChange: å®‰å…¨å¤„ç†äº†ç©ºå…ƒç´ ');
    } catch (error) {
        console.error('[æµ‹è¯•] âŒ onModelChange: å‡ºç°é”™è¯¯:', error);
    }
    
    console.log('[æµ‹è¯•] é…ç½®æ¨¡æ€æ¡†å®‰å…¨æ€§æµ‹è¯•å®Œæˆ');
};

// V0.3.1 æ·»åŠ ï¼šä¾›ç”¨æˆ·æ‰‹åŠ¨æµ‹è¯•çš„å‡½æ•°
window.testConfigSave = async function() {
    console.log('[æ‰‹åŠ¨æµ‹è¯•] å¼€å§‹æµ‹è¯•é…ç½®ä¿å­˜åŠŸèƒ½');
    
    try {
        // ç¡®ä¿é…ç½®æ­£ç¡®
        ensureDefaultConfig();
        
        // æ‰“å¼€é…ç½®æ¨¡æ€æ¡†
        await openConfigModal();
        
        console.log('[æ‰‹åŠ¨æµ‹è¯•] é…ç½®æ¨¡æ€æ¡†å·²æ‰“å¼€');
        console.log('[æ‰‹åŠ¨æµ‹è¯•] å½“å‰é…ç½®:', currentConfig);
        console.log('[æ‰‹åŠ¨æµ‹è¯•] è¯·æ‰‹åŠ¨è°ƒæ•´å‚æ•°å¹¶ç‚¹å‡»ä¿å­˜æŒ‰é’®æµ‹è¯•');
        console.log('[æ‰‹åŠ¨æµ‹è¯•] æˆ–è€…è°ƒç”¨ window.testAutoSave() è‡ªåŠ¨æµ‹è¯•ä¿å­˜åŠŸèƒ½');
        
    } catch (error) {
        console.error('[æ‰‹åŠ¨æµ‹è¯•] æµ‹è¯•å¤±è´¥:', error);
    }
};

// V0.3.1 æ·»åŠ ï¼šè‡ªåŠ¨æµ‹è¯•ä¿å­˜åŠŸèƒ½
window.testAutoSave = async function() {
    console.log('[è‡ªåŠ¨æµ‹è¯•] å¼€å§‹è‡ªåŠ¨æµ‹è¯•é…ç½®ä¿å­˜');
    
    try {
        // ç¡®ä¿æœ‰å½“å‰å¯¹è¯
        if (!currentConversationId) {
            console.warn('[è‡ªåŠ¨æµ‹è¯•] æ²¡æœ‰å½“å‰å¯¹è¯ï¼Œè¯·å…ˆå¼€å§‹ä¸€ä¸ªå¯¹è¯');
            return;
        }
        
        // æ¨¡æ‹Ÿä¿å­˜é…ç½®
        const testConfig = {
            model_name: 'deepseek-chat',
            temperature: 1.0,
            max_tokens: 4000,
            system_prompt: 'æµ‹è¯•æç¤ºè¯'
        };
        
        console.log('[è‡ªåŠ¨æµ‹è¯•] å‡†å¤‡ä¿å­˜é…ç½®:', testConfig);
        
        const response = await fetch(`/api/conversations/${currentConversationId}/config`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testConfig)
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('[è‡ªåŠ¨æµ‹è¯•] âœ… é…ç½®ä¿å­˜æˆåŠŸ:', data);
        } else {
            console.error('[è‡ªåŠ¨æµ‹è¯•] âŒ é…ç½®ä¿å­˜å¤±è´¥:', data);
        }
        
    } catch (error) {
        console.error('[è‡ªåŠ¨æµ‹è¯•] æµ‹è¯•å¼‚å¸¸:', error);
    }
};

// åˆå§‹åŒ–é…ç½®åŠŸèƒ½
function initializeConfigFeatures() {
    console.log('[é…ç½®] åˆå§‹åŒ–é…ç½®åŠŸèƒ½');
    
    // V0.3.1 ä¿®å¤ï¼šç¡®ä¿é»˜è®¤é…ç½®æ­£ç¡®åˆå§‹åŒ–
    ensureDefaultConfig();
    
    // è®¾ç½®æŒ‰é’®äº‹ä»¶
    document.getElementById('settingsBtn').addEventListener('click', openConfigModal);
    
    // ä¿å­˜é…ç½®æŒ‰é’®äº‹ä»¶
    document.getElementById('saveConfigBtn').addEventListener('click', saveConversationConfig);
    
    // æ¨¡å‹åˆ‡æ¢äº‹ä»¶
    document.getElementById('modelSelect').addEventListener('change', onModelChange);
    
    // ç³»ç»Ÿæç¤ºè¯å­—ç¬¦è®¡æ•°
    document.getElementById('systemPrompt').addEventListener('input', updateCharCount);
    
    // é…ç½®é¢„è§ˆæ›´æ–°
    ['modelSelect', 'temperatureSelect', 'systemPrompt'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updateConfigPreview);
            element.addEventListener('input', updateConfigPreview);
        }
    });
    
    // åˆå§‹åŒ–è¾“å‡ºé•¿åº¦å•é€‰æŒ‰é’®
    initMaxTokensRadio();
    
    // åˆå§‹åŒ–æŠ˜å æç¤ºè¯
    initPromptCollapse();
    
    // V0.3.1 ä¿®å¤ï¼šåˆå§‹åŒ–æ—¶è®¾ç½®æ€è€ƒè¿‡ç¨‹å¤é€‰æ¡†çŠ¶æ€
    onModelChange();
    
    console.log('[é…ç½®] é…ç½®åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
}

// åˆå§‹åŒ–è¾“å‡ºé•¿åº¦å•é€‰æŒ‰é’®
function initMaxTokensRadio() {
    const container = document.getElementById('maxTokensRadioGroup');
    if (!container) return;
    
    // é»˜è®¤é€‰é¡¹ï¼ˆV3æ¨¡å‹ï¼‰
    updateMaxTokensOptions('deepseek-chat');
}

// åˆå§‹åŒ–æŠ˜å æç¤ºè¯
function initPromptCollapse() {
    const promptCollapse = document.getElementById('promptCollapse');
    const toggleIcon = document.getElementById('promptToggleIcon');
    
    if (promptCollapse && toggleIcon) {
        promptCollapse.addEventListener('show.bs.collapse', () => {
            toggleIcon.className = 'bi bi-chevron-up';
        });
        
        promptCollapse.addEventListener('hide.bs.collapse', () => {
            toggleIcon.className = 'bi bi-chevron-down';
        });
    }
}

// æ‰“å¼€é…ç½®æ¨¡æ€æ¡†ï¼ˆä¿®æ”¹ç°æœ‰å¯¹è¯ï¼‰
async function openConfigModal() {
    try {
        console.log('[é…ç½®] æ‰“å¼€é…ç½®æ¨¡æ€æ¡†, å½“å‰å¯¹è¯ID:', currentConversationId);
        
        // V0.3.1 ä¿®å¤ï¼šæ ¹æ®æ˜¯å¦æœ‰å¯¹è¯IDæ¥å†³å®šæ¨¡å¼
        if (currentConversationId) {
            // æœ‰å¯¹è¯IDï¼Œç¼–è¾‘æ¨¡å¼
            configModalMode = 'edit';
            document.getElementById('configModalTitle').textContent = 'ä¿®æ”¹å¯¹è¯å‚æ•°';
            document.getElementById('saveConfigBtnText').textContent = 'ä¿å­˜é…ç½®';
            
            console.log('[é…ç½®] ç¼–è¾‘æ¨¡å¼ï¼Œå°è¯•è·å–å¯¹è¯é…ç½®, ID:', currentConversationId);
            
            try {
                // è·å–å½“å‰å¯¹è¯çš„çœŸå®é…ç½®
                const response = await fetch(`/api/conversations/${currentConversationId}/config`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('[é…ç½®] è·å–åˆ°å¯¹è¯çš„çœŸå®é…ç½®:', data.config);
                    currentConfig = data.config;
                } else {
                    console.warn('[é…ç½®] è·å–å¯¹è¯é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', data.message);
                    ensureDefaultConfig();
                }
            } catch (fetchError) {
                console.error('[é…ç½®] è·å–é…ç½®APIè°ƒç”¨å¤±è´¥:', fetchError);
                ensureDefaultConfig();
            }
        } else {
            // æ²¡æœ‰å¯¹è¯IDï¼Œæ–°å»ºæ¨¡å¼
            configModalMode = 'create';
            document.getElementById('configModalTitle').textContent = 'æ–°å»ºå¯¹è¯ - å‚æ•°è®¾ç½®';
            document.getElementById('saveConfigBtnText').textContent = 'å¼€å§‹å¯¹è¯';
            
            console.log('[é…ç½®] æ–°å»ºæ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            ensureDefaultConfig();
        }
        
        // å¡«å……é…ç½®åˆ°è¡¨å•
        fillConfigForm(currentConfig);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
        
    } catch (error) {
        console.error('[é…ç½®] æ‰“å¼€é…ç½®æ¨¡æ€æ¡†å¤±è´¥:', error);
        
        // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤é…ç½®å’Œæ–°å»ºæ¨¡å¼
        configModalMode = 'create';
        document.getElementById('configModalTitle').textContent = 'æ–°å»ºå¯¹è¯ - å‚æ•°è®¾ç½®';
        document.getElementById('saveConfigBtnText').textContent = 'å¼€å§‹å¯¹è¯';
        
        ensureDefaultConfig();
        fillConfigForm(currentConfig);
        
        const modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
    }
}

// å¡«å……é…ç½®è¡¨å• - é€‚åº”æ–°çš„ç´§å‡‘å‹ç•Œé¢
function fillConfigForm(config) {
    console.log('[é…ç½®] å¡«å……è¡¨å•é…ç½®:', config);
    
    // 1. è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.value = config.model_name || 'deepseek-chat';
    console.log('[é…ç½®] è®¾ç½®æ¨¡å‹:', modelSelect.value);
    
    // 2. è®¾ç½®æ¸©åº¦é€‰æ‹©å™¨ - V0.3.1 ä¿®å¤
    const temperatureSelect = document.getElementById('temperatureSelect');
    let temperatureValue = '1.0'; // å¼ºåˆ¶é»˜è®¤å€¼
    
    if (config.temperature !== undefined && config.temperature !== null) {
        temperatureValue = config.temperature.toString();
    }
    
    console.log('[é…ç½®] å‡†å¤‡è®¾ç½®æ¸©åº¦å€¼:', temperatureValue);
    console.log('[é…ç½®] æ¸©åº¦é€‰æ‹©å™¨å½“å‰é€‰é¡¹:');
    for (let i = 0; i < temperatureSelect.options.length; i++) {
        console.log(`  é€‰é¡¹${i}: value="${temperatureSelect.options[i].value}", text="${temperatureSelect.options[i].text}"`);
    }
    
    // V0.3.1 ä¿®å¤ï¼šå»¶è¿Ÿè®¾ç½®ï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½ä¸”æ¨¡æ€æ¡†ä»ç„¶å¯è§
    setTimeout(() => {
        // æ£€æŸ¥æ¸©åº¦é€‰æ‹©å™¨æ˜¯å¦ä»ç„¶å¯è®¿é—®ï¼ˆæ¨¡æ€æ¡†æœªå…³é—­ï¼‰
        const currentTemperatureSelect = document.getElementById('temperatureSelect');
        if (!currentTemperatureSelect) {
            console.log('[é…ç½®] æ¨¡æ€æ¡†å·²å…³é—­ï¼Œè·³è¿‡å»¶è¿Ÿçš„æ¸©åº¦è®¾ç½®');
            return;
        }
        
        currentTemperatureSelect.value = temperatureValue;
        console.log('[é…ç½®] æ¸©åº¦å€¼è®¾ç½®å:', currentTemperatureSelect.value);
        
        // å¦‚æœè®¾ç½®å¤±è´¥ï¼Œå¼ºåˆ¶é€‰æ‹©ç¬¬ä¸€ä¸ªåŒ…å«1.0çš„é€‰é¡¹
        if (currentTemperatureSelect.value !== temperatureValue) {
            console.warn('[é…ç½®] æ¸©åº¦å€¼è®¾ç½®å¤±è´¥ï¼Œå°è¯•é€šè¿‡ç´¢å¼•è®¾ç½®');
            for (let i = 0; i < currentTemperatureSelect.options.length; i++) {
                if (currentTemperatureSelect.options[i].value === temperatureValue) {
                    currentTemperatureSelect.selectedIndex = i;
                    console.log('[é…ç½®] é€šè¿‡ç´¢å¼•è®¾ç½®æ¸©åº¦æˆåŠŸ:', currentTemperatureSelect.value);
                    break;
                }
            }
        }
        
        // åªæœ‰å½“æ‰€æœ‰å¿…è¦å…ƒç´ éƒ½å­˜åœ¨æ—¶æ‰è§¦å‘changeäº‹ä»¶
        if (document.getElementById('configPreview')) {
            currentTemperatureSelect.dispatchEvent(new Event('change'));
            console.log('[é…ç½®] å»¶è¿Ÿè®¾ç½®å®Œæˆï¼Œå·²è§¦å‘changeäº‹ä»¶');
        } else {
            console.log('[é…ç½®] æ¨¡æ€æ¡†å·²å…³é—­ï¼Œè·³è¿‡changeäº‹ä»¶è§¦å‘');
        }
    }, 50);
    
    // 3. è®¾ç½®ç³»ç»Ÿæç¤ºè¯
    const systemPrompt = document.getElementById('systemPrompt');
    systemPrompt.value = config.system_prompt || '';
    console.log('[é…ç½®] è®¾ç½®ç³»ç»Ÿæç¤ºè¯é•¿åº¦:', systemPrompt.value.length);
    
    // 4. æ›´æ–°è¾“å‡ºé•¿åº¦é€‰é¡¹
    updateMaxTokensOptions(config.model_name || 'deepseek-chat');
    setMaxTokensValue(config.max_tokens || 4000);
    
    // 5. æ›´æ–°å­—ç¬¦è®¡æ•°å’Œé¢„è§ˆ
    updateCharCount();
    updateConfigPreview();
    
    console.log('[é…ç½®] é…ç½®è¡¨å•å¡«å……å®Œæˆ');
}

// æ¨¡å‹å˜åŒ–æ—¶æ›´æ–°è¾“å‡ºé•¿åº¦é€‰é¡¹ - V0.3.1 ä¿®å¤ï¼šæ·»åŠ æ€è€ƒè¿‡ç¨‹è‡ªåŠ¨æ§åˆ¶å’Œæ¸©åº¦æ§åˆ¶
function onModelChange() {
    const modelSelect = document.getElementById('modelSelect');
    if (!modelSelect) {
        console.warn('[é…ç½®] onModelChange: modelSelectå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    const modelName = modelSelect.value;
    const enableThinkingCheckbox = document.getElementById('enableThinking');
    const temperatureSelect = document.getElementById('temperatureSelect');
    
    // V0.3.1 ä¿®å¤ï¼šè‡ªåŠ¨æ§åˆ¶æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºé€‰é¡¹
    if (enableThinkingCheckbox) {
        if (modelName === 'deepseek-reasoner') {
            // R1æ¨¡å‹ï¼šè‡ªåŠ¨å¯ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
            enableThinkingCheckbox.checked = true;
            enableThinkingCheckbox.disabled = false;
            console.log('[é…ç½®] é€‰æ‹©R1æ¨¡å‹ï¼Œè‡ªåŠ¨å¯ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º');
        } else {
            // å…¶ä»–æ¨¡å‹ï¼šç¦ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºé€‰é¡¹
            enableThinkingCheckbox.checked = false;
            enableThinkingCheckbox.disabled = true;
            console.log('[é…ç½®] é€‰æ‹©éR1æ¨¡å‹ï¼Œç¦ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º');
        }
    }
    
    // V0.3.1 ä¿®å¤ï¼šæ¸©åº¦å‚æ•°æ§åˆ¶é€»è¾‘
    if (temperatureSelect) {
        if (modelName === 'deepseek-reasoner') {
            // R1æ¨¡å‹ï¼šç¦ç”¨æ¸©åº¦é€‰æ‹©ï¼ŒR1æœ‰å›ºå®šæ¨ç†æ¸©åº¦
            temperatureSelect.disabled = true;
            console.log('[é…ç½®] é€‰æ‹©R1æ¨¡å‹ï¼Œç¦ç”¨æ¸©åº¦é€‰æ‹©');
        } else {
            // V3æ¨¡å‹ï¼šå¯ç”¨æ¸©åº¦é€‰æ‹©ï¼Œé»˜è®¤ä¸º1.0
            temperatureSelect.disabled = false;
            temperatureSelect.value = '1.0';
            console.log('[é…ç½®] é€‰æ‹©V3æ¨¡å‹ï¼Œå¯ç”¨æ¸©åº¦é€‰æ‹©ï¼Œé»˜è®¤ä¸º1.0');
        }
    }
    
    updateMaxTokensOptions(modelName);
    updateConfigPreview();
}

// æ›´æ–°è¾“å‡ºé•¿åº¦é€‰é¡¹ - æ–°çš„å•é€‰æŒ‰é’®ç‰ˆæœ¬ - V0.3.1 ä¿®å¤ï¼šå¢å¼ºå®‰å…¨æ£€æŸ¥
function updateMaxTokensOptions(modelName) {
    const container = document.getElementById('maxTokensRadioGroup');
    if (!container) {
        console.warn('[é…ç½®] updateMaxTokensOptions: maxTokensRadioGroupå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    container.innerHTML = '';
    
    let options = [];
    if (modelName === 'deepseek-chat') {
        options = [
            { value: '4000', label: '4K' },
            { value: '8000', label: '8K' }
        ];
    } else if (modelName === 'deepseek-reasoner') {
        options = [
            { value: '32000', label: '32K' },
            { value: '64000', label: '64K' }
        ];
    }
    
    options.forEach((option, index) => {
        const radioHtml = `
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="max_tokens" 
                       id="maxTokens${option.value}" value="${option.value}" 
                       ${index === 0 ? 'checked' : ''} onchange="updateConfigPreview()">
                <label class="form-check-label small" for="maxTokens${option.value}">
                    ${option.label}
                </label>
            </div>
        `;
        container.innerHTML += radioHtml;
    });
}

// è®¾ç½®è¾“å‡ºé•¿åº¦å€¼
function setMaxTokensValue(value) {
    const radio = document.querySelector(`input[name="max_tokens"][value="${value}"]`);
    if (radio) {
        radio.checked = true;
    }
}

// è·å–é€‰ä¸­çš„è¾“å‡ºé•¿åº¦å€¼ - V0.3.1 ä¿®å¤ï¼šæ·»åŠ å®‰å…¨æ£€æŸ¥
function getMaxTokensValue() {
    try {
        const radio = document.querySelector('input[name="max_tokens"]:checked');
        return radio ? parseInt(radio.value) : 4000;
    } catch (error) {
        console.warn('[é…ç½®] getMaxTokensValue: è·å–è¾“å‡ºé•¿åº¦å€¼å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼');
        return 4000;
    }
}

// æ›´æ–°å­—ç¬¦è®¡æ•° - V0.3.1 ä¿®å¤ï¼šæ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
function updateCharCount() {
    const systemPrompt = document.getElementById('systemPrompt');
    const charCountSpan = document.getElementById('promptCharCount');
    
    if (!systemPrompt || !charCountSpan) {
        console.warn('[é…ç½®] updateCharCount: å¿…è¦å…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    const charCount = systemPrompt.value.length;
    charCountSpan.textContent = charCount;
    
    // å­—ç¬¦æ•°è­¦å‘Š
    if (charCount > 1800) {
        charCountSpan.className = 'text-warning';
    } else if (charCount > 1950) {
        charCountSpan.className = 'text-danger';
    } else {
        charCountSpan.className = 'text-muted';
    }
}

// æ›´æ–°é…ç½®é¢„è§ˆ - ç´§å‡‘ç‰ˆæœ¬ - V0.3.1 ä¿®å¤ï¼šæ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
function updateConfigPreview() {
    // V0.3.1 ä¿®å¤ï¼šæ£€æŸ¥å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
    const modelSelect = document.getElementById('modelSelect');
    const temperatureSelect = document.getElementById('temperatureSelect');
    const systemPromptElement = document.getElementById('systemPrompt');
    const configPreview = document.getElementById('configPreview');
    
    if (!modelSelect || !temperatureSelect || !systemPromptElement || !configPreview) {
        console.warn('[é…ç½®] updateConfigPreview: å¿…è¦å…ƒç´ ä¸å­˜åœ¨ï¼Œå¯èƒ½æ¨¡æ€æ¡†å·²å…³é—­');
        return;
    }
    
    const modelName = modelSelect.value;
    const temperature = temperatureSelect.value;
    const maxTokens = getMaxTokensValue();
    const systemPrompt = systemPromptElement.value;
    
    const modelDisplayMap = {
        'deepseek-chat': 'DeepSeek-V3',
        'deepseek-reasoner': 'DeepSeek-R1'
    };
    
    const temperatureDisplayMap = {
        '0.0': 'ä»£ç ',
        '1.0': 'é€šç”¨',
        '1.5': 'åˆ›æ„'
    };
    
    const previewHtml = `
        <div class="d-flex justify-content-between small">
            <span><strong>${modelDisplayMap[modelName] || modelName}</strong></span>
            <span>æ¸©åº¦: ${temperatureDisplayMap[temperature] || temperature}</span>
            <span>è¾“å‡º: ${(maxTokens/1000).toFixed(0)}K</span>
            <span>${systemPrompt ? 'âœ“ æç¤ºè¯' : 'é»˜è®¤'}</span>
        </div>
    `;
    
    configPreview.innerHTML = previewHtml;
}

// ä¿å­˜å¯¹è¯é…ç½® - æ›´æ–°ä»¥æ”¯æŒæ–°å»ºå’Œä¿®æ”¹æ¨¡å¼
async function saveConversationConfig() {
    try {
        const modelSelect = document.getElementById('modelSelect');
        const temperatureSelect = document.getElementById('temperatureSelect');
        const systemPrompt = document.getElementById('systemPrompt');
        
        console.log('[é…ç½®] å‡†å¤‡ä¿å­˜é…ç½®');
        console.log('[é…ç½®] æ¨¡å‹é€‰æ‹©å™¨å€¼:', modelSelect.value);
        console.log('[é…ç½®] æ¸©åº¦é€‰æ‹©å™¨å€¼:', temperatureSelect.value);
        console.log('[é…ç½®] è¾“å‡ºé•¿åº¦å€¼:', getMaxTokensValue());
        
        const config = {
            model_name: modelSelect.value,
            temperature: parseFloat(temperatureSelect.value),
            max_tokens: getMaxTokensValue(),
            system_prompt: systemPrompt.value.trim() || null
        };
        
        console.log('[é…ç½®] å‡†å¤‡ä¿å­˜çš„é…ç½®å¯¹è±¡:', config);
        
        // éªŒè¯é…ç½®
        if (!config.model_name) {
            showAlert('è¯·é€‰æ‹©æ¨¡å‹', 'error');
            return;
        }
        
        if (isNaN(config.temperature)) {
            showAlert('æ¸©åº¦å‚æ•°æ— æ•ˆ', 'error');
            return;
        }
        
        if (!config.max_tokens || config.max_tokens <= 0) {
            showAlert('è¾“å‡ºé•¿åº¦å‚æ•°æ— æ•ˆ', 'error');
            return;
        }
        
        // éªŒè¯ç³»ç»Ÿæç¤ºè¯é•¿åº¦
        if (config.system_prompt && config.system_prompt.length > 2000) {
            showAlert('ç³»ç»Ÿæç¤ºè¯ä¸èƒ½è¶…è¿‡2000å­—ç¬¦', 'error');
            return;
        }
        
        if (configModalMode === 'create') {
            // æ–°å»ºå¯¹è¯æ¨¡å¼
            currentConfig = config;
            console.log('[é…ç½®] æ–°å»ºå¯¹è¯æ¨¡å¼ï¼Œä¿å­˜é…ç½®:', currentConfig);
            
            // V0.3.1 ä¿®å¤ï¼šç«‹å³æ˜¾ç¤ºæ¨¡å‹å‚æ•°è°ƒè¯•ä¿¡æ¯
            if (debugMode) {
                updateModelParamsDebug({
                    model_name: config.model_name,
                    temperature: config.temperature,
                    max_tokens: config.max_tokens,
                    has_system_prompt: !!config.system_prompt,
                    system_prompt_length: config.system_prompt ? config.system_prompt.length : 0
                });
            }
            
            // å…³é—­æ¨¡æ€æ¡†å¹¶å¼€å§‹æ–°å¯¹è¯
            bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
            doStartNewConversation();
            
        } else if (configModalMode === 'edit') {
            console.log('[é…ç½®] ç¼–è¾‘æ¨¡å¼ï¼Œå½“å‰å¯¹è¯ID:', currentConversationId);
            
            if (currentConversationId) {
                // æœ‰å¯¹è¯IDï¼Œæ›´æ–°ç°æœ‰å¯¹è¯é…ç½®
                const response = await fetch(`/api/conversations/${currentConversationId}/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                console.log('[é…ç½®] APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[é…ç½®] APIå“åº”æ•°æ®:', data);
                
                if (data.success) {
                    currentConfig = config;
                    console.log('[é…ç½®] é…ç½®ä¿å­˜æˆåŠŸï¼Œæ›´æ–°currentConfig:', currentConfig);
                    
                    // V0.3.1 ä¿®å¤ï¼šé…ç½®æ›´æ–°åç«‹å³æ˜¾ç¤ºæ¨¡å‹å‚æ•°è°ƒè¯•ä¿¡æ¯
                    if (debugMode) {
                        updateModelParamsDebug({
                            model_name: config.model_name,
                            temperature: config.temperature,
                            max_tokens: config.max_tokens,
                            has_system_prompt: !!config.system_prompt,
                            system_prompt_length: config.system_prompt ? config.system_prompt.length : 0
                        });
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                    showAlert('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    console.error('[é…ç½®] ä¿å­˜å¤±è´¥:', data.message);
                    showAlert(data.message || 'ä¿å­˜é…ç½®å¤±è´¥', 'error');
                }
            } else {
                // ç¼–è¾‘æ¨¡å¼ä½†æ²¡æœ‰å¯¹è¯IDï¼Œè½¬ä¸ºæ–°å»ºæ¨¡å¼
                console.log('[é…ç½®] ç¼–è¾‘æ¨¡å¼ä½†æ— å¯¹è¯IDï¼Œè½¬ä¸ºæ–°å»ºå¯¹è¯');
                currentConfig = config;
                
                if (debugMode) {
                    updateModelParamsDebug({
                        model_name: config.model_name,
                        temperature: config.temperature,
                        max_tokens: config.max_tokens,
                        has_system_prompt: !!config.system_prompt,
                        system_prompt_length: config.system_prompt ? config.system_prompt.length : 0
                    });
                }
                
                bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
                doStartNewConversation();
            }
        } else {
            console.error('[é…ç½®] æœªçŸ¥çš„é…ç½®æ¨¡å¼:', configModalMode);
            showAlert('ä¿å­˜é…ç½®å¤±è´¥ï¼šæœªçŸ¥æ¨¡å¼', 'error');
        }
        
    } catch (error) {
        console.error('[é…ç½®] ä¿å­˜é…ç½®å¼‚å¸¸:', error);
        showAlert(`ä¿å­˜é…ç½®å¤±è´¥: ${error.message}`, 'error');
    }
}

// åˆ‡æ¢è°ƒè¯•æ¨¡å¼
function toggleDebugMode() {
    debugMode = !debugMode;
    const debugPanel = document.getElementById('debugPanel');
    const chatMain = document.querySelector('.chat-main');
    const debugBtn = document.getElementById('debugBtn');
    
    if (debugMode) {
        debugPanel.style.display = 'flex';
        chatMain.classList.add('debug-mode');
        if (debugBtn) {
            debugBtn.classList.add('active');
        }
        addDebugEntry('system', 'è°ƒè¯•æ¨¡å¼å·²å¼€å¯', 'info');
        loadSystemInfo();
        
        // V0.3.1 ä¿®å¤ï¼šå¼€å¯è°ƒè¯•æ¨¡å¼æ—¶ç«‹å³æ˜¾ç¤ºå½“å‰å¯¹è¯çš„æ¨¡å‹å‚æ•°
        if (currentConfig) {
            updateModelParamsDebug({
                model_name: currentConfig.model_name,
                temperature: currentConfig.temperature,
                max_tokens: currentConfig.max_tokens,
                has_system_prompt: !!currentConfig.system_prompt,
                system_prompt_length: currentConfig.system_prompt ? currentConfig.system_prompt.length : 0
            });
        }
    } else {
        debugPanel.style.display = 'none';
        chatMain.classList.remove('debug-mode');
        if (debugBtn) {
            debugBtn.classList.remove('active');
        }
    }
}

// å…³é—­è°ƒè¯•é¢æ¿
function closeDebugPanel() {
    debugMode = false;
    document.getElementById('debugPanel').style.display = 'none';
    document.querySelector('.chat-main').classList.remove('debug-mode');
    const debugBtn = document.getElementById('debugBtn');
    if (debugBtn) {
        debugBtn.classList.remove('active');
    }
}

// æ¸…ç©ºè°ƒè¯•æ—¥å¿— - V0.3.1 ä¿®å¤ï¼šæ¸…ç©ºæ‰€æœ‰è°ƒè¯•æ ‡ç­¾é¡µ
function clearDebugLog() {
    // V0.3.1 ä¿®å¤ï¼šæ¸…ç©ºç³»ç»Ÿæ—¥å¿—è€Œä¸æ˜¯ä¸å­˜åœ¨çš„debugLog
    const debugSystem = document.getElementById('debugSystem');
    if (debugSystem) {
        debugSystem.innerHTML = '<div class="text-muted text-center py-3">ç³»ç»ŸçŠ¶æ€ä¿¡æ¯</div>';
    }
    
    const debugContext = document.getElementById('debugContext');
    if (debugContext) {
        debugContext.innerHTML = '<div class="text-muted text-center py-3">APIäº¤äº’ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    }
    
    const debugLangchain = document.getElementById('debugLangchain');
    if (debugLangchain) {
        debugLangchain.innerHTML = '<div class="text-muted text-center py-3">LangChainå¤„ç†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    }
    
    const debugDatabase = document.getElementById('debugDatabase');
    if (debugDatabase) {
        debugDatabase.innerHTML = '<div class="text-muted text-center py-3">æ•°æ®åº“ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    }
    
    const debugModel = document.getElementById('debugModel');
    if (debugModel) {
        debugModel.innerHTML = '<div class="text-muted text-center py-3">æ¨¡å‹å‚æ•°ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>';
    }
    
    debugData = {};
    console.log('[è°ƒè¯•] æ‰€æœ‰è°ƒè¯•é¢æ¿å·²æ¸…ç©º');
}

// åˆ‡æ¢è°ƒè¯•æ ‡ç­¾
function switchDebugTab(tabName) {
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.debug-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
    document.querySelectorAll('.debug-tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    document.getElementById(`debug-${tabName}`).classList.add('active');
    
    currentDebugTab = tabName;
    
    // å¦‚æœåˆ‡æ¢åˆ°ç³»ç»Ÿæ ‡ç­¾ï¼ŒåŠ è½½ç³»ç»Ÿä¿¡æ¯
    if (tabName === 'system') {
        loadSystemInfo();
    }
    
    // å¦‚æœåˆ‡æ¢åˆ°æ•°æ®åº“æ ‡ç­¾ï¼ŒåŠ è½½æ•°æ®åº“ä¿¡æ¯
    if (tabName === 'database') {
        loadDatabaseInfo();
    }
}

// æ·»åŠ è°ƒè¯•æ—¥å¿—æ¡ç›® - V0.3.1 ä¿®å¤ï¼šä½¿ç”¨ç³»ç»Ÿæ ‡ç­¾é¡µæ˜¾ç¤ºæ—¥å¿—
function addDebugEntry(type, message, level = 'info', data = null) {
    if (!debugMode) return;
    
    // V0.3.1 ä¿®å¤ï¼šä½¿ç”¨ç³»ç»Ÿæ ‡ç­¾é¡µè€Œä¸æ˜¯ä¸å­˜åœ¨çš„debugLogå…ƒç´ 
    const debugSystem = document.getElementById('debugSystem');
    if (!debugSystem) {
        console.warn('[è°ƒè¯•] debugSystemå…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ è°ƒè¯•æ¡ç›®');
        return;
    }
    
    const timestamp = new Date().toLocaleTimeString();
    
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ¡ç›®ï¼Œæ¸…ç©ºé»˜è®¤æ¶ˆæ¯
    if (debugSystem.innerHTML.includes('ç³»ç»ŸçŠ¶æ€ä¿¡æ¯')) {
        debugSystem.innerHTML = '<div class="mb-2"><strong>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</strong></div>';
    }
    
    const entry = document.createElement('div');
    entry.className = `debug-entry ${level} mb-2`;
    
    let content = `
        <div class="debug-entry-header">
            <span class="small text-muted">[${timestamp}]</span> 
            <span class="badge bg-${level === 'error' ? 'danger' : level === 'success' ? 'success' : 'primary'}">${type.toUpperCase()}</span>
        </div>
        <div class="debug-entry-content mt-1">${message}</div>
    `;
    
    if (data) {
        content += `<details class="mt-1"><summary class="small text-muted">è¯¦ç»†æ•°æ®</summary><div class="debug-json mt-1">${JSON.stringify(data, null, 2)}</div></details>`;
    }
    
    entry.innerHTML = content;
    debugSystem.appendChild(entry);
    
    // é™åˆ¶æ¡ç›®æ•°é‡ï¼Œåªä¿ç•™æœ€æ–°çš„20æ¡
    const entries = debugSystem.querySelectorAll('.debug-entry');
    if (entries.length > 20) {
        entries[1].remove(); // ä¿ç•™æ ‡é¢˜ï¼Œåˆ é™¤æœ€æ—§çš„æ¡ç›®
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    debugSystem.scrollTop = debugSystem.scrollHeight;
}

// V0.3.1 é‡æ–°è®¾è®¡ä¸Šä¸‹æ–‡è°ƒè¯•ä¿¡æ¯ - å±•ç¤ºå®Œæ•´APIäº¤äº’
function updateContextDebug(apiInteraction) {
    if (!debugMode) return;
    
    const debugContext = document.getElementById('debugContext');
    if (!debugContext) {
        console.warn('[è°ƒè¯•] debugContextå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    const timestamp = new Date().toLocaleTimeString();
    
    if (!apiInteraction) {
        debugContext.innerHTML = `
            <div class="text-muted text-center py-3">
                å‘é€æ¶ˆæ¯åå°†æ˜¾ç¤ºAPIäº¤äº’è¯¦æƒ…
            </div>
        `;
        return;
    }
    
    debugContext.innerHTML = `
        <div class="debug-entry success">
            <div class="debug-entry-header">ğŸ“¤ å‘é€ç»™APIçš„è¯·æ±‚ <span class="text-muted">${timestamp}</span></div>
            <div class="debug-entry-content">
                <div class="mb-2">
                    <strong>ç”¨æˆ·åŸå§‹è¾“å…¥:</strong> 
                    <code style="background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">
                        ${truncateText(apiInteraction.user_message, 100)}
                    </code>
                </div>
                
                <details class="mt-2">
                    <summary class="text-primary" style="cursor: pointer;">ğŸ“‹ å®Œæ•´è¯·æ±‚JSON</summary>
                    <div class="debug-json mt-2" style="max-height: 300px; overflow-y: auto;">
                        ${JSON.stringify(apiInteraction.request, null, 2)}
                    </div>
                </details>
            </div>
        </div>
        
        <div class="debug-entry info mt-3">
            <div class="debug-entry-header">ğŸ“¥ APIè¿”å›çš„å“åº”</div>
            <div class="debug-entry-content">
                <div class="mb-2">
                    <strong>å“åº”çŠ¶æ€:</strong> 
                    <span class="badge ${apiInteraction.response_success ? 'bg-success' : 'bg-danger'}">
                        ${apiInteraction.response_success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                    </span>
                </div>
                
                ${apiInteraction.response_content ? `
                    <div class="mb-2">
                        <strong>AIå›å¤å†…å®¹é¢„è§ˆ:</strong><br>
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #007bff;">
                            ${truncateText(apiInteraction.response_content, 200)}
                        </div>
                    </div>
                ` : ''}
                
                ${apiInteraction.thinking_process ? `
                    <div class="mb-2">
                        <strong>R1æ€è€ƒè¿‡ç¨‹:</strong> 
                        <span class="text-success">å·²æ£€æµ‹åˆ°</span> 
                        (${apiInteraction.thinking_process.length} å­—ç¬¦)
                    </div>
                ` : ''}
                
                <details class="mt-2">
                    <summary class="text-primary" style="cursor: pointer;">ğŸ“‹ å®Œæ•´å“åº”JSON</summary>
                    <div class="debug-json mt-2" style="max-height: 300px; overflow-y: auto;">
                        ${JSON.stringify(apiInteraction.response, null, 2)}
                    </div>
                </details>
                
                <div class="mt-2 text-muted small">
                    <strong>å¤„ç†æ—¶é—´:</strong> ${apiInteraction.processing_time || 'æœªçŸ¥'}ms |
                    <strong>Tokenæ¶ˆè€—:</strong> ${apiInteraction.token_usage || 'æœªçŸ¥'}
                </div>
            </div>
        </div>
    `;
}

// æ–‡æœ¬æˆªæ–­å‡½æ•°
function truncateText(text, maxLength) {
    if (!text) return 'æ— ';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// æ›´æ–°LangChainè°ƒè¯•ä¿¡æ¯
function updateLangChainDebug(langchainInfo) {
    if (!debugMode) return;
    
    const debugLangchain = document.getElementById('debugLangchain');
    if (!debugLangchain) {
        console.warn('[è°ƒè¯•] debugLangchainå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    debugLangchain.innerHTML = '';
    
    if (langchainInfo.enabled) {
        debugLangchain.innerHTML += `
            <div class="debug-entry success">
                <div class="debug-entry-header">LangChainçŠ¶æ€</div>
                <div class="debug-entry-content">
                    <p><strong>çŠ¶æ€:</strong> å·²å¯ç”¨</p>
                    <p><strong>å†…å­˜ç±»å‹:</strong> ${langchainInfo.memory_type || 'æœªçŸ¥'}</p>
                    <p><strong>å¤„ç†æ—¶é—´:</strong> ${langchainInfo.processing_time || 'æœªçŸ¥'}ms</p>
                </div>
            </div>
        `;
        
        if (langchainInfo.context_info) {
            debugLangchain.innerHTML += `
                <div class="debug-entry info">
                    <div class="debug-entry-header">ä¸Šä¸‹æ–‡ç®¡ç†</div>
                    <div class="debug-json">${JSON.stringify(langchainInfo.context_info, null, 2)}</div>
                </div>
            `;
        }
        
        if (langchainInfo.processing_steps) {
            debugLangchain.innerHTML += `
                <div class="debug-entry">
                    <div class="debug-entry-header">å¤„ç†æ­¥éª¤</div>
                    <div class="debug-entry-content">
                        ${langchainInfo.processing_steps.map(step => `<p>â€¢ ${step}</p>`).join('')}
                    </div>
                </div>
            `;
        }
    } else {
        debugLangchain.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">LangChainçŠ¶æ€</div>
                <div class="debug-entry-content">LangChainæœªå¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿä¸Šä¸‹æ–‡ç®¡ç†</div>
            </div>
        `;
    }
}

// V0.3.1 é‡æ–°è®¾è®¡æ¨¡å‹å‚æ•°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
function updateModelParamsDebug(modelParams) {
    if (!debugMode) return;
    
    const debugModel = document.getElementById('debugModel');
    if (!debugModel) return;
    
    const timestamp = new Date().toLocaleTimeString();
    
    debugModel.innerHTML = `
        <div class="debug-entry success">
            <div class="debug-entry-header">ğŸ¤– å½“å‰å¯¹è¯æ¨¡å‹é…ç½®</div>
            <div class="debug-entry-content">
                <table class="table table-sm table-borderless mb-0">
                    <tr><td width="30%"><strong>æ¨¡å‹åç§°:</strong></td><td>${getModelDisplayName(modelParams.model_name)} <code>(${modelParams.model_name})</code></td></tr>
                    <tr><td><strong>æ¸©åº¦å‚æ•°:</strong></td><td>${getTemperatureDisplayName(modelParams.temperature)} <code>(${modelParams.temperature})</code></td></tr>
                    <tr><td><strong>æœ€å¤§è¾“å‡º:</strong></td><td><code>${modelParams.max_tokens}</code> tokens</td></tr>
                    <tr><td><strong>ç³»ç»Ÿæç¤ºè¯:</strong></td><td>${modelParams.has_system_prompt ? `<span class="text-success">å·²è®¾ç½®</span> (${modelParams.system_prompt_length} å­—ç¬¦)` : '<span class="text-muted">æœªè®¾ç½®</span>'}</td></tr>
                    <tr><td><strong>æ›´æ–°æ—¶é—´:</strong></td><td><code>${timestamp}</code></td></tr>
                </table>
            </div>
        </div>
        
        <div class="debug-entry info mt-3">
            <div class="debug-entry-header">ğŸ“Š æ¨¡å‹ç‰¹æ€§è¯´æ˜</div>
            <div class="debug-entry-content">
                ${getModelDescription(modelParams.model_name)}
            </div>
        </div>
    `;
}

// è·å–æ¨¡å‹æ˜¾ç¤ºåç§°
function getModelDisplayName(modelName) {
    const modelNames = {
        'deepseek-chat': 'DeepSeek-V3',
        'deepseek-reasoner': 'DeepSeek-R1'
    };
    return modelNames[modelName] || modelName;
}

// è·å–æ¸©åº¦æ˜¾ç¤ºåç§°
function getTemperatureDisplayName(temperature) {
    const tempNames = {
        0: 'ä»£ç ç”Ÿæˆ',
        1.0: 'é€šç”¨å¯¹è¯',
        1.5: 'åˆ›æ„å†™ä½œ'
    };
    return tempNames[temperature] || `è‡ªå®šä¹‰(${temperature})`;
}

// è·å–æ¨¡å‹ç‰¹æ€§è¯´æ˜
function getModelDescription(modelName) {
    const descriptions = {
        'deepseek-chat': `
            <p><strong>DeepSeek-V3</strong> - é«˜æ€§èƒ½é€šç”¨å¯¹è¯æ¨¡å‹</p>
            <ul class="mb-0" style="font-size: 0.9em;">
                <li>æ”¯æŒ4K/8Kè¾“å‡ºé•¿åº¦</li>
                <li>å¹³è¡¡çš„æ¨ç†å’Œåˆ›æ„èƒ½åŠ›</li>
                <li>é€‚åˆæ—¥å¸¸å¯¹è¯ã€ä»£ç ç”Ÿæˆã€æ–‡æ¡£å†™ä½œ</li>
                <li>å“åº”é€Ÿåº¦å¿«ï¼Œæˆæœ¬è¾ƒä½</li>
            </ul>
        `,
        'deepseek-reasoner': `
            <p><strong>DeepSeek-R1</strong> - æ·±åº¦æ¨ç†æ€è€ƒæ¨¡å‹</p>
            <ul class="mb-0" style="font-size: 0.9em;">
                <li>æ”¯æŒ32K/64Kè¶…é•¿è¾“å‡º</li>
                <li>å…·å¤‡æ·±åº¦æ€è€ƒå’Œæ¨ç†èƒ½åŠ›</li>
                <li>é€‚åˆå¤æ‚é—®é¢˜åˆ†æã€å­¦æœ¯ç ”ç©¶</li>
                <li>ä¼šæ˜¾ç¤ºå®Œæ•´çš„æ€è€ƒè¿‡ç¨‹</li>
            </ul>
        `
    };
    return descriptions[modelName] || '<p>æ¨¡å‹ä¿¡æ¯æš‚ä¸å¯ç”¨</p>';
}

// æ›´æ–°æ•°æ®åº“è°ƒè¯•ä¿¡æ¯
function updateDatabaseDebug(dbOperations) {
    if (!debugMode) return;
    
    // åœ¨å¤„ç†è¿‡ç¨‹æ ‡ç­¾é¡µæ˜¾ç¤ºæ•°æ®åº“æ“ä½œ
    const debugProcess = document.getElementById('debug-process');
    if (!debugProcess) return;
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºæ•°æ®åº“æ“ä½œéƒ¨åˆ†
    let dbSection = debugProcess.querySelector('.db-operations-section');
    if (!dbSection) {
        dbSection = document.createElement('div');
        dbSection.className = 'db-operations-section';
        dbSection.innerHTML = `
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ“Š æ•°æ®åº“æ“ä½œ</div>
                <div class="db-operations-list"></div>
            </div>
        `;
        debugProcess.appendChild(dbSection);
    }
    
    const operationsList = dbSection.querySelector('.db-operations-list');
    
    // æ¸²æŸ“æ•°æ®åº“æ“ä½œ
    dbOperations.forEach(op => {
        const opDiv = document.createElement('div');
        opDiv.className = `db-operation ${getOperationLevel(op.operation)}`;
        
        const timestamp = new Date(op.timestamp * 1000).toLocaleTimeString();
        let content = `<strong>[${timestamp}]</strong> ${getOperationDescription(op)}`;
        
        if (op.duration) {
            content += ` <span class="text-muted">(${op.duration.toFixed(3)}s)</span>`;
        }
        
        if (op.error) {
            content += `<br><span class="text-danger">é”™è¯¯: ${op.error}</span>`;
        }
        
        opDiv.innerHTML = content;
        operationsList.appendChild(opDiv);
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    operationsList.scrollTop = operationsList.scrollHeight;
}

// è·å–æ“ä½œçº§åˆ«æ ·å¼
function getOperationLevel(operation) {
    const successOps = ['user_message_saved', 'save_ai_message_success', 'ai_message_queued_for_save'];
    const warningOps = ['message_already_exists', 'retry_scheduled'];
    const errorOps = ['save_ai_message_error', 'conversation_not_found', 'save_failed_final'];
    
    if (successOps.includes(operation)) return 'success';
    if (warningOps.includes(operation)) return 'warning';
    if (errorOps.includes(operation)) return 'error';
    return 'info';
}

// è·å–æ“ä½œæè¿°
function getOperationDescription(op) {
    const descriptions = {
        'user_message_saved': 'âœ… ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜',
        'ai_message_queued_for_save': 'â³ AIæ¶ˆæ¯å·²åŠ å…¥ä¿å­˜é˜Ÿåˆ—',
        'save_ai_message_start': 'ğŸ”„ å¼€å§‹ä¿å­˜AIæ¶ˆæ¯',
        'save_ai_message_success': 'âœ… AIæ¶ˆæ¯ä¿å­˜æˆåŠŸ',
        'save_ai_message_error': 'âŒ AIæ¶ˆæ¯ä¿å­˜å¤±è´¥',
        'conversation_not_found': 'âš ï¸ å¯¹è¯ä¸å­˜åœ¨',
        'message_already_exists': 'âš ï¸ æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜',
        'retry_scheduled': 'ğŸ”„ å®‰æ’é‡è¯•ä¿å­˜',
        'save_failed_final': 'ğŸ’€ ä¿å­˜å½»åº•å¤±è´¥',
        'rollback_error': 'âš ï¸ å›æ»šå¤±è´¥',
        'stream_error': 'âŒ æµå¼å¤„ç†é”™è¯¯'
    };
    
    let desc = descriptions[op.operation] || `ğŸ“ ${op.operation}`;
    
    if (op.ai_msg_id) {
        desc += ` (ID: ${op.ai_msg_id.substring(0, 8)}...)`;
    }
    
    if (op.retry_count > 0) {
        desc += ` [é‡è¯• ${op.retry_count}]`;
    }
    
    if (op.queue_size !== undefined) {
        desc += ` [é˜Ÿåˆ—: ${op.queue_size}]`;
    }
    
    return desc;
}

// åŠ è½½ç³»ç»Ÿä¿¡æ¯
async function loadSystemInfo() {
    if (!debugMode || currentDebugTab !== 'system') return;
    
    const debugSystem = document.getElementById('debugSystem');
    if (!debugSystem) {
        console.warn('[è°ƒè¯•] debugSystemå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    debugSystem.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> åŠ è½½ä¸­...</div>';
    
    try {
        // è·å–LangChainé…ç½®
        const langchainResponse = await fetch('/api/langchain/config');
        const langchainData = await langchainResponse.json();
        
        // è·å–å¯¹è¯ç»Ÿè®¡
        const conversationsResponse = await fetch('/api/conversations');
        const conversationsData = await conversationsResponse.json();
        
        // ğŸ”¥ è·å–æ¶ˆæ¯ä¿å­˜é˜Ÿåˆ—çŠ¶æ€
        const messageSaveResponse = await fetch('/api/message_save_status');
        const messageSaveData = await messageSaveResponse.json();
        
        debugSystem.innerHTML = `
            <div class="debug-entry info">
                <div class="debug-entry-header">ç³»ç»ŸçŠ¶æ€</div>
                <div class="debug-entry-content">
                    <p><strong>å½“å‰æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>å¯¹è¯æ•°é‡:</strong> ${conversationsData.conversations?.length || 0}</p>
                    <p><strong>å½“å‰å¯¹è¯ID:</strong> ${currentConversationId || 'æ— '}</p>
                    <p><strong>è°ƒè¯•æ¨¡å¼:</strong> å·²å¼€å¯</p>
                </div>
            </div>
            
            <div class="debug-entry ${messageSaveData.success ? 'success' : 'warning'}">
                <div class="debug-entry-header">ğŸ’¾ æ¶ˆæ¯ä¿å­˜é˜Ÿåˆ—</div>
                <div class="debug-entry-content">
                    <p><strong>é˜Ÿåˆ—å¤§å°:</strong> ${messageSaveData.status?.queue_size || 0}</p>
                    <p><strong>å·¥ä½œçº¿ç¨‹:</strong> ${messageSaveData.status?.thread_status || 'æœªçŸ¥'}</p>
                    <p><strong>é˜Ÿåˆ—çŠ¶æ€:</strong> ${messageSaveData.status?.queue_empty ? 'ç©ºé—²' : 'å·¥ä½œä¸­'}</p>
                    ${messageSaveData.status?.thread_id ? `<p><strong>çº¿ç¨‹ID:</strong> ${messageSaveData.status.thread_id}</p>` : ''}
                </div>
            </div>
            
            <div class="debug-entry ${langchainData.success ? 'success' : 'warning'}">
                <div class="debug-entry-header">ğŸ”— LangChainé…ç½®</div>
                <div class="debug-json">${JSON.stringify(langchainData.config || {}, null, 2)}</div>
            </div>
        `;
    } catch (error) {
        debugSystem.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">åŠ è½½å¤±è´¥</div>
                <div class="debug-entry-content">æ— æ³•åŠ è½½ç³»ç»Ÿä¿¡æ¯: ${error.message}</div>
            </div>
        `;
    }
}

// åŠ è½½æ•°æ®åº“ä¿¡æ¯å¯è§†åŒ–
async function loadDatabaseInfo() {
    if (!debugMode || currentDebugTab !== 'database') return;
    
    const debugDatabase = document.getElementById('debugDatabase');
    if (!debugDatabase) {
        console.warn('[è°ƒè¯•] debugDatabaseå…ƒç´ ä¸å­˜åœ¨');
        return;
    }
    
    // åˆ›å»ºæœç´¢ç•Œé¢
    debugDatabase.innerHTML = `
        <div class="database-search-panel">
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ” æ•°æ®åº“æœç´¢</div>
                <div class="debug-entry-content">
                    <div class="search-controls" style="margin-bottom: 12px;">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="dbSearchInput" placeholder="è¾“å…¥å¯¹è¯IDæˆ–å…³é”®è¯æœç´¢..." />
                            <select class="form-select" id="dbSearchType" style="max-width: 150px;">
                                <option value="keyword">å…³é”®è¯æœç´¢</option>
                                <option value="conversation_id">å¯¹è¯ID</option>
                                <option value="all">å…¨éƒ¨</option>
                            </select>
                            <button class="btn btn-primary" type="button" id="dbSearchBtn">æœç´¢</button>
                        </div>
                    </div>
                    <div class="search-quick-actions">
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchCurrentConv()">å½“å‰å¯¹è¯</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchType('ç”¨æˆ·')">ç”¨æˆ·æ¶ˆæ¯</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickSearchType('assistant')">AIå›å¤</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearDatabaseSearch()">æ¸…ç©º</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="databaseSearchResults"></div>
        <div id="databaseCurrentInfo"></div>
    `;
    
    // ç»‘å®šæœç´¢äº‹ä»¶
    document.getElementById('dbSearchBtn').addEventListener('click', performDatabaseSearch);
    document.getElementById('dbSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performDatabaseSearch();
        }
    });
    
    // è‡ªåŠ¨åŠ è½½å½“å‰å¯¹è¯ä¿¡æ¯
    await loadCurrentDatabaseInfo();
}

// æ‰§è¡Œæ•°æ®åº“æœç´¢
async function performDatabaseSearch() {
    const searchInput = document.getElementById('dbSearchInput');
    const searchType = document.getElementById('dbSearchType');
    const resultsDiv = document.getElementById('databaseSearchResults');
    
    const query = searchInput.value.trim();
    if (!query) {
        resultsDiv.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">âš ï¸ æœç´¢æç¤º</div>
                <div class="debug-entry-content">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>
            </div>
        `;
        return;
    }
    
    resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> æœç´¢ä¸­...</div>';
    
    try {
        const response = await fetch(`/api/database_search?q=${encodeURIComponent(query)}&type=${searchType.value}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'æœç´¢å¤±è´¥');
        }
        
        renderSearchResults(data.results, query);
        
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">âŒ æœç´¢å¤±è´¥</div>
                <div class="debug-entry-content">${error.message}</div>
            </div>
        `;
    }
}

// æ¸²æŸ“æœç´¢ç»“æœ
function renderSearchResults(results, query) {
    const resultsDiv = document.getElementById('databaseSearchResults');
    
    if (results.conversations.length === 0 && results.messages.length === 0) {
        resultsDiv.innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">ğŸ” æœç´¢ç»“æœ</div>
                <div class="debug-entry-content">æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ</div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="debug-entry success">
            <div class="debug-entry-header">ğŸ” æœç´¢ç»“æœ</div>
            <div class="debug-entry-content">
                <p><strong>æœç´¢å…³é”®è¯:</strong> "${query}"</p>
                <p><strong>æ‰¾åˆ°å¯¹è¯:</strong> ${results.search_stats.conversations_found} ä¸ª</p>
                <p><strong>æ‰¾åˆ°æ¶ˆæ¯ç»„:</strong> ${results.search_stats.message_groups_found} ä¸ª</p>
                <p><strong>åŒ¹é…æ¶ˆæ¯æ•°:</strong> ${results.search_stats.total_message_matches} æ¡</p>
                <p><strong>æœç´¢æ—¶é—´:</strong> ${results.search_stats.search_time}</p>
            </div>
        </div>
    `;
    
    // æ¸²æŸ“å¯¹è¯ç»“æœ
    if (results.conversations.length > 0) {
        html += `
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ’¬ åŒ¹é…çš„å¯¹è¯ (${results.conversations.length})</div>
                <div class="debug-entry-content">
                    <div style="max-height: 300px; overflow-y: auto;">
        `;
        
        results.conversations.forEach(conv => {
            html += `
                <div class="conversation-result" style="margin-bottom: 12px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer;" onclick="loadSpecificConversation('${conv.id}')">
                    <div style="font-weight: bold; color: #007bff;">${highlightText(conv.title, query)}</div>
                    <div style="font-size: 11px; color: #666;">
                        ID: <code>${conv.id}</code>
                        ${conv.match_type ? `| ${conv.match_type}` : ''}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        æ¶ˆæ¯æ•°: ${conv.message_count} | åˆ›å»º: ${conv.created_at_formatted}
                        ${conv.matching_messages_count !== undefined ? `| åŒ¹é…æ¶ˆæ¯: ${conv.matching_messages_count}` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // æ¸²æŸ“æ¶ˆæ¯ç»“æœ
    if (results.messages.length > 0) {
        html += `
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ“ åŒ¹é…çš„æ¶ˆæ¯</div>
                <div class="debug-entry-content">
                    <div style="max-height: 400px; overflow-y: auto;">
        `;
        
        results.messages.forEach(group => {
            html += `
                <div class="message-group-result" style="margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 10px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">
                        ğŸ“ ${group.conversation_title}
                        <span style="font-size: 11px; color: #666;">(${group.messages.length} æ¡åŒ¹é…)</span>
                    </div>
            `;
            
            group.messages.forEach(msg => {
                const roleColor = msg.role === 'user' ? '#007bff' : '#28a745';
                const roleIcon = msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                
                html += `
                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                            ${roleIcon} <span style="color: ${roleColor};">${msg.role.toUpperCase()}</span> 
                            | ${msg.created_at_formatted} 
                            | ${msg.content_length} å­—ç¬¦
                            | Token: ${msg.token_count || 0}
                        </div>
                        <div style="font-size: 12px; line-height: 1.4;">
                            ${highlightText(msg.content_preview, query)}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
}

// é«˜äº®æœç´¢å…³é”®è¯
function highlightText(text, query) {
    if (!query || !text) return text;
    
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark style="background-color: yellow; padding: 1px 2px;">$1</mark>');
}

// å¿«é€Ÿæœç´¢åŠŸèƒ½
function quickSearchCurrentConv() {
    if (currentConversationId) {
        document.getElementById('dbSearchInput').value = currentConversationId;
        document.getElementById('dbSearchType').value = 'conversation_id';
        performDatabaseSearch();
    }
}

function quickSearchType(type) {
    document.getElementById('dbSearchInput').value = type;
    document.getElementById('dbSearchType').value = 'keyword';
    performDatabaseSearch();
}

function clearDatabaseSearch() {
    document.getElementById('dbSearchInput').value = '';
    document.getElementById('databaseSearchResults').innerHTML = '';
}

// åŠ è½½æŒ‡å®šå¯¹è¯çš„è¯¦ç»†ä¿¡æ¯
async function loadSpecificConversation(conversationId) {
    const currentInfoDiv = document.getElementById('databaseCurrentInfo');
    currentInfoDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> åŠ è½½å¯¹è¯è¯¦æƒ…ä¸­...</div>';
    
    try {
        const response = await fetch(`/api/conversation_database_info/${conversationId}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'è·å–å¯¹è¯ä¿¡æ¯å¤±è´¥');
        }
        
        renderConversationDetails(data);
        
    } catch (error) {
        currentInfoDiv.innerHTML = `
            <div class="debug-entry error">
                <div class="debug-entry-header">âŒ åŠ è½½å¤±è´¥</div>
                <div class="debug-entry-content">${error.message}</div>
            </div>
        `;
    }
}

// åŠ è½½å½“å‰å¯¹è¯ä¿¡æ¯
async function loadCurrentDatabaseInfo() {
    if (!currentConversationId) {
        document.getElementById('databaseCurrentInfo').innerHTML = `
            <div class="debug-entry warning">
                <div class="debug-entry-header">âš ï¸ æ— å¯¹è¯é€‰ä¸­</div>
                <div class="debug-entry-content">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è¯æ¥æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½</div>
            </div>
        `;
        return;
    }
    
    await loadSpecificConversation(currentConversationId);
}

// æ¸²æŸ“å¯¹è¯è¯¦ç»†ä¿¡æ¯
function renderConversationDetails(data) {
    const currentInfoDiv = document.getElementById('databaseCurrentInfo');
    const { conversation, messages, statistics, table_info, user_info, query_stats } = data;
        
    currentInfoDiv.innerHTML = `
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ’¬ æ¶ˆæ¯åˆ—è¡¨ (${messages.length})</div>
                <div class="debug-entry-content">
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px;">
                        ${messages.map(msg => `
                            <div style="margin-bottom: 10px; padding: 8px; border-radius: 4px; background: ${msg.role === 'user' ? 'rgba(0,123,255,0.1)' : 'rgba(40,167,69,0.1)'};">
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    <strong>#${msg.sequence}</strong> | 
                                    <span style="color: ${msg.role === 'user' ? '#007bff' : '#28a745'};">${msg.role.toUpperCase()}</span> | 
                                    ${msg.created_at_formatted}
                                    ${msg.time_diff_formatted ? ` | â±ï¸ ${msg.time_diff_formatted}` : ''}
                                </div>
                                <div style="font-size: 12px;">
                                    <strong>ID:</strong> <code style="font-size: 10px;">${msg.id}</code><br>
                                    <strong>é•¿åº¦:</strong> ${msg.content_length} å­—ç¬¦ | <strong>Token:</strong> ${msg.token_count || 0}<br>
                                    <strong>å†…å®¹:</strong> ${msg.content_preview}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <!-- å¯¹è¯ç»Ÿè®¡ -->
            <div class="debug-entry success">
                <div class="debug-entry-header">ğŸ“Š å¯¹è¯ç»Ÿè®¡</div>
                <div class="debug-entry-content">
                    <p><strong>å¯¹è¯ID:</strong> <code>${conversation.id}</code></p>
                    <p><strong>æ ‡é¢˜:</strong> ${conversation.title}</p>
                    <p><strong>æ€»æ¶ˆæ¯æ•°:</strong> ${statistics.total_messages} (ç”¨æˆ·: ${statistics.user_messages}, AI: ${statistics.ai_messages})</p>
                    <p><strong>æ€»å­—ç¬¦æ•°:</strong> ${statistics.total_characters.toLocaleString()}</p>
                    <p><strong>æ€»Tokenæ•°:</strong> ${statistics.total_tokens.toLocaleString()}</p>
                    <p><strong>å¹³å‡æ¶ˆæ¯é•¿åº¦:</strong> ${statistics.avg_message_length} å­—ç¬¦</p>
                    ${statistics.conversation_duration_formatted ? `<p><strong>å¯¹è¯æŒç»­æ—¶é—´:</strong> ${statistics.conversation_duration_formatted}</p>` : ''}
                    <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${conversation.created_at_formatted}</p>
                </div>
            </div>
            
            <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
            <div class="debug-entry info">
                <div class="debug-entry-header">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</div>
                <div class="debug-entry-content">
                    <p><strong>ç”¨æˆ·å:</strong> ${user_info.username}</p>
                    <p><strong>é‚®ç®±:</strong> ${user_info.email}</p>
                    <p><strong>æ³¨å†Œæ—¶é—´:</strong> ${user_info.created_at_formatted}</p>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç»Ÿè®¡ -->
            <div class="debug-entry">
                <div class="debug-entry-header">ğŸ“ˆ ç”¨æˆ·ç»Ÿè®¡</div>
                <div class="debug-entry-content">
                    <p><strong>ç”¨æˆ·å¯¹è¯æ•°:</strong> ${query_stats.user_total_conversations}</p>
                    <p><strong>ç”¨æˆ·æ¶ˆæ¯æ•°:</strong> ${query_stats.user_total_messages}</p>
                    <p><strong>æ•°æ®åº“æ€»å¯¹è¯:</strong> ${query_stats.database_total_conversations}</p>
                    <p><strong>æ•°æ®åº“æ€»æ¶ˆæ¯:</strong> ${query_stats.database_total_messages}</p>
                </div>
            </div>
        `;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const pageInitStart = performance.now();
    console.log(`ğŸ” [DEBUG] é¡µé¢åˆå§‹åŒ–å¼€å§‹ - ${new Date().toLocaleTimeString()}`);
    
    // åˆå§‹åŒ–Markdownè§£æå™¨
    const markdownStart = performance.now();
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
        console.log(`âœ… [DEBUG] Markdownè§£æå™¨åˆå§‹åŒ–å®Œæˆ: ${(performance.now() - markdownStart).toFixed(3)}ms`);
    } else {
        console.warn(`âš ï¸ [DEBUG] Markdownè§£æå™¨æœªå°±ç»ª`);
    }
    
    const setupStart = performance.now();
    setupEventListeners();
    console.log(`âœ… [DEBUG] äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ: ${(performance.now() - setupStart).toFixed(3)}ms`);
    
    // ğŸ”¥ ä¿®å¤ï¼šåˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    const buttonStart = performance.now();
    updateSendButtonState();
    console.log(`âœ… [DEBUG] æŒ‰é’®çŠ¶æ€åˆå§‹åŒ–å®Œæˆ: ${(performance.now() - buttonStart).toFixed(3)}ms`);
    
    // åˆå§‹åŒ–è°ƒè¯•åŠŸèƒ½
    const debugStart = performance.now();
    initializeDebugFeatures();
    console.log(`âœ… [DEBUG] è°ƒè¯•åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ: ${(performance.now() - debugStart).toFixed(3)}ms`);
    
    // V0.3.0 åˆå§‹åŒ–é…ç½®åŠŸèƒ½
    const configStart = performance.now();
    initializeConfigFeatures();
    console.log(`âœ… [DEBUG] é…ç½®åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ: ${(performance.now() - configStart).toFixed(3)}ms`);
    
    // V0.3.1 ä¿®å¤ï¼šç§»é™¤è‡ªåŠ¨æµ‹è¯•åŠŸèƒ½ï¼Œé¿å…è°ƒè¯•é¢æ¿è‡ªåŠ¨å¼¹å‡º
    // æµ‹è¯•å‡½æ•°ä»å¯é€šè¿‡æ§åˆ¶å°æ‰‹åŠ¨è°ƒç”¨ï¼štestConfig(), testDebugFeatures(), testConfigModalSafety()
    console.log('[DEBUG] æµ‹è¯•å‡½æ•°å¯é€šè¿‡æ§åˆ¶å°æ‰‹åŠ¨è°ƒç”¨: testConfig(), testDebugFeatures(), testConfigModalSafety(), testConfigSave(), testAutoSave(), fixTemperatureSelect()');
    
    // åœ¨èŠå¤©é¡µé¢ç¦ç”¨å…¨å±€ä¾§è¾¹æ åŠŸèƒ½
    const sidebarStart = performance.now();
    disableGlobalSidebar();
    console.log(`âœ… [DEBUG] å…¨å±€ä¾§è¾¹æ ç¦ç”¨å®Œæˆ: ${(performance.now() - sidebarStart).toFixed(3)}ms`);
    
    // å¼‚æ­¥åŠ è½½æ•°æ®
    loadConversationsAndInitialize().then(() => {
        const totalTime = performance.now() - pageInitStart;
        console.log(`ğŸ‰ [DEBUG] é¡µé¢å®Œå…¨åˆå§‹åŒ–å®Œæˆ: ${totalTime.toFixed(3)}ms`);
    }).catch(error => {
        const totalTime = performance.now() - pageInitStart;
        console.error(`âŒ [DEBUG] é¡µé¢åˆå§‹åŒ–å¤±è´¥: ${error.message} (è€—æ—¶: ${totalTime.toFixed(3)}ms)`);
    });
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const chatForm = document.getElementById('chatForm');
    const newChatBtn = document.getElementById('newChatBtn');
    const sendBtn = document.getElementById('sendBtn');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const showSidebar = document.getElementById('showSidebar');
    const conversationSearch = document.getElementById('conversationSearch');
    const sidebarOverlay = document.getElementById('sidebarOverlay'); // ä½¿ç”¨base.htmlä¸­çš„é®ç½©å±‚
    const sidebarTriggerChat = document.getElementById('sidebarTriggerChat');
    
    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateSendButtonState();
    });
    
    // è¾“å…¥æ¡†èšç„¦æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    messageInput.addEventListener('focus', function() {
        updateSendButtonState();
    });
    
    // é”®ç›˜å¿«æ·é”®
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading && this.value.trim()) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // è¡¨å•æäº¤
    chatForm.addEventListener('submit', handleSendMessage);
    
    // æ–°å¯¹è¯æŒ‰é’®
    newChatBtn.addEventListener('click', startNewConversation);
    
    // ä¾§è¾¹æ æ§åˆ¶
    toggleSidebar.addEventListener('click', hideSidebar);
    showSidebar.addEventListener('click', showSidebarPanel);
    if (sidebarTriggerChat) {
        sidebarTriggerChat.addEventListener('click', showSidebarPanel);
    }
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', hideSidebar); // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
    }
    
    // å¯¹è¯æœç´¢
    conversationSearch.addEventListener('input', filterConversations);
    
    // åˆ†äº«å¯¹è¯æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
    setupShareConversationModal();
}

// è®¾ç½®åˆ†äº«å¯¹è¯æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
function setupShareConversationModal() {
    const modal = document.getElementById('shareConversationModal');
    const descriptionTextarea = document.getElementById('shareConversationDescription');
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeShareConversationModal();
        }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            closeShareConversationModal();
        }
    });
    
    // æè¿°è¾“å…¥æ¡†å­—ç¬¦è®¡æ•°å™¨
    descriptionTextarea.addEventListener('input', updateCharCounter);
}

// ç¦ç”¨å…¨å±€ä¾§è¾¹æ åŠŸèƒ½
function disableGlobalSidebar() {
    // éšè—å…¨å±€ä¾§è¾¹æ 
    const globalSidebar = document.getElementById('sidebar');
    if (globalSidebar) {
        globalSidebar.style.display = 'none';
    }
    
    // ç§»é™¤å…¨å±€ä¾§è¾¹æ è§¦å‘å™¨çš„äº‹ä»¶ç›‘å¬
    const globalTrigger = document.getElementById('sidebarTrigger');
    if (globalTrigger) {
        globalTrigger.style.display = 'none';
        // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        globalTrigger.replaceWith(globalTrigger.cloneNode(true));
    }
    
    // ç§»é™¤å…¨å±€ä¾§è¾¹æ çš„é¼ æ ‡äº‹ä»¶
    const globalSidebarOverlay = document.getElementById('sidebarOverlay');
    if (globalSidebarOverlay) {
        // åªåœ¨èŠå¤©é¡µé¢ä½¿ç”¨é®ç½©å±‚ï¼Œä¸è®©å…¨å±€ä¾§è¾¹æ ä½¿ç”¨
        globalSidebarOverlay.removeAttribute('onclick');
    }
    
    // éšè—é¡¶éƒ¨å¯¼èˆªæ çš„ä¾§è¾¹æ æŒ‰é’®
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle) {
        sidebarToggle.style.display = 'none';
    }
    
    console.log('å…¨å±€ä¾§è¾¹æ åŠŸèƒ½å·²åœ¨èŠå¤©é¡µé¢ç¦ç”¨');
}

// åŠ è½½å¯¹è¯åˆ—è¡¨å¹¶åˆå§‹åŒ–é¡µé¢
async function loadConversationsAndInitialize() {
    const startTime = performance.now();
    console.log(`ğŸ” [DEBUG] å¼€å§‹åŠ è½½å¯¹è¯åˆ—è¡¨å¹¶åˆå§‹åŒ– - ${new Date().toLocaleTimeString()}`);
    
    try {
        // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¦å¯¼å…¥çš„å¯¹è¯
        const urlParams = new URLSearchParams(window.location.search);
        const shouldImport = urlParams.get('import') === 'true';
        
        if (shouldImport) {
            const importedData = sessionStorage.getItem('importedConversation');
            if (importedData) {
                try {
                    const conversationData = JSON.parse(importedData);
                    sessionStorage.removeItem('importedConversation'); // æ¸…ç†æ•°æ®
                    
                    // å¼€å§‹æ–°å¯¹è¯å¹¶å¯¼å…¥æ¶ˆæ¯
                    startNewConversation();
                    
                    // è®¾ç½®å¯¹è¯æ ‡é¢˜
                    if (conversationData.title) {
                        document.getElementById('conversationTitle').textContent = conversationData.title;
                    }
                    
                    // å¯¼å…¥æ¶ˆæ¯
                    if (conversationData.messages && conversationData.messages.length > 0) {
                        for (const message of conversationData.messages) {
                            addMessage(message.role, message.content);
                        }
                        
                        // æ˜¾ç¤ºå¯¼å…¥æˆåŠŸæç¤º
                        showToast('å¯¹è¯å·²æˆåŠŸå¯¼å…¥ï¼æ‚¨å¯ä»¥ç»§ç»­ä¸AIå¯¹è¯ã€‚', 'success');
                    }
                    
                    // æ¸…ç†URLå‚æ•°
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                } catch (error) {
                    console.error('å¯¼å…¥å¯¹è¯æ•°æ®è§£æå¤±è´¥:', error);
                    showToast('å¯¼å…¥å¯¹è¯å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯', 'error');
                }
            }
        }
        
        // æ­£å¸¸åŠ è½½å¯¹è¯åˆ—è¡¨
        const fetchStart = performance.now();
        const response = await fetch('/api/conversations');
        const fetchEnd = performance.now();
        
        const parseStart = performance.now();
        const data = await response.json();
        const parseEnd = performance.now();
        
        if (data.success) {
            const renderStart = performance.now();
            conversations = data.conversations;
            renderConversationList(conversations);
            const renderEnd = performance.now();
            
            // å¦‚æœæœ‰å¯¹è¯å†å²ï¼Œè‡ªåŠ¨åŠ è½½æœ€è¿‘çš„å¯¹è¯
            if (conversations.length > 0) {
                const loadStart = performance.now();
                const latestConversation = conversations[0]; // å·²æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
                await switchConversation(latestConversation.id);
                const loadEnd = performance.now();
                
                const totalTime = loadEnd - startTime;
                console.log(`âœ… [DEBUG] å¯¹è¯åˆ—è¡¨åŠ è½½å®Œæˆå¹¶åˆ‡æ¢åˆ°æœ€æ–°å¯¹è¯:`);
                console.log(`   - ç½‘ç»œè¯·æ±‚: ${(fetchEnd - fetchStart).toFixed(3)}ms`);
                console.log(`   - æ•°æ®è§£æ: ${(parseEnd - parseStart).toFixed(3)}ms`);
                console.log(`   - åˆ—è¡¨æ¸²æŸ“: ${(renderEnd - renderStart).toFixed(3)}ms`);
                console.log(`   - å¯¹è¯åˆ‡æ¢: ${(loadEnd - loadStart).toFixed(3)}ms`);
                console.log(`   - æ€»è€—æ—¶: ${totalTime.toFixed(3)}ms`);
                console.log(`   - å¯¹è¯æ•°é‡: ${conversations.length}`);
            } else {
                // æ²¡æœ‰å†å²å¯¹è¯ï¼Œæ˜¾ç¤ºæ–°å¯¹è¯é¡µé¢
                startNewConversation();
                const totalTime = performance.now() - startTime;
                console.log(`âœ… [DEBUG] å¯¹è¯åˆ—è¡¨åŠ è½½å®Œæˆ(æ— å†å²å¯¹è¯): ${totalTime.toFixed(3)}ms`);
            }
        } else {
            const errorTime = performance.now() - startTime;
            console.error(`âŒ [DEBUG] åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥: ${data.message} (è€—æ—¶: ${errorTime.toFixed(3)}ms)`);
            startNewConversation();
        }
    } catch (error) {
        const errorTime = performance.now() - startTime;
        console.error(`âŒ [DEBUG] åŠ è½½å¯¹è¯åˆ—è¡¨å¼‚å¸¸: ${error.message} (è€—æ—¶: ${errorTime.toFixed(3)}ms)`);
        startNewConversation();
    }
}

// åŠ è½½å¯¹è¯åˆ—è¡¨ï¼ˆä¸åˆå§‹åŒ–é¡µé¢ï¼‰
async function loadConversations() {
    try {
        // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
        const response = await fetch(`/api/conversations?t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            conversations = data.conversations;
            renderConversationList(conversations);
        } else {
            console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¼‚å¸¸:', error);
    }
}

// æ¸²æŸ“å¯¹è¯åˆ—è¡¨
function renderConversationList(conversationList) {
    const conversationListEl = document.getElementById('conversationList');
    
    if (conversationList.length === 0) {
        conversationListEl.innerHTML = `
            <div class="empty-conversations text-center py-4">
                <i class="bi bi-chat-text text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">è¿˜æ²¡æœ‰å¯¹è¯å†å²</p>
                <small class="text-muted">ç‚¹å‡»ä¸Šæ–¹"æ–°å»ºå¯¹è¯"å¼€å§‹</small>
            </div>
        `;
        return;
    }
    
    const conversationItems = conversationList.map(conv => {
        const isActive = conv.id === currentConversationId;
        
        // å®‰å…¨çš„æ—¥æœŸå¤„ç†
        let lastUpdate = 'æœªçŸ¥æ—¶é—´';
        try {
            if (conv.last_message_time) {
                const date = new Date(conv.last_message_time);
                if (!isNaN(date.getTime())) {
                    const now = new Date();
                    const diffMs = now - date;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffHours / 24);
                    
                    if (diffDays > 0) {
                        lastUpdate = `${diffDays}å¤©å‰`;
                    } else if (diffHours > 0) {
                        lastUpdate = `${diffHours}å°æ—¶å‰`;
                    } else {
                        const diffMinutes = Math.floor(diffMs / (1000 * 60));
                        lastUpdate = diffMinutes > 0 ? `${diffMinutes}åˆ†é’Ÿå‰` : 'åˆšåˆš';
                    }
                }
            } else if (conv.updated_at) {
                const date = new Date(conv.updated_at);
                if (!isNaN(date.getTime())) {
                    lastUpdate = date.toLocaleDateString();
                }
            }
        } catch (error) {
            console.warn('æ—¥æœŸè§£æå¤±è´¥:', conv.updated_at, error);
        }
        
        // æ¶ˆæ¯é¢„è§ˆ
        const messagePreview = conv.last_message_preview || 'æš‚æ— æ¶ˆæ¯';
        
        return `
            <div class="conversation-item ${isActive ? 'active' : ''}" 
                 data-conversation-id="${conv.id}"
                 onclick="switchConversation('${conv.id}')">
                <div class="conversation-content">
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-preview">
                        <small class="text-muted">${messagePreview}</small>
                    </div>
                    <div class="conversation-meta">
                        <small class="text-muted">
                            <i class="bi bi-chat-dots"></i> ${conv.message_count} æ¡æ¶ˆæ¯
                        </small>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${lastUpdate}
                        </small>
                    </div>
                </div>
                <div class="conversation-actions">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="shareConversation('${conv.id}', event)" title="åˆ†äº«åˆ°è®ºå›">
                        <i class="bi bi-share"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConversation('${conv.id}', event)" title="åˆ é™¤å¯¹è¯">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    conversationListEl.innerHTML = conversationItems;
}

// åˆ‡æ¢å¯¹è¯
async function switchConversation(conversationId) {
    if (conversationId === currentConversationId) {
        console.log('åˆ‡æ¢åˆ°ç›¸åŒå¯¹è¯ï¼Œè·³è¿‡');
        return;
    }
    
    console.log(`[UI] åˆ‡æ¢å¯¹è¯: ${conversationId}`);
    currentConversationId = conversationId;
    
    // æ›´æ–°UIçŠ¶æ€
    updateActiveConversation(conversationId);
    
    // åŠ è½½å¯¹è¯å†å²
    await loadConversationHistory(conversationId);
    
    // V0.3.1 ä¿®å¤ï¼šåŠ è½½å¯¹è¯é…ç½®å¹¶æ˜¾ç¤ºæ¨¡å‹å‚æ•°
    try {
        console.log('[é…ç½®] åˆ‡æ¢å¯¹è¯ï¼ŒåŠ è½½é…ç½® ID:', conversationId);
        const configResponse = await fetch(`/api/conversations/${conversationId}/config`);
        const configData = await configResponse.json();
        
        if (configData.success) {
            currentConfig = configData.config;
            console.log('[é…ç½®] åˆ‡æ¢å¯¹è¯åæ›´æ–°currentConfig:', currentConfig);
            
            // å¦‚æœè°ƒè¯•æ¨¡å¼å¼€å¯ï¼Œç«‹å³æ˜¾ç¤ºæ¨¡å‹å‚æ•°
            if (debugMode) {
                updateModelParamsDebug({
                    model_name: currentConfig.model_name,
                    temperature: currentConfig.temperature,
                    max_tokens: currentConfig.max_tokens,
                    has_system_prompt: !!currentConfig.system_prompt,
                    system_prompt_length: currentConfig.system_prompt ? currentConfig.system_prompt.length : 0
                });
            }
        } else {
            console.warn('[é…ç½®] è·å–å¯¹è¯é…ç½®å¤±è´¥:', configData.message);
            // ä½¿ç”¨é»˜è®¤é…ç½®
            ensureDefaultConfig();
        }
    } catch (error) {
        console.error('[é…ç½®] åŠ è½½å¯¹è¯é…ç½®å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤é…ç½®
        ensureDefaultConfig();
    }
    
    // å¦‚æœè°ƒè¯•æ¨¡å¼å¼€å¯ä¸”å½“å‰åœ¨æ•°æ®åº“æ ‡ç­¾ï¼Œåˆ·æ–°æ•°æ®åº“ä¿¡æ¯
    if (debugMode && currentDebugTab === 'database') {
        await loadDatabaseInfo();
    }
}

// æ›´æ–°æ´»è·ƒå¯¹è¯çŠ¶æ€
function updateActiveConversation(conversationId) {
    // æ›´æ–°å¯¹è¯åˆ—è¡¨ä¸­çš„æ´»è·ƒçŠ¶æ€
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.conversationId === conversationId) {
            item.classList.add('active');
        }
    });
    
    // æ›´æ–°æ ‡é¢˜ï¼ˆä¿ç•™ç¼–è¾‘å›¾æ ‡ï¼‰
    const conversation = conversations.find(c => c.id === conversationId);
    if (conversation) {
        const titleElement = document.getElementById('currentChatTitle');
        titleElement.innerHTML = `${conversation.title}<i class="bi bi-pencil-square edit-icon"></i>`;
    }
}

// åŠ è½½å¯¹è¯å†å²
async function loadConversationHistory(conversationId) {
    try {
        // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
        const response = await fetch(`/api/conversations/${conversationId}/messages?t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            console.log(`[æ•°æ®åº“] åŠ è½½å¯¹è¯å†å²: ${data.messages ? data.messages.length : 0} æ¡æ¶ˆæ¯`);
            
            // æ¸…ç©ºå½“å‰èŠå¤©åŒºåŸŸ
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            console.log('èŠå¤©åŒºåŸŸå·²æ¸…ç©º');
            
            // æ¸²æŸ“å†å²æ¶ˆæ¯
            if (data.messages && data.messages.length > 0) {
                // console.log('å¼€å§‹æ¸²æŸ“å†å²æ¶ˆæ¯...');
                
                // æµ‹è¯•addMessageå‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof addMessage !== 'function') {
                    console.error('addMessage å‡½æ•°ä¸å­˜åœ¨!');
                    return;
                }
                
                data.messages.forEach((msg, index) => {
                    // console.log(`æ¸²æŸ“å†å²æ¶ˆæ¯ ${index + 1}:`, {
                    //     role: msg.role,
                    //     content: msg.content.substring(0, 100) + '...',
                    //     contentLength: msg.content.length
                    // });
                    
                    try {
                        // V0.3.1 ä¿®å¤ï¼šä¼ é€’æ€è€ƒè¿‡ç¨‹ç»™addMessage
                        addMessage(msg.role, msg.content, false, msg.thinking_process);
                        // console.log(`æ¶ˆæ¯ ${index + 1} æ¸²æŸ“å®Œæˆ`);
                    } catch (error) {
                        console.error(`æ¸²æŸ“æ¶ˆæ¯ ${index + 1} å¤±è´¥:`, error);
                    }
                });
                console.log(`[UI] å·²æ¸²æŸ“ ${data.messages.length} æ¡å†å²æ¶ˆæ¯`);
                
                // æ£€æŸ¥æ¸²æŸ“åçš„DOM
                const messagesAfter = chatMessages.children.length;
                // console.log('æ¸²æŸ“åèŠå¤©åŒºåŸŸçš„å­å…ƒç´ æ•°é‡:', messagesAfter);
            } else {
                console.log('è¯¥å¯¹è¯æš‚æ— å†å²æ¶ˆæ¯');
            }
            
            // éšè—æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                scrollToBottom();
            }, 100);
        } else {
            console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯å†å²å¼‚å¸¸:', error);
    }
}

// å¼€å§‹æ–°å¯¹è¯ - V0.3.0 æ–°å»ºæ—¶å¼¹å‡ºå‚æ•°ç¡®è®¤
function startNewConversation() {
    console.log('[é…ç½®] å¼€å§‹æ–°å¯¹è¯');
    
    // V0.3.1 ä¿®å¤ï¼šç¡®ä¿é»˜è®¤é…ç½®æ­£ç¡®åˆå§‹åŒ–
    ensureDefaultConfig();
    
    // è®¾ç½®æ¨¡æ€æ¡†ä¸ºæ–°å»ºæ¨¡å¼
    configModalMode = 'create';
    document.getElementById('configModalTitle').textContent = 'æ–°å»ºå¯¹è¯ - å‚æ•°è®¾ç½®';
    document.getElementById('saveConfigBtnText').textContent = 'å¼€å§‹å¯¹è¯';
    
    // é‡ç½®ä¸ºé»˜è®¤é…ç½®
    currentConfig = {
        model_name: 'deepseek-chat',
        temperature: 1.0,
        max_tokens: 4000,
        system_prompt: ''
    };
    
    console.log('[é…ç½®] é‡ç½®ä¸ºé»˜è®¤é…ç½®:', currentConfig);
    
    // å¡«å……é»˜è®¤é…ç½®åˆ°è¡¨å•
    fillConfigForm(currentConfig);
    updateConfigPreview();
    
    // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('configModal'));
    modal.show();
}

// å®é™…å¼€å§‹æ–°å¯¹è¯ï¼ˆé…ç½®ç¡®è®¤åï¼‰
function doStartNewConversation() {
    currentConversationId = null;
    
    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="welcome-message" id="welcomeMessage">
            <i class="bi bi-chat-dots welcome-icon"></i>
            <h4>å¼€å§‹æ–°çš„å¯¹è¯</h4>
            <p class="text-muted small">
                æ¨¡å‹: ${currentConfig.model_name === 'deepseek-chat' ? 'DeepSeek-V3' : 'DeepSeek-R1'} | 
                æ¸©åº¦: ${currentConfig.temperature} | 
                è¾“å‡º: ${currentConfig.max_tokens}Token
            </p>
        </div>
    `;
    
    // æ›´æ–°æ ‡é¢˜ï¼ˆä¿ç•™ç¼–è¾‘å›¾æ ‡ï¼‰
    document.getElementById('currentChatTitle').innerHTML = 'æ™ºèƒ½é—®ç­”<i class="bi bi-pencil-square edit-icon"></i>';
    
    // æ¸…é™¤æ´»è·ƒçŠ¶æ€
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById('messageInput').focus();
}

// åˆ é™¤å¯¹è¯
async function deleteConversation(conversationId, event) {
    event.stopPropagation();
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/conversations/${conversationId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œå¼€å§‹æ–°å¯¹è¯
            if (conversationId === currentConversationId) {
                startNewConversation();
            }
            
            // é‡æ–°åŠ è½½å¯¹è¯åˆ—è¡¨
            await loadConversations();
        } else {
            alert('åˆ é™¤å¯¹è¯å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åˆ é™¤å¯¹è¯å¼‚å¸¸:', error);
        alert('åˆ é™¤å¯¹è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// è¿‡æ»¤å¯¹è¯
function filterConversations() {
    const searchTerm = document.getElementById('conversationSearch').value.toLowerCase();
    const filteredConversations = conversations.filter(conv => 
        conv.title.toLowerCase().includes(searchTerm)
    );
    renderConversationList(filteredConversations);
}

// æ˜¾ç¤º/éšè—ä¾§è¾¹æ 
function showSidebarPanel() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const chatContainer = document.getElementById('chatContainer');
    
    sidebar.classList.remove('hidden');
    sidebar.classList.add('show');
    chatContainer.classList.remove('sidebar-hidden');
    
    // ç§»åŠ¨ç«¯æ˜¾ç¤ºé®ç½©å±‚
    if (window.innerWidth <= 768 && overlay) {
        overlay.classList.add('show');
    }
}

function hideSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const chatContainer = document.getElementById('chatContainer');
    
    sidebar.classList.remove('show');
    sidebar.classList.add('hidden');
    chatContainer.classList.add('sidebar-hidden');
    
    if (overlay) {
        overlay.classList.remove('show');
    }
}

// å¤„ç†å‘é€æ¶ˆæ¯
async function handleSendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const message = messageInput.value.trim();
    
    if (!message || isLoading) return;
    
    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    addDebugEntry('user', `å‘é€æ¶ˆæ¯: ${message.substring(0, 100)}${message.length > 100 ? '...' : ''}`, 'info');
    
    try {
        // ä¿å­˜å‘é€å‰çš„çŠ¶æ€
        const previousState = {
            message: message,
            conversationId: currentConversationId
        };
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        isLoading = true;
        window.lastSendTime = Date.now(); // è®°å½•å‘é€æ—¶é—´ï¼Œç”¨äºè¶…æ—¶æ£€æµ‹
        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
        updateSendButtonState();
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        addDebugEntry('system', 'ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ åˆ°ç•Œé¢', 'info');
        
        // è®¾ç½®æ¢å¤è¶…æ—¶
        const recoveryTimeout = setTimeout(() => {
            if (isLoading) {
                console.warn('[é”™è¯¯æ¢å¤] æ£€æµ‹åˆ°è¯·æ±‚å¯èƒ½è¶…æ—¶ï¼Œå°è¯•æ¢å¤çŠ¶æ€');
                addDebugEntry('error', 'è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œå°è¯•æ¢å¤çŠ¶æ€', 'error');
                recoverFromError(previousState);
            }
        }, 30000); // 30ç§’è¶…æ—¶
        
        try {
            // ä½¿ç”¨æµå¼å“åº”
            const url = new URL('/api/chat', window.location.origin);
            url.searchParams.set('stream', 'true');
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: currentConversationId,
                    // V0.3.0 æ–°å¢ï¼šå‘é€é…ç½®ä¿¡æ¯
                    conversation_config: currentConversationId ? null : currentConfig
                    // V0.3.0 ç§»é™¤ knowledge_base_id å‚æ•°
                })
            });
            
            // æ¸…é™¤æ¢å¤è¶…æ—¶
            clearTimeout(recoveryTimeout);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
                    // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
        const assistantMessageDiv = createMessageContainer('assistant');
        const messageContent = assistantMessageDiv.querySelector('.message-content');
        let aiResponse = '';
        
        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºç­‰å¾…åŠ¨ç”»
        messageContent.innerHTML = `
            <div class="waiting-animation">
                <span class="waiting-text">æ­£åœ¨æ€è€ƒ</span>
                <span class="waiting-dots">
                    <span>.</span><span>.</span><span>.</span>
                </span>
            </div>
        `;
        
        // ğŸ”¥ æ–°å¢ï¼šéšè—æ¸²æŸ“æŒ‰é’®ç›´åˆ°è¾“å‡ºå®Œæˆ
        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
            
            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            switch (data.type) {
                                case 'start':
                                    addDebugEntry('stream', 'å¼€å§‹æ¥æ”¶AIå“åº”', 'info');
                                    currentConversationId = data.conversation_id;
                                    
                                    // ä¿å­˜è°ƒè¯•ä¿¡æ¯
                                    if (data.debug_info) {
                                        addDebugEntry('debug', 'æ”¶åˆ°è°ƒè¯•ä¿¡æ¯', 'info', data.debug_info);
                                    }
                                    
                                    // æ›´æ–°å¯¹è¯æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰
                                    if (!conversations.find(c => c.id === currentConversationId)) {
                                        const title = message.length > 30 ? message.substring(0, 30) + '...' : message;
                                        document.getElementById('currentChatTitle').textContent = title;
                                        
                                        // ç«‹å³æ·»åŠ æ–°å¯¹è¯åˆ°åˆ—è¡¨é¡¶éƒ¨
                                        const newConversation = {
                                            id: currentConversationId,
                                            title: title,
                                            created_at: new Date().toISOString(),
                                            message_count: 1
                                        };
                                        conversations.unshift(newConversation);
                                        renderConversationList(conversations);
                                        
                                        // è®¾ç½®ä¸ºæ´»è·ƒçŠ¶æ€
                                        setTimeout(() => {
                                            const newItem = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
                                            if (newItem) {
                                                document.querySelectorAll('.conversation-item').forEach(item => {
                                                    item.classList.remove('active');
                                                });
                                                newItem.classList.add('active');
                                            }
                                        }, 100);
                                    }
                                    break;
                                case 'processing':
                                    // ğŸ”¥ ä¿®å¤BUG2ï¼šå¤„ç†å¤„ç†çŠ¶æ€æ¶ˆæ¯ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆ
                                    console.log('[æ¨¡å‹] å¤„ç†çŠ¶æ€:', data.status);
                                    addDebugEntry('stream', `å¤„ç†çŠ¶æ€: ${data.status}`, 'info');
                                    
                                    // V0.3.0 æ˜¾ç¤ºæ¨¡å‹å‚æ•°
                                    if (data.model_params) {
                                        updateModelParamsDebug(data.model_params);
                                    }
                                    break;
                                case 'content':
                                    aiResponse += data.content;
                                    
                                    // ğŸ”¥ æ–°å¢ï¼šç¬¬ä¸€æ¬¡æ”¶åˆ°å†…å®¹æ—¶æ¸…é™¤ç­‰å¾…åŠ¨ç”»
                                    if (aiResponse === data.content && messageContent.querySelector('.waiting-animation')) {
                                        messageContent.innerHTML = '';
                                    }
                                    
                                    // æ›´æ–°åŸæ–‡å†…å®¹
                                    const messageRaw = assistantMessageDiv.querySelector('.message-raw');
                                    if (messageRaw) {
                                        messageRaw.textContent = aiResponse;
                                    }
                                    // æ¸²æŸ“Markdown
                                    messageContent.innerHTML = renderMarkdown(aiResponse);
                                    // ä»£ç é«˜äº®å’Œå¤åˆ¶æŒ‰é’®
                                    messageContent.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightElement(block);
                                        addCopyButtonToCodeBlock(block.parentElement);
                                    });
                                    // æ¸²æŸ“æ•°å­¦å…¬å¼
                                    renderMath(messageContent);
                                    scrollToBottom();
                                    break;
                                case 'thinking_stream':
                                    // V0.3.1 ä¿®å¤ï¼šDeepSeek R1 æµå¼æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
                                    if (data.content) {
                                        // è‡ªåŠ¨å¯ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºï¼ˆR1æ¨¡å‹ï¼‰
                                        const isR1Model = currentConfig.model_name === 'deepseek-reasoner';
                                        const enableThinkingCheckbox = document.getElementById('enableThinking');
                                        
                                        if (isR1Model && enableThinkingCheckbox && !enableThinkingCheckbox.checked) {
                                            console.log('[R1] è‡ªåŠ¨å¯ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º');
                                            enableThinkingCheckbox.checked = true;
                                        }
                                        
                                        // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼ˆR1æ¨¡å‹æˆ–ç”¨æˆ·æ‰‹åŠ¨å¯ç”¨æ—¶ï¼‰
                                        if (isR1Model || (enableThinkingCheckbox && enableThinkingCheckbox.checked)) {
                                            // æµå¼æ·»åŠ æ€è€ƒå†…å®¹
                                            addThinkingStreamToMessage(assistantMessageDiv, data.content);
                                            scrollToBottom();
                                        }
                                    }
                                    break;
                                case 'thinking_complete':
                                    // V0.3.1 ä¿®å¤ï¼šæ€è€ƒè¿‡ç¨‹å®Œæˆï¼Œè‡ªåŠ¨æŠ˜å å¹¶å‡†å¤‡æ­£æ–‡æ˜¾ç¤º
                                    if (data.thinking_process) {
                                        const isR1Model = currentConfig.model_name === 'deepseek-reasoner';
                                        const enableThinkingCheckbox = document.getElementById('enableThinking');
                                        
                                        if (isR1Model || (enableThinkingCheckbox && enableThinkingCheckbox.checked)) {
                                            // å®Œæˆæ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºå¹¶è‡ªåŠ¨æŠ˜å 
                                            completeThinkingProcessInMessage(assistantMessageDiv, data.thinking_process);
                                            console.log('[R1] æ€è€ƒè¿‡ç¨‹å®Œæˆï¼Œå·²è‡ªåŠ¨æŠ˜å ');
                                            addDebugEntry('stream', 'DeepSeek-R1æ€è€ƒè¿‡ç¨‹å®Œæˆå¹¶æŠ˜å ', 'success');
                                            scrollToBottom();
                                        }
                                    }
                                    break;
                                case 'done':
                                    console.log('[æ¨¡å‹] æµå¼å“åº”å®Œæˆ');
                                    addDebugEntry('stream', 'æµå¼å“åº”å®Œæˆ', 'success');
                                    
                                    // V0.3.1 ä¿®å¤ï¼šDeepSeek R1 æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºï¼ˆdoneäº‹ä»¶å…¼å®¹å¤„ç†ï¼‰
                                    if (data.thinking_process && data.has_thinking) {
                                        const isR1Model = currentConfig.model_name === 'deepseek-reasoner';
                                        const enableThinkingCheckbox = document.getElementById('enableThinking');
                                        
                                        // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼ˆR1æ¨¡å‹æˆ–ç”¨æˆ·æ‰‹åŠ¨å¯ç”¨æ—¶ï¼‰
                                        if (isR1Model || (enableThinkingCheckbox && enableThinkingCheckbox.checked)) {
                                            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºï¼ˆæ–°æµå¼æ¨¡å¼å¤„ç†è¿‡çš„ï¼‰
                                            const existingThinking = assistantMessageDiv.querySelector('.thinking-process-container');
                                            if (!existingThinking) {
                                                // å…¼å®¹æ—§æ¨¡å¼ï¼šç›´æ¥æ·»åŠ æ€è€ƒè¿‡ç¨‹ï¼ˆæŠ˜å çŠ¶æ€ï¼‰
                                                addThinkingProcessToMessage(assistantMessageDiv, data.thinking_process);
                                                console.log('[R1] doneäº‹ä»¶å…¼å®¹æ¨¡å¼æ·»åŠ æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º');
                                            } else {
                                                console.log('[R1] doneäº‹ä»¶æ£€æµ‹åˆ°å·²æœ‰æ€è€ƒè¿‡ç¨‹ï¼Œè·³è¿‡é‡å¤æ·»åŠ ');
                                            }
                                        } else {
                                            console.log('[R1] doneäº‹ä»¶æ€è€ƒè¿‡ç¨‹å·²æ”¶åˆ°ä½†æœªæ˜¾ç¤ºï¼ˆç”¨æˆ·æœªå¯ç”¨ï¼‰');
                                        }
                                    }
                                    
                                    try {
                                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                                        if (data.debug_info) {
                                            addDebugEntry('debug', 'æ”¶åˆ°å®Œæ•´è°ƒè¯•ä¿¡æ¯', 'success', data.debug_info);
                                            
                                            // ğŸ”¥ æ˜¾ç¤ºæ•°æ®åº“æ“ä½œä¿¡æ¯
                                            if (data.debug_info.db_operations && data.debug_info.db_operations.length > 0) {
                                                updateDatabaseDebug(data.debug_info.db_operations);
                                            }
                                            
                                            // V0.3.1 æ›´æ–°APIäº¤äº’è°ƒè¯•ä¿¡æ¯
                                            const apiInteraction = {
                                                user_message: data.debug_info.user_message || 'æœªçŸ¥',
                                                request: data.debug_info.api_request || {},
                                                response: data.debug_info.api_response || {},
                                                response_success: true,
                                                response_content: data.full_response || aiResponse,
                                                thinking_process: data.thinking_process || null,
                                                processing_time: data.debug_info.timing?.total_time,
                                                token_usage: data.debug_info.api_response?.usage || 'æœªçŸ¥'
                                            };
                                            updateContextDebug(apiInteraction);
                                            
                                            if (data.debug_info.langchain_enabled) {
                                                updateLangChainDebug({
                                                    enabled: true,
                                                    memory_type: data.debug_info.langchain_result?.context_info?.memory_type,
                                                    processing_time: data.debug_info.timing?.total_time,
                                                    context_info: data.debug_info.context_info,
                                                    processing_steps: data.debug_info.processing_steps
                                                });
                                            } else {
                                                updateLangChainDebug({
                                                    enabled: false
                                                });
                                            }
                                            
                                            // æ˜¾ç¤ºæ¶ˆæ¯ä¿å­˜çŠ¶æ€
                                            if (data.debug_info.final_stats) {
                                                const stats = data.debug_info.final_stats;
                                                addDebugEntry('database', 
                                                    `æ¶ˆæ¯ä¿å­˜çŠ¶æ€: ${stats.save_queued ? 'å·²åŠ å…¥é˜Ÿåˆ—' : 'æœªä¿å­˜'}, é˜Ÿåˆ—å¤§å°: ${stats.queue_size || 0}`, 
                                                    stats.save_queued ? 'success' : 'warning'
                                                );
                                            }
                                        }
                                        
                                        // æµå¼å“åº”å·²å®Œæˆï¼ŒAIæ¶ˆæ¯å·²åœ¨æœåŠ¡å™¨ç«¯ä¿å­˜
                                        console.log(`[æ•°æ®åº“] AIæ¶ˆæ¯å·²ä¿å­˜: ${data.message_id}`);
                                        
                                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°
                                        await loadConversations();
                                        console.log('[UI] å¯¹è¯åˆ—è¡¨å·²åˆ·æ–°');
                                        
                                        // é‡ç½®æ‰€æœ‰çŠ¶æ€
                                        isLoading = false;
                                        window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
                                        
                                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°  
                                        updateSendButtonState();
                                        
                                        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºæ¸²æŸ“æŒ‰é’®
                                        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
                                        if (toggleBtn) {
                                            toggleBtn.style.display = 'inline-block';
                                        }
                                        
                                        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                                        const messageInput = document.getElementById('messageInput');
                                        if (messageInput) {
                                            messageInput.focus();
                                        }
                                        
                                        addDebugEntry('system', 'æ¶ˆæ¯å¤„ç†å®Œæˆï¼ŒçŠ¶æ€å·²é‡ç½®', 'success');
                                        
                                    } catch (error) {
                                        console.error('doneäº‹ä»¶å¤„ç†å¼‚å¸¸:', error);
                                        addDebugEntry('error', `doneäº‹ä»¶å¤„ç†å¼‚å¸¸: ${error.message}`, 'error');
                                    }
                                    break;
                                case 'error':
                                    console.error('AIå“åº”é”™è¯¯:', data.error);
                                    try {
                                        const errorMessage = `æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ï¼š${data.error}`;
                                        messageContent.innerHTML = renderMarkdown(errorMessage);
                                        assistantMessageDiv.querySelector('.message-bubble').classList.add('error');
                                        // æ›´æ–°åŸæ–‡å†…å®¹
                                        const errorMessageRaw = assistantMessageDiv.querySelector('.message-raw');
                                        if (errorMessageRaw) {
                                            errorMessageRaw.textContent = errorMessage;
                                        }
                                        // æ¸²æŸ“æ•°å­¦å…¬å¼
                                        renderMath(messageContent);
                                    } catch (error) {
                                        console.error('erroräº‹ä»¶å¤„ç†å¼‚å¸¸:', error);
                                    } finally {
                                        // é‡ç½®åŠ è½½çŠ¶æ€
                                        isLoading = false;
                                        window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
                                        
                                        // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
                                        updateSendButtonState();
                                        
                                        // ğŸ”¥ æ–°å¢ï¼šé”™è¯¯æ—¶ä¹Ÿè¦æ˜¾ç¤ºæ¸²æŸ“æŒ‰é’®
                                        const toggleBtn = assistantMessageDiv.querySelector('.message-toggle-btn');
                                        if (toggleBtn) {
                                            toggleBtn.style.display = 'inline-block';
                                        }
                                        
                                        console.log('erroräº‹ä»¶å¤„ç†å®Œæˆï¼ŒæŒ‰é’®çŠ¶æ€å·²æ¢å¤ï¼ŒisLoading=', isLoading);
                                    }
                                    break;
                            }
                        } catch (e) {
                            console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            }
            
        } catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            recoverFromError(previousState);
            addMessage('assistant', 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
        }
    } catch (error) {
        console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
        addMessage('assistant', 'æŠ±æ­‰ï¼Œå¤„ç†æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
    }
}

// æ·»åŠ é”™è¯¯æ¢å¤å‡½æ•°
function recoverFromError(previousState) {
    console.log('[é”™è¯¯æ¢å¤] å¼€å§‹æ¢å¤çŠ¶æ€');
    
    // é‡ç½®åŠ è½½çŠ¶æ€
    isLoading = false;
    window.lastSendTime = null; // æ¸…é™¤å‘é€æ—¶é—´è®°å½•
    
    // æ¢å¤UIå…ƒç´ 
    const messageInput = document.getElementById('messageInput');
    
    // ğŸ”¥ ä¿®å¤ï¼šæ¢å¤è¾“å…¥æ¡†å†…å®¹å¹¶èšç„¦
    if (messageInput) {
        messageInput.value = previousState.message;
        messageInput.focus();
    }
    
    // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å‡½æ•°
    updateSendButtonState();
    
    // æ¢å¤å¯¹è¯ID
    if (previousState.conversationId) {
        currentConversationId = previousState.conversationId;
    }
    
    console.log('[é”™è¯¯æ¢å¤] çŠ¶æ€å·²æ¢å¤');
}

// åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼å“åº”ï¼‰
function createMessageContainer(role, isError = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const bubbleClass = isError ? 'message-bubble error' : 'message-bubble';
    
    // æ ¹æ®è§’è‰²å†³å®šå¤´åƒå’Œæ¶ˆæ¯çš„é¡ºåº
    if (role === 'user') {
        // ç”¨æˆ·æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ä¾§ï¼ HTMLç»“æ„è¦æ˜ç¡®ï¼šæ°”æ³¡ + å¤´åƒ
        messageDiv.innerHTML = `
            <div class="${bubbleClass}">
                <div class="message-content"></div>
            </div>
            <div class="message-avatar">
                <i class="bi bi-person-fill"></i>
            </div>
        `;
    } else {
        // AIæ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œæ¶ˆæ¯æ°”æ³¡åœ¨å³ï¼ŒåŒ…å«åˆ‡æ¢æŒ‰é’®
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi bi-robot"></i>
            </div>
            <div class="${bubbleClass}">
                <div class="message-header">
                    <button class="btn btn-outline-secondary btn-sm message-toggle-btn" 
                            onclick="toggleMessageFormat('${messageId}')" 
                            title="åˆ‡æ¢åŸæ–‡/æ¸²æŸ“è§†å›¾">
                        <i class="bi bi-eye"></i> æ¸²æŸ“
                    </button>
                </div>
                <div class="message-content" id="${messageId}"></div>
                <div class="message-raw" id="${messageId}_raw" style="display: none;"></div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ - V0.3.1 æ”¯æŒæ€è€ƒè¿‡ç¨‹
function addMessage(role, content, isError = false, thinkingProcess = null) {
    // console.log(`æ·»åŠ æ¶ˆæ¯: role=${role}, contentLength=${content.length}, isError=${isError}`);
    
    // ğŸ”¥ ä¿®å¤BUG1ï¼šæ·»åŠ æ¶ˆæ¯æ—¶ç«‹å³éšè—æ¬¢è¿æ¶ˆæ¯
    const welcomeMessage = document.getElementById('welcomeMessage');
    if (welcomeMessage && welcomeMessage.style.display !== 'none') {
        welcomeMessage.style.display = 'none';
    }
    
    const messageDiv = createMessageContainer(role, isError);
    const messageContent = messageDiv.querySelector('.message-content');
    
    if (!messageContent) {
        console.error('æ— æ³•æ‰¾åˆ° .message-content å…ƒç´ !', messageDiv);
        return;
    }
    
    if (role === 'user') {
        // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨ç®€å•æ ¼å¼åŒ–
        messageContent.innerHTML = formatMessage(content);
        // console.log('ç”¨æˆ·æ¶ˆæ¯å·²æ¸²æŸ“');
    } else {
        // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“
        const messageRaw = messageDiv.querySelector('.message-raw');
        if (messageRaw) {
            messageRaw.textContent = content; // ä¿å­˜åŸæ–‡
        } else {
            console.warn('æœªæ‰¾åˆ° .message-raw å…ƒç´ ï¼ŒAIæ¶ˆæ¯å¯èƒ½æ˜¾ç¤ºä¸å®Œæ•´');
        }
        
        const renderedContent = renderMarkdown(content);
        messageContent.innerHTML = renderedContent;
        // console.log('AIæ¶ˆæ¯å·²æ¸²æŸ“ï¼Œå†…å®¹é•¿åº¦:', renderedContent.length);
        
        // V0.3.1 å¤„ç†æ€è€ƒè¿‡ç¨‹æ¢å¤ï¼ˆå…¼å®¹null/undefinedï¼‰
        if (thinkingProcess && typeof thinkingProcess === 'string' && thinkingProcess.trim()) {
            console.log('[æ€è€ƒè¿‡ç¨‹] æ¢å¤å†å²æ€è€ƒè¿‡ç¨‹ï¼Œé•¿åº¦:', thinkingProcess.length);
            addThinkingProcessToMessage(messageDiv, thinkingProcess);
            // å†å²æ¶ˆæ¯çš„æ€è€ƒè¿‡ç¨‹é»˜è®¤æŠ˜å 
            completeThinkingProcessInMessage(messageDiv, thinkingProcess);
        }
        
        // ä»£ç é«˜äº®å’Œå¤åˆ¶æŒ‰é’®
        messageContent.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
            addCopyButtonToCodeBlock(block.parentElement);
        });
        
        // æ¸²æŸ“æ•°å­¦å…¬å¼
        renderMath(messageContent);
    }
    
    scrollToBottom();
}

// æ¸²æŸ“Markdownå†…å®¹
function renderMarkdown(content) {
    try {
        // é¢„å¤„ç†æ•°å­¦å…¬å¼ï¼šå¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„å…¬å¼
        content = preprocessMathFormulas(content);
        
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });
        
        return marked.parse(content);
    } catch (error) {
        console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
        return formatMessage(content); // é™çº§åˆ°ç®€å•æ ¼å¼åŒ–
    }
}

// é¢„å¤„ç†æ•°å­¦å…¬å¼
function preprocessMathFormulas(content) {
    // console.log('å¼€å§‹é¢„å¤„ç†æ•°å­¦å…¬å¼ï¼ŒåŸå§‹å†…å®¹:', content.substring(0, 100) + '...');
    
    // 1. å¤„ç†æ¯ä¸ªç‹¬ç«‹çš„LaTeXå—çº§å…¬å¼ \[ ... \]
    let processedContent = content;
    let matches = [];
    let regex = /\\\[\s*\n?\s*([\s\S]*?)\s*\n?\s*\\\]/g;
    let match;
    
    // æ”¶é›†æ‰€æœ‰åŒ¹é…
    while ((match = regex.exec(content)) !== null) {
        matches.push({
            fullMatch: match[0],
            formula: match[1].trim(),
            index: match.index
        });
    }
    
    // console.log('æ‰¾åˆ°', matches.length, 'ä¸ªLaTeXå—çº§å…¬å¼');
    
    // ä»åå¾€å‰æ›¿æ¢ï¼Œé¿å…ç´¢å¼•åç§»
    for (let i = matches.length - 1; i >= 0; i--) {
        const m = matches[i];
        // console.log('å¤„ç†å…¬å¼', i + 1, ':', m.formula);
        const replacement = '\n$$' + m.formula + '$$\n';
        processedContent = processedContent.substring(0, m.index) + replacement + processedContent.substring(m.index + m.fullMatch.length);
    }
    
    // 2. å¤„ç†LaTeXè¡Œå†…å…¬å¼ \( ... \)
    processedContent = processedContent.replace(/\\\(\s*(.*?)\s*\\\)/g, function(match, formula) {
        formula = formula.trim();
                    // console.log('å‘ç°LaTeXè¡Œå†…å…¬å¼:', formula);
        return '$' + formula + '$';
    });
    
    // 3. å¤„ç†æ–¹æ‹¬å·åŒ…å›´çš„æ•°å­¦å…¬å¼ [æ•°å­¦å†…å®¹]
    processedContent = processedContent.replace(/\[\s*([^[\]]*(?:\\[^[\]]*)*[^[\]]*)\s*\]/g, function(match, formula) {
        formula = formula.trim();
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦ç¬¦å·
        const mathIndicators = ['\\frac', '\\partial', '\\hat', '\\text', '\\quad', 
                              '\\alpha', '\\beta', '\\gamma', '\\delta', '\\theta', '\\lambda', 
                              '^{', '_{', '\\sum', '\\int', '\\cdot', '\\times'];
        
        const isMathFormula = mathIndicators.some(indicator => formula.includes(indicator));
        
        if (isMathFormula) {
            // console.log('å‘ç°æ–¹æ‹¬å·æ•°å­¦å…¬å¼:', formula);
            return '\n$$' + formula + '$$\n';
        }
        
        return match;
    });
    
    // 4. æ¸…ç†é‡å¤çš„æ ‡è®°
    processedContent = processedContent.replace(/\$\$\s*\$\$/g, '$$');
    processedContent = processedContent.replace(/\$\s*\$/g, '$');
    
    // console.log('æ•°å­¦å…¬å¼é¢„å¤„ç†å®Œæˆï¼Œå¤„ç†åå†…å®¹:', processedContent.substring(0, 100) + '...');
    return processedContent;
}

// æ¸²æŸ“æ•°å­¦å…¬å¼
function renderMath(element) {
    if (window.MathJax && window.MathJax.typesetPromise) {
        // æ¸…é™¤ä¹‹å‰çš„MathJaxå¤„ç†
        window.MathJax.typesetClear([element]);
        
        // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
        window.MathJax.typesetPromise([element]).then(function() {
            // console.log('MathJaxæ¸²æŸ“å®Œæˆ');
        }).catch(function (err) {
            // console.log('MathJaxæ¸²æŸ“é”™è¯¯:', err.message);
        });
    }
}

// ç®€å•æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºç”¨æˆ·æ¶ˆæ¯ï¼‰
function formatMessage(content) {
    return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/\n/g, '<br>');
}

// åˆ‡æ¢æ¶ˆæ¯æ˜¾ç¤ºæ ¼å¼ï¼ˆæ¸²æŸ“/åŸæ–‡ï¼‰
function toggleMessageFormat(messageId) {
    const contentDiv = document.getElementById(messageId);
    const rawDiv = document.getElementById(messageId + '_raw');
    const toggleBtn = document.querySelector(`[onclick="toggleMessageFormat('${messageId}')"]`);
    
    if (contentDiv.style.display === 'none') {
        // åˆ‡æ¢åˆ°æ¸²æŸ“è§†å›¾
        contentDiv.style.display = 'block';
        rawDiv.style.display = 'none';
        toggleBtn.innerHTML = '<i class="bi bi-eye"></i> æ¸²æŸ“';
        toggleBtn.title = 'åˆ‡æ¢åˆ°åŸæ–‡è§†å›¾';
    } else {
        // åˆ‡æ¢åˆ°åŸæ–‡è§†å›¾
        contentDiv.style.display = 'none';
        rawDiv.style.display = 'block';
        toggleBtn.innerHTML = '<i class="bi bi-code"></i> åŸæ–‡';
        toggleBtn.title = 'åˆ‡æ¢åˆ°æ¸²æŸ“è§†å›¾';
    }
}

// æ‰“å­—æŒ‡ç¤ºå™¨åŠŸèƒ½å·²ç§»é™¤

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// æ’å…¥å¿«æ·æ–‡æœ¬
function insertQuickText(text) {
    const messageInput = document.getElementById('messageInput');
    messageInput.value = text;
    messageInput.focus();
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    document.getElementById('sendBtn').disabled = false;
}

// ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
async function saveMessage(conversationId, messageId, content, role = 'assistant') {
    try {
        const response = await fetch('/api/save_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                message_id: messageId,
                content: content,
                role: role
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', data.message);
        }
    } catch (error) {
        console.error('ä¿å­˜æ¶ˆæ¯å¼‚å¸¸:', error);
    }
}

// V0.3.0 ç§»é™¤çŸ¥è¯†åº“é€‰æ‹©åŠŸèƒ½ - è¯¥å‡½æ•°å·²åˆ é™¤

// V0.3.0 DeepSeek R1 æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºåŠŸèƒ½
function addThinkingProcessToMessage(messageDiv, thinkingProcess) {
    if (!thinkingProcess || !thinkingProcess.trim()) {
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ€è€ƒè¿‡ç¨‹ï¼Œé¿å…é‡å¤æ·»åŠ 
    if (messageDiv.querySelector('.thinking-process-container')) {
        return;
    }
    
    // åˆ›å»ºæ€è€ƒè¿‡ç¨‹å®¹å™¨
    const thinkingContainer = document.createElement('div');
    thinkingContainer.className = 'thinking-process-container';
    
    // åˆ›å»ºå±•å¼€/æŠ˜å æŒ‰é’®
    const toggleButton = document.createElement('button');
    toggleButton.className = 'btn btn-link btn-sm thinking-toggle-btn p-1';
    toggleButton.innerHTML = `
        <i class="bi bi-chevron-right me-1"></i>
        <i class="bi bi-brain me-1 text-muted"></i>
        <span class="text-muted small">æŸ¥çœ‹æ·±åº¦æ€è€ƒè¿‡ç¨‹</span>
    `;
    
    // åˆ›å»ºæ€è€ƒå†…å®¹åŒºåŸŸ
    const thinkingContent = document.createElement('div');
    thinkingContent.className = 'thinking-content';
    thinkingContent.style.display = 'none';
    thinkingContent.innerHTML = `
        <div class="thinking-text p-2 border-start border-2 border-primary bg-light" style="color: #666; font-size: 0.9em;">
            ${renderMarkdown(thinkingProcess)}
        </div>
    `;
    
    // æ·»åŠ å±•å¼€/æŠ˜å åŠŸèƒ½
    toggleButton.addEventListener('click', function() {
        const isExpanded = thinkingContent.style.display !== 'none';
        
        if (isExpanded) {
            // æŠ˜å 
            thinkingContent.style.display = 'none';
            toggleButton.innerHTML = `
                <i class="bi bi-chevron-right me-1"></i>
                <i class="bi bi-brain me-1 text-muted"></i>
                <span class="text-muted small">æŸ¥çœ‹æ·±åº¦æ€è€ƒè¿‡ç¨‹</span>
            `;
        } else {
            // å±•å¼€
            thinkingContent.style.display = 'block';
            toggleButton.innerHTML = `
                <i class="bi bi-chevron-down me-1"></i>
                <i class="bi bi-brain me-1 text-muted"></i>
                <span class="text-muted small">éšè—æ€è€ƒè¿‡ç¨‹</span>
            `;
            
            // ä»£ç é«˜äº®
            thinkingContent.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                addCopyButtonToCodeBlock(block.parentElement);
            });
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (typeof renderMath === 'function') {
                renderMath(thinkingContent);
            }
        }
    });
    
    // ç»„è£…å®¹å™¨
    thinkingContainer.appendChild(toggleButton);
    thinkingContainer.appendChild(thinkingContent);
    
    // åœ¨æ¶ˆæ¯å†…å®¹ä¹‹å‰æ’å…¥æ€è€ƒè¿‡ç¨‹
    const messageContent = messageDiv.querySelector('.message-content');
    if (messageContent) {
        messageContent.parentNode.insertBefore(thinkingContainer, messageContent);
    }
}

// V0.3.1 æ–°å¢ï¼šæµå¼æ€è€ƒè¿‡ç¨‹å¤„ç†å‡½æ•°
function addThinkingStreamToMessage(messageDiv, content) {
    if (!content) return;
    
    let thinkingContainer = messageDiv.querySelector('.thinking-process-container');
    
    // å¦‚æœä¸å­˜åœ¨æ€è€ƒè¿‡ç¨‹å®¹å™¨ï¼Œåˆ›å»ºå®ƒ
    if (!thinkingContainer) {
        thinkingContainer = document.createElement('div');
        thinkingContainer.className = 'thinking-process-container';
        
        // åˆ›å»ºæ ‡é¢˜æ ï¼Œæ˜¾ç¤ºæ€è€ƒæ­£åœ¨è¿›è¡Œ
        const thinkingHeader = document.createElement('div');
        thinkingHeader.className = 'thinking-header p-2 bg-primary bg-opacity-10 border-start border-2 border-primary';
        thinkingHeader.innerHTML = `
            <i class="bi bi-brain me-2 text-primary"></i>
            <span class="text-primary small fw-bold">AIæ­£åœ¨æ·±åº¦æ€è€ƒä¸­...</span>
            <i class="bi bi-arrow-repeat spin ms-2 text-primary"></i>
        `;
        
        // åˆ›å»ºæ€è€ƒå†…å®¹åŒºåŸŸï¼ˆå±•å¼€çŠ¶æ€æ˜¾ç¤ºæµå¼å†…å®¹ï¼‰
        const thinkingContent = document.createElement('div');
        thinkingContent.className = 'thinking-content-stream';
        thinkingContent.style.display = 'block';
        thinkingContent.innerHTML = `
            <div class="thinking-text p-2 border-start border-2 border-primary bg-light" style="color: #666; font-size: 0.9em;">
                <div class="thinking-stream-content"></div>
            </div>
        `;
        
        thinkingContainer.appendChild(thinkingHeader);
        thinkingContainer.appendChild(thinkingContent);
        
        // åœ¨æ¶ˆæ¯å†…å®¹ä¹‹å‰æ’å…¥æ€è€ƒè¿‡ç¨‹
        const messageContent = messageDiv.querySelector('.message-content');
        if (messageContent) {
            messageContent.parentNode.insertBefore(thinkingContainer, messageContent);
        }
    }
    
    // æ·»åŠ æµå¼å†…å®¹åˆ°æ€è€ƒè¿‡ç¨‹
    const streamContent = thinkingContainer.querySelector('.thinking-stream-content');
    if (streamContent) {
        streamContent.textContent += content;
    }
}

// V0.3.1 æ–°å¢ï¼šå®Œæˆæ€è€ƒè¿‡ç¨‹å¹¶è‡ªåŠ¨æŠ˜å 
function completeThinkingProcessInMessage(messageDiv, fullThinkingProcess) {
    const thinkingContainer = messageDiv.querySelector('.thinking-process-container');
    if (!thinkingContainer) return;
    
    // ç§»é™¤æµå¼æ˜¾ç¤ºçš„å†…å®¹
    const streamContent = thinkingContainer.querySelector('.thinking-content-stream');
    if (streamContent) {
        streamContent.remove();
    }
    
    // ç§»é™¤æ€è€ƒå¤´éƒ¨
    const thinkingHeader = thinkingContainer.querySelector('.thinking-header');
    if (thinkingHeader) {
        thinkingHeader.remove();
    }
    
    // åˆ›å»ºæŠ˜å çŠ¶æ€çš„æ€è€ƒè¿‡ç¨‹ç•Œé¢
    const toggleButton = document.createElement('button');
    toggleButton.className = 'btn btn-link btn-sm thinking-toggle-btn p-1';
    toggleButton.innerHTML = `
        <i class="bi bi-chevron-right me-1"></i>
        <i class="bi bi-brain me-1 text-muted"></i>
        <span class="text-muted small">æŸ¥çœ‹æ·±åº¦æ€è€ƒè¿‡ç¨‹</span>
    `;
    
    // åˆ›å»ºæŠ˜å çš„æ€è€ƒå†…å®¹åŒºåŸŸ
    const thinkingContent = document.createElement('div');
    thinkingContent.className = 'thinking-content';
    thinkingContent.style.display = 'none'; // é»˜è®¤æŠ˜å 
    thinkingContent.innerHTML = `
        <div class="thinking-text p-2 border-start border-2 border-primary bg-light" style="color: #666; font-size: 0.9em;">
            ${renderMarkdown(fullThinkingProcess)}
        </div>
    `;
    
    // æ·»åŠ å±•å¼€/æŠ˜å åŠŸèƒ½
    toggleButton.addEventListener('click', function() {
        const isExpanded = thinkingContent.style.display !== 'none';
        
        if (isExpanded) {
            // æŠ˜å 
            thinkingContent.style.display = 'none';
            toggleButton.innerHTML = `
                <i class="bi bi-chevron-right me-1"></i>
                <i class="bi bi-brain me-1 text-muted"></i>
                <span class="text-muted small">æŸ¥çœ‹æ·±åº¦æ€è€ƒè¿‡ç¨‹</span>
            `;
        } else {
            // å±•å¼€
            thinkingContent.style.display = 'block';
            toggleButton.innerHTML = `
                <i class="bi bi-chevron-down me-1"></i>
                <i class="bi bi-brain me-1 text-muted"></i>
                <span class="text-muted small">éšè—æ€è€ƒè¿‡ç¨‹</span>
            `;
            
            // ä»£ç é«˜äº®
            thinkingContent.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                addCopyButtonToCodeBlock(block.parentElement);
            });
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (typeof renderMath === 'function') {
                renderMath(thinkingContent);
            }
        }
    });
    
    // é‡æ–°ç»„è£…å®¹å™¨
    thinkingContainer.innerHTML = '';
    thinkingContainer.appendChild(toggleButton);
    thinkingContainer.appendChild(thinkingContent);
}

// V0.3.0 å¤„ç†èŠå¤©ç®€å•APIçš„æ€è€ƒè¿‡ç¨‹å“åº”
function handleSimpleChatThinking(response) {
    if (response.has_thinking && response.thinking_process) {
        // å¦‚æœæœ‰æ€è€ƒè¿‡ç¨‹ï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·
        const lastAssistantMessage = document.querySelector('.message.assistant:last-child');
        if (lastAssistantMessage) {
            addThinkingProcessToMessage(lastAssistantMessage, response.thinking_process);
        }
    }
}

// å‘é€æŒ‰é’®çŠ¶æ€ç®¡ç†å‡½æ•°
function updateSendButtonState() {
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    
    if (!sendBtn || !messageInput) return;
    
    const hasContent = messageInput.value.trim().length > 0;
    
    if (isLoading) {
        // åŠ è½½çŠ¶æ€ï¼šç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½å›¾æ ‡
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
    } else {
        // éåŠ è½½çŠ¶æ€ï¼šæ ¹æ®å†…å®¹å†³å®šæŒ‰é’®çŠ¶æ€
        sendBtn.disabled = !hasContent;
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
    }
}

// å¼ºåˆ¶é‡ç½®åŠ è½½çŠ¶æ€ï¼ˆä»…åœ¨çœŸæ­£éœ€è¦æ—¶è°ƒç”¨ï¼‰
function forceResetLoadingState() {
    isLoading = false;
    updateSendButtonState();
    
    // ç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.disabled = false;
        messageInput.focus();
    }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ï¼ˆå¦‚æœä¸å­˜åœ¨çš„è¯ï¼‰
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// æ£€æŸ¥æ˜¯å¦å¯ç”¨æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
function shouldShowThinkingProcess() {
    const checkbox = document.getElementById('enableThinking');
    const modelName = currentConfig.model_name;
    return checkbox && checkbox.checked && modelName === 'deepseek-reasoner';
}

// åˆ†äº«å¯¹è¯åˆ°è®ºå› - æ˜¾ç¤ºä¸“ä¸šæ¨¡æ€æ¡†
function shareConversation(conversationId, event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘åˆ‡æ¢å¯¹è¯
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // è·å–å¯¹è¯ä¿¡æ¯
    const conversation = conversations.find(c => c.id === conversationId);
    if (!conversation) {
        showToast('å¯¹è¯ä¸å­˜åœ¨', 'error');
        return;
    }
    
    // æ£€æŸ¥å¯¹è¯æ˜¯å¦æœ‰æ¶ˆæ¯
    if (!conversation.message_count || conversation.message_count === 0) {
        showToast('ç©ºå¯¹è¯æ— æ³•åˆ†äº«', 'error');
        return;
    }
    
    // æ‰“å¼€åˆ†äº«æ¨¡æ€æ¡†
    openShareConversationModal(conversation);
}

// æ‰“å¼€åˆ†äº«å¯¹è¯æ¨¡æ€æ¡†
function openShareConversationModal(conversation) {
    const modal = document.getElementById('shareConversationModal');
    const titleInput = document.getElementById('shareConversationTitle');
    const descriptionTextarea = document.getElementById('shareConversationDescription');
    const tagsInput = document.getElementById('shareConversationTags');
    const messageCountSpan = document.getElementById('shareConversationMessageCount');
    const modelSpan = document.getElementById('shareConversationModel');
    const timeSpan = document.getElementById('shareConversationTime');
    const form = document.getElementById('shareConversationForm');
    
    // å¡«å……å¯¹è¯ä¿¡æ¯
    titleInput.value = conversation.title;
    descriptionTextarea.value = `è¿™æ˜¯ä¸€æ®µå…³äº"${conversation.title}"çš„ç²¾å½©AIå¯¹è¯ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼`;
    tagsInput.value = 'AIå¯¹è¯,åˆ†äº«';
    
    // å¡«å……ç»Ÿè®¡ä¿¡æ¯
    messageCountSpan.textContent = conversation.message_count || 0;
    modelSpan.textContent = conversation.model_display_name || 'DeepSeek';
    
    // æ ¼å¼åŒ–æ—¶é—´
    if (conversation.updated_at) {
        const date = new Date(conversation.updated_at);
        timeSpan.textContent = date.toLocaleString('zh-CN');
    } else {
        timeSpan.textContent = 'æœªçŸ¥';
    }
    
    // æ›´æ–°å­—ç¬¦è®¡æ•°å™¨
    updateCharCounter();
    
    // è®¾ç½®è¡¨å•æäº¤å¤„ç†
    form.onsubmit = function(e) {
        e.preventDefault();
        handleShareConversationSubmit(conversation.id);
    };
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'block';
    
    // èšç„¦åˆ°æè¿°è¾“å…¥æ¡†
    setTimeout(() => {
        descriptionTextarea.focus();
        descriptionTextarea.setSelectionRange(0, descriptionTextarea.value.length);
    }, 100);
}

// å…³é—­åˆ†äº«å¯¹è¯æ¨¡æ€æ¡†
function closeShareConversationModal() {
    const modal = document.getElementById('shareConversationModal');
    modal.style.display = 'none';
}

// æ›´æ–°å­—ç¬¦è®¡æ•°å™¨
function updateCharCounter() {
    const descriptionTextarea = document.getElementById('shareConversationDescription');
    const charCounter = document.getElementById('shareDescriptionCharCounter');
    
    const currentLength = descriptionTextarea.value.length;
    const maxLength = 140;
    charCounter.textContent = `${currentLength}/${maxLength}`;
    
    // è¶…å‡ºé™åˆ¶æ—¶æ˜¾ç¤ºçº¢è‰²
    if (currentLength > maxLength) {
        charCounter.style.color = '#dc2626';
        descriptionTextarea.style.borderColor = '#dc2626';
    } else {
        charCounter.style.color = '#64748b';
        descriptionTextarea.style.borderColor = '#e2e8f0';
    }
}

// å¤„ç†åˆ†äº«è¡¨å•æäº¤
async function handleShareConversationSubmit(conversationId) {
    const descriptionTextarea = document.getElementById('shareConversationDescription');
    const tagsInput = document.getElementById('shareConversationTags');
    const submitBtn = document.getElementById('submitShareBtn');
    
    const description = descriptionTextarea.value.trim();
    const tags = tagsInput.value.trim();
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!description) {
        showToast('è¯·è¾“å…¥åˆ†äº«æè¿°', 'error');
        descriptionTextarea.focus();
        return;
    }
    
    if (description.length > 140) {
        showToast('åˆ†äº«æè¿°ä¸èƒ½è¶…è¿‡140å­—ç¬¦', 'error');
        descriptionTextarea.focus();
        return;
    }
    
    // ç¦ç”¨æäº¤æŒ‰é’®
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> åˆ†äº«ä¸­...';
    
    try {
        // å¤„ç†æ ‡ç­¾
        let tagArray = ['AIå¯¹è¯', 'åˆ†äº«']; // é»˜è®¤æ ‡ç­¾
        if (tags) {
            const customTags = tags.split(/[,ï¼Œ]/).map(tag => tag.trim()).filter(tag => tag.length > 0);
            tagArray = [...new Set([...tagArray, ...customTags])]; // å»é‡
        }
        
        // è°ƒç”¨åˆ†äº«API
        const response = await fetch('/api/community/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: description,
                ai_content_type: 'conversation',
                ai_content_data: {
                    conversation_id: conversationId
                },
                tags: tagArray
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            closeShareConversationModal();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('åˆ†äº«æˆåŠŸï¼', 'success');
            
            // è¯¢é—®æ˜¯å¦è·³è½¬åˆ°è®ºå›æŸ¥çœ‹
            setTimeout(() => {
                if (confirm('åˆ†äº«æˆåŠŸï¼æ˜¯å¦è·³è½¬åˆ°è®ºå›æŸ¥çœ‹ï¼Ÿ')) {
                    window.open('/community', '_blank');
                }
            }, 500);
        } else {
            showToast(`åˆ†äº«å¤±è´¥ï¼š${result.message}`, 'error');
        }
        
    } catch (error) {
        console.error('åˆ†äº«å¯¹è¯å¤±è´¥:', error);
        showToast('åˆ†äº«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } finally {
        // æ¢å¤æäº¤æŒ‰é’®
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-share"></i> åˆ†äº«åˆ°è®ºå›';
    }
}

// æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
function startEditTitle() {
    const titleElement = document.getElementById('currentChatTitle');
    const editorElement = document.getElementById('titleEditor');
    
    // å¦‚æœæ²¡æœ‰å¯¹è¯IDï¼Œä¸å…è®¸ç¼–è¾‘
    if (!currentConversationId) {
        showToast('å¼€å§‹å¯¹è¯åå¯ä»¥ç¼–è¾‘æ ‡é¢˜', 'info');
        return;
    }
    
    const currentTitle = titleElement.textContent.trim();
    
    // éšè—æ ‡é¢˜ï¼Œæ˜¾ç¤ºç¼–è¾‘å™¨
    titleElement.style.display = 'none';
    editorElement.style.display = 'block';
    editorElement.value = currentTitle;
    
    // èšç„¦å¹¶é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
    setTimeout(() => {
        editorElement.focus();
        editorElement.select();
    }, 10);
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    editorElement.onkeydown = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTitle();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEditTitle();
        }
    };
    
    editorElement.onblur = function() {
        saveTitle();
    };
}

// å–æ¶ˆç¼–è¾‘æ ‡é¢˜
function cancelEditTitle() {
    const titleElement = document.getElementById('currentChatTitle');
    const editorElement = document.getElementById('titleEditor');
    
    editorElement.style.display = 'none';
    titleElement.style.display = 'block';
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    editorElement.onkeydown = null;
    editorElement.onblur = null;
}

// ä¿å­˜æ ‡é¢˜
async function saveTitle() {
    const titleElement = document.getElementById('currentChatTitle');
    const editorElement = document.getElementById('titleEditor');
    const newTitle = editorElement.value.trim();
    
    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œå–æ¶ˆç¼–è¾‘
    if (!newTitle) {
        showToast('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
        editorElement.focus();
        return;
    }
    
    // å¦‚æœæ ‡é¢˜æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥å–æ¶ˆç¼–è¾‘
    const originalTitle = titleElement.textContent.trim();
    if (newTitle === originalTitle) {
        cancelEditTitle();
        return;
    }
    
    try {
        // è°ƒç”¨APIæ›´æ–°æ ‡é¢˜
        const response = await fetch(`/api/conversations/${currentConversationId}/title`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: newTitle
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤º
            const titleText = titleElement.childNodes[0];
            if (titleText && titleText.nodeType === Node.TEXT_NODE) {
                titleText.textContent = newTitle;
            } else {
                // å¦‚æœç»“æ„æœ‰å˜åŒ–ï¼Œé‡æ–°è®¾ç½®å†…å®¹
                titleElement.innerHTML = `${newTitle}<i class="bi bi-pencil-square edit-icon"></i>`;
            }
            
            // æ›´æ–°ä¾§è¾¹æ å¯¹è¯åˆ—è¡¨ä¸­çš„æ ‡é¢˜
            updateConversationListTitle(currentConversationId, newTitle);
            
            showToast('æ ‡é¢˜å·²æ›´æ–°', 'success');
        } else {
            showToast(`æ›´æ–°æ ‡é¢˜å¤±è´¥ï¼š${result.message}`, 'error');
        }
    } catch (error) {
        console.error('æ›´æ–°æ ‡é¢˜å¤±è´¥:', error);
        showToast('æ›´æ–°æ ‡é¢˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
    
    // éšè—ç¼–è¾‘å™¨ï¼Œæ˜¾ç¤ºæ ‡é¢˜
    cancelEditTitle();
}

// æ›´æ–°ä¾§è¾¹æ å¯¹è¯åˆ—è¡¨ä¸­çš„æ ‡é¢˜
function updateConversationListTitle(conversationId, newTitle) {
    // æ›´æ–°å†…å­˜ä¸­çš„å¯¹è¯æ•°æ®
    const conversation = conversations.find(c => c.id === conversationId);
    if (conversation) {
        conversation.title = newTitle;
    }
    
    // æ›´æ–°DOMä¸­çš„æ ‡é¢˜æ˜¾ç¤º
    const conversationElement = document.querySelector(`.conversation-item[data-conversation-id="${conversationId}"]`);
    if (conversationElement) {
        const titleElement = conversationElement.querySelector('.conversation-title');
        if (titleElement) {
            titleElement.textContent = newTitle;
        }
    }
}

// V0.3.1 ä¿®å¤ï¼šåˆ é™¤é‡å¤çš„toggleDebugModeå‡½æ•°å®šä¹‰ï¼Œä½¿ç”¨å‰é¢çš„ç‰ˆæœ¬
</script>

<style>
/* èŠå¤©å¸ƒå±€æ ·å¼ */
.chat-layout {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 120px);
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(37, 99, 235, 0.1);
}

.chat-header {
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
    border-bottom: 1px solid rgba(37, 99, 235, 0.1);
    background: #ffffff;
}

.chat-messages-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
    background: #fafafa;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(37, 99, 235, 0.2);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(37, 99, 235, 0.3);
}

/* æ¬¢è¿æ¶ˆæ¯æ ·å¼ */
.welcome-message {
    text-align: center;
    padding: 3rem 1rem;
    color: #64748b;
}

.welcome-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 1rem;
    display: block;
}

.welcome-message h4 {
    margin-bottom: 0.5rem;
    color: #334155;
}

/* è¿™äº›æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ï¼Œæ— éœ€é‡å¤ */

/* message-avatar æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* message-bubbleæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* AIæ¶ˆæ¯æ°”æ³¡æ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

.message-bubble.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.message-content {
    font-size: 14px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»15pxæ”¹ä¸º14px */
}

.message-content pre {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.6rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.75remæ”¹ä¸º0.6rem */
    border-radius: 0.4rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.5remæ”¹ä¸º0.4rem */
    margin: 0.4rem 0; /* ğŸ”¥ ç¼©å°ï¼šä»0.5remæ”¹ä¸º0.4rem */
    overflow-x: auto;
    font-size: 13px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»14pxæ”¹ä¸º13px */
}

.message-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.15rem 0.3rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.2rem 0.4remæ”¹ä¸º0.15rem 0.3rem */
    border-radius: 0.2rem; /* ğŸ”¥ ç¼©å°ï¼šä»0.25remæ”¹ä¸º0.2rem */
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 13px; /* ğŸ”¥ å­—ä½“ç¼©å°ï¼šä»14pxæ”¹ä¸º13px */
}

.message-content strong {
    font-weight: 600;
}

.message-content em {
    font-style: italic;
}

/* åˆ†äº«å¯¹è¯æ¨¡æ€æ¡†æ ·å¼ */
.share-conversation-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

.share-conversation-content {
    position: relative;
    background: #ffffff;
    margin: 5% auto;
    max-width: 500px;
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.share-conversation-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.share-conversation-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    font-weight: 300;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #334155;
    font-size: 14px;
}

.form-group .form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-group .form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.char-counter {
    text-align: right;
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
}

.conversation-stats {
    display: flex;
    gap: 16px;
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #475569;
}

.stat-item i {
    color: #667eea;
}

.share-conversation-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.share-conversation-actions .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.share-conversation-actions .btn-secondary {
    background: #f1f5f9;
    color: #475569;
}

.share-conversation-actions .btn-secondary:hover {
    background: #e2e8f0;
}

.share-conversation-actions .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.share-conversation-actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.share-conversation-actions .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 576px) {
    .share-conversation-content {
        margin: 2% auto;
        max-width: 95%;
        border-radius: 8px;
    }
    
    .share-conversation-header {
        padding: 16px 20px;
    }
    
    .share-conversation-header h3 {
        font-size: 16px;
    }
    
    .conversation-stats {
        flex-direction: column;
        gap: 8px;
    }
    
    .share-conversation-actions {
        flex-direction: column-reverse;
    }
    
    .share-conversation-actions .btn {
        width: 100%;
        margin: 0;
    }
}

/* åŠ¨ç”»ä¼˜åŒ– */
.share-conversation-content {
    transform-origin: center top;
}

/* åŠ è½½çŠ¶æ€åŠ¨ç”» */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.bi-arrow-repeat.spin {
    animation: spin 1s linear infinite;
}

/* å¯ç¼–è¾‘æ ‡é¢˜æ ·å¼ */
.editable-title {
    cursor: pointer;
    position: relative;
    transition: color 0.2s ease;
    border-radius: 4px;
    padding: 4px 8px;
    margin: -4px -8px;
}

.editable-title:hover {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.edit-icon {
    opacity: 0;
    font-size: 12px;
    margin-left: 8px;
    transition: opacity 0.2s ease;
}

.editable-title:hover .edit-icon {
    opacity: 0.6;
}

.title-editor {
    font-size: 1.25rem;
    font-weight: 500;
    border: 2px solid #667eea;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.title-editor:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* ä¼˜åŒ–æ ‡é¢˜è¡Œå¸ƒå±€ */
.chat-header .d-flex.justify-content-between {
    align-items: center;
    min-height: 48px;
}

.chat-header .d-flex.align-items-center > div {
    flex: 1;
    min-width: 0; /* å…è®¸æ–‡æœ¬æ”¶ç¼© */
}

.editable-title {
    word-break: break-word;
    max-width: calc(100vw - 300px); /* ä¸ºæŒ‰é’®é¢„ç•™ç©ºé—´ */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ç¼–è¾‘çŠ¶æ€ä¸‹çš„æ ‡é¢˜è¾“å…¥æ¡† */
.title-editor {
    max-width: calc(100vw - 300px); /* ä¸æ ‡é¢˜ä¿æŒä¸€è‡´ */
}

/* å“åº”å¼æŒ‰é’®ç»„ */
@media (max-width: 768px) {
    .chat-header .d-flex.gap-2 {
        gap: 0.5rem !important;
    }
    
    .chat-header .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .chat-header .btn-sm .bi {
        display: none; /* å°å±å¹•æ—¶éšè—å›¾æ ‡ */
    }
}

/* è¾“å…¥åŒºåŸŸæ ·å¼ */
.chat-input-container {
    background: #ffffff;
    border-top: 1px solid rgba(37, 99, 235, 0.1);
    padding: 1rem; /* ğŸ”¥ ç¼©å°ï¼šä»1.5remæ”¹ä¸º1rem */
}

.chat-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.knowledge-base-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.knowledge-base-selector select {
    width: auto;
    min-width: 150px;
}

.quick-actions {
    display: flex;
    gap: 0.5rem;
}

.chat-input-form {
    margin: 0;
}

/* input-wrapperæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* input-wrapper:focus-withinæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* chat-inputæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

.chat-input::placeholder {
    color: #94a3b8;
}

/* send-btnæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* send-btn hoverå’Œdisabledæ ·å¼å·²åœ¨ä¸»CSSæ–‡ä»¶ä¸­å®šä¹‰ */

/* æ‰“å­—æŒ‡ç¤ºå™¨æ ·å¼ */
.typing-indicator {
    display: none;
    padding: 0 1.5rem 1rem;
}

.typing-dots {
    display: inline-flex;
    margin-left: 0.5rem;
}

.typing-dots span {
    height: 4px;
    width: 4px;
    border-radius: 50%;
    background-color: var(--accent);
    margin: 0 1px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { 
        transform: scale(0.8); 
        opacity: 0.5; 
    }
    40% { 
        transform: scale(1); 
        opacity: 1; 
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .chat-layout {
        height: calc(100vh - 80px);
    }
    
    .chat-controls {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .quick-actions {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .message-bubble {
        max-width: 85%;
    }
}

/* V0.3.0 DeepSeek R1 æ€è€ƒè¿‡ç¨‹æ ·å¼ */
.thinking-process-container {
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
    overflow: hidden;
}

.thinking-toggle-btn {
    width: 100%;
    padding: 0.75rem 1rem;
    text-align: left;
    border: none;
    background: transparent;
    color: #6b7280;
    font-size: 0.875rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
}

.thinking-toggle-btn:hover {
    background: #f3f4f6;
    color: #374151;
    text-decoration: none;
}

.thinking-toggle-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.thinking-content {
    border-top: 1px solid #e5e7eb;
    background: #ffffff;
}

.thinking-text {
    padding: 1rem;
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.6;
}

.thinking-text h1, .thinking-text h2, .thinking-text h3, 
.thinking-text h4, .thinking-text h5, .thinking-text h6 {
    color: #6b7280;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
}

.thinking-text p {
    margin-bottom: 0.75rem;
    color: #6b7280;
}

.thinking-text ul, .thinking-text ol {
    color: #6b7280;
    padding-left: 1.5rem;
}

.thinking-text pre {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.75rem;
    margin: 0.75rem 0;
    overflow-x: auto;
}

.thinking-text code {
    background: #f3f4f6;
    color: #6b7280;
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    font-size: 0.85rem;
}

.thinking-text blockquote {
    border-left: 3px solid #d1d5db;
    padding-left: 1rem;
    margin: 0.75rem 0;
    color: #6b7280;
    font-style: italic;
}

/* æ€è€ƒè¿‡ç¨‹åŠ¨ç”»æ•ˆæœ */
.thinking-content {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        max-height: 1000px;
        transform: translateY(0);
    }
}

/* å¯¹è¯æ“ä½œæŒ‰é’®æ ·å¼ */
.conversation-actions {
    display: flex;
    align-items: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.conversation-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 4px;
    min-width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.conversation-actions .btn-outline-primary {
    border-color: #3b82f6;
    color: #3b82f6;
    transition: all 0.2s ease;
}

.conversation-actions .btn-outline-primary:hover {
    background-color: #3b82f6;
    color: white;
    transform: translateY(-1px);
}

.conversation-actions .btn-outline-danger {
    border-color: #ef4444;
    color: #ef4444;
    transition: all 0.2s ease;
}

.conversation-actions .btn-outline-danger:hover {
    background-color: #ef4444;
    color: white;
    transform: translateY(-1px);
}
</style>

<script>
// ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
function addCopyButtonToCodeBlock(preElement) {
    // å¦‚æœå·²ç»æœ‰å¤åˆ¶æŒ‰é’®ï¼Œä¸é‡å¤æ·»åŠ 
    if (preElement.querySelector('.code-copy-btn')) {
        return;
    }
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.innerHTML = 'å¤åˆ¶';
    copyBtn.title = 'å¤åˆ¶ä»£ç ';
    
    copyBtn.addEventListener('click', async function() {
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return;
        
        const text = codeElement.textContent;
        
        try {
            await navigator.clipboard.writeText(text);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'å·²å¤åˆ¶';
            copyBtn.classList.add('copied');
            
            // 2ç§’åæ¢å¤åŸçŠ¶
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
            
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            
            // é™çº§åˆ°æ—§ç‰ˆæœ¬å¤åˆ¶æ–¹æ³•
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = 'å·²å¤åˆ¶';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
        }
    });
    
    preElement.appendChild(copyBtn);
}
</script>

{% endblock %} 