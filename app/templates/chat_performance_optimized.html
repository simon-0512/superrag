{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - Agorix{% endblock %}

{% block extra_css %}
<!-- æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿ŸåŠ è½½å¤–éƒ¨èµ„æº -->
<style>
/* å…ˆå®šä¹‰åŸºç¡€æ ·å¼ï¼Œé¿å…FOUC */
.chat-page-content {
    padding: 0 !important;
    margin: 0 !important;
    height: calc(100vh - 60px);
    overflow: hidden;
}

.chat-container {
    height: 100% !important;
    max-height: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
}

/* åŠ è½½æŒ‡ç¤ºå™¨ */
.external-resources-loading {
    position: fixed;
    top: 70px;
    right: 20px;
    background: rgba(0, 123, 255, 0.1);
    border: 1px solid rgba(0, 123, 255, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 12px;
    color: #007bff;
    z-index: 1000;
    display: none;
}

.external-resources-loading.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block content %}
<!-- å¤–éƒ¨èµ„æºåŠ è½½æŒ‡ç¤ºå™¨ -->
<div id="externalResourcesLoading" class="external-resources-loading">
    <i class="bi bi-cloud-download"></i> æ­£åœ¨åŠ è½½æ¸²æŸ“ç»„ä»¶...
</div>

<div class="chat-page-content">
    <div class="chat-container">
        <!-- Chat é¡µé¢å†…å®¹ -->
        <div class="row h-100 g-0">
            <!-- ä¾§è¾¹æ  -->
            <div class="col-3 border-end chat-sidebar" id="chatSidebar">
                <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <h6 class="mb-0">å¯¹è¯å†å²</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="newChatBtn" title="æ–°å»ºå¯¹è¯">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm d-lg-none" id="toggleSidebar" title="éšè—ä¾§è¾¹æ ">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="p-3 border-bottom">
                    <input type="text" class="form-control form-control-sm" 
                           id="conversationSearch" placeholder="æœç´¢å¯¹è¯...">
                </div>
                
                <!-- å¯¹è¯åˆ—è¡¨ -->
                <div class="chat-conversations" id="conversationList">
                    <!-- å¯¹è¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ä¸»èŠå¤©åŒº -->
            <div class="col-9 d-flex flex-column">
                <!-- èŠå¤©å¤´éƒ¨ -->
                <div class="chat-header border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-link d-lg-none p-0" id="showSidebar" title="æ˜¾ç¤ºä¾§è¾¹æ ">
                                <i class="bi bi-list"></i>
                            </button>
                            <div>
                                <h5 class="mb-0" id="conversationTitle">å¼€å§‹æ–°å¯¹è¯</h5>
                                <small class="text-muted" id="conversationInfo">é€‰æ‹©çŸ¥è¯†åº“å¼€å§‹æ™ºèƒ½é—®ç­”</small>
                            </div>
                        </div>
                        
                        <!-- çŸ¥è¯†åº“é€‰æ‹© -->
                        <div class="d-flex align-items-center gap-2">
                            <label for="knowledgeBaseSelect" class="form-label mb-0 small text-muted">çŸ¥è¯†åº“:</label>
                            <select class="form-select form-select-sm" id="knowledgeBaseSelect" style="min-width: 150px;">
                                <option value="">é€‰æ‹©çŸ¥è¯†åº“...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <i class="bi bi-chat-dots welcome-icon"></i>
                        <h4>æ¬¢è¿ä½¿ç”¨Agorixæ™ºèƒ½é—®ç­”</h4>
                        <p class="mb-3">è¯·é€‰æ‹©çŸ¥è¯†åº“å¹¶å¼€å§‹æé—®ï¼Œæˆ‘å°†åŸºäºæ‚¨çš„çŸ¥è¯†åº“å†…å®¹ä¸ºæ‚¨æä¾›å‡†ç¡®çš„ç­”æ¡ˆã€‚</p>
                        <div class="welcome-features">
                            <span class="badge bg-primary me-2">æ™ºèƒ½æ£€ç´¢</span>
                            <span class="badge bg-success me-2">ä¸Šä¸‹æ–‡ç†è§£</span>
                            <span class="badge bg-info">å¤šæ ¼å¼æ”¯æŒ</span>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input-area">
                    <form id="chatForm" class="d-flex gap-2 align-items-end">
                        <div class="flex-grow-1">
                            <textarea class="form-control" id="messageInput" 
                                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1"
                                    style="resize: none; min-height: 38px; max-height: 120px;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendBtn" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¦†ç›–å±‚ -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script>
// æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿ŸåŠ è½½å¤–éƒ¨èµ„æº
let isLoading = false;
let conversations = [];
let currentConversationId = null;

// ç«‹å³åˆå§‹åŒ–åŸºç¡€åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    console.log(`ğŸ” [DEBUG] é¡µé¢åŸºç¡€åˆå§‹åŒ–å¼€å§‹ - ${new Date().toLocaleTimeString()}`);
    
    // å…ˆè®¾ç½®åŸºç¡€äº‹ä»¶ç›‘å¬å™¨
    setupBasicEventListeners();
    
    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    showResourcesLoading();
    
    // å¼‚æ­¥åŠ è½½å¤–éƒ¨èµ„æºå’Œæ•°æ®
    loadExternalResourcesAndInitialize();
});

function showResourcesLoading() {
    const indicator = document.getElementById('externalResourcesLoading');
    if (indicator) {
        indicator.classList.add('show');
    }
}

function hideResourcesLoading() {
    const indicator = document.getElementById('externalResourcesLoading');
    if (indicator) {
        indicator.classList.remove('show');
        setTimeout(() => indicator.remove(), 300);
    }
}

async function loadExternalResourcesAndInitialize() {
    const startTime = performance.now();
    
    try {
        // 1. åŠ¨æ€åŠ è½½å¤–éƒ¨èµ„æº
        await loadExternalResources();
        
        // 2. å¹¶è¡ŒåŠ è½½æ•°æ®
        await Promise.all([
            loadKnowledgeBases(),
            loadConversationsAndInitialize()
        ]);
        
        // 3. å®Œæˆåˆå§‹åŒ–
        hideResourcesLoading();
        
        const totalTime = performance.now() - startTime;
        console.log(`ğŸ‰ [DEBUG] é¡µé¢å®Œå…¨åˆå§‹åŒ–å®Œæˆ: ${totalTime.toFixed(3)}ms`);
        
    } catch (error) {
        console.error(`âŒ [DEBUG] é¡µé¢åˆå§‹åŒ–å¤±è´¥:`, error);
        hideResourcesLoading();
        
        // å³ä½¿å¤–éƒ¨èµ„æºåŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿åŸºç¡€åŠŸèƒ½å¯ç”¨
        setupBasicEventListeners();
        loadKnowledgeBases();
        loadConversationsAndInitialize();
    }
}

function loadExternalResources() {
    return new Promise((resolve, reject) => {
        const resources = [
            {
                type: 'script',
                src: 'https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js',
                name: 'marked.js'
            },
            {
                type: 'script', 
                src: 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js',
                name: 'highlight.js'
            },
            {
                type: 'link',
                href: 'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/one-dark.min.css',
                name: 'highlight.css'
            }
        ];
        
        let loadedCount = 0;
        let hasError = false;
        
        function onResourceLoad(name) {
            loadedCount++;
            console.log(`âœ… [DEBUG] ${name} åŠ è½½å®Œæˆ (${loadedCount}/${resources.length})`);
            
            if (loadedCount === resources.length) {
                console.log(`âœ… [DEBUG] æ‰€æœ‰å¤–éƒ¨èµ„æºåŠ è½½å®Œæˆ`);
                initializeMarkdown();
                resolve();
            }
        }
        
        function onResourceError(name) {
            console.warn(`âš ï¸ [DEBUG] ${name} åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é™çº§æ–¹æ¡ˆ`);
            hasError = true;
            onResourceLoad(name); // ç»§ç»­æµç¨‹
        }
        
        resources.forEach(resource => {
            if (resource.type === 'script') {
                const script = document.createElement('script');
                script.src = resource.src;
                script.onload = () => onResourceLoad(resource.name);
                script.onerror = () => onResourceError(resource.name);
                document.head.appendChild(script);
            } else if (resource.type === 'link') {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = resource.href;
                link.onload = () => onResourceLoad(resource.name);
                link.onerror = () => onResourceError(resource.name);
                document.head.appendChild(link);
            }
        });
        
        // 10ç§’è¶…æ—¶
        setTimeout(() => {
            if (loadedCount < resources.length) {
                console.warn(`âš ï¸ [DEBUG] å¤–éƒ¨èµ„æºåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨å·²åŠ è½½çš„èµ„æºç»§ç»­`);
                resolve();
            }
        }, 10000);
    });
}

function initializeMarkdown() {
    if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });
        console.log(`âœ… [DEBUG] Markdownè§£æå™¨é…ç½®å®Œæˆ`);
    } else {
        console.warn(`âš ï¸ [DEBUG] Markdownè§£æå™¨æˆ–ä»£ç é«˜äº®ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º`);
    }
}

function setupBasicEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const chatForm = document.getElementById('chatForm');
    const newChatBtn = document.getElementById('newChatBtn');
    
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            updateSendButtonState();
        });
        
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isLoading && this.value.trim()) {
                    chatForm.dispatchEvent(new Event('submit'));
                }
            }
        });
    }
    
    if (chatForm) {
        chatForm.addEventListener('submit', handleSendMessage);
    }
    
    if (newChatBtn) {
        newChatBtn.addEventListener('click', startNewConversation);
    }
}

// ç®€åŒ–çš„å‘é€æŒ‰é’®çŠ¶æ€ç®¡ç†
function updateSendButtonState() {
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    
    if (!sendBtn || !messageInput) return;
    
    const hasContent = messageInput.value.trim().length > 0;
    sendBtn.disabled = isLoading || !hasContent;
    
    if (isLoading) {
        sendBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
    } else {
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
    }
}

// å ä½å‡½æ•°ï¼Œå®é™…å®ç°å°†åœ¨å¤–éƒ¨èµ„æºåŠ è½½å®Œæˆåæä¾›
function handleSendMessage(e) {
    e.preventDefault();
    console.log('å‘é€æ¶ˆæ¯åŠŸèƒ½æš‚æœªå°±ç»ªï¼Œè¯·ç­‰å¾…èµ„æºåŠ è½½å®Œæˆ');
}

function startNewConversation() {
    console.log('æ–°å»ºå¯¹è¯åŠŸèƒ½æš‚æœªå°±ç»ªï¼Œè¯·ç­‰å¾…èµ„æºåŠ è½½å®Œæˆ');
}

async function loadKnowledgeBases() {
    // ç®€åŒ–ç‰ˆæœ¬ï¼Œå¿«é€ŸåŠ è½½
    try {
        const response = await fetch('/api/knowledge_bases');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('knowledgeBaseSelect');
            data.knowledge_bases.forEach(kb => {
                const option = document.createElement('option');
                option.value = kb.id;
                option.textContent = kb.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
    }
}

async function loadConversationsAndInitialize() {
    // ç®€åŒ–ç‰ˆæœ¬ï¼Œå¿«é€ŸåŠ è½½
    try {
        const response = await fetch('/api/conversations');
        const data = await response.json();
        
        if (data.success) {
            conversations = data.conversations;
            renderConversationList(conversations);
            
            if (conversations.length > 0) {
                // å»¶è¿ŸåŠ è½½å¯¹è¯è¯¦æƒ…ï¼Œä¼˜å…ˆæ˜¾ç¤ºé¡µé¢
                setTimeout(() => {
                    const latestConversation = conversations[0];
                    switchConversation(latestConversation.id);
                }, 100);
            }
        }
    } catch (error) {
        console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
    }
}

function renderConversationList(conversations) {
    const container = document.getElementById('conversationList');
    if (!container) return;
    
    container.innerHTML = '';
    
    conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        item.innerHTML = `
            <div class="conversation-content">
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-meta">
                    <small class="text-muted">${conv.message_count} æ¡æ¶ˆæ¯</small>
                    <small class="text-muted">${new Date(conv.updated_at).toLocaleDateString()}</small>
                </div>
            </div>
        `;
        item.onclick = () => switchConversation(conv.id);
        container.appendChild(item);
    });
}

function switchConversation(conversationId) {
    // å ä½å‡½æ•°ï¼Œå®é™…å®ç°éœ€è¦æ›´å¤šä¾èµ–
    console.log(`åˆ‡æ¢åˆ°å¯¹è¯: ${conversationId}`);
    currentConversationId = conversationId;
}
</script>

<style>
/* å¯¹è¯åˆ—è¡¨æ ·å¼ */
.chat-conversations {
    overflow-y: auto;
    height: calc(100% - 140px);
}

.conversation-item {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #e3f2fd;
}

.conversation-title {
    font-weight: 500;
    margin-bottom: 4px;
    color: #333;
}

.conversation-meta {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 992px) {
    .chat-sidebar {
        position: fixed;
        left: -100%;
        top: 60px;
        height: calc(100vh - 60px);
        width: 300px;
        z-index: 1040;
        background: white;
        transition: left 0.3s ease;
    }
    
    .chat-sidebar.show {
        left: 0;
    }
    
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1030;
        display: none;
    }
    
    .sidebar-overlay.show {
        display: block;
    }
}
</style>
{% endblock %} 